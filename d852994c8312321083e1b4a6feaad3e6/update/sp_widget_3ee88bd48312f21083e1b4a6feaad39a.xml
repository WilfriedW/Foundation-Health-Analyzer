<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $location, $window) {
  var c = this;

  c.analysisId = $location.search().sys_id || c.data.analysisId || c.data.analysis_id || '';
  c.result = c.data.result || null;
  c.error = c.data.error || null;
  c.loading = !!c.analysisId && !c.result;
  c.activeTab = 'overview';
  c.filters = { severity: 'all', search: '' };
  c.categoryTabs = [];

  c.setTab = function(tab) { c.activeTab = tab; };
  c.isTab = function(tab) { return c.activeTab === tab; };

  c.getData = function() {
    return (c.result && c.result.result && c.result.result.data) || [];
  };

  c.buildCategories = function() {
    var data = c.getData();
    var seen = {};
    data.forEach(function(item) {
      var cat = item.category || 'general';
      seen[cat] = true;
    });
    c.categoryTabs = Object.keys(seen).sort();
    if (!c.categoryTabs.length) {
      c.categoryTabs = ['general'];
    }
    if (c.activeTab !== 'overview' && c.activeTab !== 'json' && c.categoryTabs.indexOf(c.activeTab) === -1) {
      c.activeTab = c.categoryTabs[0] || 'overview';
    }
  };

  c.countItems = function() {
    return c.getData().length;
  };

  c.countIssuesBySeverity = function(sev) {
    var s = (sev || '').toLowerCase();
    var total = 0;
    c.getData().forEach(function(item) {
      (item.issues || []).forEach(function(issue) {
        if ((issue.severity || '').toLowerCase() === s) total++;
      });
    });
    return total;
  };

  c.getTableInfo = function() {
    var r = c.result || {};
    var cfg = r.config || {};
    return {
      number: r.number || '',
      state: r.state || '',
      table_name: cfg.table_name || r.table_name || '',
      table_label: cfg.table_label || r.table_label || '',
      description: cfg.description || r.description || '',
      include_children_tables: cfg.include_children_tables,
      deep_scan: cfg.deep_scan,
      ignore_servicenow_records: cfg.ignore_servicenow_records,
      include_ldap: cfg.include_ldap,
      created_on: r.created_on || '',
      created_by: r.created_by || ''
    };
  };

  c.booleanText = function(val) {
    if (val === undefined || val === null) return 'N/A';
    return val ? 'Yes' : 'No';
  };

  c.truncate = function(str, len) {
    if (!str) return '';
    if (!len || str.length <= len) return str;
    return str.substring(0, len) + '…';
  };

  c.filteredData = function(tab) {
    var cat = tab;
    var sev = c.filters.severity;
    var search = (c.filters.search || '').toLowerCase();
    return c.getData().filter(function(item) {
      var matchesCat = (item.category || 'general') === cat;
      if (!matchesCat) return false;
      if (sev !== 'all') {
        var hasSev = (item.issues || []).some(function(issue) {
          return (issue.severity || '').toLowerCase() === sev;
        });
        if (!hasSev) return false;
      }
      if (search) {
        var hay = [
          item.category,
          item.table,
          item.values && item.values.name,
          item.values && item.values.sys_created_by,
          item.values && item.values.sys_updated_by
        ].join(' ').toLowerCase();
        var issueText = (item.issues || []).map(function(i){ return (i.code || '') + ' ' + (i.message || ''); }).join(' ').toLowerCase();
        if (hay.indexOf(search) === -1 && issueText.indexOf(search) === -1) return false;
      }
      return true;
    });
  };

  c.exportJSON = function() {
    if (!c.result) return;
    var blob = new Blob([JSON.stringify(c.result, null, 2)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (c.result.number || 'analysis') + '.json';
    a.click();
    URL.revokeObjectURL(url);
  };

  c.exportPDF = function() {
    $window.print();
  };

  c.init = function() {
    if (c.result) {
      c.buildCategories();
      c.loading = false;
      return;
    }

    if (!c.analysisId) {
      c.error = '${Missing analysis identifier}';
      c.loading = false;
      return;
    }

    c.loading = true;
    c.server.get({ action: 'get_result', analysisId: c.analysisId }).then(function(resp) {
      if (resp.data && resp.data.success && resp.data.analysisResult) {
        c.result = resp.data.analysisResult;
        c.error = null;
        c.buildCategories();
      } else {
        c.error = (resp.data && resp.data.error) ? resp.data.error : '${Result not found}';
      }
      c.loading = false;
    }, function() {
      c.error = '${Server communication error}';
      c.loading = false;
    });
  };

  c.init();
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.fha-detail {
  max-width: 1200px;
  margin: 0 auto;
  padding: 22px 18px 28px;
  background: #f8fafc;
}

.fha-header {
  background: linear-gradient(135deg, #0c63d4 0%, #0a4f9c 100%);
  color: #fff;
  padding: 22px 24px;
  border-radius: 14px;
  margin-bottom: 18px;
  box-shadow: 0 8px 28px rgba(12, 99, 212, 0.25);
}

.fha-header h1 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.fha-stats {
  display: flex;
  gap: 16px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.fha-stat-card {
  flex: 1;
  min-width: 200px;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 4px 12px rgba(17, 24, 39, 0.04);
  text-align: center;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.fha-stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(17, 24, 39, 0.08);
}

.fha-stat-value {
  font-size: 28px;
  font-weight: 800;
  line-height: 1;
  margin-bottom: 8px;
}

.fha-stat-value.danger {
  color: #b91c1c;
}

.fha-stat-value.warning {
  color: #b45309;
}

.fha-stat-value.info { color: #075985; }
.fha-stat-value.neutral { color: #1f2937; }

.fha-stat-label {
  font-size: 13px;
  font-weight: 600;
  color: #4b5563;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}




.fha-meta {
  margin-top: 10px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 13px;
}

.fha-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin: 8px 0 16px;
}

.fha-btn {
  background: #0c63d4;
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 10px 14px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(12, 99, 212, 0.2);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.fha-btn i {
  margin-right: 6px;
}

.fha-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(12, 99, 212, 0.3);
}

.fha-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.15);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.25);
  font-weight: 600;
}

.fha-tabs {
  display: flex;
  gap: 10px;
  margin: 18px 0 14px;
  flex-wrap: wrap;
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: 6px;
}

.fha-tab-btn {
  border: none;
  background: transparent;
  padding: 10px 16px;
  border-radius: 10px 10px 0 0;
  cursor: pointer;
  font-weight: 700;
  color: #4b5563;
  border-bottom: 3px solid transparent;
  transition: all 0.2s ease;
}

.fha-tab-btn:hover {
  color: #0c63d4;
  background: #eef5ff;
}

.fha-tab-btn.active {
  color: #0c63d4;
  border-bottom-color: #0c63d4;
  background: #eef5ff;
}

.fha-tab-btn .fha-badge {
  background: #0c63d4;
  color: #fff;
  border: none;
  padding: 3px 8px;
  font-size: 11px;
}

.fha-card {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  margin-bottom: 16px;
  box-shadow: 0 6px 18px rgba(17, 24, 39, 0.06);
  overflow: hidden;
}

.fha-card h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
  color: #0f172a;
}

.fha-card__head {
  padding: 14px 16px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f8fafc;
}

.fha-card__body {
  padding: 16px;
}

.fha-data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.fha-data-table th,
.fha-data-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #eef2f7;
  text-align: left;
}

.fha-data-table th {
  background: #f3f6fb;
  font-weight: 700;
  color: #1f2937;
}

.fha-data-table tr:hover td {
  background: #f9fbff;
}

.pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  background: #eef2f7;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.2px;
}

.pill.red { background: #fee2e2; color: #b91c1c; }
.pill.amber { background: #fef3c7; color: #b45309; }
.pill.blue { background: #dbeafe; color: #1d4ed8; }
.pill.gray { background: #e5e7eb; color: #374151; }

.issue-badge {
  padding: 6px 10px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 800;
  text-transform: uppercase;
  display: inline-block;
  letter-spacing: 0.4px;
}
.sev-high { background: #fee2e2; color: #b91c1c; }
.sev-medium { background: #fef3c7; color: #b45309; }
.sev-low { background: #e0f2fe; color: #075985; }

.section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  margin: 0 0 6px 0;
  color: #0f172a;
}

.filter-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.filter-bar label {
  font-size: 12px;
  font-weight: 700;
  color: #4b5563;
}

.filter-bar input,
.filter-bar select {
  padding: 8px 10px;
  border: 1px solid #cfd8e3;
  border-radius: 8px;
  font-size: 13px;
  background: #fff;
  min-width: 140px;
}

.filter-bar input:focus,
.filter-bar select:focus {
  outline: none;
  border-color: #0c63d4;
  box-shadow: 0 0 0 3px rgba(12, 99, 212, 0.18);
}

.fha-link {
  color: #0c63d4;
  text-decoration: none;
}

.fha-link:hover {
  text-decoration: underline;
}

.alert {
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 12px;
  border: 1px solid transparent;
}
.alert-danger { background: #fef2f2; color: #b91c1c; border-color: #fecdd3; }
.alert-info { background: #e0f2fe; color: #075985; border-color: #bae6fd; }

@media (max-width: 768px) {
  .fha-stat-card {
    flex: 1 1 45%;
  }
}

@media (max-width: 480px) {
  .fha-stat-card {
    flex: 1 1 100%;
  }
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_analysis_detail</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>FHA Analysis detail</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    data.analysisId = $sp.getParameter('sys_id') || (input && input.analysisId) || '';
    data.result = null;
    data.error = null;
    data.success = false;

    function loadResult(resultId) {
        if (!resultId) {
            return { success: false, error: gs.getMessage('Missing result identifier') };
        }

        var gr = new GlideRecord('x_1310794_founda_0_results');
        if (!gr.get(resultId)) {
            return { success: false, error: gs.getMessage('Result not found') };
        }

        var parsed;
        try {
            parsed = JSON.parse(gr.getValue('details') || '{}');
        } catch (err) {
            return { success: false, error: gs.getMessage('Unable to parse analysis details') };
        }
					gs.info('Parsed : ' + JSON.stringify (parsed.sys_id))

        parsed.number = gr.getValue('number');
        parsed.state = gr.getValue('state');
        parsed.health_score =gr.getValue('health_score') || '';
        parsed.sys_id = gr.getUniqueValue();
        parsed.created_on = gr.getDisplayValue('sys_created_on');
        parsed.created_by = gr.getDisplayValue('sys_created_by');

        return { success: true, result: parsed };
    }

    var initial = loadResult(data.analysisId);
    if (initial.success) {
        data.result = initial.result;
        data.success = true;
    } else if (data.analysisId) {
        data.error = initial.error;
    }

    if (input && input.action === 'get_result') {
        var res = loadResult(input.analysisId || data.analysisId);
        data.success = res.success;
        if (res.success) {
            data.analysisResult = res.result;
            data.error = '';
        } else {
            data.error = res.error;
        }
    }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-03 22:38:44</sys_created_on>
        <sys_id>3ee88bd48312f21083e1b4a6feaad39a</sys_id>
        <sys_mod_count>51</sys_mod_count>
        <sys_name>FHA Analysis detail</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_3ee88bd48312f21083e1b4a6feaad39a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-09 23:05:03</sys_updated_on>
        <template><![CDATA[<div class="fha-detail">
  <div class="fha-header">
    <div style="display:flex;flex-direction:column;gap:6px;">
      <h1>${Analysis Results}</h1>
      <div style="font-size:13px;opacity:0.9;" ng-if="c.result">
        {{c.result.name || 'Configuration'}} — <strong>{{c.getTableInfo().table_label || c.getTableInfo().table_name || 'N/A'}}</strong>
        <span style="opacity:0.8;">({{c.getTableInfo().table_name || 'N/A'}})</span>
      </div>
      <div class="fha-meta" ng-if="c.result">
        <span class="fha-badge">{{c.result.number || c.analysisId}}</span>
        <span class="fha-badge" ng-if="c.result.state">{{c.result.state}}</span>
        <span class="fha-badge" ng-if="c.getTableInfo().created_on">{{c.getTableInfo().created_on}}</span>
        <span class="fha-badge" ng-if="c.getTableInfo().created_by">{{c.getTableInfo().created_by}}</span>
      </div>
    </div>
  </div>

  <div class="alert alert-danger" ng-if="c.error">
    {{c.error}}
  </div>

  <div class="alert alert-info" ng-if="c.loading">
    ${Loading analysis results...}
  </div>

  <div ng-if="!c.loading && c.result">

    <div class="fha-stats">
      <div class="fha-stat-card">
        <div class="fha-stat-value neutral">{{c.countItems()}}</div>
        <div class="fha-stat-label">Records scanned</div>
      </div>
      <div class="fha-stat-card">
        <div class="fha-stat-value danger">{{c.countIssuesBySeverity('high')}}</div>
        <div class="fha-stat-label">High issues</div>
      </div>
      <div class="fha-stat-card">
        <div class="fha-stat-value warning">{{c.countIssuesBySeverity('medium')}}</div>
        <div class="fha-stat-label">Medium issues</div>
      </div>
      <div class="fha-stat-card">
        <div class="fha-stat-value info">{{c.countIssuesBySeverity('low')}}</div>
        <div class="fha-stat-label">Low issues</div>
      </div>
    </div>

    <div class="fha-actions">
      <button class="fha-btn" ng-click="c.exportPDF()"><i class="fa fa-file-pdf-o"></i> Export PDF</button>
      <button class="fha-btn" ng-click="c.exportJSON()"><i class="fa fa-download"></i> Export JSON</button>
    </div>

    <div class="fha-tabs">
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('overview')}" ng-click="c.setTab('overview')">Overview</button>
      <button class="fha-tab-btn" ng-repeat="cat in c.categoryTabs" ng-class="{'active': c.isTab(cat)}" ng-click="c.setTab(cat)">
        {{cat | uppercase}} <span class="fha-badge">{{c.filteredData(cat).length}}</span>
      </button>
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('json')}" ng-click="c.setTab('json')">JSON</button>
    </div>

    <div ng-show="c.isTab('overview')">
      <div class="fha-card">
        <div class="fha-card__head"><h3>Overview</h3></div>
        <div class="fha-card__body">
          <table class="fha-data-table">
            <tbody>
              <tr><td><strong>Number</strong></td><td>{{c.result.number || 'N/A'}}</td></tr>
              <tr><td><strong>State</strong></td><td>{{c.result.state || 'N/A'}}</td></tr>
              <tr><td><strong>Created on</strong></td><td>{{c.getTableInfo().created_on || 'N/A'}}</td></tr>
              <tr><td><strong>Created by</strong></td><td>{{c.getTableInfo().created_by || 'N/A'}}</td></tr>
              <tr><td><strong>Table label</strong></td><td>{{c.getTableInfo().table_label || 'N/A'}}</td></tr>
              <tr><td><strong>Table name</strong></td><td>{{c.getTableInfo().table_name || 'N/A'}}</td></tr>
              <tr><td><strong>Description</strong></td><td>{{c.getTableInfo().description || 'N/A'}}</td></tr>
              <tr><td><strong>Include children</strong></td><td>{{c.booleanText(c.getTableInfo().include_children_tables)}}</td></tr>
              <tr><td><strong>Deep scan</strong></td><td>{{c.booleanText(c.getTableInfo().deep_scan)}}</td></tr>
              <tr><td><strong>Ignore ServiceNow records</strong></td><td>{{c.booleanText(c.getTableInfo().ignore_servicenow_records)}}</td></tr>
              <tr><td><strong>Include LDAP</strong></td><td>{{c.booleanText(c.getTableInfo().include_ldap)}}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div ng-show="c.categoryTabs.indexOf(c.activeTab) !== -1">
      <div class="fha-card">
        <div class="fha-card__head">
          <h3>Category: {{c.activeTab | uppercase}}</h3>
          <div class="filter-bar">
            <label>Severity:</label>
            <select ng-model="c.filters.severity">
              <option value="all">All</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <label>Search:</label>
            <input type="text" ng-model="c.filters.search" placeholder="Name, user, issue...">
            <button class="fha-tab-btn" style="border:none;" ng-click="c.filters = { severity: 'all', search: '' }">
              <i class="fa fa-refresh"></i> Reset
            </button>
          </div>
        </div>
        <div class="fha-card__body" ng-if="c.filteredData(c.activeTab).length">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Name</th>
                <th>Table</th>
                <th>Active</th>
                <th>Created by</th>
                <th>Updated by</th>
                <th>Issues</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="item in c.filteredData(c.activeTab)">
                <td>{{item.category || 'general'}}</td>
                <td>{{item.values && item.values.name || item.sys_id}}</td>
                <td>{{item.table}}</td>
                <td>
                  <span class="pill blue" ng-if="(item.values && item.values.active) === 'true'">Active</span>
                  <span class="pill gray" ng-if="(item.values && item.values.active) !== 'true'">Inactive</span>
                </td>
                <td>{{item.values && item.values.sys_created_by || '-'}}</td>
                <td>{{item.values && item.values.sys_updated_by || '-'}}</td>
                <td>
                  <div ng-if="item.issues && item.issues.length">
                    <div ng-repeat="issue in item.issues">
                      <span class="issue-badge" ng-class="{'sev-high': issue.severity=='high','sev-medium': issue.severity=='medium','sev-low': issue.severity=='low'}">
                        {{issue.severity | uppercase}}
                      </span>
                      <span style="margin-left:6px;">{{issue.code}} - {{issue.message}}</span>
                    </div>
                  </div>
                  <span ng-if="!item.issues || !item.issues.length">-</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="fha-card__body" ng-if="!c.filteredData(c.activeTab).length"><span class="pill gray">No data</span></div>
      </div>
    </div>

    <div ng-show="c.isTab('json')">
      <div class="fha-card">
        <div class="fha-card__head"><h3>JSON</h3></div>
        <div class="fha-card__body">
          <pre style="white-space:pre-wrap; word-break:break-word;">{{c.result | json:2}}</pre>
        </div>
      </div>
    </div>

  </div>
</div>]]></template>
    </sp_widget>
</record_update>
