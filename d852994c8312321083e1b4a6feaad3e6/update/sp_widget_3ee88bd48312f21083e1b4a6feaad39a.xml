<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $location) {
  var c = this;

  c.analysisId = $location.search().sys_id || c.data.analysis_id || '';
  c.result = c.data.result || null;
  c.error = c.data.error || null;
  c.number = c.data.number || '';
  c.state = c.data.state || '';
  c.loading = false;

  c.hasData = function() {
    return c.result && Array.isArray(c.result.data) && c.result.data.length > 0;
  };

  c.recordKeys = function(rec) {
    if (!rec || !rec.values) return [];
    return Object.keys(rec.values);
  };
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.fha-detail {
  max-width: 1100px;
  margin: 0 auto;
  padding: 20px;
}

.fha-header {
  background: #0b5cab;
  color: #fff;
  padding: 18px;
  border-radius: 10px;
  margin-bottom: 16px;
}

.fha-header h1 {
  margin: 0;
  font-size: 20px;
}

.fha-meta {
  margin-top: 8px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  font-size: 13px;
  opacity: 0.9;
}

.fha-card {
  background: #fff;
  border: 1px solid #dfe3e6;
  border-radius: 10px;
  margin-bottom: 14px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.fha-card h3 {
  margin: 0;
  font-size: 16px;
}

.fha-card__head {
  padding: 12px 16px;
  border-bottom: 1px solid #dfe3e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.fha-card__body {
  padding: 14px 16px;
}

.fha-data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.fha-data-table th,
.fha-data-table td {
  padding: 8px 10px;
  border-bottom: 1px solid #eef1f3;
  text-align: left;
}

.fha-data-table th {
  background: #f5f7f9;
  font-weight: 600;
}

.fha-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  background: #eef1f3;
}

pre {
  background: #0f172a;
  color: #e2e8f0;
  padding: 12px;
  border-radius: 8px;
  overflow: auto;
  font-size: 12px;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_analysis_detail</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>FHA Analysis detail</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    data.analysis_id = $sp.getParameter('sys_id') || '';
    data.result = null;
    data.error = null;
    data.number = '';
    data.state = '';

    function parseJSON(val) {
        if (!val) return null;
        try {
            return JSON.parse(val);
        } catch (e) {
            data.error = 'Impossible de parser le JSON du resultat: ' + e.message;
            return null;
        }
    }

    if (!data.analysis_id) {
        data.error = 'Aucun sys_id de resultat trouve dans l URL.';
        return;
    }

    var gr = new GlideRecord('x_1310794_founda_0_results');
    if (gr.get(data.analysis_id)) {
        data.number = gr.getValue('number') || '';
        data.state = gr.getValue('state') || '';
        data.result = parseJSON(gr.getValue('details'));
        if (!data.result && !data.error) {
            data.error = 'Aucun detail JSON trouve pour ce resultat.';
        }
    } else {
        data.error = 'Resultat introuvable pour le sys_id fourni.';
    }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-03 22:38:44</sys_created_on>
        <sys_id>3ee88bd48312f21083e1b4a6feaad39a</sys_id>
        <sys_mod_count>40</sys_mod_count>
        <sys_name>FHA Analysis detail</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_3ee88bd48312f21083e1b4a6feaad39a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-05 00:34:36</sys_updated_on>
        <template><![CDATA[<div class="fha-detail">
  <div class="fha-header">
    <h1>Analyse detail</h1>
    <div class="fha-meta">
      <span class="fha-badge">sys_id : {{c.analysisId}}</span>
      <span class="fha-badge" ng-if="c.number">numero : {{c.number}}</span>
      <span class="fha-badge" ng-if="c.state">etat : {{c.state}}</span>
    </div>
  </div>

  <div class="alert alert-danger" ng-if="c.error">
    {{c.error}}
  </div>

  <div class="alert alert-info" ng-if="!c.error && !c.result">
    Aucun resultat charge. Verifie le parametre sys_id.
  </div>

  <div ng-if="c.result">
    <div class="fha-card">
      <div class="fha-card__head">
        <h3>Statut</h3>
        <span class="fha-badge">{{c.result.success === false ? 'echec' : 'ok'}}</span>
      </div>
      <div class="fha-card__body">
        <p ng-if="c.result.metadata">Metadonnees :</p>
        <table class="fha-data-table" ng-if="c.result.metadata">
          <thead>
            <tr>
              <th>Cle</th>
              <th>Valeur</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="(key,val) in c.result.metadata">
              <td>{{key}}</td>
              <td>{{val}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="fha-card" ng-if="c.result.errors && c.result.errors.length">
      <div class="fha-card__head">
        <h3>Erreurs</h3>
        <span class="fha-badge">{{c.result.errors.length}}</span>
      </div>
      <div class="fha-card__body">
        <ul>
          <li ng-repeat="err in c.result.errors track by $index">{{err}}</li>
        </ul>
      </div>
    </div>

    <div class="fha-card" ng-if="c.hasData()">
      <div class="fha-card__head">
        <h3>Donnees</h3>
        <span class="fha-badge">{{c.result.data.length}}</span>
      </div>
      <div class="fha-card__body">
        <div ng-repeat="rec in c.result.data track by rec.sys_id || $index" style="margin-bottom:16px;">
          <h4 style="margin:0 0 6px 0;">{{rec.table || 'table inconnue'}} - {{rec.sys_id || 'id inconnu'}}</h4>
          <table class="fha-data-table" ng-if="c.recordKeys(rec).length">
            <thead>
              <tr>
                <th>Champ</th>
                <th>Valeur</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="field in c.recordKeys(rec) track by field">
                <td>{{field}}</td>
                <td>{{rec.values[field]}}</td>
              </tr>
            </tbody>
          </table>
          <div ng-if="rec.issues && rec.issues.length">
            <strong>Issues :</strong>
            <ul>
              <li ng-repeat="issue in rec.issues track by $index">
                {{issue.code || 'ISSUE'}} - {{issue.message || issue}}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="fha-card">
      <div class="fha-card__head">
        <h3>JSON brut</h3>
      </div>
      <div class="fha-card__body">
        <pre>{{c.result | json:2}}</pre>
      </div>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
