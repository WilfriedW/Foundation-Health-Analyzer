<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $location, $window) {
  var c = this;

  c.analysisId = $location.search().sys_id || c.data.analysisId || c.data.analysis_id || '';
  c.result = c.data.result || null;
  c.error = c.data.error || null;
  c.loading = !!c.analysisId && !c.result;
  c.activeTab = 'overview';
  c.filters = { severity: 'all', search: '', type: 'all', issueCategory: 'all' };
  c.sort = { field: 'name', dir: 'asc' };
  c.categoryTabs = [];
  c.metaByTable = {};
  c.metaByCategory = {};
  c.typeOptions = [];
  c.issueCategories = ['all'];

  c.setTab = function(tab) { c.activeTab = tab; };
  c.isTab = function(tab) { return c.activeTab === tab; };

  c.getData = function() {
    return (c.result && c.result.result && c.result.result.data) || [];
  };

  c.buildCategories = function() {
    var seen = {};
    var typesSeen = {};
    c.getData().forEach(function(item) {
      var cat = item.category || 'general';
      seen[cat] = true;
      var t = c.getTypeLabel(item);
      if (t) typesSeen[t] = true;
    });
    c.categoryTabs = Object.keys(seen).sort();
    if (!c.categoryTabs.length) c.categoryTabs = ['general'];
    c.typeOptions = ['all'].concat(Object.keys(typesSeen).sort());
    if (c.activeTab !== 'overview' && c.activeTab !== 'json' && c.categoryTabs.indexOf(c.activeTab) === -1) {
      c.activeTab = c.categoryTabs[0];
    }

    // build issue categories
    var catsIssue = ['all'];
    var seenIssue = {};
    (c.getIssues() || []).forEach(function(is) {
      var cat = is.category || 'general';
      if (!seenIssue[cat]) {
        seenIssue[cat] = true;
        catsIssue.push(cat);
      }
    });
    c.issueCategories = catsIssue;
  };

  c.countItems = function() {
    return c.getData().length;
  };

  c.countIssuesBySeverity = function(sev) {
    var s = (sev || '').toLowerCase();
    return c.getIssues().filter(function(is){ return (is.severity || '').toLowerCase() === s; }).length;
  };

  c.safeParseMeta = function(str) {
    if (!str || typeof str !== 'string') return {};
    try { return JSON.parse(str); } catch(e) {}
    try {
      var normalized = str.replace(/'/g, '"');
      return JSON.parse(normalized);
    } catch(e2) {}
    try { return Function('return ' + str)(); } catch(e3) {}
    return {};
  };

  c.buildMetadataMaps = function() {
    c.metaByTable = {};
    c.metaByCategory = {};
    var cfg = (c.result && c.result.config && c.result.config.verification_items) || [];
    cfg.forEach(function(item) {
      var meta = c.safeParseMeta(item.metadata);
      if (item.tableName) c.metaByTable[item.tableName] = meta;
      if (item.category) c.metaByCategory[item.category] = meta;
    });
  };

  c.getMeta = function(item) {
    return c.metaByTable[item.table] || c.metaByCategory[item.category] || {};
  };

  c.getTypeLabel = function(item) {
    var meta = c.getMeta(item);
    return meta.displayName || meta.record_type || item.tableName || item.table || 'general';
  };

  c.getIssues = function() {
    return (c.result && c.result.issues) || [];
  };

  c.filteredIssues = function() {
    var sev = c.filters.severity;
    var search = (c.filters.search || '').toLowerCase();
    var cat = c.filters.issueCategory || 'all';
    return c.getIssues().filter(function(is) {
      if (sev !== 'all' && (is.severity || '').toLowerCase() !== sev) return false;
      if (cat !== 'all' && (is.category || 'general') !== cat) return false;
      if (search) {
        var hay = [
          is.code, is.message, is.category, is.record_table, is.record_name
        ].join(' ').toLowerCase();
        if (hay.indexOf(search) === -1) return false;
      }
      return true;
    });
  };

  c.getResultMeta = function() {
    var r = c.result || {};
    return {
      number: r.number || '',
      state: r.state || '',
      created_on: r.created_on || '',
      created_by: r.created_by || ''
    };
  };

  c.getConfigInfo = function() {
    var cfg = (c.result && c.result.config) || {};
    return {
      table_name: cfg.table_name || '',
      table_label: cfg.table_label || '',
      description: cfg.description || '',
      include_children_tables: cfg.include_children_tables,
      deep_scan: cfg.deep_scan,
      ignore_servicenow_records: cfg.ignore_servicenow_records,
      include_ldap: cfg.include_ldap
    };
  };

  c.booleanText = function(val) {
    if (val === undefined || val === null) return 'N/A';
    if (typeof val === 'object') {
      var s = val.toString();
      if (s === '{}' || s === '[object Object]') return 'N/A';
    }
    return val ? 'Yes' : 'No';
  };

  c.truncate = function(str, len) {
    if (!str) return '';
    if (!len || str.length <= len) return str;
    return str.substring(0, len) + '…';
  };

  // Safely read values that may be quoted in payload
  c.val = function(obj, key) {
    if (!obj) return '';
    if (obj[key] !== undefined && obj[key] !== null) return obj[key];
    if (obj[" '" + key + "'"] !== undefined && obj[" '" + key + "'"] !== null) return obj[" '" + key + "'"];
    if (obj["'" + key + "'"] !== undefined && obj["'" + key + "'"] !== null) return obj["'" + key + "'"];
    return '';
  };

  c.isActive = function(val) {
    var v = (val || '').toString().toLowerCase();
    return v === 'true' || v === '1' || v === 'yes';
  };

  c.sortData = function(arr) {
    var dir = c.sort.dir === 'desc' ? -1 : 1;
    var field = c.sort.field;
    return arr.slice().sort(function(a, b) {
      var av = '', bv = '';
      if (field === 'name') {
        av = c.val(a.values, 'name') || a.sys_id || '';
        bv = c.val(b.values, 'name') || b.sys_id || '';
      } else if (field === 'table') {
        av = a.table || '';
        bv = b.table || '';
      } else if (field === 'active') {
        av = c.isActive(c.val(a.values, 'active')) ? 1 : 0;
        bv = c.isActive(c.val(b.values, 'active')) ? 1 : 0;
      } else if (field === 'created_by') {
        av = c.val(a.values, 'sys_created_by') || '';
        bv = c.val(b.values, 'sys_created_by') || '';
      } else if (field === 'updated_by') {
        av = c.val(a.values, 'sys_updated_by') || '';
        bv = c.val(b.values, 'sys_updated_by') || '';
      } else if (field === 'issues') {
        av = (a.issues || []).length;
        bv = (b.issues || []).length;
      }
      if (av < bv) return -1 * dir;
      if (av > bv) return 1 * dir;
      return 0;
    });
  };

  c.filteredData = function(cat) {
    var sev = c.filters.severity;
    var search = (c.filters.search || '').toLowerCase();
    var typeFilter = c.filters.type;
    var filtered = c.getData().filter(function(item) {
      var matchesCat = (item.category) === cat;
      if (!matchesCat) return false;
      if (typeFilter !== 'all') {
        if (c.getTypeLabel(item) !== typeFilter) return false;
      }
      if (sev !== 'all') {
        var hasSev = (item.issues || []).some(function(issue) {
          return (issue.severity || '').toLowerCase() === sev;
        });
        if (!hasSev) return false;
      }
      if (search) {
        var hay = [
          item.category,
          item.table,
          c.val(item.values, 'name'),
          c.val(item.values, 'sys_created_by'),
          c.val(item.values, 'sys_updated_by')
        ].join(' ').toLowerCase();
        var issueText = (item.issues || []).map(function(i){ return (i.code || '') + ' ' + (i.message || ''); }).join(' ').toLowerCase();
        if (hay.indexOf(search) === -1 && issueText.indexOf(search) === -1) return false;
      }
      return true;
    });
    return c.sortData(filtered);
  };

  c.exportJSON = function() {
    if (!c.result) return;
    var blob = new Blob([JSON.stringify(c.result, null, 2)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (c.result.number || 'analysis') + '.json';
    a.click();
    URL.revokeObjectURL(url);
  };

  c.exportPDF = function() {
    $window.print();
  };

  c.init = function() {
    if (c.result) {
      c.buildMetadataMaps();
      c.buildCategories();
      c.loading = false;
      return;
    }

    if (!c.analysisId) {
      c.error = '${Missing analysis identifier}';
      c.loading = false;
      return;
    }

    c.loading = true;
    c.server.get({ action: 'get_result', analysisId: c.analysisId }).then(function(resp) {
      if (resp.data && resp.data.success && resp.data.analysisResult) {
        c.result = resp.data.analysisResult;
        c.error = null;
        c.buildMetadataMaps();
        c.buildCategories();
      } else {
        c.error = (resp.data && resp.data.error) ? resp.data.error : '${Result not found}';
      }
      c.loading = false;
    }, function() {
      c.error = '${Server communication error}';
      c.loading = false;
    });
  };

  c.init();
}]]></client_script>
        <controller_as>c</controller_as>
        <css>/* CSS centralisé dans le thème FHA */
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_analysis_detail</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>FHA Analysis detail</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    data.analysisId = $sp.getParameter('sys_id') || (input && input.analysisId) || '';
    data.result = null;
    data.error = null;
    data.success = false;

    function loadResult(resultId) {
        if (!resultId) {
            return { success: false, error: gs.getMessage('Missing result identifier') };
        }

        var gr = new GlideRecord('x_1310794_founda_0_results');
        if (!gr.get(resultId)) {
            return { success: false, error: gs.getMessage('Result not found') };
        }

        var parsed;
        try {
            parsed = JSON.parse(gr.getValue('details') || '{}');
        } catch (err) {
            return { success: false, error: gs.getMessage('Unable to parse analysis details') };
        }

        parsed.number = gr.getValue('number');
        parsed.state = gr.getValue('state');
        parsed.health_score =gr.getValue('health_score') || '';
        parsed.sys_id = gr.getUniqueValue();
        parsed.created_on = gr.getDisplayValue('sys_created_on');
        parsed.created_by = gr.getDisplayValue('sys_created_by');

        return { success: true, result: parsed };
    }

    var initial = loadResult(data.analysisId);
    if (initial.success) {
        data.result = initial.result;
        data.success = true;
    } else if (data.analysisId) {
        data.error = initial.error;
    }

    if (input && input.action === 'get_result') {
        var res = loadResult(input.analysisId || data.analysisId);
        data.success = res.success;
        if (res.success) {
            data.analysisResult = res.result;
            data.error = '';
        } else {
            data.error = res.error;
        }
    }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-03 22:38:44</sys_created_on>
        <sys_id>3ee88bd48312f21083e1b4a6feaad39a</sys_id>
        <sys_mod_count>63</sys_mod_count>
        <sys_name>FHA Analysis detail</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_3ee88bd48312f21083e1b4a6feaad39a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-13 06:33:22</sys_updated_on>
        <template><![CDATA[<div class="fha-detail">
  <div class="fha-header">
    <div style="display:flex;flex-direction:column;gap:6px;">
      <h1>${Analysis Results}</h1>
      <div style="font-size:13px;opacity:0.9;" ng-if="c.result">
        {{c.result.name || '${Configuration}'}} — <strong>{{c.getConfigInfo().table_label || c.getConfigInfo().table_name || 'N/A'}}</strong>
        <span style="opacity:0.8;">({{c.getConfigInfo().table_name || 'N/A'}})</span>
      </div>
      <div class="fha-meta" ng-if="c.result">
        <span class="fha-badge">{{c.result.number || c.analysisId}}</span>
        <span class="fha-badge" ng-if="c.result.state">{{c.result.state}}</span>
        <span class="fha-badge" ng-if="c.result.created_on">{{c.result.created_on}}</span>
        <span class="fha-badge" ng-if="c.result.created_by">{{c.result.created_by}}</span>
      </div>
    </div>
  </div>

  <div class="fha-alert fha-alert-danger" ng-if="c.error">
    {{c.error}}
  </div>

  <div class="fha-alert fha-alert-info" ng-if="c.loading">
    ${Loading analysis results...}
  </div>

  <div ng-if="!c.loading && c.result">

    <div class="fha-stats">
      <div class="fha-stat-card">
        <div class="fha-stat-value">{{c.countItems()}}</div>
        <div class="fha-stat-label">Records scanned</div>
      </div>
      <div class="fha-stat-card">
        <div class="fha-stat-value danger">{{c.countIssuesBySeverity('high')}}</div>
        <div class="fha-stat-label">High issues</div>
      </div>
      <div class="fha-stat-card">
        <div class="fha-stat-value warning">{{c.countIssuesBySeverity('medium')}}</div>
        <div class="fha-stat-label">Medium issues</div>
      </div>
      <div class="fha-stat-card">
        <div class="fha-stat-value info">{{c.countIssuesBySeverity('low')}}</div>
        <div class="fha-stat-label">Low issues</div>
      </div>
    </div>

    <div class="fha-actions">
      <button class="fha-btn" ng-click="c.exportPDF()"><i class="fa fa-file-pdf-o"></i> ${Export PDF}</button>
      <button class="fha-btn" ng-click="c.exportJSON()"><i class="fa fa-download"></i> ${Export JSON}</button>
    </div>

    <div class="fha-tabs">
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('overview')}" ng-click="c.setTab('overview')">Overview</button>
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('issues')}" ng-click="c.setTab('issues')">
        Issues <span class="fha-badge">{{c.getIssues().length}}</span>
      </button>
      <button class="fha-tab-btn" ng-repeat="cat in c.categoryTabs" ng-class="{'active': c.isTab(cat)}" ng-click="c.setTab(cat)">
        {{cat | uppercase}} <span class="fha-badge">{{c.filteredData(cat).length}}</span>
      </button>
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('json')}" ng-click="c.setTab('json')">JSON</button>
    </div>

    <div ng-show="c.isTab('overview')">
        <div class="fha-card">
        <div class="fha-card__head"><h3>Result</h3></div>
          <div class="fha-card__body">
            <table class="fha-data-table">
              <tbody>
              <tr><td><strong>Number</strong></td><td>{{c.getResultMeta().number || 'N/A'}}</td></tr>
              <tr><td><strong>State</strong></td><td>{{c.getResultMeta().state || 'N/A'}}</td></tr>
              <tr><td><strong>Created on</strong></td><td>{{c.getResultMeta().created_on || 'N/A'}}</td></tr>
              <tr><td><strong>Created by</strong></td><td>{{c.getResultMeta().created_by || 'N/A'}}</td></tr>
              </tbody>
            </table>
    </div>
   </div>

      <div class="fha-card">
        <div class="fha-card__head"><h3>Configuration</h3></div>
        <div class="fha-card__body">
          <table class="fha-data-table">
            <tbody>
              <tr><td><strong>Table label</strong></td><td>{{c.getConfigInfo().table_label || 'N/A'}}</td></tr>
              <tr><td><strong>Table name</strong></td><td>{{c.getConfigInfo().table_name || 'N/A'}}</td></tr>
              <tr><td><strong>Description</strong></td><td>{{c.getConfigInfo().description || 'N/A'}}</td></tr>
              <tr><td><strong>Include children</strong></td><td>{{c.booleanText(c.getConfigInfo().include_children_tables)}}</td></tr>
              <tr><td><strong>Deep scan</strong></td><td>{{c.booleanText(c.getConfigInfo().deep_scan)}}</td></tr>
              <tr><td><strong>Ignore ServiceNow records</strong></td><td>{{c.booleanText(c.getConfigInfo().ignore_servicenow_records)}}</td></tr>
              <tr><td><strong>Include LDAP</strong></td><td>{{c.booleanText(c.getConfigInfo().include_ldap)}}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div ng-show="c.categoryTabs.indexOf(c.activeTab) !== -1">
      <div class="fha-card">
        <div class="fha-card__head">
          <div class="fha-filter-bar">
            <label>Severity:</label>
            <select ng-model="c.filters.severity">
              <option value="all">All</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <label>Search:</label>
            <input type="text" ng-model="c.filters.search" placeholder="Name, user, issue...">
            <label>Type:</label>
            <select ng-model="c.filters.type">
              <option ng-repeat="t in c.typeOptions" value="{{t}}">{{t | uppercase}}</option>
            </select>
            <label>Sort:</label>
            <select ng-model="c.sort.field">
              <option value="name">Name</option>
              <option value="table">Table</option>
              <option value="active">Active</option>
              <option value="created_by">Created by</option>
              <option value="updated_by">Updated by</option>
              <option value="issues">Issues count</option>
            </select>
            <button class="fha-tab-btn" style="border:none;" ng-click="c.sort.dir = (c.sort.dir === 'asc' ? 'desc' : 'asc')">
              <i class="fa" ng-class="{'fa-sort-amount-asc': c.sort.dir==='asc','fa-sort-amount-desc': c.sort.dir==='desc'}"></i>
            </button>
            <button class="fha-tab-btn" style="border:none;" ng-click="c.filters = { severity: 'all', search: '', type: 'all' }; c.sort = { field: 'name', dir: 'asc' }">
              <i class="fa fa-refresh"></i> Reset
            </button>
          </div>
        </div>
        <div class="fha-card__body" ng-if="c.filteredData(c.activeTab).length">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th style="width:120px;">Type</th>
                <th>Name</th>
                <th style="width:140px;">Table</th>
                <th style="width:90px;">Active</th>
                <th style="width:120px;">Created by</th>
                <th style="width:120px;">Updated by</th>
                <th style="width:120px;">Issues</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="item in c.filteredData(c.activeTab)">
                <td>
                  <span class="fha-pill fha-pill-cat" ng-style="{'background': (c.getMeta(item).color || 'var(--fha-gray-500)')}">
                    <i class="fa" ng-class="c.getMeta(item).icon || 'fa-tag'"></i>
                    {{c.getTypeLabel(item)}}
                  </span>
                </td>
                <td>
                  <i class="fa" ng-class="c.getMeta(item).icon || 'fa-file-text-o'" ng-style="{'color': c.getMeta(item).color || 'var(--fha-gray-800)', 'margin-right':'6px'}"></i>
                  {{c.val(item.values, 'name') || item.sys_id}}
                </td>
                <td>{{item.table}}</td>
                <td>
                  <span class="fha-pill fha-pill-blue" ng-if="c.isActive(c.val(item.values, 'active'))">Active</span>
                  <span class="fha-pill fha-pill-gray" ng-if="!c.isActive(c.val(item.values, 'active'))">Inactive</span>
                </td>
                <td>{{c.val(item.values, 'sys_created_by') || '-'}}</td>
                <td>{{c.val(item.values, 'sys_updated_by') || '-'}}</td>
                <td>
                  <div ng-if="item.issues && item.issues.length">
                    <div ng-repeat="issue in item.issues">
                      <span class="fha-issue-badge" ng-class="{'fha-sev-high': issue.severity=='high','fha-sev-medium': issue.severity=='medium','fha-sev-low': issue.severity=='low'}">
                        {{issue.severity | uppercase}}
                      </span>
                      <span style="margin-left:6px;">{{issue.code}} - {{issue.message}}</span>
        </div>
      </div>
                  <span ng-if="!item.issues || !item.issues.length">-</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="fha-card__body" ng-if="!c.filteredData(c.activeTab).length"><span class="fha-pill fha-pill-gray">No data</span></div>
      </div>
    </div>

    <div ng-show="c.isTab('issues')">
      <div class="fha-card">
        <div class="fha-card__head">
          <h3>Issues</h3>
          <div class="fha-filter-bar">
            <label>Severity:</label>
            <select ng-model="c.filters.severity">
              <option value="all">All</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <label>Category:</label>
            <select ng-model="c.filters.issueCategory">
              <option ng-repeat="cat in c.issueCategories" value="{{cat}}">{{cat | uppercase}}</option>
            </select>
            <label>Search:</label>
            <input type="text" ng-model="c.filters.search" placeholder="Code, message, table, record...">
            <button class="fha-tab-btn" style="border:none;" ng-click="c.filters = { severity: 'all', search: '', type: c.filters.type, issueCategory: 'all' }">
              <i class="fa fa-refresh"></i> Reset
            </button>
          </div>
        </div>
        <div class="fha-card__body" ng-if="c.filteredIssues().length">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th style="width:110px;">Severity</th>
                <th style="width:140px;">Category</th>
                <th style="width:140px;">Code</th>
                <th>Message</th>
                <th style="width:140px;">Table</th>
                <th style="width:180px;">Record</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="issue in c.filteredIssues()">
                <td><span class="fha-issue-badge" ng-class="{'fha-sev-high': issue.severity=='high','fha-sev-medium': issue.severity=='medium','fha-sev-low': issue.severity=='low'}">{{issue.severity | uppercase}}</span></td>
                <td>{{issue.category || 'general'}}</td>
                <td>{{issue.code}}</td>
                <td>{{issue.message}}</td>
                <td>{{issue.record_table}}</td>
                <td>
                  <a class="fha-link" ng-if="issue.record_sys_id && issue.record_table" ng-click="c.openRecord(issue.record_table, issue.record_sys_id)">{{issue.record_name || issue.record_sys_id}}</a>
                  <span ng-if="!issue.record_sys_id">{{issue.record_name || '-'}}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="fha-card__body" ng-if="!c.filteredIssues().length"><span class="fha-pill fha-pill-gray">No issues</span></div>
      </div>
    </div>

    <div ng-show="c.isTab('json')">
      <div class="fha-card">
        <div class="fha-card__head"><h3>JSON</h3></div>
        <div class="fha-card__body">
          <pre style="white-space:pre-wrap; word-break:break-word;">{{c.result | json:2}}</pre>
        </div>
      </div>
    </div>

  </div>
</div>]]></template>
    </sp_widget>
</record_update>
