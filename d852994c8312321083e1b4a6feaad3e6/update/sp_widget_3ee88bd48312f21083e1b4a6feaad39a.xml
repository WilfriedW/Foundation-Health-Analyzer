<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $location) {
  var c = this;
    
  c.analysisId = $location.search().sys_id || c.data.analysis_id || '';
    c.result = c.data.result || null;
  c.error = c.data.error || null;
  c.number = c.data.number || '';
  c.state = c.data.state || '';
  c.loading = false;
  c.activeTab = 'summary';
  c.issueFilters = { severity: 'all', search: '' };
  c.categoryFilters = {};

  c.setTab = function(tab) { c.activeTab = tab; };
  c.isTab = function(tab) { return c.activeTab === tab; };

  c.getScore = function() {
    if (!c.result) return '--';
    return c.result.health_score || c.result.score || '--';
  };

  c.totalRecords = function() {
    return c.result && Array.isArray(c.result.data) ? c.result.data.length : 0;
  };

  c.totalErrors = function() {
    return c.result && Array.isArray(c.result.errors) ? c.result.errors.length : 0;
  };

  c.totalIssues = function() {
    var issues = c.getIssues();
    return issues.length;
  };

  c.hasErrors = function() { return c.totalErrors() > 0; };
  c.hasData = function() { return c.result && Array.isArray(c.result.data) && c.result.data.length > 0; };

  c.getIssues = function() {
    return (c.result && Array.isArray(c.result.issues)) ? c.result.issues : [];
  };

  c.filteredIssues = function() {
    var list = c.getIssues();
    return list.filter(function(it) {
      if (c.issueFilters.severity !== 'all' && it.severity !== c.issueFilters.severity) return false;
      if (c.issueFilters.search) {
        var t = c.issueFilters.search.toLowerCase();
        var s = (it.message || '') + ' ' + (it.code || '') + ' ' + (it.category || '');
        if (s.toLowerCase().indexOf(t) === -1) return false;
      }
      return true;
      });
  };

  c.getCategories = function() {
    if (!c.result || !c.result.categories) return [];
    return Object.keys(c.result.categories);
  };

  c.getCategoryItems = function(catId) {
    if (!c.result || !c.result.categories || !c.result.categories[catId]) return [];
    var cat = c.result.categories[catId];
    if (!cat.items) return [];
    var out = [];
    cat.items.forEach(function(it) {
      var records = it.records || [];
      records.forEach(function(rec) {
        out.push({
          item_type: it.type,
          item_label: it.label || it.itemLabel,
          item_icon: it.icon || it.itemIcon,
          item_color: it.color || it.itemColor,
          count: it.count || records.length,
          active_count: it.active_count || 0,
          inactive_count: it.inactive_count || 0,
          category: catId,
          record: rec
        });
      });
    });
    return out;
  };

  c.getCategoryFilter = function(catId) {
    c.categoryFilters[catId] = c.categoryFilters[catId] || { search: '' };
    return c.categoryFilters[catId];
  };

  c.filteredCategoryItems = function(catId) {
    var items = c.getCategoryItems(catId);
    var filter = c.getCategoryFilter(catId);
    if (!filter.search) return items;
    var t = filter.search.toLowerCase();
    return items.filter(function(it) {
      var rec = it.record || {};
      var hay = (it.item_label || '') + ' ' + (rec.name || '') + ' ' + (rec.label || '') + ' ' + (rec.description || '');
      return hay.toLowerCase().indexOf(t) !== -1;
    });
  };

  c.recordKeys = function(rec) {
    if (!rec || !rec.values) return [];
    return Object.keys(rec.values);
  };

  c.getConfig = function() {
    return (c.result && c.result.config) || {};
  };

  c.getOptions = function() {
    var cfg = c.getConfig();
    return cfg.options || cfg || {};
  };
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.fha-detail {
  max-width: 1100px;
  margin: 0 auto;
  padding: 20px;
}

.fha-header {
  background: #0b5cab;
  color: #fff;
  padding: 18px;
  border-radius: 10px;
  margin-bottom: 16px;
}

.fha-header h1 {
  margin: 0;
  font-size: 20px;
}

.fha-meta {
  margin-top: 8px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  font-size: 13px;
  opacity: 0.9;
}

.fha-card {
  background: #fff;
  border: 1px solid #dfe3e6;
  border-radius: 10px;
  margin-bottom: 14px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.fha-card h3 {
  margin: 0;
  font-size: 16px;
}

.fha-card__head {
  padding: 12px 16px;
  border-bottom: 1px solid #dfe3e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.fha-card__body {
  padding: 14px 16px;
}

.fha-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

.fha-tab-btn {
  border: 1px solid #d0d6dc;
  background: #f5f7f9;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  color: #1f2933;
}

.fha-tab-btn.active {
  border-color: #0b5cab;
  color: #0b5cab;
  background: #e8f1fb;
}

.fha-data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.fha-data-table th,
.fha-data-table td {
  padding: 8px 10px;
  border-bottom: 1px solid #eef1f3;
  text-align: left;
}

.fha-data-table th {
  background: #f5f7f9;
  font-weight: 600;
}

.fha-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  background: #eef1f3;
}

.pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  background: #eef1f3;
  font-weight: 600;
}

.pill.red { background: #fde8e8; color: #c81e1e; }
.pill.amber { background: #fff4e5; color: #b45309; }
.pill.blue { background: #e0f2fe; color: #075985; }
.pill.gray { background: #f3f4f6; color: #4b5563; }

.issue-badge {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  display: inline-block;
}
.sev-high { background: #fde8e8; color: #b91c1c; }
.sev-medium { background: #fff4e5; color: #b45309; }
.sev-low { background: #e0f2fe; color: #075985; }

.section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  margin: 0 0 6px 0;
}

.filter-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.filter-bar input,
.filter-bar select {
  padding: 6px 10px;
  border: 1px solid #d0d6dc;
  border-radius: 6px;
  font-size: 13px;
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_analysis_detail</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>FHA Analysis detail</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    data.analysis_id = $sp.getParameter('sys_id') || '';
    data.result = null;
    data.error = null;
    data.number = '';
    data.state = '';

    function parseJSON(val) {
        if (!val) return null;
        try {
            return JSON.parse(val);
        } catch (e) {
            data.error = 'Impossible de parser le JSON du resultat: ' + e.message;
            return null;
        }
    }

    if (!data.analysis_id) {
        data.error = 'Aucun sys_id de resultat trouve dans l URL.';
        return;
    }

                var gr = new GlideRecord('x_1310794_founda_0_results');
    if (gr.get(data.analysis_id)) {
        data.number = gr.getValue('number') || '';
        data.state = gr.getValue('state') || '';
        data.result = parseJSON(gr.getValue('details'));
        if (!data.result && !data.error) {
            data.error = 'Aucun detail JSON trouve pour ce resultat.';
        }
    } else {
        data.error = 'Resultat introuvable pour le sys_id fourni.';
    }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-03 22:38:44</sys_created_on>
        <sys_id>3ee88bd48312f21083e1b4a6feaad39a</sys_id>
        <sys_mod_count>40</sys_mod_count>
        <sys_name>FHA Analysis detail</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_3ee88bd48312f21083e1b4a6feaad39a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-05 00:34:36</sys_updated_on>
        <template><![CDATA[<div class="fha-detail">
  <div class="fha-header">
    <h1>${Analysis detail}</h1>
    <div class="fha-meta">
      <span class="fha-badge">sys_id : {{c.analysisId}}</span>
      <span class="fha-badge" ng-if="c.number">${Number}: {{c.number}}</span>
      <span class="fha-badge" ng-if="c.state">${State}: {{c.state}}</span>
    </div>
  </div>

  <div class="alert alert-danger" ng-if="c.error">
    {{c.error}}
  </div>

  <div class="alert alert-info" ng-if="!c.error && !c.result">
    Aucun resultat charge. Verifie le parametre sys_id.
  </div>

  <div ng-if="c.result">
    <div class="fha-tabs">
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('summary')}" ng-click="c.setTab('summary')">${Summary}</button>
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('details')}" ng-click="c.setTab('details')">${Details}</button>
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('metadata')}" ng-click="c.setTab('metadata')" ng-if="c.result.metadata">${Metadata}</button>
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('issues')}" ng-click="c.setTab('issues')" ng-if="c.getIssues().length">${Issues} ({{c.totalIssues()}})</button>
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('data')}" ng-click="c.setTab('data')" ng-if="c.hasData()">${Data} ({{c.totalRecords()}})</button>
      <button class="fha-tab-btn" ng-repeat="cat in c.getCategories()" ng-class="{'active': c.isTab('cat_' + cat)}" ng-click="c.setTab('cat_' + cat)">
        {{cat | uppercase}}
      </button>
  </div>

    <div class="fha-card" ng-show="c.isTab('summary')">
      <div class="fha-card__head">
        <h3>${Summary}</h3>
      </div>
      <div class="fha-card__body" style="display:flex;gap:12px;flex-wrap:wrap;">
        <span class="pill blue">${Score}: {{c.getScore()}}</span>
        <span class="pill gray">${Records}: {{c.totalRecords()}}</span>
        <span class="pill amber" ng-if="c.totalErrors() > 0">${Errors}: {{c.totalErrors()}}</span>
        <span class="pill red" ng-if="c.totalIssues() > 0">${Issues}: {{c.totalIssues()}}</span>
        </div>
      </div>
      
    <div class="fha-card" ng-show="c.isTab('details')">
      <div class="fha-card__head">
        <h3>${Details}</h3>
      </div>
      <div class="fha-card__body">
        <div class="section-title">${Analysis}</div>
        <div class="filter-bar" style="margin-bottom:8px;">
          <span class="pill gray">${Table}: {{c.result.table_label || c.result.table_name || 'N/A'}}</span>
          <span class="pill gray" ng-if="c.result.duration_ms">${Duration}: {{c.result.duration_ms}} ms</span>
          <span class="pill gray" ng-if="c.result.created_on">${Created}: {{c.result.created_on}}</span>
          <span class="pill gray" ng-if="c.result.created_by">${By}: {{c.result.created_by}}</span>
        </div>
        <div class="section-title" style="margin-top:12px;">${Configuration}</div>
        <table class="fha-data-table">
          <tbody>
            <tr ng-repeat="(key,val) in c.getConfig()">
              <td style="width:200px;"><strong>{{key}}</strong></td>
              <td>{{val}}</td>
            </tr>
          </tbody>
        </table>
        <div class="section-title" style="margin-top:12px;">${Options}</div>
        <table class="fha-data-table">
          <tbody>
            <tr ng-repeat="(key,val) in c.getOptions()">
              <td style="width:200px;"><strong>{{key}}</strong></td>
              <td>{{val}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="fha-card" ng-if="c.result.metadata" ng-show="c.isTab('metadata')">
      <div class="fha-card__head">
        <h3>${Metadata}</h3>
      </div>
      <div class="fha-card__body">
        <table class="fha-data-table">
          <thead>
            <tr>
              <th>${Key}</th>
              <th>${Value}</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="(key,val) in c.result.metadata">
              <td>{{key}}</td>
              <td>{{val}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="fha-card" ng-if="c.getIssues().length" ng-show="c.isTab('issues')">
      <div class="fha-card__head">
        <h3>${Issues}</h3>
        <span class="fha-badge">{{c.totalIssues()}}</span>
      </div>
      <div class="fha-card__body">
        <div class="filter-bar">
          <label>${Severity}:</label>
          <select ng-model="c.issueFilters.severity">
            <option value="all">${All}</option>
            <option value="high">${High}</option>
            <option value="medium">${Medium}</option>
            <option value="low">${Low}</option>
          </select>
          <label>${Search}:</label>
          <input type="text" ng-model="c.issueFilters.search" placeholder="${Filter issues}" />
        </div>
        <table class="fha-data-table">
          <thead>
            <tr>
              <th style="width:120px;">${Severity}</th>
              <th style="width:160px;">${Category}</th>
              <th style="width:140px;">${Code}</th>
              <th>${Message}</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="issue in c.filteredIssues()">
              <td><span class="issue-badge" ng-class="{'sev-high': issue.severity=='high','sev-medium': issue.severity=='medium','sev-low': issue.severity=='low'}">{{issue.severity | uppercase}}</span></td>
              <td>{{issue.category || 'general'}}</td>
              <td>{{issue.code}}</td>
              <td>{{issue.message}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="fha-card" ng-if="c.hasData()" ng-show="c.isTab('data')">
      <div class="fha-card__head">
        <h3>${Data}</h3>
        <span class="fha-badge">{{c.result.data.length}}</span>
      </div>
      <div class="fha-card__body">
        <div ng-repeat="rec in c.result.data track by rec.sys_id || $index" style="margin-bottom:16px;">
          <h4 style="margin:0 0 6px 0;">{{rec.table || 'N/A'}} - {{rec.sys_id || 'N/A'}}</h4>
          <table class="fha-data-table" ng-if="c.recordKeys(rec).length">
            <thead>
              <tr>
                <th>${Field}</th>
                <th>${Value}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="field in c.recordKeys(rec) track by field">
                <td>{{field}}</td>
                <td>{{rec.values[field]}}</td>
              </tr>
            </tbody>
          </table>
          <div ng-if="rec.issues && rec.issues.length">
            <strong>${Issues}:</strong>
            <ul>
              <li ng-repeat="issue in rec.issues track by $index">
                {{issue.code || 'ISSUE'}} - {{issue.message || issue}}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="fha-card" ng-repeat="cat in c.getCategories()" ng-show="c.isTab('cat_' + cat)">
      <div class="fha-card__head">
        <h3>{{cat | uppercase}}</h3>
        <span class="fha-badge">{{c.getCategoryItems(cat).length}}</span>
      </div>
      <div class="fha-card__body">
        <div class="filter-bar">
          <label>${Search}:</label>
          <input type="text" ng-model="c.getCategoryFilter(cat).search" placeholder="${Filter items}" />
        </div>
        <table class="fha-data-table" ng-if="c.getCategoryItems(cat).length">
          <thead>
            <tr>
              <th style="width:160px;">${Type}</th>
              <th>${Name}</th>
              <th style="width:120px;">${Status}</th>
              <th style="width:120px;">${Counts}</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="item in c.filteredCategoryItems(cat)">
              <td>{{item.item_label || item.item_type}}</td>
              <td>{{item.record.name || item.record.label || item.record.description || 'N/A'}}</td>
              <td>
                <span class="pill gray" ng-if="item.record.active === false">${Inactive}</span>
                <span class="pill blue" ng-if="item.record.active !== false">${Active}</span>
              </td>
              <td>
                <span ng-if="item.count">{{item.count}} ${records}</span>
              </td>
            </tr>
          </tbody>
        </table>
        <div ng-if="!c.getCategoryItems(cat).length">${No data}</div>
      </div>
    </div>
        </div>
</div>]]></template>
    </sp_widget>
</record_update>
