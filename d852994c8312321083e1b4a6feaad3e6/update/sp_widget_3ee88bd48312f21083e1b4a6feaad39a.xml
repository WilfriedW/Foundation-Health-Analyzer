<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[(function() {
  api.controller = function($scope, spModal) {
    var c = this;
    
    // Init
    c.activeTab = 'overview';
    c.result = null;
    c.categoryTabs = [];
    c.filters = { search: '', severity: 'all', type: 'all', issueCategory: 'all' };
    c.issueCategories = ['all'];
    c.sort = { field: 'name', dir: 'asc' };
    
    // Tab management
    c.isTab = function(tab) { return c.activeTab === tab; };
    c.setTab = function(tab) { c.activeTab = tab; };
    
    // Data accessors
    c.getConfigInfo = function() {
      return c.result && c.result.configuration ? c.result.configuration : {};
    };
    
    c.getResultMeta = function() {
      if (!c.result) return {};
      return {
        number: c.result.number,
        state: c.result.state,
        created_on: c.result.sys_created_on,
        created_by: c.result.sys_created_by
      };
    };
    
    c.countItems = function() {
      if (!c.result || !c.result.data) return 0;
      return Object.keys(c.result.data).reduce(function(sum, cat) {
        return sum + (c.result.data[cat] ? c.result.data[cat].length : 0);
      }, 0);
    };
    
    c.countIssuesBySeverity = function(severity) {
      if (!c.result || !c.result.issues) return 0;
      return c.result.issues.filter(function(i) { 
        return i.severity && i.severity.toLowerCase() === severity.toLowerCase(); 
      }).length;
    };
    
    c.getIssues = function() {
      return c.result && c.result.issues ? c.result.issues : [];
    };
    
    // Category data filtering
    c.filteredData = function(category) {
      if (!c.result || !c.result.data || !c.result.data[category]) return [];
      var items = c.result.data[category];
      
      // Apply filters
      if (c.filters.severity !== 'all') {
        items = items.filter(function(item) {
          if (!item.issues) return false;
          return item.issues.some(function(issue) {
            return issue.severity && issue.severity.toLowerCase() === c.filters.severity;
          });
        });
      }
      
      if (c.filters.type !== 'all') {
        items = items.filter(function(item) {
          return item.type === c.filters.type;
        });
      }
      
      if (c.filters.search) {
        var search = c.filters.search.toLowerCase();
        items = items.filter(function(item) {
          var name = c.val(item.values, 'name') || '';
          var user = c.val(item.values, 'sys_created_by') || '';
          return name.toLowerCase().indexOf(search) !== -1 || 
                 user.toLowerCase().indexOf(search) !== -1;
        });
      }
      
      // Apply sorting
      items = items.slice().sort(function(a, b) {
        var aVal, bVal;
        if (c.sort.field === 'name') {
          aVal = c.val(a.values, 'name') || '';
          bVal = c.val(b.values, 'name') || '';
        } else if (c.sort.field === 'type') {
          aVal = a.type || '';
          bVal = b.type || '';
        } else if (c.sort.field === 'table') {
          aVal = a.table || '';
          bVal = b.table || '';
        } else if (c.sort.field === 'active') {
          aVal = c.val(a.values, 'active') ? 1 : 0;
          bVal = c.val(b.values, 'active') ? 1 : 0;
        } else if (c.sort.field === 'created_by') {
          aVal = c.val(a.values, 'sys_created_by') || '';
          bVal = c.val(b.values, 'sys_created_by') || '';
        } else if (c.sort.field === 'updated_by') {
          aVal = c.val(a.values, 'sys_updated_by') || '';
          bVal = c.val(b.values, 'sys_updated_by') || '';
        }
        
        if (c.sort.dir === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });
      
      return items;
    };
    
    c.filteredIssues = function() {
      var issues = c.getIssues();
      
      if (c.filters.severity !== 'all') {
        issues = issues.filter(function(i) {
          return i.severity && i.severity.toLowerCase() === c.filters.severity;
        });
      }
      
      if (c.filters.issueCategory !== 'all') {
        issues = issues.filter(function(i) {
          return (i.category || 'general') === c.filters.issueCategory;
        });
      }
      
      if (c.filters.search) {
        var search = c.filters.search.toLowerCase();
        issues = issues.filter(function(i) {
          return (i.code || '').toLowerCase().indexOf(search) !== -1 ||
                 (i.message || '').toLowerCase().indexOf(search) !== -1 ||
                 (i.record_table || '').toLowerCase().indexOf(search) !== -1;
        });
      }
      
      return issues;
    };
    
    // Sorting
    c.sortBy = function(field) {
      if (c.sort.field === field) {
        c.sort.dir = c.sort.dir === 'asc' ? 'desc' : 'asc';
      } else {
        c.sort.field = field;
        c.sort.dir = 'asc';
      }
    };
    
    c.getTypesForActiveTab = function() {
      if (!c.result || !c.result.data || !c.result.data[c.activeTab]) return [];
      var types = {};
      c.result.data[c.activeTab].forEach(function(item) {
        if (item.type) types[item.type] = true;
      });
      return Object.keys(types).sort();
    };
    
    // Item metadata
    c.getMeta = function(item) {
      var meta = {
        icon: 'fa-file-code-o',
        color: '#6c757d'
      };
      
      var type = (item.type || '').toLowerCase();
      if (type.indexOf('business_rule') !== -1) {
        meta.icon = 'fa-cogs';
        meta.color = '#3498db';
      } else if (type.indexOf('script_include') !== -1) {
        meta.icon = 'fa-code';
        meta.color = '#9b59b6';
      } else if (type.indexOf('client_script') !== -1) {
        meta.icon = 'fa-desktop';
        meta.color = '#e67e22';
      } else if (type.indexOf('ui') !== -1) {
        meta.icon = 'fa-window-maximize';
        meta.color = '#1abc9c';
      } else if (type.indexOf('acl') !== -1) {
        meta.icon = 'fa-shield-alt';
        meta.color = '#e74c3c';
      }
      
      return meta;
    };
    
    c.getTypeLabel = function(item) {
      if (!item.type) return 'Unknown';
      return item.type.replace(/_/g, ' ').toUpperCase();
    };
    
    // Utilities
    c.val = function(obj, key) {
      return obj && obj[key] !== undefined ? obj[key] : null;
    };
    
    c.isActive = function(val) {
      return val === true || val === 'true' || val === '1' || val === 1;
    };
    
    c.booleanText = function(val) {
      return c.isActive(val) ? 'Yes' : 'No';
    };
    
    c.openRecord = function(table, sysId) {
      if (!table || !sysId) return;
      window.open('/' + table + '.do?sys_id=' + sysId, '_blank');
    };
    
    // Export
    c.exportJSON = function() {
      if (!c.result) return;
      var dataStr = JSON.stringify(c.result, null, 2);
      var dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      var link = document.createElement('a');
      link.setAttribute('href', dataUri);
      link.setAttribute('download', 'fha_analysis_' + (c.result.number || 'export') + '.json');
      link.click();
    };
    
    c.exportPDF = function() {
      spModal.alert('PDF export will be implemented soon.');
    };
    
    // Analytics functions for old dashboard template
    c.getIssuesBySeverity = function(severity) {
      if (!c.result || !c.result.issues) return [];
      return c.result.issues.filter(function(i) {
        return i.severity && i.severity.toLowerCase() === severity.toLowerCase();
      });
    };
    
    c.getIssuesByTable = function() {
      if (!c.result || !c.result.issues) return {};
      var grouped = {};
      c.result.issues.forEach(function(issue) {
        var table = issue.parent_table || issue.record_table || issue.table || 'unknown';
        if (!grouped[table]) grouped[table] = [];
        grouped[table].push(issue);
      });
      return grouped;
    };
    
    c.getIssuesBySeverityForTable = function(table, severity) {
      var byTable = c.getIssuesByTable();
      if (!byTable[table]) return [];
      return byTable[table].filter(function(i) {
        return i.severity && i.severity.toLowerCase() === severity.toLowerCase();
      });
    };
    
    c.getTopTables = function(limit) {
      var byTable = c.getIssuesByTable();
      var result = [];
      for (var table in byTable) {
        result.push({ name: table, issues: byTable[table] });
      }
      result.sort(function(a, b) { return b.issues.length - a.issues.length; });
      return limit ? result.slice(0, limit) : result;
    };
    
    c.getIssuesByCategory = function() {
      if (!c.result || !c.result.issues) return {};
      var grouped = {};
      c.result.issues.forEach(function(issue) {
        var cat = issue.category || 'general';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(issue);
      });
      return grouped;
    };
    
    c.getFilteredIssues = function() {
      var issues = c.getIssues();
      if (c.filters.severity !== 'all') {
        issues = issues.filter(function(i) {
          return i.severity && i.severity.toLowerCase() === c.filters.severity;
        });
      }
      if (c.filters.table && c.filters.table !== 'all') {
        issues = issues.filter(function(i) {
          return (i.parent_table || i.record_table || i.table) === c.filters.table;
        });
      }
      if (c.filters.search) {
        var search = c.filters.search.toLowerCase();
        issues = issues.filter(function(i) {
          return (i.message || '').toLowerCase().indexOf(search) !== -1 ||
                 (i.code || '').toLowerCase().indexOf(search) !== -1;
        });
      }
      return issues;
    };
    
    c.getHealthLabel = function() {
      if (!c.result || !c.result.health_score) return 'N/A';
      var score = c.result.health_score;
      if (score >= 90) return 'Excellent';
      if (score >= 70) return 'Good';
      if (score >= 50) return 'Fair';
      return 'Poor';
    };
    
    c.getHealthDescription = function() {
      if (!c.result || !c.result.health_score) return '';
      var score = c.result.health_score;
      if (score >= 90) return 'Your system is in excellent condition with minimal issues.';
      if (score >= 70) return 'Your system is in good condition with some minor issues to address.';
      if (score >= 50) return 'Your system has several issues that should be addressed soon.';
      return 'Your system has critical issues that require immediate attention.';
    };
    
    c.getAnalysisDuration = function() {
      if (!c.result || !c.result.sys_created_on || !c.result.sys_updated_on) return 'N/A';
      var start = new Date(c.result.sys_created_on);
      var end = new Date(c.result.sys_updated_on);
      var diff = end - start;
      var seconds = Math.floor(diff / 1000);
      var minutes = Math.floor(seconds / 60);
      var hours = Math.floor(minutes / 60);
      if (hours > 0) return hours + 'h ' + (minutes % 60) + 'm';
      if (minutes > 0) return minutes + 'm ' + (seconds % 60) + 's';
      return seconds + 's';
    };
    
    c.getAvgIssuesPerTable = function() {
      var tables = Object.keys(c.getIssuesByTable());
      if (tables.length === 0) return 0;
      return (c.getIssues().length / tables.length).toFixed(1);
    };
    
    c.getMostAffectedTable = function() {
      var topTables = c.getTopTables(1);
      return topTables.length > 0 ? topTables[0].name : 'N/A';
    };
    
    c.sortTableStats = function(field) {
      c.tableStatsSort = field;
      c.tableStatsSortDir = c.tableStatsSortDir === 'asc' ? 'desc' : 'asc';
    };
    
    c.clearFilters = function() {
      c.filters = { search: '', severity: 'all', type: 'all', issueCategory: 'all', table: 'all' };
    };
    
    c.hasActiveFilters = function() {
      return c.filters.search || c.filters.severity !== 'all' || c.filters.type !== 'all' || c.filters.issueCategory !== 'all' || c.filters.table !== 'all';
    };
    
    c.toggleFilter = function(type, value) {
      // Not used in current template, kept for compatibility
      if (type === 'severity') {
        c.filters.severity = c.filters.severity === value ? 'all' : value;
      }
    };
    
    c.expandAll = function() {
      if (c.result && c.result.issues) {
        c.result.issues.forEach(function(issue) { issue.showDetails = true; });
      }
    };
    
    c.collapseAll = function() {
      if (c.result && c.result.issues) {
        c.result.issues.forEach(function(issue) { issue.showDetails = false; });
      }
    };
    
    c.viewRecord = function(issue) {
      if (!issue) return;
      var table = issue.parent_table || issue.record_table || issue.table;
      var sysId = issue.record_sys_id || issue.sys_id;
      if (table && sysId) {
        window.open('/' + table + '.do?sys_id=' + sysId, '_blank');
      }
    };
    
    // Init filters
    c.tableStatsSort = 'total';
    c.tableStatsSortDir = 'desc';
    c.filters.table = 'all';
    
    // Load data
    console.log('[FHA Widget] Loading data...');
    console.log('[FHA Widget] c.data:', c.data);
    
    if (c.data && c.data.result) {
      c.result = c.data.result;
      console.log('[FHA Widget] Result loaded:', c.result);
      console.log('[FHA Widget] Issues count:', c.result.issues ? c.result.issues.length : 0);
      console.log('[FHA Widget] Has data?', !!c.result.data);
      console.log('[FHA Widget] Has configuration?', !!c.result.configuration);
      
      // Extract category tabs
      if (c.result.data) {
        c.categoryTabs = Object.keys(c.result.data).filter(function(k) {
          return c.result.data[k] && c.result.data[k].length > 0;
        });
        console.log('[FHA Widget] Category tabs:', c.categoryTabs);
      }
      
      // Extract issue categories
      if (c.result.issues) {
        var cats = { 'all': true };
        c.result.issues.forEach(function(i) {
          cats[i.category || 'general'] = true;
        });
        c.issueCategories = Object.keys(cats);
        console.log('[FHA Widget] Issue categories:', c.issueCategories);
      }
    } else {
      console.error('[FHA Widget] No data.result available');
      console.log('[FHA Widget] c.data structure:', JSON.stringify(c.data));
    }
  };
})();
]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_analysis_detail</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Analysis detail</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  // R√©cup√©rer le sys_id depuis l'URL
  var sysId = $sp.getParameter('sys_id');
  
  console.log('=== FHA SERVER SCRIPT DEBUG ===');
  console.log('sys_id from URL:', sysId);
  
  if (!sysId) {
    console.error('ERROR: No sys_id parameter found in URL');
    data.error = 'No analysis ID provided';
    data.result = null;
    return;
  }
  
  // Requ√™te GlideRecord
  var gr = new GlideRecord('x_1310794_founda_0_results');
  
  if (gr.get(sysId)) {
    console.log('Record found:', gr.getValue('number'));
    console.log('State:', gr.getValue('state'));
    console.log('Issues field type:', typeof gr.getValue('issues'));
    console.log('Issues field raw value:', gr.getValue('issues'));
    
    // Parse result_json field (contains full analysis data)
    var resultJson = gr.getValue('result_json');
    var fullResult = null;
    
    if (resultJson) {
      try {
        fullResult = JSON.parse(resultJson);
        console.log('Parsed result_json successfully');
      } catch (e) {
        console.error('ERROR parsing result_json:', e.message);
      }
    }
    
    // Construction de l'objet result
    data.result = {
      sys_id: gr.getUniqueValue(),
      number: gr.getValue('number'),
      state: gr.getValue('state'),
      health_score: parseFloat(gr.getValue('health_score')) || 0,
      configuration_name: gr.getValue('configuration_name'),
      configuration_description: gr.getValue('configuration_description'),
      scope: gr.getValue('scope'),
      sys_created_on: gr.getValue('sys_created_on'),
      sys_updated_on: gr.getValue('sys_updated_on'),
      sys_created_by: gr.getValue('sys_created_by'),
      issues: [],
      data: {},
      configuration: {}
    };
    
    // If full result exists, use it
    if (fullResult) {
      if (fullResult.issues) data.result.issues = fullResult.issues;
      if (fullResult.data) data.result.data = fullResult.data;
      if (fullResult.configuration) data.result.configuration = fullResult.configuration;
      console.log('Loaded full result from result_json');
    } else {
      // Fallback: Parse du champ JSON issues
      var issuesJson = gr.getValue('issues');
      console.log('Issues JSON length:', issuesJson ? issuesJson.length : 0);
      
      if (issuesJson) {
        try {
          var parsedIssues = JSON.parse(issuesJson);
          console.log('Parsed issues type:', typeof parsedIssues);
          console.log('Is array?', Array.isArray(parsedIssues));
          
          if (Array.isArray(parsedIssues)) {
            data.result.issues = parsedIssues;
            console.log('SUCCESS: Loaded ' + parsedIssues.length + ' issues');
          } else if (parsedIssues && parsedIssues.issues && Array.isArray(parsedIssues.issues)) {
            // Si la structure est {issues: [...]}
            data.result.issues = parsedIssues.issues;
            console.log('SUCCESS: Loaded ' + parsedIssues.issues.length + ' issues from nested structure');
          } else {
            console.warn('WARNING: Parsed JSON is not an array');
            console.log('Parsed structure:', JSON.stringify(parsedIssues).substring(0, 200));
          }
        } catch (e) {
          console.error('ERROR parsing issues JSON:', e.message);
          console.error('JSON content preview:', issuesJson.substring(0, 500));
          data.result.issues = [];
        }
      } else {
        console.warn('WARNING: Issues field is empty');
      }
    }
    
    console.log('FINAL: data.result.issues.length =', data.result.issues.length);
    
  } else {
    console.error('ERROR: No record found with sys_id:', sysId);
    data.error = 'Analysis not found';
    data.result = null;
  }
  
  console.log('=== END SERVER SCRIPT ===');
  
})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-03 22:38:44</sys_created_on>
        <sys_id>3ee88bd48312f21083e1b4a6feaad39a</sys_id>
        <sys_mod_count>107</sys_mod_count>
        <sys_name>Analysis detail</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_3ee88bd48312f21083e1b4a6feaad39a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-30 07:59:16</sys_updated_on>
        <template><![CDATA[<div class="fha-detail">
  <!-- Header Section -->
  <div class="fha-detail-header">
    <div class="fha-detail-header-content">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <h1 style="margin: 0; color: white; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
            ]]>üè•<![CDATA[ Field Health Analysis
            <span class="fha-status-badge" ng-class="{
              'badge-completed': c.result.state == 'completed',
              'badge-in-progress': c.result.state == 'in_progress',
              'badge-pending': c.result.state == 'pending'
            }">
              {{c.result.state | uppercase}}
            </span>
          </h1>
          <p style="margin: 8px 0 0 0; color: rgba(255,255,255,0.8); font-size: 14px;">
            Analysis: <strong>{{c.result.number}}</strong> | 
            Created: <strong>{{c.result.sys_created_on | date:'short'}}</strong>
          </p>
        </div>
        <div style="display: flex; gap: 12px;">
          <button class="fha-btn-secondary" ng-click="c.exportJSON()">
            <i class="fa fa-download"></i> JSON
          </button>
          <button class="fha-btn-primary" ng-click="c.exportPDF()">
            <i class="fa fa-file-pdf-o"></i> PDF
          </button>
        </div>
      </div>
      
      <!-- Stats rapides dans le header -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-top: 24px;">
        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; border-left: 3px solid white;">
          <div style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total Issues</div>
          <div style="font-size: 24px; color: white; font-weight: 700; margin-top: 4px;">{{c.result.issues.length}}</div>
        </div>
        <div style="background: rgba(231,76,60,0.15); padding: 12px; border-radius: 8px; border-left: 3px solid #e74c3c;">
          <div style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Critical</div>
          <div style="font-size: 24px; color: #ff6b6b; font-weight: 700; margin-top: 4px;">{{c.getIssuesBySeverity('critical').length}}</div>
        </div>
        <div style="background: rgba(243,156,18,0.15); padding: 12px; border-radius: 8px; border-left: 3px solid #f39c12;">
          <div style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">High</div>
          <div style="font-size: 24px; color: #ffa726; font-weight: 700; margin-top: 4px;">{{c.getIssuesBySeverity('high').length}}</div>
        </div>
        <div style="background: rgba(245,158,11,0.15); padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b;">
          <div style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Medium</div>
          <div style="font-size: 24px; color: #ffd93d; font-weight: 700; margin-top: 4px;">{{c.getIssuesBySeverity('medium').length}}</div>
        </div>
        <div style="background: rgba(93,173,226,0.15); padding: 12px; border-radius: 8px; border-left: 3px solid #5dade2;">
          <div style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Low</div>
          <div style="font-size: 24px; color: #6bcef5; font-weight: 700; margin-top: 4px;">{{c.getIssuesBySeverity('low').length}}</div>
        </div>
        <div ng-if="c.result.health_score" style="background: rgba(39,174,96,0.15); padding: 12px; border-radius: 8px; border-left: 3px solid #27ae60;">
          <div style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Health Score</div>
          <div style="font-size: 24px; color: #27ae60; font-weight: 700; margin-top: 4px;">{{c.result.health_score}}%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       TABS NAVIGATION
       ============================================================ -->
  <div class="fha-tabs">
    <button class="fha-tab-btn" ng-class="{'active': c.activeTab == 'dashboard'}" ng-click="c.activeTab = 'dashboard'">
      <i class="fa fa-tachometer-alt"></i> Dashboard
    </button>
    <button class="fha-tab-btn" ng-class="{'active': c.activeTab == 'issues'}" ng-click="c.activeTab = 'issues'">
      <i class="fa fa-list"></i> Issues Explorer ({{c.getFilteredIssues().length}})
    </button>
    <button class="fha-tab-btn" ng-class="{'active': c.activeTab == 'analytics'}" ng-click="c.activeTab = 'analytics'">
      <i class="fa fa-chart-bar"></i> Analytics
    </button>
    <button class="fha-tab-btn" ng-class="{'active': c.activeTab == 'details'}" ng-click="c.activeTab = 'details'">
      <i class="fa fa-info-circle"></i> Details
    </button>
    <button class="fha-tab-btn" ng-class="{'active': c.activeTab == 'data'}" ng-click="c.activeTab = 'data'">
      <i class="fa fa-database"></i> Raw Data
    </button>
  </div>

  <!-- ============================================================
       TAB: DASHBOARD (Vue d'ensemble compl√®te)
       ============================================================ -->
  <div ng-if="c.activeTab == 'dashboard'">
    
    <!-- Grid 3 colonnes -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-bottom: 24px;">
      
      <!-- Card: Issues Distribution -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-chart-pie" style="color: var(--fha-primary);"></i> Issues Distribution
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 20px;">
          <div style="display: flex; flex-direction: column; gap: 12px;">
            
            <!-- Critical -->
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="flex: 0 0 80px; font-size: 12px; font-weight: 600; color: var(--fha-danger);">CRITICAL</div>
              <div style="flex: 1; height: 24px; background: var(--fha-gray-100); border-radius: 12px; overflow: hidden; position: relative;">
                <div style="height: 100%; background: linear-gradient(90deg, var(--fha-danger), var(--fha-danger-light)); border-radius: 12px; transition: width 0.6s ease;"
                     ng-style="{'width': (c.getIssuesBySeverity('critical').length / c.result.issues.length * 100) + '%'}">
                </div>
                <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 700; color: var(--fha-anthracite);">
                  {{c.getIssuesBySeverity('critical').length}}
                </span>
              </div>
              <div style="flex: 0 0 50px; text-align: right; font-size: 13px; font-weight: 700; color: var(--fha-danger);">
                {{(c.getIssuesBySeverity('critical').length / c.result.issues.length * 100) | number:0}}%
              </div>
            </div>
            
            <!-- High -->
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="flex: 0 0 80px; font-size: 12px; font-weight: 600; color: #E74C3C;">HIGH</div>
              <div style="flex: 1; height: 24px; background: var(--fha-gray-100); border-radius: 12px; overflow: hidden; position: relative;">
                <div style="height: 100%; background: linear-gradient(90deg, #E74C3C, #EC7063); border-radius: 12px; transition: width 0.6s ease;"
                     ng-style="{'width': (c.getIssuesBySeverity('high').length / c.result.issues.length * 100) + '%'}">
                </div>
                <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 700; color: var(--fha-anthracite);">
                  {{c.getIssuesBySeverity('high').length}}
                </span>
              </div>
              <div style="flex: 0 0 50px; text-align: right; font-size: 13px; font-weight: 700; color: #E74C3C;">
                {{(c.getIssuesBySeverity('high').length / c.result.issues.length * 100) | number:0}}%
              </div>
            </div>
            
            <!-- Medium -->
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="flex: 0 0 80px; font-size: 12px; font-weight: 600; color: var(--fha-warning);">MEDIUM</div>
              <div style="flex: 1; height: 24px; background: var(--fha-gray-100); border-radius: 12px; overflow: hidden; position: relative;">
                <div style="height: 100%; background: linear-gradient(90deg, var(--fha-warning), var(--fha-warning-light)); border-radius: 12px; transition: width 0.6s ease;"
                     ng-style="{'width': (c.getIssuesBySeverity('medium').length / c.result.issues.length * 100) + '%'}">
                </div>
                <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 700; color: var(--fha-anthracite);">
                  {{c.getIssuesBySeverity('medium').length}}
                </span>
              </div>
              <div style="flex: 0 0 50px; text-align: right; font-size: 13px; font-weight: 700; color: var(--fha-warning);">
                {{(c.getIssuesBySeverity('medium').length / c.result.issues.length * 100) | number:0}}%
              </div>
            </div>
            
            <!-- Low -->
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="flex: 0 0 80px; font-size: 12px; font-weight: 600; color: #2E86C1;">LOW</div>
              <div style="flex: 1; height: 24px; background: var(--fha-gray-100); border-radius: 12px; overflow: hidden; position: relative;">
                <div style="height: 100%; background: linear-gradient(90deg, #2E86C1, #5DADE2); border-radius: 12px; transition: width 0.6s ease;"
                     ng-style="{'width': (c.getIssuesBySeverity('low').length / c.result.issues.length * 100) + '%'}">
                </div>
                <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 700; color: var(--fha-anthracite);">
                  {{c.getIssuesBySeverity('low').length}}
                </span>
              </div>
              <div style="flex: 0 0 50px; text-align: right; font-size: 13px; font-weight: 700; color: #2E86C1;">
                {{(c.getIssuesBySeverity('low').length / c.result.issues.length * 100) | number:0}}%
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Card: Top 5 Affected Tables -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-table" style="color: var(--fha-primary);"></i> Top Affected Tables
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 20px;">
          <div ng-repeat="(table, issues) in c.getTopTables(5)" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--fha-bg-section); margin-bottom: 8px; border-radius: 6px; border-left: 3px solid var(--fha-primary); transition: all 0.2s ease;" 
               ng-mouseenter="$event.currentTarget.style.transform='translateX(4px)'"
               ng-mouseleave="$event.currentTarget.style.transform='translateX(0)'">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
              <i class="fa fa-database" style="color: var(--fha-primary); font-size: 16px;"></i>
              <span style="font-weight: 600; color: var(--fha-anthracite); font-size: 13px;">{{table}}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <span class="fha-badge fha-badge-primary" style="font-size: 11px;">{{issues.length}}</span>
              <!-- Mini distribution -->
              <div style="display: flex; gap: 2px;">
                <span ng-if="c.getIssuesBySeverityForTable(table, 'critical').length > 0" 
                      title="{{c.getIssuesBySeverityForTable(table, 'critical').length}} Critical"
                      style="width: 6px; height: 20px; background: var(--fha-danger); border-radius: 2px;"></span>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'high').length > 0"
                      title="{{c.getIssuesBySeverityForTable(table, 'high').length}} High"
                      style="width: 6px; height: 20px; background: #E74C3C; border-radius: 2px;"></span>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'medium').length > 0"
                      title="{{c.getIssuesBySeverityForTable(table, 'medium').length}} Medium"
                      style="width: 6px; height: 20px; background: var(--fha-warning); border-radius: 2px;"></span>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'low').length > 0"
                      title="{{c.getIssuesBySeverityForTable(table, 'low').length}} Low"
                      style="width: 6px; height: 20px; background: #5DADE2; border-radius: 2px;"></span>
              </div>
            </div>
          </div>
          <div ng-if="Object.keys(c.getIssuesByTable()).length == 0" style="text-align: center; padding: 20px; color: var(--fha-text-secondary);">
            <i class="fa fa-check-circle" style="font-size: 32px; color: var(--fha-success); margin-bottom: 8px;"></i>
            <p style="margin: 0; font-size: 13px;">No issues by table</p>
          </div>
        </div>
      </div>
      
      <!-- Card: Categories Overview -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-tags" style="color: var(--fha-primary);"></i> Categories
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 20px;">
          <div ng-repeat="(category, issues) in c.getIssuesByCategory()" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--fha-bg-section); margin-bottom: 8px; border-radius: 6px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <i class="fa fa-tag" style="color: var(--fha-primary); font-size: 14px;"></i>
              <span style="font-weight: 600; color: var(--fha-anthracite); font-size: 13px;">{{category}}</span>
            </div>
            <span class="fha-badge fha-badge-primary">{{issues.length}}</span>
          </div>
          <div ng-if="Object.keys(c.getIssuesByCategory()).length == 0" style="text-align: center; padding: 20px; color: var(--fha-text-secondary);">
            <i class="fa fa-info-circle" style="font-size: 32px; color: var(--fha-info); margin-bottom: 8px;"></i>
            <p style="margin: 0; font-size: 13px;">No categories defined</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Critical Issues (si > 0) -->
    <div ng-if="c.getIssuesBySeverity('critical').length > 0" class="fha-card" style="margin-bottom: 24px;">
      <div class="fha-card-header">
        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-danger);">
          <i class="fa fa-exclamation-triangle"></i> Critical Issues Requiring Immediate Attention
        </h3>
      </div>
      <div class="fha-card-body" style="padding: 20px;">
        <div ng-repeat="issue in c.getIssuesBySeverity('critical') | limitTo:5" 
             style="background: var(--fha-danger-bg); border: 1px solid var(--fha-danger-light); border-left: 4px solid var(--fha-danger); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
          <div style="display: flex; gap: 12px; margin-bottom: 8px; align-items: center;">
            <span class="issue-badge critical">CRITICAL</span>
            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; border: 1px solid var(--fha-danger);">{{issue.code}}</code>
          </div>
          <p style="margin: 0 0 8px 0; color: var(--fha-text-primary); font-size: 14px; font-weight: 500;">
            <i class="fa fa-exclamation-circle" style="color: var(--fha-danger); margin-right: 6px;"></i>
            {{issue.message}}
          </p>
          <div style="display: flex; gap: 16px; font-size: 12px; color: var(--fha-text-secondary);">
            <span><i class="fa fa-table"></i> {{issue.parent_table || issue.table}}</span>
            <span><i class="fa fa-hashtag"></i> {{issue.record}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Analysis Info Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
      
      <!-- Configuration Details -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-cog" style="color: var(--fha-primary);"></i> Configuration
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 20px;">
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Name:</span>
            <span class="fha-info-value">{{c.result.configuration_name || 'N/A'}}</span>
          </div>
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Description:</span>
            <span class="fha-info-value">{{c.result.configuration_description || 'No description'}}</span>
          </div>
          <div class="fha-info-row">
            <span class="fha-info-label">Scope:</span>
            <span class="fha-info-value">{{c.result.scope || 'Global'}}</span>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-clock" style="color: var(--fha-primary);"></i> Timeline
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 20px;">
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Created:</span>
            <span class="fha-info-value">{{c.result.sys_created_on | date:'medium'}}</span>
          </div>
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Updated:</span>
            <span class="fha-info-value">{{c.result.sys_updated_on | date:'medium'}}</span>
          </div>
          <div class="fha-info-row">
            <span class="fha-info-label">Duration:</span>
            <span class="fha-info-value">{{c.getAnalysisDuration()}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       TAB: ISSUES EXPLORER (Filtres dynamiques + recherche)
       ============================================================ -->
  <div ng-if="c.activeTab == 'issues'">
    
    <!-- Filtres et recherche -->
    <div class="fha-card" style="margin-bottom: 24px;">
      <div class="fha-card-body" style="padding: 24px;">
        
        <!-- Barre de recherche -->
        <div style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 300px;">
            <div style="position: relative;">
              <i class="fa fa-search" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--fha-text-secondary); font-size: 14px;"></i>
              <input type="text" 
                     ng-model="c.filters.search" 
                     placeholder="Search issues by message, code, or table..."
                     style="width: 100%; padding: 12px 16px 12px 40px; border: 2px solid var(--fha-border-color); border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                     ng-focus="$event.target.style.borderColor='var(--fha-primary)'"
                     ng-blur="$event.target.style.borderColor='var(--fha-border-color)'">
            </div>
          </div>
          <button class="fha-btn-secondary" ng-click="c.clearFilters()" ng-if="c.hasActiveFilters()">
            <i class="fa fa-times"></i> Clear Filters
          </button>
        </div>
        
        <!-- Filtres rapides -->
        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
          <span style="font-size: 12px; font-weight: 600; color: var(--fha-text-secondary); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center;">
            Quick Filters:
          </span>
          
          <!-- Severity Filters -->
          <button ng-repeat="sev in ['critical', 'high', 'medium', 'low']"
                  ng-click="c.filters.severity = sev"
                  style="padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; border: 2px solid; cursor: pointer; transition: all 0.2s ease;"
                  ng-class="{
                    'issue-badge critical': sev == 'critical',
                    'issue-badge high': sev == 'high',
                    'issue-badge medium': sev == 'medium',
                    'issue-badge low': sev == 'low'
                  }"
                  ng-style="{
                    'opacity': c.filters.severity == sev ? '1' : '0.3',
                    'transform': c.filters.severity == sev ? 'scale(1.05)' : 'scale(1)'
                  }">
            {{sev | uppercase}} ({{c.getIssuesBySeverity(sev).length}})
          </button>
        </div>
        
        <!-- Filtres avanc√©s (dropdowns) -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          
          <!-- Filter: Table -->
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--fha-text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
              <i class="fa fa-table"></i> Table
            </label>
            <select ng-model="c.filters.table" class="fha-select">
              <option value="">All Tables</option>
              <option ng-repeat="(table, issues) in c.getIssuesByTable()" value="{{table}}">
                {{table}} ({{issues.length}})
              </option>
            </select>
          </div>
          
          <!-- Filter: Category -->
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--fha-text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
              <i class="fa fa-tag"></i> Category
            </label>
            <select ng-model="c.filters.category" class="fha-select">
              <option value="">All Categories</option>
              <option ng-repeat="(category, issues) in c.getIssuesByCategory()" value="{{category}}">
                {{category}} ({{issues.length}})
              </option>
            </select>
          </div>
          
          <!-- Sort By -->
          <div>
            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--fha-text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
              <i class="fa fa-sort"></i> Sort By
            </label>
            <select ng-model="c.filters.sortBy" class="fha-select">
              <option value="severity">Severity (High to Low)</option>
              <option value="table">Table (A-Z)</option>
              <option value="code">Code (A-Z)</option>
              <option value="message">Message (A-Z)</option>
            </select>
          </div>
        </div>
        
        <!-- Active filters count -->
        <div ng-if="c.hasActiveFilters()" style="margin-top: 16px; padding: 12px; background: var(--fha-info-bg); border-left: 3px solid var(--fha-info); border-radius: 6px; display: flex; align-items: center; gap: 12px;">
          <i class="fa fa-filter" style="color: var(--fha-info); font-size: 16px;"></i>
          <span style="flex: 1; font-size: 13px; color: var(--fha-text-primary);">
            <strong>{{c.getFilteredIssues().length}}</strong> issue(s) match your filters
          </span>
        </div>
      </div>
    </div>

    <!-- Issues List -->
    <div class="fha-card">
      <div class="fha-card-header">
        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
          <i class="fa fa-list"></i> Issues ({{c.getFilteredIssues().length}} of {{c.result.issues.length}})
        </h3>
        <div style="display: flex; gap: 8px;">
          <button class="fha-btn-secondary fha-btn-sm" ng-click="c.expandAll()">
            <i class="fa fa-expand"></i> Expand All
          </button>
          <button class="fha-btn-secondary fha-btn-sm" ng-click="c.collapseAll()">
            <i class="fa fa-compress"></i> Collapse All
          </button>
        </div>
      </div>
      <div class="fha-card-body" style="padding: 24px;">
        
        <!-- No results -->
        <div ng-if="c.getFilteredIssues().length == 0" style="text-align: center; padding: 60px 20px; color: var(--fha-text-secondary);">
          <i class="fa fa-search" style="font-size: 64px; color: var(--fha-gray-300); margin-bottom: 20px; opacity: 0.5;"></i>
          <h4 style="margin: 0 0 8px 0; font-size: 18px; color: var(--fha-anthracite);">No issues found</h4>
          <p style="margin: 0; font-size: 14px;">Try adjusting your filters or search criteria</p>
        </div>

        <!-- Issues Cards -->
        <div ng-repeat="issue in c.getFilteredIssues() track by $index" 
             style="background: var(--fha-bg-card); border: 1px solid var(--fha-border-color); border-left: 4px solid; border-radius: 8px; padding: 20px; margin-bottom: 16px; box-shadow: var(--fha-shadow-sm); transition: all 0.2s ease;"
             ng-style="{
               'border-left-color': issue.severity == 'critical' ? 'var(--fha-danger)' :
                                   issue.severity == 'high' ? '#E74C3C' :
                                   issue.severity == 'medium' ? 'var(--fha-warning)' :
                                   'var(--fha-info)'
             }"
             ng-mouseenter="$event.currentTarget.style.boxShadow='var(--fha-shadow-lg)'; $event.currentTarget.style.transform='translateY(-2px)'"
             ng-mouseleave="$event.currentTarget.style.boxShadow='var(--fha-shadow-sm)'; $event.currentTarget.style.transform='translateY(0)'">
          
          <!-- Issue Header -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;">
            <span class="issue-badge" ng-class="{
              'critical': issue.severity == 'critical',
              'high': issue.severity == 'high',
              'medium': issue.severity == 'medium',
              'low': issue.severity == 'low'
            }">
              <i class="fa fa-exclamation-triangle"></i>
              {{issue.severity | uppercase}}
            </span>
            <code style="background: var(--fha-gray-100); padding: 6px 12px; border-radius: 6px; font-size: 12px; color: var(--fha-anthracite); border: 1px solid var(--fha-border-color); font-weight: 600;">
              {{issue.code}}
            </code>
            <span ng-if="issue.category" style="padding: 4px 10px; background: var(--fha-bg-section); border-radius: 12px; font-size: 11px; color: var(--fha-text-secondary); border: 1px solid var(--fha-border-color);">
              <i class="fa fa-tag"></i> {{issue.category}}
            </span>
          </div>
          
          <!-- Issue Message -->
          <div style="margin-bottom: 16px;">
            <p style="margin: 0; font-size: 15px; color: var(--fha-text-primary); line-height: 1.7; font-weight: 500;">
              {{issue.message}}
            </p>
          </div>
          
          <!-- Issue Meta Grid -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; padding: 16px; background: var(--fha-bg-section); border-radius: 6px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <i class="fa fa-table" style="color: var(--fha-primary); font-size: 14px;"></i>
              <div>
                <div style="font-size: 10px; color: var(--fha-text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Table</div>
                <div style="font-size: 13px; color: var(--fha-anthracite); font-weight: 600;">{{issue.parent_table || issue.table}}</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <i class="fa fa-hashtag" style="color: var(--fha-primary); font-size: 14px;"></i>
              <div>
                <div style="font-size: 10px; color: var(--fha-text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Record</div>
                <code style="font-size: 11px; color: var(--fha-anthracite); background: white; padding: 2px 6px; border-radius: 3px;">{{issue.record}}</code>
              </div>
            </div>
            <div ng-if="issue.field" style="display: flex; align-items: center; gap: 8px;">
              <i class="fa fa-edit" style="color: var(--fha-primary); font-size: 14px;"></i>
              <div>
                <div style="font-size: 10px; color: var(--fha-text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Field</div>
                <div style="font-size: 13px; color: var(--fha-anthracite); font-weight: 600;">{{issue.field}}</div>
              </div>
            </div>
          </div>
          
          <!-- Actions -->
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button ng-if="issue.details" 
                    class="fha-btn-secondary fha-btn-sm" 
                    ng-click="issue.showDetails = !issue.showDetails"
                    style="font-size: 12px;">
              <i class="fa" ng-class="{'fa-chevron-down': !issue.showDetails, 'fa-chevron-up': issue.showDetails}"></i>
              {{issue.showDetails ? 'Hide' : 'Show'}} Details
            </button>
            <button class="fha-btn-secondary fha-btn-sm" ng-click="c.viewRecord(issue)" title="View record in ServiceNow">
              <i class="fa fa-external-link-alt"></i> View Record
            </button>
          </div>
          
          <!-- Details Panel (collapsible) -->
          <div ng-if="issue.showDetails && issue.details" 
               style="margin-top: 16px; background: var(--fha-bg-section); padding: 16px; border-radius: 6px; border: 1px solid var(--fha-border-color); animation: slideDown 0.3s ease;">
            <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--fha-border-color);">
              <h5 style="margin: 0; font-size: 13px; font-weight: 700; color: var(--fha-anthracite); text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fa fa-info-circle" style="color: var(--fha-primary);"></i> Additional Details
              </h5>
            </div>
            <pre class="fha-json-viewer" style="margin: 0; max-height: 300px; font-size: 12px;">{{issue.details | json}}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       TAB: ANALYTICS (Statistiques avanc√©es)
       ============================================================ -->
  <div ng-if="c.activeTab == 'analytics'">
    
    <!-- Stats Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 24px;">
      
      <!-- Card: Severity Breakdown -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-chart-pie" style="color: var(--fha-primary);"></i> Severity Breakdown
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 24px;">
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <div ng-repeat="sev in ['critical', 'high', 'medium', 'low']" 
                 style="padding: 16px; background: var(--fha-bg-section); border-radius: 8px; border-left: 4px solid;"
                 ng-style="{
                   'border-left-color': sev == 'critical' ? 'var(--fha-danger)' :
                                       sev == 'high' ? '#E74C3C' :
                                       sev == 'medium' ? 'var(--fha-warning)' :
                                       '#5DADE2'
                 }">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span style="font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;"
                      ng-style="{'color': sev == 'critical' ? 'var(--fha-danger)' :
                                         sev == 'high' ? '#E74C3C' :
                                         sev == 'medium' ? 'var(--fha-warning)' :
                                         '#2E86C1'}">
                  {{sev}}
                </span>
                <span style="font-size: 24px; font-weight: 700;"
                      ng-style="{'color': sev == 'critical' ? 'var(--fha-danger)' :
                                         sev == 'high' ? '#E74C3C' :
                                         sev == 'medium' ? 'var(--fha-warning)' :
                                         '#2E86C1'}">
                  {{c.getIssuesBySeverity(sev).length}}
                </span>
              </div>
              <div style="height: 8px; background: var(--fha-gray-100); border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; border-radius: 4px; transition: width 0.6s ease;"
                     ng-style="{
                       'width': (c.getIssuesBySeverity(sev).length / c.result.issues.length * 100) + '%',
                       'background': sev == 'critical' ? 'var(--fha-danger)' :
                                    sev == 'high' ? '#E74C3C' :
                                    sev == 'medium' ? 'var(--fha-warning)' :
                                    '#5DADE2'
                     }">
                </div>
              </div>
              <div style="margin-top: 8px; font-size: 12px; color: var(--fha-text-secondary); text-align: right;">
                {{(c.getIssuesBySeverity(sev).length / c.result.issues.length * 100) | number:1}}% of total
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Tables Summary -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-database" style="color: var(--fha-primary);"></i> Tables Summary
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 24px;">
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 16px; background: var(--fha-bg-section); border-radius: 8px;">
              <span style="font-size: 13px; color: var(--fha-text-secondary); font-weight: 600;">Total Tables Affected</span>
              <span style="font-size: 20px; font-weight: 700; color: var(--fha-primary);">
                {{Object.keys(c.getIssuesByTable()).length}}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 16px; background: var(--fha-bg-section); border-radius: 8px;">
              <span style="font-size: 13px; color: var(--fha-text-secondary); font-weight: 600;">Avg Issues per Table</span>
              <span style="font-size: 20px; font-weight: 700; color: var(--fha-anthracite);">
                {{c.getAvgIssuesPerTable() | number:1}}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 16px; background: var(--fha-bg-section); border-radius: 8px;">
              <span style="font-size: 13px; color: var(--fha-text-secondary); font-weight: 600;">Most Affected Table</span>
              <span style="font-size: 14px; font-weight: 700; color: var(--fha-anthracite);">
                {{c.getMostAffectedTable()}}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Health Score -->
      <div class="fha-card" ng-if="c.result.health_score">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-heartbeat" style="color: var(--fha-primary);"></i> Health Score
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 24px; text-align: center;">
          <div style="width: 120px; height: 120px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: 700; border: 8px solid; box-shadow: var(--fha-shadow-lg);"
               ng-class="{
                 'fha-score-excellent': c.result.health_score >= 90,
                 'fha-score-good': c.result.health_score >= 70 && c.result.health_score < 90,
                 'fha-score-medium': c.result.health_score >= 40 && c.result.health_score < 70,
                 'fha-score-poor': c.result.health_score < 40
               }"
               ng-style="{
                 'color': c.result.health_score >= 90 ? 'var(--fha-success)' :
                         c.result.health_score >= 70 ? '#2E86C1' :
                         c.result.health_score >= 40 ? 'var(--fha-warning)' :
                         'var(--fha-danger)',
                 'border-color': c.result.health_score >= 90 ? 'var(--fha-success)' :
                                c.result.health_score >= 70 ? '#2E86C1' :
                                c.result.health_score >= 40 ? 'var(--fha-warning)' :
                                'var(--fha-danger)',
                 'background': c.result.health_score >= 90 ? 'var(--fha-success-bg)' :
                              c.result.health_score >= 70 ? 'var(--fha-info-bg)' :
                              c.result.health_score >= 40 ? 'var(--fha-warning-bg)' :
                              'var(--fha-danger-bg)'
               }">
            {{c.result.health_score}}%
          </div>
          <h4 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700; color: var(--fha-anthracite);">
            {{c.getHealthLabel()}}
          </h4>
          <p style="margin: 0; font-size: 13px; color: var(--fha-text-secondary);">
            {{c.getHealthDescription()}}
          </p>
        </div>
      </div>
    </div>

    <!-- Detailed Table Stats -->
    <div class="fha-card">
      <div class="fha-card-header">
        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
          <i class="fa fa-table" style="color: var(--fha-primary);"></i> Detailed Table Analysis
        </h3>
      </div>
      <div class="fha-card-body" style="padding: 0;">
        <table class="fha-data-table">
          <thead>
            <tr>
              <th class="fha-th-sortable" ng-click="c.sortTableStats('name')">
                Table Name
                <i class="fa" ng-class="{'fa-sort-up': c.tableStatsSort == 'name' && c.tableStatsSortDir == 'asc', 'fa-sort-down': c.tableStatsSort == 'name' && c.tableStatsSortDir == 'desc', 'fa-sort': c.tableStatsSort != 'name'}"></i>
              </th>
              <th class="fha-th-sortable" ng-click="c.sortTableStats('total')">
                Total Issues
                <i class="fa" ng-class="{'fa-sort-up': c.tableStatsSort == 'total' && c.tableStatsSortDir == 'asc', 'fa-sort-down': c.tableStatsSort == 'total' && c.tableStatsSortDir == 'desc', 'fa-sort': c.tableStatsSort != 'total'}"></i>
              </th>
              <th>Critical</th>
              <th>High</th>
              <th>Medium</th>
              <th>Low</th>
              <th>Distribution</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="(table, issues) in c.getIssuesByTable()">
              <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <i class="fa fa-database" style="color: var(--fha-primary);"></i>
                  <strong>{{table}}</strong>
                </div>
              </td>
              <td>
                <span class="fha-badge fha-badge-primary" style="font-size: 13px; padding: 6px 12px;">
                  {{issues.length}}
                </span>
              </td>
              <td>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'critical').length > 0" 
                      class="fha-badge fha-badge-critical">
                  {{c.getIssuesBySeverityForTable(table, 'critical').length}}
                </span>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'critical').length == 0" 
                      style="color: var(--fha-text-muted);">-</span>
              </td>
              <td>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'high').length > 0" 
                      class="fha-badge fha-badge-high">
                  {{c.getIssuesBySeverityForTable(table, 'high').length}}
                </span>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'high').length == 0" 
                      style="color: var(--fha-text-muted);">-</span>
              </td>
              <td>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'medium').length > 0" 
                      class="fha-badge fha-badge-medium">
                  {{c.getIssuesBySeverityForTable(table, 'medium').length}}
                </span>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'medium').length == 0" 
                      style="color: var(--fha-text-muted);">-</span>
              </td>
              <td>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'low').length > 0" 
                      class="fha-badge fha-badge-low">
                  {{c.getIssuesBySeverityForTable(table, 'low').length}}
                </span>
                <span ng-if="c.getIssuesBySeverityForTable(table, 'low').length == 0" 
                      style="color: var(--fha-text-muted);">-</span>
              </td>
              <td>
                <div style="display: flex; gap: 2px; height: 24px;">
                  <div ng-if="c.getIssuesBySeverityForTable(table, 'critical').length > 0" 
                       style="background: var(--fha-danger); border-radius: 2px; transition: flex 0.3s ease;"
                       ng-style="{'flex': c.getIssuesBySeverityForTable(table, 'critical').length}"></div>
                  <div ng-if="c.getIssuesBySeverityForTable(table, 'high').length > 0" 
                       style="background: #E74C3C; border-radius: 2px; transition: flex 0.3s ease;"
                       ng-style="{'flex': c.getIssuesBySeverityForTable(table, 'high').length}"></div>
                  <div ng-if="c.getIssuesBySeverityForTable(table, 'medium').length > 0" 
                       style="background: var(--fha-warning); border-radius: 2px; transition: flex 0.3s ease;"
                       ng-style="{'flex': c.getIssuesBySeverityForTable(table, 'medium').length}"></div>
                  <div ng-if="c.getIssuesBySeverityForTable(table, 'low').length > 0" 
                       style="background: #5DADE2; border-radius: 2px; transition: flex 0.3s ease;"
                       ng-style="{'flex': c.getIssuesBySeverityForTable(table, 'low').length}"></div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ============================================================
       TAB: DETAILS (Analysis metadata)
       ============================================================ -->
  <div ng-if="c.activeTab == 'details'">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
      
      <!-- General Info -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-info-circle" style="color: var(--fha-primary);"></i> General Information
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 24px;">
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Analysis Number:</span>
            <span class="fha-info-value"><strong>{{c.result.number}}</strong></span>
          </div>
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">State:</span>
            <span class="fha-status-badge" ng-class="{
              'badge-completed': c.result.state == 'completed',
              'badge-in-progress': c.result.state == 'in_progress'
            }">
              {{c.result.state | uppercase}}
            </span>
          </div>
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Created:</span>
            <span class="fha-info-value">{{c.result.sys_created_on | date:'medium'}}</span>
          </div>
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Updated:</span>
            <span class="fha-info-value">{{c.result.sys_updated_on | date:'medium'}}</span>
          </div>
          <div class="fha-info-row">
            <span class="fha-info-label">Created By:</span>
            <span class="fha-info-value">{{c.result.sys_created_by || 'System'}}</span>
          </div>
        </div>
      </div>

      <!-- Configuration -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-cog" style="color: var(--fha-primary);"></i> Configuration
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 24px;">
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Name:</span>
            <span class="fha-info-value">{{c.result.configuration_name || 'N/A'}}</span>
          </div>
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Description:</span>
            <span class="fha-info-value">{{c.result.configuration_description || 'No description available'}}</span>
          </div>
          <div class="fha-info-row">
            <span class="fha-info-label">Scope:</span>
            <span class="fha-info-value">{{c.result.scope || 'Global'}}</span>
          </div>
        </div>
      </div>

      <!-- Statistics -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
            <i class="fa fa-chart-bar" style="color: var(--fha-primary);"></i> Statistics
          </h3>
        </div>
        <div class="fha-card-body" style="padding: 24px;">
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Total Issues:</span>
            <span class="fha-info-value">{{c.result.issues.length}}</span>
          </div>
          <div class="fha-info-row" style="margin-bottom: 16px;">
            <span class="fha-info-label">Tables Affected:</span>
            <span class="fha-info-value">{{Object.keys(c.getIssuesByTable()).length}}</span>
          </div>
          <div class="fha-info-row">
            <span class="fha-info-label">Categories:</span>
            <span class="fha-info-value">{{Object.keys(c.getIssuesByCategory()).length}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       TAB: RAW DATA (JSON)
       ============================================================ -->
  <div ng-if="c.activeTab == 'data'">
    <div class="fha-card">
      <div class="fha-card-header">
        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--fha-anthracite);">
          <i class="fa fa-database" style="color: var(--fha-primary);"></i> Raw JSON Data
        </h3>
      </div>
      <div class="fha-card-body" style="padding: 24px;">
        <pre class="fha-json-viewer" style="max-height: 800px; overflow-y: auto;">{{c.result | json:2}}</pre>
      </div>
    </div>
  </div>

</div>]]></template>
    </sp_widget>
</record_update>
