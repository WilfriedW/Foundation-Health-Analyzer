<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $location, $window) {
  var c = this;

  c.analysisId = $location.search().sys_id || c.data.analysisId || c.data.analysis_id || '';
  c.result = c.data.result || null;
  c.error = c.data.error || null;
  c.loading = !!c.analysisId && !c.result;
  c.activeTab = 'details';
  c.issueCategory = 'all';
  c.issueCategories = ['all'];
  c.issueFilters = { severity: 'all', search: '' };

  c.setTab = function(tab) { c.activeTab = tab; };
  c.isTab = function(tab) { return c.activeTab === tab; };
  c.setIssueCategory = function(cat) { c.issueCategory = cat; };

  c.getHealthScoreClass = function(score) {
    if (score === null || score === undefined) return 'medium';
    if (score >= 70) return 'blue';
    if (score >= 40) return 'amber';
    return 'red';
  };

  c.getCategories = function() {
    return (c.result && c.result.categories) || {};
  };

  c.getCategoryItems = function(catId) {
    var cats = c.getCategories();
    var cat = cats[catId];
    if (!cat || !cat.items) return [];
    var out = [];
    cat.items.forEach(function(it) {
      var records = it.records || [];
      records.forEach(function(rec) {
        out.push(angular.extend({
          item_type: it.type,
          item_label: it.label || it.itemLabel,
          item_icon: it.icon || it.itemIcon,
          item_color: it.color || it.itemColor
        }, rec));
      });
    });
    return out;
  };

  c.getOptionsList = function() {
    var opts = (c.result && c.result.options) || {};
    return Object.keys(opts).map(function(key) {
      return { key: key, value: opts[key] };
    });
  };

  c.getConfigOptions = function() {
    var cfg = (c.result && c.result.config) || {};
    var opts = cfg.options || {};
    return Object.keys(opts).map(function(key) {
      return { key: key, value: opts[key] };
    });
  };

  c.buildIssueCategories = function() {
    var cats = ['all'];
    var seen = {};
    var issues = (c.result && c.result.issues) || [];
    issues.forEach(function(issue) {
      var cat = issue.category || 'general';
      if (!seen[cat]) {
        seen[cat] = true;
        cats.push(cat);
      }
    });
    return cats;
  };

  c.filteredIssues = function() {
    var issues = (c.result && c.result.issues) || [];
    var cat = c.issueCategory;
    var sev = c.issueFilters.severity;
    var search = (c.issueFilters.search || '').toLowerCase();

    return issues.filter(function(issue) {
      if (cat !== 'all' && (issue.category || 'general') !== cat) return false;
      if (sev !== 'all' && (issue.severity || '').toLowerCase() !== sev) return false;
      if (search) {
        var haystack = [
          issue.code,
          issue.message,
          issue.category,
          issue.record_table,
          issue.record_name
        ].join(' ').toLowerCase();
        if (haystack.indexOf(search) === -1) return false;
      }
      return true;
    });
  };

  c.countIssuesByCategory = function(cat) {
    if (!c.result || !c.result.issues) return 0;
    if (cat === 'all') return c.result.issues.length;
    var count = 0;
    c.result.issues.forEach(function(issue) {
      if ((issue.category || 'general') === cat) count++;
    });
    return count;
  };

  c.resetFilters = function() {
    c.issueFilters = { severity: 'all', search: '' };
  };

  c.openRecord = function(table, sysId) {
    if (!table || !sysId) return;
    $window.open('/' + table + '.do?sys_id=' + sysId, '_blank');
  };

  c.enrich = function() {
    c.issueCategories = c.buildIssueCategories();
  };

  c.init = function() {
    if (c.result) {
      c.enrich();
      c.loading = false;
      return;
    }

    if (!c.analysisId) {
      c.error = '${Missing analysis identifier}';
      c.loading = false;
      return;
    }

    c.loading = true;
    c.server.get({ action: 'get_result', analysisId: c.analysisId }).then(function(resp) {
      if (resp.data && resp.data.success && resp.data.analysisResult) {
        c.result = resp.data.analysisResult;
        c.enrich();
        c.error = null;
      } else {
        c.error = (resp.data && resp.data.error) ? resp.data.error : '${Result not found}';
      }
      c.loading = false;
    }, function() {
      c.error = '${Server communication error}';
      c.loading = false;
    });
  };

  c.init();
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.fha-detail {
  max-width: 1100px;
  margin: 0 auto;
  padding: 20px;
}

.fha-header {
  background: #0b5cab;
  color: #fff;
  padding: 18px;
  border-radius: 10px;
  margin-bottom: 16px;
}

.fha-header h1 {
  margin: 0;
  font-size: 20px;
}

.fha-meta {
  margin-top: 8px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  font-size: 13px;
  opacity: 0.9;
}

.fha-card {
  background: #fff;
  border: 1px solid #dfe3e6;
  border-radius: 10px;
  margin-bottom: 14px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.fha-card h3 {
  margin: 0;
  font-size: 16px;
}

.fha-card__head {
  padding: 12px 16px;
  border-bottom: 1px solid #dfe3e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.fha-card__body {
  padding: 14px 16px;
}

.fha-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

.fha-tab-btn {
  border: 1px solid #d0d6dc;
  background: #f5f7f9;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  color: #1f2933;
}

.fha-tab-btn.active {
  border-color: #0b5cab;
  color: #0b5cab;
  background: #e8f1fb;
}

.fha-data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.fha-data-table th,
.fha-data-table td {
  padding: 8px 10px;
  border-bottom: 1px solid #eef1f3;
  text-align: left;
}

.fha-data-table th {
  background: #f5f7f9;
  font-weight: 600;
}

.fha-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  background: #eef1f3;
}

.pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  background: #eef1f3;
  font-weight: 600;
}

.pill.red { background: #fde8e8; color: #c81e1e; }
.pill.amber { background: #fff4e5; color: #b45309; }
.pill.blue { background: #e0f2fe; color: #075985; }
.pill.gray { background: #f3f4f6; color: #4b5563; }

.issue-badge {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  display: inline-block;
}
.sev-high { background: #fde8e8; color: #b91c1c; }
.sev-medium { background: #fff4e5; color: #b45309; }
.sev-low { background: #e0f2fe; color: #075985; }

.section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  margin: 0 0 6px 0;
}

.filter-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.filter-bar input,
.filter-bar select {
  padding: 6px 10px;
  border: 1px solid #d0d6dc;
  border-radius: 6px;
  font-size: 13px;
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_analysis_detail</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>FHA Analysis detail</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    data.analysisId = $sp.getParameter('sys_id') || (input && input.analysisId) || '';
    data.result = null;
    data.error = null;
    data.success = false;

    function loadResult(resultId) {
        if (!resultId) {
            return { success: false, error: gs.getMessage('Missing result identifier') };
        }

        var gr = new GlideRecord('x_1310794_founda_0_results');
        if (!gr.get(resultId)) {
            return { success: false, error: gs.getMessage('Result not found') };
        }

        var parsed;
        try {
            parsed = JSON.parse(gr.getValue('details') || '{}');
        } catch (err) {
            return { success: false, error: gs.getMessage('Unable to parse analysis details') };
        }

        parsed.number = parsed.number || gr.getValue('number');
        parsed.state = parsed.state || gr.getValue('state');
        parsed.status = parsed.status || parsed.state;
        parsed.health_score = parsed.health_score || parsed.healthScore || gr.getValue('health_score');
        parsed.sys_id = gr.getUniqueValue();
        parsed.created_on = parsed.created_on || gr.getDisplayValue('sys_created_on');
        parsed.created_by = parsed.created_by || gr.getDisplayValue('sys_created_by');

        return { success: true, result: parsed };
    }

    var initial = loadResult(data.analysisId);
    if (initial.success) {
        data.result = initial.result;
        data.success = true;
    } else if (data.analysisId) {
        data.error = initial.error;
    }

    if (input && input.action === 'get_result') {
        var res = loadResult(input.analysisId || data.analysisId);
        data.success = res.success;
        if (res.success) {
            data.analysisResult = res.result;
            data.error = '';
        } else {
            data.error = res.error;
        }
    }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-03 22:38:44</sys_created_on>
        <sys_id>3ee88bd48312f21083e1b4a6feaad39a</sys_id>
        <sys_mod_count>40</sys_mod_count>
        <sys_name>FHA Analysis detail</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_3ee88bd48312f21083e1b4a6feaad39a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-05 00:34:36</sys_updated_on>
        <template><![CDATA[<div class="fha-detail">
  <div class="fha-header">
    <h1>${Analysis detail}</h1>
    <div class="fha-meta" ng-if="c.result">
      <span class="fha-badge">${Number}: {{c.result.number || c.analysisId}}</span>
      <span class="fha-badge">${Status}: {{c.result.state || c.result.status || 'N/A'}}</span>
      <span class="fha-badge">${Table}: {{c.result.table_label || c.result.table_name || (c.result.config && (c.result.config.table_label || c.result.config.table_name))}}</span>
      <span class="fha-badge" ng-if="c.result.health_score !== undefined">${Health score}: {{c.result.health_score}}</span>
    </div>
  </div>

  <div class="alert alert-danger" ng-if="c.error">
    {{c.error}}
  </div>

  <div class="alert alert-info" ng-if="c.loading">
    ${Loading analysis results...}
  </div>

  <div ng-if="!c.loading && c.result">
    <div class="fha-tabs">
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('details')}" ng-click="c.setTab('details')">${Details}</button>
      <button class="fha-tab-btn" ng-class="{'active': c.isTab('issues')}" ng-click="c.setTab('issues')">
        ${Issues} ({{(c.result.issues || []).length}})
      </button>
    </div>

    <div ng-show="c.isTab('details')">
      <div class="fha-card">
        <div class="fha-card__head">
          <h3>${Overview}</h3>
        </div>
        <div class="fha-card__body">
          <table class="fha-data-table">
            <tbody>
              <tr>
                <td style="width:200px;"><strong>${Number}</strong></td>
                <td>{{c.result.number || c.analysisId}}</td>
              </tr>
              <tr>
                <td><strong>${Status}</strong></td>
                <td>{{c.result.state || c.result.status || 'N/A'}}</td>
              </tr>
              <tr>
                <td><strong>${Table}</strong></td>
                <td>{{c.result.table_label || c.result.table_name || (c.result.config && (c.result.config.table_label || c.result.config.table_name))}}</td>
              </tr>
              <tr ng-if="c.result.health_score !== undefined">
                <td><strong>${Health score}</strong></td>
                <td>{{c.result.health_score}}</td>
              </tr>
              <tr ng-if="c.result.duration_ms">
                <td><strong>${Duration}</strong></td>
                <td>{{c.result.duration_ms}} ms</td>
              </tr>
              <tr ng-if="c.result.created_on">
                <td><strong>${Created}</strong></td>
                <td>{{c.result.created_on}}</td>
              </tr>
              <tr ng-if="c.result.created_by">
                <td><strong>${By}</strong></td>
                <td>{{c.result.created_by}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="fha-card">
        <div class="fha-card__head">
          <h3>${Configuration options}</h3>
        </div>
        <div class="fha-card__body" ng-if="c.getConfigOptions().length">
          <table class="fha-data-table">
            <tbody>
              <tr ng-repeat="opt in c.getConfigOptions()">
                <td style="width:220px;"><strong>{{opt.key}}</strong></td>
                <td>{{opt.value}}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="fha-card__body" ng-if="!c.getConfigOptions().length">
          <span class="pill gray">${No configuration options found}</span>
        </div>
      </div>

      <div class="fha-card">
        <div class="fha-card__head">
          <h3>${Run options}</h3>
        </div>
        <div class="fha-card__body" ng-if="c.getOptionsList().length">
          <table class="fha-data-table">
            <tbody>
              <tr ng-repeat="opt in c.getOptionsList()">
                <td style="width:220px;"><strong>{{opt.key}}</strong></td>
                <td>{{opt.value}}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="fha-card__body" ng-if="!c.getOptionsList().length">
          <span class="pill gray">${No options provided}</span>
        </div>
      </div>

      <div class="fha-card" ng-repeat="(catId, cat) in c.getCategories()">
        <div class="fha-card__head">
          <h3>{{cat.label || catId}}</h3>
          <span class="fha-badge">{{c.getCategoryItems(catId).length}}</span>
        </div>
        <div class="fha-card__body" ng-if="c.getCategoryItems(catId).length">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th style="width:180px;">${Type}</th>
                <th>${Name}</th>
                <th style="width:140px;">${Table}</th>
                <th style="width:120px;">${Status}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="item in c.getCategoryItems(catId)">
                <td>{{item.item_label || item.type || item.item_type}}</td>
                <td>{{item.name || item.label || item.field || item.code}}</td>
                <td>{{item.table || item.target_table || item.trigger_table}}</td>
                <td>
                  <span class="pill blue" ng-if="item.active !== false">${Active}</span>
                  <span class="pill gray" ng-if="item.active === false">${Inactive}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="fha-card__body" ng-if="!c.getCategoryItems(catId).length">
          <span class="pill gray">${No data}</span>
        </div>
      </div>
    </div>

    <div ng-show="c.isTab('issues')">
      <div class="fha-card">
        <div class="fha-card__body">
          <div class="filter-bar">
            <label>${Severity}:</label>
            <select ng-model="c.issueFilters.severity">
              <option value="all">${All}</option>
              <option value="high">${High}</option>
              <option value="medium">${Medium}</option>
              <option value="low">${Low}</option>
            </select>
            <label>${Search}:</label>
            <input type="text" ng-model="c.issueFilters.search" placeholder="${Filter issues}">
            <button class="fha-tab-btn" style="border:none;" ng-click="c.resetFilters()">
              <i class="fa fa-refresh"></i> ${Reset}
            </button>
          </div>
          <div class="fha-tabs" style="margin-bottom:12px;">
            <button class="fha-tab-btn" ng-repeat="cat in c.issueCategories" ng-class="{'active': c.issueCategory === cat}" ng-click="c.setIssueCategory(cat)">
              {{cat === 'all' ? '${All categories}' : cat}} <span class="fha-badge">{{c.countIssuesByCategory(cat)}}</span>
            </button>
          </div>

          <table class="fha-data-table" ng-if="c.filteredIssues().length">
            <thead>
              <tr>
                <th style="width:120px;">${Severity}</th>
                <th style="width:160px;">${Category}</th>
                <th style="width:140px;">${Code}</th>
                <th>${Message}</th>
                <th style="width:60px;">${Action}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="issue in c.filteredIssues()">
                <td><span class="issue-badge" ng-class="{'sev-high': issue.severity=='high','sev-medium': issue.severity=='medium','sev-low': issue.severity=='low'}">{{issue.severity | uppercase}}</span></td>
                <td>{{issue.category || 'general'}}</td>
                <td>{{issue.code}}</td>
                <td>{{issue.message}}</td>
                <td>
                  <a class="fha-link" ng-if="issue.record_sys_id" ng-click="c.openRecord(issue.record_table, issue.record_sys_id)">
                    <i class="fa fa-external-link"></i>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
          <div ng-if="!c.filteredIssues().length" style="padding:12px 0;">
            <span class="pill gray">${No issues to display}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
