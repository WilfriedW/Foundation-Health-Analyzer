<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, spUtil, $location, $window) {
  var c = this;
    
    // Get analysis ID from URL parameter
    c.analysisId = $location.search().sys_id || c.data.analysisId || '';
    c.loading = !c.data.result;
    c.error = c.data.error || null;
    c.result = c.data.result || null;
    c.activeTab = 'overview';
    
    // Expanded sections
    c.expandedSections = {
        fields: false,
        business_rules: false,
        automation: false,
        integration: false
    };

    // Toggle section
    c.toggleSection = function(section) {
        c.expandedSections[section] = !c.expandedSections[section];
    };

    // Get health score class
    c.getHealthScoreClass = function(score) {
        if (score >= 70) return 'good';
        if (score >= 40) return 'medium';
        return 'poor';
    };

    // Get severity class
    c.getSeverityClass = function(severity) {
        switch(severity) {
            case 'high': return 'danger';
            case 'medium': return 'warning';
            case 'low': return 'info';
            default: return 'default';
        }
    };

    // Count issues by severity
    c.countBySeverity = function(severity) {
        if (!c.result || !c.result.issues) return 0;
        return c.result.issues.filter(function(i) { return i.severity === severity; }).length;
    };

    // Get issues by category
    c.getIssuesByCategory = function(category) {
        if (!c.result || !c.result.issues) return [];
        return c.result.issues.filter(function(i) { return i.category === category; });
    };

    // Get metrics
    c.getMetrics = function() {
        return (c.result && c.result.metrics) ? c.result.metrics : {};
    };

    // Get custom fields
    c.getCustomFields = function() {
        var metrics = c.getMetrics();
        return metrics.custom_fields || [];
    };

    // Get business rules
    c.getBusinessRules = function() {
        var metrics = c.getMetrics();
        return metrics.business_rules || [];
    };

    // Get all automation items
    c.getAutomationItems = function() {
        var metrics = c.getMetrics();
        var items = [];
        
        if (metrics.scheduled_jobs) {
            metrics.scheduled_jobs.forEach(function(job) {
                items.push({ type: 'Scheduled Job', name: job.name, active: job.active, sys_id: job.sys_id, table: 'sysauto_script' });
            });
        }
        if (metrics.flows) {
            metrics.flows.forEach(function(flow) {
                items.push({ type: 'Flow', name: flow.name, active: flow.active, sys_id: flow.sys_id, table: 'sys_hub_flow' });
            });
        }
        if (metrics.workflows) {
            metrics.workflows.forEach(function(wf) {
                items.push({ type: 'Workflow', name: wf.name, active: wf.active, sys_id: wf.sys_id, table: 'wf_workflow' });
            });
        }
        if (metrics.notifications) {
            metrics.notifications.forEach(function(n) {
                items.push({ type: 'Notification', name: n.name, active: n.active, sys_id: n.sys_id, table: 'sysevent_email_action' });
            });
        }
        if (metrics.ui_actions) {
            metrics.ui_actions.forEach(function(a) {
                items.push({ type: 'UI Action', name: a.name, active: true, sys_id: a.sys_id, table: 'sys_ui_action' });
            });
        }
        
        return items;
    };

    // Get integration items
    c.getIntegrationItems = function() {
        var metrics = c.getMetrics();
        var items = [];
        
        if (metrics.data_sources) {
            metrics.data_sources.forEach(function(ds) {
                items.push({ type: 'Data Source', name: ds.name, active: ds.active, sys_id: ds.sys_id, table: 'sys_data_source' });
            });
        }
        if (metrics.transform_maps) {
            metrics.transform_maps.forEach(function(tm) {
                items.push({ type: 'Transform Map', name: tm.name, active: tm.active, sys_id: tm.sys_id, table: 'sys_transform_map' });
            });
        }
        
        return items;
    };

    // Get LDAP analysis data
    c.getLdapAnalysis = function() {
        var metrics = c.getMetrics();
        return metrics.ldap_analysis || null;
    };

    // Check if LDAP analysis is available
    c.hasLdapAnalysis = function() {
        var ldap = c.getLdapAnalysis();
        return ldap && (ldap.data_sources.length > 0 || ldap.transform_maps.length > 0 || ldap.attribute_mappings.length > 0);
    };

    // Get LDAP data sources
    c.getLdapDataSources = function() {
        var ldap = c.getLdapAnalysis();
        return ldap ? ldap.data_sources : [];
    };

    // Get LDAP transform maps
    c.getLdapTransformMaps = function() {
        var ldap = c.getLdapAnalysis();
        return ldap ? ldap.transform_maps : [];
    };

    // Get LDAP attribute mappings
    c.getLdapAttributeMappings = function() {
        var ldap = c.getLdapAnalysis();
        return ldap ? ldap.attribute_mappings : [];
    };

    // Get LDAP servers
    c.getLdapServers = function() {
        var ldap = c.getLdapAnalysis();
        return ldap ? ldap.servers : [];
    };

    // Get LDAP issues
    c.getLdapIssues = function() {
        if (!c.result || !c.result.issues) return [];
        return c.result.issues.filter(function(i) { return i.category === 'ldap'; });
    };

    // LDAP filter
    c.ldapFilter = {
        search: ''
    };

    // Get filtered LDAP attribute mappings
    c.getFilteredLdapMappings = function() {
        var mappings = c.getLdapAttributeMappings();
        
        if (c.ldapFilter.search) {
            var search = c.ldapFilter.search.toLowerCase();
            mappings = mappings.filter(function(m) {
                return m.ldap_attribute.toLowerCase().indexOf(search) !== -1 ||
                       m.servicenow_field.toLowerCase().indexOf(search) !== -1 ||
                       m.transform_map.toLowerCase().indexOf(search) !== -1;
            });
        }
        
        return mappings;
    };

    // Filters for automation tab
    c.automationFilter = {
        type: 'all',
        status: 'all',
        search: ''
    };

    // Filters for integration tab
    c.integrationFilter = {
        type: 'all',
        status: 'all',
        search: ''
    };

    // Get unique automation types
    c.getAutomationTypes = function() {
        var items = c.getAutomationItems();
        var types = {};
        items.forEach(function(item) {
            types[item.type] = true;
        });
        return Object.keys(types);
    };

    // Get unique integration types
    c.getIntegrationTypes = function() {
        var items = c.getIntegrationItems();
        var types = {};
        items.forEach(function(item) {
            types[item.type] = true;
        });
        return Object.keys(types);
    };

    // Get filtered automation items
    c.getFilteredAutomationItems = function() {
        var items = c.getAutomationItems();
        
        // Filter by type
        if (c.automationFilter.type !== 'all') {
            items = items.filter(function(item) {
                return item.type === c.automationFilter.type;
            });
        }
        
        // Filter by status
        if (c.automationFilter.status !== 'all') {
            var isActive = c.automationFilter.status === 'active';
            items = items.filter(function(item) {
                return item.active === isActive;
            });
        }
        
        // Filter by search
        if (c.automationFilter.search) {
            var search = c.automationFilter.search.toLowerCase();
            items = items.filter(function(item) {
                return item.name.toLowerCase().indexOf(search) !== -1;
            });
        }
        
        return items;
    };

    // Get filtered integration items
    c.getFilteredIntegrationItems = function() {
        var items = c.getIntegrationItems();
        
        // Filter by type
        if (c.integrationFilter.type !== 'all') {
            items = items.filter(function(item) {
                return item.type === c.integrationFilter.type;
            });
        }
        
        // Filter by status
        if (c.integrationFilter.status !== 'all') {
            var isActive = c.integrationFilter.status === 'active';
            items = items.filter(function(item) {
                return item.active === isActive;
            });
        }
        
        // Filter by search
        if (c.integrationFilter.search) {
            var search = c.integrationFilter.search.toLowerCase();
            items = items.filter(function(item) {
                return item.name.toLowerCase().indexOf(search) !== -1;
            });
        }
        
        return items;
    };

    // Get type badge class (color coding)
    c.getTypeBadgeClass = function(type) {
        var classes = {
            'Scheduled Job': 'type-scheduled-job',
            'Flow': 'type-flow',
            'Workflow': 'type-workflow',
            'Notification': 'type-notification',
            'UI Action': 'type-ui-action',
            'Data Source': 'type-data-source',
            'Transform Map': 'type-transform-map'
        };
        return classes[type] || 'type-default';
    };

    // Reset automation filter
    c.resetAutomationFilter = function() {
        c.automationFilter = { type: 'all', status: 'all', search: '' };
    };

    // Reset integration filter
    c.resetIntegrationFilter = function() {
        c.integrationFilter = { type: 'all', status: 'all', search: '' };
    };

    // Open record
    c.openRecord = function(table, sysId) {
        if (table && sysId) {
            $window.open('/' + table + '.do?sys_id=' + sysId, '_blank');
        }
    };

    // Open list with filter
    c.openList = function(table, filter) {
        var url = '/' + table + '_list.do';
        if (filter) {
            url += '?sysparm_query=' + encodeURIComponent(filter);
        }
        $window.open(url, '_blank');
    };

    // Go back to dashboard
    c.goBack = function() {
        $location.path('/fha');
    };

    // Set active tab
    c.setActiveTab = function(tab) {
        c.activeTab = tab;
    };

    // Export to JSON
    c.exportJSON = function() {
        if (!c.result) return;
        var dataStr = JSON.stringify(c.result, null, 2);
        var dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        var exportName = 'fha_analysis_' + c.analysisId + '.json';
        var linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportName);
        linkElement.click();
    };

    // Export to PDF
    c.exportPDF = function() {
        if (!c.result) return;
        
        // Create a printable HTML content
        var printContent = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
        printContent += '<title>FHA Analysis Report - ' + (c.result.table_label || c.result.table_name) + '</title>';
        printContent += '<style>';
        printContent += 'body { font-family: Arial, sans-serif; padding: 40px; color: #333; }';
        printContent += 'h1 { color: #0378BE; border-bottom: 3px solid #0378BE; padding-bottom: 10px; }';
        printContent += 'h2 { color: #035B8E; margin-top: 30px; }';
        printContent += 'h3 { color: #495057; margin-top: 20px; }';
        printContent += '.header-info { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }';
        printContent += '.score-circle { display: inline-block; width: 80px; height: 80px; border-radius: 50%; text-align: center; line-height: 80px; font-size: 28px; font-weight: bold; margin-right: 20px; }';
        printContent += '.score-good { background: #d4edda; color: #28A745; border: 3px solid #28A745; }';
        printContent += '.score-medium { background: #fff3cd; color: #856404; border: 3px solid #FFC107; }';
        printContent += '.score-poor { background: #f8d7da; color: #DC3545; border: 3px solid #DC3545; }';
        printContent += 'table { width: 100%; border-collapse: collapse; margin: 15px 0; }';
        printContent += 'th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }';
        printContent += 'th { background: #f8f9fa; font-weight: 600; }';
        printContent += '.severity-high { background: #DC3545; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px; }';
        printContent += '.severity-medium { background: #FFC107; color: #333; padding: 3px 8px; border-radius: 3px; font-size: 11px; }';
        printContent += '.severity-low { background: #17A2B8; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px; }';
        printContent += '.summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }';
        printContent += '.summary-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; }';
        printContent += '.summary-value { font-size: 24px; font-weight: bold; }';
        printContent += '.summary-label { font-size: 12px; color: #666; margin-top: 5px; }';
        printContent += '.footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center; }';
        printContent += '@media print { body { padding: 20px; } }';
        printContent += '</style></head><body>';
        
        // Header
        printContent += '<h1>Foundation Health Analysis Report</h1>';
        printContent += '<div class="header-info">';
        printContent += '<p><strong>Table:</strong> ' + (c.result.table_label || c.result.table_name) + ' (' + c.result.table_name + ')</p>';
        printContent += '<p><strong>Analysis Number:</strong> ' + c.result.number + '</p>';
        printContent += '<p><strong>Date:</strong> ' + c.result.created_on + '</p>';
        printContent += '<p><strong>Analyzed by:</strong> ' + c.result.created_by + '</p>';
        printContent += '</div>';
        
        // Health Score
        var scoreClass = c.result.health_score >= 70 ? 'score-good' : (c.result.health_score >= 40 ? 'score-medium' : 'score-poor');
        printContent += '<h2>Health Score</h2>';
        printContent += '<div class="score-circle ' + scoreClass + '">' + c.result.health_score + '</div>';
        printContent += '<span style="font-size: 18px;">' + (c.result.health_score >= 70 ? 'Good' : (c.result.health_score >= 40 ? 'Needs Attention' : 'Critical')) + '</span>';
        
        // Summary
        printContent += '<div class="summary-grid">';
        printContent += '<div class="summary-item"><div class="summary-value">' + c.result.issues.length + '</div><div class="summary-label">Total Issues</div></div>';
        printContent += '<div class="summary-item"><div class="summary-value" style="color:#DC3545;">' + c.countBySeverity('high') + '</div><div class="summary-label">High Severity</div></div>';
        printContent += '<div class="summary-item"><div class="summary-value" style="color:#FFC107;">' + c.countBySeverity('medium') + '</div><div class="summary-label">Medium Severity</div></div>';
        printContent += '<div class="summary-item"><div class="summary-value" style="color:#17A2B8;">' + c.countBySeverity('low') + '</div><div class="summary-label">Low Severity</div></div>';
        printContent += '</div>';
        
        // Issues List
        if (c.result.issues && c.result.issues.length > 0) {
            printContent += '<h2>Issues Found</h2>';
            printContent += '<table><thead><tr><th>Severity</th><th>Category</th><th>Code</th><th>Description</th></tr></thead><tbody>';
            c.result.issues.forEach(function(issue) {
                var severityClass = 'severity-' + issue.severity;
                printContent += '<tr>';
                printContent += '<td><span class="' + severityClass + '">' + issue.severity.toUpperCase() + '</span></td>';
                printContent += '<td>' + (issue.category || 'general') + '</td>';
                printContent += '<td>' + issue.code + '</td>';
                printContent += '<td>' + issue.message + '</td>';
                printContent += '</tr>';
            });
            printContent += '</tbody></table>';
        } else {
            printContent += '<h2>Issues Found</h2>';
            printContent += '<p style="color: #28A745;"><strong>No issues found. This table is in excellent health!</strong></p>';
        }
        
        // Footer
        printContent += '<div class="footer">';
        printContent += '<p>Generated by Foundation Health Analyzer</p>';
        printContent += '<p>' + new Date().toLocaleString() + '</p>';
        printContent += '</div>';
        
        printContent += '</body></html>';
        
        // Open print window
        var printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        
        // Auto print after a short delay
        setTimeout(function() {
            printWindow.print();
        }, 500);
    };
}
]]></client_script>
        <controller_as>c</controller_as>
        <css>/* FHA Analysis Results Page Styles */
.fha-results-page {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

/* Page Header */
.fha-results-header {
  background: linear-gradient(135deg, #0378BE 0%, #035B8E 100%);
  color: white;
  padding: 30px;
  border-radius: 12px;
  margin-bottom: 25px;
  box-shadow: 0 4px 15px rgba(3, 120, 190, 0.3);
}

.fha-results-header h1 {
  margin: 0 0 10px 0;
  font-weight: 600;
}

.fha-results-header .fha-table-code {
  opacity: 0.85;
}

.fha-results-header p {
  color: white;
  margin: 0;
}

/* Stats Row */
.fha-stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 25px;
}

.fha-stat-card {
  background: white;
  border-radius: 12px;
  padding: 25px;
  text-align: center;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  transition: box-shadow 0.2s ease;
}

.fha-stat-card:hover {
  box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}

.fha-stat-card.highlight {
  border: 2px solid #0378BE;
}

.fha-stat-value {
  font-size: 36px;
  font-weight: 700;
  margin-bottom: 5px;
}

.fha-stat-value.good { color: #28A745; }
.fha-stat-value.medium { color: #FFC107; }
.fha-stat-value.poor { color: #DC3545; }

.fha-stat-label {
  color: #666;
  font-size: 14px;
}

/* Health Score Circle */
.fha-health-circle {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 15px;
  font-size: 32px;
  font-weight: 700;
}

.fha-health-circle.good {
  background: rgba(40, 167, 69, 0.15);
  color: #28A745;
  border: 4px solid #28A745;
}

.fha-health-circle.medium {
  background: rgba(255, 193, 7, 0.15);
  color: #856404;
  border: 4px solid #FFC107;
}

.fha-health-circle.poor {
  background: rgba(220, 53, 69, 0.15);
  color: #DC3545;
  border: 4px solid #DC3545;
}

/* Tabs */
.fha-tabs-nav {
  display: flex;
  border-bottom: 2px solid #e9ecef;
  margin-bottom: 25px;
  gap: 5px;
}

/* Tab content */
.fha-tab-content {
  display: block;
  animation: fadeIn 0.2s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.fha-tab-btn {
  padding: 12px 24px;
  background: transparent;
  border: none;
  color: #666;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
  border-radius: 8px 8px 0 0;
}

.fha-tab-btn:hover {
  color: #0378BE;
  background: #f8f9fa;
}

.fha-tab-btn.active {
  color: #0378BE;
  border-bottom-color: #0378BE;
  font-weight: 600;
}

.fha-tab-btn .badge {
  margin-left: 8px;
  background: #0378BE;
  color: white;
  padding: 3px 8px;
  border-radius: 10px;
  font-size: 11px;
}

/* Cards */
.fha-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  margin-bottom: 20px;
  overflow: hidden;
  transition: box-shadow 0.2s ease;
}

.fha-card:hover {
  box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}

.fha-card-header {
  background: #f8f9fa;
  padding: 15px 20px;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.fha-card-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.fha-card-body {
  padding: 20px;
}

/* Section styles */
.fha-section {
  margin-bottom: 20px;
  border: 1px solid #e9ecef;
  border-radius: 12px;
  overflow: hidden;
  background: white;
}

.fha-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  cursor: pointer;
  transition: background 0.2s;
}

.fha-section-header:hover {
  background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
}

.fha-section-title {
  display: flex;
  align-items: center;
  gap: 10px;
}

.fha-section-title i {
  color: #0378BE;
  font-size: 18px;
}

.fha-section-title h5 {
  margin: 0;
  font-size: 15px;
  font-weight: 600;
}

.fha-section-count {
  background: #6c757d;
  color: white;
  padding: 3px 12px;
  border-radius: 15px;
  font-size: 12px;
}

.fha-section-actions {
  display: flex;
  align-items: center;
  gap: 15px;
}

/* Issues */
.fha-issue-item {
  display: flex;
  align-items: flex-start;
  padding: 12px 20px;
  border-bottom: 1px solid #f0f0f0;
  transition: background 0.15s;
}

.fha-issue-item:last-child {
  border-bottom: none;
}

.fha-issue-item:hover {
  background: #f8f9fa;
}

.fha-issue-severity {
  padding: 4px 12px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  margin-right: 12px;
  min-width: 65px;
  text-align: center;
}

.fha-severity-high { background: #DC3545; color: white; }
.fha-severity-medium { background: #FFC107; color: #333; }
.fha-severity-low { background: #17A2B8; color: white; }

.fha-issue-content { flex: 1; }
.fha-issue-code { font-weight: 600; color: #333; }
.fha-issue-message { color: #666; margin-top: 4px; font-size: 14px; }

/* Tables */
.fha-data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.fha-data-table th {
  text-align: left;
  padding: 10px 12px;
  background: #f8f9fa;
  font-weight: 600;
  color: #495057;
  border-bottom: 2px solid #e9ecef;
}

.fha-data-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #e9ecef;
}

.fha-data-table tr:hover {
  background: #f8f9fa;
}

.fha-data-table code {
  background: #e9ecef;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
}

/* Status badges */
.fha-status-badge {
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
}

.fha-status-badge.active { background: rgba(40, 167, 69, 0.15); color: #28A745; }
.fha-status-badge.inactive { background: rgba(108, 117, 125, 0.15); color: #6c757d; }

/* LDAP Stat Cards */
.fha-stat-card {
  padding: 20px;
  border-radius: 12px;
  color: white;
  text-align: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.fha-stat-number {
  font-size: 32px;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 5px;
}

.fha-stat-label {
  font-size: 13px;
  opacity: 0.9;
}

.fha-type-badge {
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 500;
  display: inline-block;
}

/* Type-specific colors for Automation */
.fha-type-badge.type-scheduled-job { background: #6f42c1; color: white; }
.fha-type-badge.type-flow { background: #0d6efd; color: white; }
.fha-type-badge.type-workflow { background: #0dcaf0; color: #000; }
.fha-type-badge.type-notification { background: #fd7e14; color: white; }
.fha-type-badge.type-ui-action { background: #20c997; color: white; }

/* Type-specific colors for Integration */
.fha-type-badge.type-data-source { background: #198754; color: white; }
.fha-type-badge.type-transform-map { background: #6610f2; color: white; }

/* Default type badge */
.fha-type-badge.type-default { background: #6c757d; color: white; }

/* Fill rate */
.fha-fill-rate {
  display: flex;
  align-items: center;
  gap: 10px;
}

.fha-fill-bar {
  height: 8px;
  border-radius: 4px;
  min-width: 5px;
  max-width: 100px;
}

.fha-fill-bar.good { background: #28A745; }
.fha-fill-bar.warning { background: #FFC107; }
.fha-fill-bar.danger { background: #DC3545; }

/* Buttons */
.fha-btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.fha-btn-primary {
  background: linear-gradient(135deg, #0378BE 0%, #035B8E 100%);
  color: white;
  box-shadow: 0 2px 8px rgba(3, 120, 190, 0.3);
}

.fha-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(3, 120, 190, 0.4);
}

.fha-btn-secondary {
  background: #6c757d;
  color: white;
}

.fha-btn-secondary:hover {
  background: #545b62;
}

.fha-btn-success {
  background: linear-gradient(135deg, #28A745 0%, #1e7e34 100%);
  color: white;
}

.fha-btn-success:hover {
  transform: translateY(-2px);
}

/* Link */
.fha-link {
  color: #0378BE;
  cursor: pointer;
  text-decoration: none;
}

.fha-link:hover {
  text-decoration: underline;
}

/* Metadata */
.fha-metadata {
  display: flex;
  gap: 20px;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.9);
  margin-top: 15px;
}

.fha-metadata i {
  margin-right: 5px;
  opacity: 0.8;
}

/* Actions panel */
.fha-actions-panel {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* Filter bar */
.fha-filter-bar {
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
  padding: 15px 20px;
  background: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
  border-radius: 8px 8px 0 0;
}

.fha-filter-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.fha-filter-group label {
  font-size: 12px;
  font-weight: 600;
  color: #495057;
  margin: 0;
}

.fha-filter-group select,
.fha-filter-group input {
  padding: 6px 12px;
  border: 1px solid #ced4da;
  border-radius: 6px;
  font-size: 13px;
  min-width: 120px;
}

.fha-filter-group select:focus,
.fha-filter-group input:focus {
  outline: none;
  border-color: #0378BE;
  box-shadow: 0 0 0 3px rgba(3, 120, 190, 0.15);
}

.fha-filter-search {
  flex: 1;
  min-width: 200px;
}

.fha-filter-search input {
  width: 100%;
}

.fha-filter-reset {
  padding: 6px 12px;
  background: transparent;
  border: 1px solid #6c757d;
  color: #6c757d;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.fha-filter-reset:hover {
  background: #6c757d;
  color: white;
}

.fha-filter-count {
  font-size: 12px;
  color: #6c757d;
  margin-left: auto;
}

/* Responsive */
@media (max-width: 992px) {
  .fha-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 576px) {
  .fha-stats-grid {
    grid-template-columns: 1fr;
  }
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_analysis_detail</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>FHA Analysis detail</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    // Get sys_id from URL parameter
    var sysId = $sp.getParameter('sys_id') || '';
    
    data.analysisId = sysId;
    data.result = null;
    data.error = null;
    
    if (sysId) {
        try {
            // Query directly by sys_id (not analysis_id)
            var gr = new GlideRecord('x_1310794_founda_0_fha_results');
            if (gr.get(sysId)) {
                // Parse detail_json for full metrics first
                var detailJson = {};
                try {
                    var detailStr = gr.getValue('detail_json');
                    if (detailStr) {
                        detailJson = JSON.parse(detailStr);
                    }
                } catch(e) {
                    // Ignore parse errors
                }
                
                // Get table name from reference field OR from detail_json
                var tableName = '';
                var tableLabel = '';
                
                // First try from reference field
                if (gr.table_name && !gr.table_name.nil()) {
                    var tableRef = gr.table_name.getRefRecord();
                    if (tableRef) {
                        tableName = tableRef.getValue('name') || '';
                        tableLabel = tableRef.getValue('label') || tableName;
                    }
                }
                
                // Fallback to detail_json if reference didn't work
                if (!tableName && detailJson.table_name) {
                    tableName = detailJson.table_name;
                    tableLabel = detailJson.table_label || detailJson.table_name;
                }
                
                data.result = {
                    sys_id: gr.getUniqueValue(),
                    number: gr.getValue('number'),
                    table_name: tableName,
                    table_label: tableLabel,
                    health_score: parseInt(gr.getValue('health_score'), 10) || 0,
                    issue_count: parseInt(gr.getValue('issue_found'), 10) || 0,
                    status: gr.getValue('status'),
                    created_on: gr.getValue('sys_created_on'),
                    created_by: gr.sys_created_by ? gr.sys_created_by.getDisplayValue() : '',
                    issues: detailJson.issues || [],
                    metrics: detailJson.metrics || {},
                    duration_ms: detailJson.metrics ? detailJson.metrics.duration_ms : 0
                };
        } else {
                data.error = 'Analysis record not found (sys_id: ' + sysId + ')';
        }
        } catch(e) {
            data.error = 'Error loading analysis: ' + e.message;
        }
    } else {
        data.error = 'No analysis ID provided. Please access this page from the dashboard.';
    }
})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-03 22:38:44</sys_created_on>
        <sys_id>3ee88bd48312f21083e1b4a6feaad39a</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>FHA Analysis detail</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_3ee88bd48312f21083e1b4a6feaad39a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-03 22:38:44</sys_updated_on>
        <template><![CDATA[<div class="fha-results-page">
  
  <!-- Page Header -->
  <div class="fha-results-header">
    <h1><i class="fa fa-chart-bar"></i> ${Analysis Results}</h1>
    <p ng-if="c.result">
      ${Detailed analysis of table:} <strong>{{c.result.table_label || c.result.table_name}}</strong>
      <span class="fha-table-code">({{c.result.table_name}})</span>
    </p>
    <div class="fha-metadata" ng-if="c.result">
      <span><i class="fa fa-hashtag"></i> {{c.result.number}}</span>
      <span><i class="fa fa-calendar"></i> {{c.result.created_on}}</span>
      <span><i class="fa fa-user"></i> {{c.result.created_by}}</span>
      <span><i class="fa fa-clock-o"></i> {{c.result.duration_ms}}ms</span>
    </div>
  </div>

  <!-- Error Message -->
  <div class="alert alert-danger" ng-if="c.error" style="margin-bottom: 20px;">
    <i class="fa fa-exclamation-triangle"></i> {{c.error}}
    <button class="fha-btn fha-btn-secondary" ng-click="c.goBack()" style="margin-left: 20px;">
      <i class="fa fa-arrow-left"></i> ${Back to Dashboard}
    </button>
  </div>

  <!-- Loading State -->
  <div ng-if="c.loading && !c.error" style="text-align: center; padding: 80px;">
        <i class="fa fa-spinner fa-spin fa-3x" style="color: #0378BE;"></i>
    <h3 style="margin-top: 20px; color: #666;">${Loading analysis results...}</h3>
  </div>

  <!-- Main Content -->
  <div ng-if="c.result && !c.loading">
    
    <!-- Stats Grid -->
    <div class="fha-stats-grid">
      <div class="fha-stat-card highlight">
        <div class="fha-health-circle" ng-class="c.getHealthScoreClass(c.result.health_score)">
          {{c.result.health_score}}
        </div>
        <div class="fha-stat-label">${Health Score}</div>
          </div>
      <div class="fha-stat-card">
        <div class="fha-stat-value" ng-class="c.countBySeverity('high') > 0 ? 'poor' : 'good'">
          {{c.countBySeverity('high')}}
          </div>
        <div class="fha-stat-label">${High Severity Issues}</div>
      </div>
      <div class="fha-stat-card">
        <div class="fha-stat-value medium">{{c.countBySeverity('medium')}}</div>
        <div class="fha-stat-label">${Medium Severity Issues}</div>
          </div>
      <div class="fha-stat-card">
        <div class="fha-stat-value" style="color: #17A2B8;">{{c.countBySeverity('low')}}</div>
        <div class="fha-stat-label">${Low Severity Issues}</div>
        </div>
      </div>
      
    <!-- Actions Bar -->
      <div class="fha-card">
        <div class="fha-card-body">
        <div class="fha-actions-panel">
          <button class="fha-btn fha-btn-primary" ng-click="c.exportPDF()">
            <i class="fa fa-file-pdf-o"></i> ${Export PDF}
          </button>
          <button class="fha-btn fha-btn-secondary" ng-click="c.exportJSON()">
            <i class="fa fa-download"></i> ${Export JSON}
          </button>
        </div>
      </div>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="fha-tabs-nav">
      <button class="fha-tab-btn" ng-class="{'active': c.activeTab === 'overview'}" ng-click="c.setActiveTab('overview')">
        <i class="fa fa-th-large"></i> ${Overview}
      </button>
      <button class="fha-tab-btn" ng-class="{'active': c.activeTab === 'issues'}" ng-click="c.setActiveTab('issues')">
        <i class="fa fa-exclamation-circle"></i> ${Issues}
        <span class="badge">{{c.result.issues.length}}</span>
      </button>
      <button class="fha-tab-btn" ng-class="{'active': c.activeTab === 'fields'}" ng-click="c.setActiveTab('fields')">
        <i class="fa fa-columns"></i> ${Fields}
        <span class="badge">{{c.getCustomFields().length}}</span>
      </button>
      <button class="fha-tab-btn" ng-class="{'active': c.activeTab === 'automation'}" ng-click="c.setActiveTab('automation')">
        <i class="fa fa-cogs"></i> ${Automation}
        <span class="badge">{{c.getAutomationItems().length}}</span>
      </button>
      <button class="fha-tab-btn" ng-class="{'active': c.activeTab === 'integration'}" ng-click="c.setActiveTab('integration')">
        <i class="fa fa-exchange"></i> ${Integrations}
        <span class="badge">{{c.getIntegrationItems().length}}</span>
      </button>
      <button class="fha-tab-btn" ng-class="{'active': c.activeTab === 'ldap'}" ng-click="c.setActiveTab('ldap')" ng-if="c.hasLdapAnalysis()">
        <i class="fa fa-address-book"></i> ${LDAP}
        <span class="badge">{{c.getLdapAttributeMappings().length}}</span>
      </button>
    </div>

    <!-- ==================== OVERVIEW TAB ==================== -->
    <div class="fha-tab-content" ng-show="c.activeTab === 'overview'">
      <div class="row">
        <div class="col-md-6">
      <div class="fha-card">
        <div class="fha-card-header">
              <h4><i class="fa fa-table"></i> ${Table Information}</h4>
        </div>
        <div class="fha-card-body">
              <table class="fha-data-table">
                <tr>
                  <td><strong>${Table Name}</strong></td>
                  <td><code>{{c.result.table_name}}</code></td>
                </tr>
                <tr>
                  <td><strong>${Table Label}</strong></td>
                  <td>{{c.result.table_label}}</td>
                </tr>
                <tr>
                  <td><strong>${Record Count}</strong></td>
                  <td>{{c.getMetrics().record_count || 'N/A'}}</td>
                </tr>
                <tr>
                  <td><strong>${Custom Fields}</strong></td>
                  <td>{{c.getMetrics().custom_field_count || 0}}</td>
                </tr>
                <tr>
                  <td><strong>${Business Rules}</strong></td>
                  <td>{{(c.getMetrics().active_br_count || 0) + (c.getMetrics().inactive_br_count || 0)}} ({{c.getMetrics().active_br_count || 0}} ${active})</td>
                </tr>
              </table>
              </div>
            </div>
          </div>
        <div class="col-md-6">
          <div class="fha-card">
            <div class="fha-card-header">
              <h4><i class="fa fa-pie-chart"></i> ${Issues Summary}</h4>
            </div>
            <div class="fha-card-body">
              <table class="fha-data-table">
                <tr>
                  <td><strong>${Total Issues}</strong></td>
                  <td>{{c.result.issues.length}}</td>
                </tr>
                <tr>
                  <td><span class="fha-issue-severity fha-severity-high">HIGH</span></td>
                  <td>{{c.countBySeverity('high')}}</td>
                </tr>
                <tr>
                  <td><span class="fha-issue-severity fha-severity-medium">MEDIUM</span></td>
                  <td>{{c.countBySeverity('medium')}}</td>
                </tr>
                <tr>
                  <td><span class="fha-issue-severity fha-severity-low">LOW</span></td>
                  <td>{{c.countBySeverity('low')}}</td>
                </tr>
              </table>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- ==================== ISSUES TAB ==================== -->
    <div class="fha-tab-content" ng-show="c.activeTab === 'issues'">
      <div class="fha-card" ng-if="c.result.issues.length > 0">
        <div class="fha-card-header">
          <h4><i class="fa fa-exclamation-circle"></i> ${All Issues} ({{c.result.issues.length}})</h4>
        </div>
        <div class="fha-card-body" style="padding: 0;">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th width="100">${Severity}</th>
                <th width="150">${Category}</th>
                <th width="200">${Code}</th>
                <th>${Message}</th>
                <th width="80">${Action}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="issue in c.result.issues | orderBy:['-severity']">
                <td>
                  <span class="fha-issue-severity" ng-class="'fha-severity-' + issue.severity">
                    {{issue.severity}}
                  </span>
                </td>
                <td><span class="fha-type-badge">{{issue.category || 'general'}}</span></td>
                <td><strong>{{issue.code}}</strong></td>
                <td>{{issue.message}}</td>
                <td>
                  <a class="fha-link" ng-if="issue.record_sys_id" 
                     ng-click="c.openRecord(issue.record_table, issue.record_sys_id)">
                    <i class="fa fa-external-link"></i>
                  </a>
                  <a class="fha-link" ng-if="issue.record_filter && !issue.record_sys_id" 
                     ng-click="c.openList(issue.record_table, issue.record_filter)">
                    <i class="fa fa-list"></i>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        </div>
      <div class="fha-card" ng-if="c.result.issues.length === 0">
        <div class="fha-card-body" style="text-align: center; padding: 50px;">
          <i class="fa fa-check-circle fa-3x" style="color: #28A745;"></i>
          <h3 style="margin-top: 15px; color: #28A745;">${No Issues Found!}</h3>
          <p style="color: #666;">${This table is in excellent health.}</p>
      </div>
    </div>
  </div>

    <!-- ==================== FIELDS TAB ==================== -->
    <div class="fha-tab-content" ng-show="c.activeTab === 'fields'">
      <div class="fha-card">
        <div class="fha-card-header">
          <h4><i class="fa fa-columns"></i> ${Custom Fields} ({{c.getCustomFields().length}})</h4>
          </div>
        <div class="fha-card-body" style="padding: 0;" ng-if="c.getCustomFields().length > 0">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th>${Field Name}</th>
                <th>${Label}</th>
                <th>${Type}</th>
                <th>${Fill Rate}</th>
                <th>${Mandatory}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="field in c.getCustomFields()" 
                  ng-class="{'fha-row-warning': field.fill_rate < 10 && field.fill_rate > 0, 'fha-row-danger': field.fill_rate === 0}">
                <td><code>{{field.name}}</code></td>
                <td>{{field.label}}</td>
                <td><span class="fha-type-badge">{{field.type}}</span></td>
                <td>
                  <div class="fha-fill-rate">
                    <div class="fha-fill-bar" 
                         ng-style="{'width': (field.fill_rate || 0) + 'px'}"
                         ng-class="{'danger': field.fill_rate === 0, 'warning': field.fill_rate > 0 && field.fill_rate < 10, 'good': field.fill_rate >= 10}">
                    </div>
                    <span>{{field.fill_rate}}%</span>
                  </div>
                </td>
                <td>
                  <span class="fha-status-badge" ng-class="field.mandatory ? 'active' : 'inactive'">
                    {{field.mandatory ? '${Yes}' : '${No}'}}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="fha-card-body" ng-if="c.getCustomFields().length === 0" style="text-align: center; padding: 40px; color: #666;">
          <i class="fa fa-info-circle fa-2x"></i>
          <p style="margin-top: 10px;">${No custom fields found on this table.}</p>
      </div>
    </div>
  </div>

    <!-- ==================== AUTOMATION TAB ==================== -->
    <div class="fha-tab-content" ng-show="c.activeTab === 'automation'">
      <div class="fha-card">
        <div class="fha-card-header">
          <h4><i class="fa fa-cogs"></i> ${Automation Items} ({{c.getAutomationItems().length}})</h4>
          </div>
        
        <!-- Filter Bar -->
        <div class="fha-filter-bar" ng-if="c.getAutomationItems().length > 0">
          <div class="fha-filter-group">
            <label>${Type}:</label>
            <select ng-model="c.automationFilter.type">
              <option value="all">${All Types}</option>
              <option ng-repeat="type in c.getAutomationTypes()" value="{{type}}">{{type}}</option>
            </select>
        </div>
          <div class="fha-filter-group">
            <label>${Status}:</label>
            <select ng-model="c.automationFilter.status">
              <option value="all">${All}</option>
              <option value="active">${Active}</option>
              <option value="inactive">${Inactive}</option>
            </select>
            </div>
          <div class="fha-filter-group fha-filter-search">
            <label>${Search}:</label>
            <input type="text" ng-model="c.automationFilter.search" placeholder="${Filter by name...}">
          </div>
          <button class="fha-filter-reset" ng-click="c.resetAutomationFilter()">
            <i class="fa fa-refresh"></i> ${Reset}
                </button>
          <span class="fha-filter-count">
            {{c.getFilteredAutomationItems().length}} / {{c.getAutomationItems().length}} ${items}
                  </span>
              </div>
        
        <div class="fha-card-body" style="padding: 0;" ng-if="c.getAutomationItems().length > 0">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th width="150">${Type}</th>
                <th>${Name}</th>
                <th width="100">${Status}</th>
                <th width="80">${Action}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="item in c.getFilteredAutomationItems()" ng-class="{'fha-row-inactive': !item.active}">
                <td><span class="fha-type-badge" ng-class="c.getTypeBadgeClass(item.type)">{{item.type}}</span></td>
                <td>{{item.name}}</td>
                <td>
                  <span class="fha-status-badge" ng-class="item.active ? 'active' : 'inactive'">
                    {{item.active ? '${Active}' : '${Inactive}'}}
                  </span>
                </td>
                <td>
                  <a class="fha-link" ng-click="c.openRecord(item.table, item.sys_id)" ng-if="item.sys_id">
                    <i class="fa fa-external-link"></i>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
            </div>
        <div class="fha-card-body" ng-if="c.getAutomationItems().length === 0" style="text-align: center; padding: 40px; color: #666;">
          <i class="fa fa-info-circle fa-2x"></i>
          <p style="margin-top: 10px;">${No automation items found for this table.}</p>
              </div>
            </div>
          </div>

    <!-- ==================== INTEGRATIONS TAB ==================== -->
    <div class="fha-tab-content" ng-show="c.activeTab === 'integration'">
      <div class="fha-card">
        <div class="fha-card-header">
          <h4><i class="fa fa-exchange"></i> ${Integration Items} ({{c.getIntegrationItems().length}})</h4>
        </div>
        
        <!-- Filter Bar -->
        <div class="fha-filter-bar" ng-if="c.getIntegrationItems().length > 0">
          <div class="fha-filter-group">
            <label>${Type}:</label>
            <select ng-model="c.integrationFilter.type">
              <option value="all">${All Types}</option>
              <option ng-repeat="type in c.getIntegrationTypes()" value="{{type}}">{{type}}</option>
            </select>
      </div>
          <div class="fha-filter-group">
            <label>${Status}:</label>
            <select ng-model="c.integrationFilter.status">
              <option value="all">${All}</option>
              <option value="active">${Active}</option>
              <option value="inactive">${Inactive}</option>
            </select>
    </div>
          <div class="fha-filter-group fha-filter-search">
            <label>${Search}:</label>
            <input type="text" ng-model="c.integrationFilter.search" placeholder="${Filter by name...}">
  </div>
          <button class="fha-filter-reset" ng-click="c.resetIntegrationFilter()">
            <i class="fa fa-refresh"></i> ${Reset}
        </button>
          <span class="fha-filter-count">
            {{c.getFilteredIntegrationItems().length}} / {{c.getIntegrationItems().length}} ${items}
          </span>
      </div>
        
        <div class="fha-card-body" style="padding: 0;" ng-if="c.getIntegrationItems().length > 0">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th width="150">${Type}</th>
                <th>${Name}</th>
                <th width="100">${Status}</th>
                <th width="80">${Action}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="item in c.getFilteredIntegrationItems()" ng-class="{'fha-row-inactive': !item.active}">
                <td><span class="fha-type-badge" ng-class="c.getTypeBadgeClass(item.type)">{{item.type}}</span></td>
                <td>{{item.name}}</td>
                <td>
                  <span class="fha-status-badge" ng-class="item.active ? 'active' : 'inactive'">
                    {{item.active ? '${Active}' : '${Inactive}'}}
                  </span>
                </td>
                <td>
                  <a class="fha-link" ng-click="c.openRecord(item.table, item.sys_id)" ng-if="item.sys_id">
                    <i class="fa fa-external-link"></i>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
  </div>
        <div class="fha-card-body" ng-if="c.getIntegrationItems().length === 0" style="text-align: center; padding: 40px; color: #666;">
          <i class="fa fa-info-circle fa-2x"></i>
          <p style="margin-top: 10px;">${No integration items found for this table.}</p>
      </div>
    </div>
  </div>

    <!-- ==================== LDAP TAB ==================== -->
    <div class="fha-tab-content" ng-show="c.activeTab === 'ldap'">
      
      <!-- LDAP Summary Cards -->
      <div class="row" style="margin-bottom: 20px;">
        <div class="col-md-3">
          <div class="fha-stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="fha-stat-number">{{c.getLdapDataSources().length}}</div>
            <div class="fha-stat-label">${LDAP Data Sources}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="fha-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="fha-stat-number">{{c.getLdapTransformMaps().length}}</div>
            <div class="fha-stat-label">${Transform Maps}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="fha-stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="fha-stat-number">{{c.getLdapAttributeMappings().length}}</div>
            <div class="fha-stat-label">${Attribute Mappings}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="fha-stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <div class="fha-stat-number">{{c.getLdapServers().length}}</div>
            <div class="fha-stat-label">${LDAP Servers}</div>
          </div>
        </div>
      </div>

      <!-- LDAP Issues -->
      <div class="fha-card" ng-if="c.getLdapIssues().length > 0" style="margin-bottom: 20px;">
        <div class="fha-card-header" style="background: #fef3c7;">
          <h4><i class="fa fa-exclamation-triangle" style="color: #d97706;"></i> ${LDAP Issues} ({{c.getLdapIssues().length}})</h4>
        </div>
        <div class="fha-card-body" style="padding: 0;">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th width="120">${Severity}</th>
                <th>${Message}</th>
                <th width="80">${Action}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="issue in c.getLdapIssues()">
                <td><span class="fha-issue-severity" ng-class="'fha-severity-' + issue.severity">{{issue.severity | uppercase}}</span></td>
                <td>{{issue.message}}</td>
                <td>
                  <a class="fha-link" ng-click="c.openRecord(issue.record_table, issue.record_sys_id)" ng-if="issue.record_sys_id">
                    <i class="fa fa-external-link"></i>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- LDAP Data Sources -->
      <div class="fha-card" style="margin-bottom: 20px;">
        <div class="fha-card-header">
          <h4><i class="fa fa-database"></i> ${LDAP Data Sources}</h4>
        </div>
        <div class="fha-card-body" style="padding: 0;" ng-if="c.getLdapDataSources().length > 0">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th>${Name}</th>
                <th>${Import Set Table}</th>
                <th>${Last Run}</th>
                <th width="100">${Status}</th>
                <th width="80">${Action}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="ds in c.getLdapDataSources()" ng-class="{'fha-row-inactive': !ds.active}">
                <td><strong>{{ds.name}}</strong></td>
                <td><code>{{ds.import_set_table}}</code></td>
                <td>{{ds.last_run || 'Never'}}</td>
                <td>
                  <span class="fha-status-badge" ng-class="ds.active ? 'active' : 'inactive'">
                    {{ds.active ? '${Active}' : '${Inactive}'}}
                  </span>
                </td>
                <td>
                  <a class="fha-link" ng-click="c.openRecord('sys_data_source', ds.sys_id)">
                    <i class="fa fa-external-link"></i>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="fha-card-body" ng-if="c.getLdapDataSources().length === 0" style="text-align: center; padding: 30px; color: #666;">
          <i class="fa fa-info-circle"></i> ${No LDAP data sources found}
        </div>
      </div>

      <!-- LDAP Transform Maps -->
      <div class="fha-card" style="margin-bottom: 20px;">
        <div class="fha-card-header">
          <h4><i class="fa fa-random"></i> ${LDAP Transform Maps}</h4>
        </div>
        <div class="fha-card-body" style="padding: 0;" ng-if="c.getLdapTransformMaps().length > 0">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th>${Name}</th>
                <th>${Source Table}</th>
                <th>${Target Table}</th>
                <th>${Coalesce Field}</th>
                <th>${Field Maps}</th>
                <th width="100">${Status}</th>
                <th width="80">${Action}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="tm in c.getLdapTransformMaps()" ng-class="{'fha-row-inactive': !tm.active}">
                <td><strong>{{tm.name}}</strong></td>
                <td><code>{{tm.source_table}}</code></td>
                <td><code>{{tm.target_table}}</code></td>
                <td>{{tm.coalesce_field || '-'}}</td>
                <td><span class="badge">{{tm.field_maps.length}}</span></td>
                <td>
                  <span class="fha-status-badge" ng-class="tm.active ? 'active' : 'inactive'">
                    {{tm.active ? '${Active}' : '${Inactive}'}}
                  </span>
                </td>
                <td>
                  <a class="fha-link" ng-click="c.openRecord('sys_transform_map', tm.sys_id)">
                    <i class="fa fa-external-link"></i>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="fha-card-body" ng-if="c.getLdapTransformMaps().length === 0" style="text-align: center; padding: 30px; color: #666;">
          <i class="fa fa-info-circle"></i> ${No LDAP transform maps found}
        </div>
      </div>

      <!-- LDAP Attribute Mappings -->
      <div class="fha-card">
        <div class="fha-card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h4><i class="fa fa-arrows-h"></i> ${LDAP Attribute Mappings}</h4>
          <div class="fha-filter-group fha-filter-search" style="margin: 0;" ng-if="c.getLdapAttributeMappings().length > 5">
            <input type="text" ng-model="c.ldapFilter.search" placeholder="${Search attributes...}" style="width: 200px;">
          </div>
        </div>
        <div class="fha-card-body" style="padding: 0;" ng-if="c.getLdapAttributeMappings().length > 0">
          <table class="fha-data-table">
            <thead>
              <tr>
                <th>${LDAP Attribute}</th>
                <th><i class="fa fa-arrow-right"></i></th>
                <th>${ServiceNow Field}</th>
                <th>${Transform Map}</th>
                <th>${Coalesce}</th>
                <th>${Uses Script}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="m in c.getFilteredLdapMappings()">
                <td><code style="background: #e0f2fe; color: #0369a1;">{{m.ldap_attribute}}</code></td>
                <td style="text-align: center; color: #9ca3af;"><i class="fa fa-arrow-right"></i></td>
                <td><code style="background: #dcfce7; color: #166534;">{{m.servicenow_field}}</code></td>
                <td>{{m.transform_map}}</td>
                <td>
                  <span ng-if="m.coalesce" style="color: #059669;"><i class="fa fa-check"></i></span>
                  <span ng-if="!m.coalesce" style="color: #9ca3af;">-</span>
                </td>
                <td>
                  <span ng-if="m.uses_script" style="color: #d97706;"><i class="fa fa-code"></i> ${Yes}</span>
                  <span ng-if="!m.uses_script" style="color: #9ca3af;">-</span>
                </td>
              </tr>
            </tbody>
          </table>
          <div style="padding: 10px 15px; background: #f8fafc; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">
            ${Showing} {{c.getFilteredLdapMappings().length}} ${of} {{c.getLdapAttributeMappings().length}} ${attribute mappings}
          </div>
        </div>
        <div class="fha-card-body" ng-if="c.getLdapAttributeMappings().length === 0" style="text-align: center; padding: 30px; color: #666;">
          <i class="fa fa-info-circle"></i> ${No LDAP attribute mappings found}
        </div>
      </div>

    </div>

  </div>
</div>
]]></template>
    </sp_widget>
</record_update>
