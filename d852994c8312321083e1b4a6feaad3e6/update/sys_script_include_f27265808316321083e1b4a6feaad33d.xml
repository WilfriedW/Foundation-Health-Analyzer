<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHAnalyzer</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Foundation Health Analyzer main class</description>
        <mobile_callable>false</mobile_callable>
        <name>FHAnalyzer</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[/**
 * FHAnalyzer - Main analysis engine for Foundation Health Assessment
 * This script include contains all core logic for table analysis
 */
var FHAnalyzer = Class.create();
FHAnalyzer.prototype = {
    initialize: function() {
        this.resultsTable = 'x_1310794_founda_0_fha_results';
        this.configTable = 'x_1310794_founda_0_fha_configuration';
        this.logPrefix = '[FHA] ';
    },

    /**
     * Check if a value is truthy (handles 'true', '1', true, 1)
     * @private
     * @param {*} val - Value to check
     * @returns {Boolean} True if value is truthy
     */
    _isTrue: function(val) {
        return val === 'true' || val === '1' || val === true || val === 1;
    },

    /**
     * Get the table name from the table_reference field
     * @private
     * @param {GlideRecord} gr - Configuration GlideRecord
     * @returns {String} Table name or empty string
     */
    _getTableInfoFromReference: function(gr) {
        var tableRef = gr.table_reference;
        if (tableRef && !tableRef.nil()) {
            var tableGr = tableRef.getRefRecord();
            if (tableGr) {
                return {
                    name: tableGr.getValue('name') || '',
                    label: tableGr.getValue('label') || tableGr.getValue('name') || '',
                    sys_id: tableGr.getUniqueValue()
                };
            }
        }
        return {
            name: '',
            label: '',
            sys_id: ''
        };
    },

    /**
     * Get all available tables for analysis
     * @returns {Array} Array of table configurations
     */
    getAvailableAnalyses: function() {
        var tables = [];
        var gr = new GlideRecord(this.configTable);
        gr.addQuery('active', true);
        gr.orderBy('name');
        gr.query();

        while (gr.next()) {
            var tableInfo = this._getTableInfoFromReference(gr);
            tables.push({
                config_sys_id: gr.sys_id.toString(),
                display_name: gr.getValue('name') || '',
                table_name: tableInfo.name,
                table_label: tableInfo.label,
                table_ref: tableInfo.table_reference.sys_id.toString(),
                description: gr.getValue('description') || ''
            });
        }

        return tables;
    },

    /**
     * Get analysis configuration by sys_id
     * @param {String} configSysId - Configuration sys_id
     * @returns {Object} Configuration object or null
     */
    getAnalysisConfiguration: function(configSysId) {
        var gr = new GlideRecord(this.configTable);
        if (gr.get(configSysId)) {
            var tableInfo = this._getTableInfoFromReference(gr);
            return {
                sys_id: gr.sys_id.toString(),
                name: gr.getValue('name') || '',
                table_name: tableInfo.name,
                table_label: tableInfo.label,
                table_sys_id: tableInfo.sys_id,
                description: gr.getValue('description') || '',
                active: this._isTrue(gr.getValue('active')),
                include_children_tables: this._isTrue(gr.getValue('include_children_tables')),
                analyze_references: this._isTrue(gr.getValue('analyze_references')),
                deep_scan: this._isTrue(gr.getValue('deep_scan')),
				ignore_servicenow_records: this._isTrue(gr.getValue('ignore_servicenow_records')),
                include_ldap: this._isTrue(gr.getValue('include_ldap'))
				
            };
        }
        return null;
    },
    /**
     * getAnalysisResult(sysId)
     */
    getAnalysisResult: function(sysId) {
        if (!sysId) {
            return {
                success: false,
                error: 'Missing analysis sys_id'
            };
        }
        var gr = new GlideRecord(this.resultsTable);
        if (!gr.get(sysId)) {
            return {
                success: false,
                error: 'Analysis not found'
            };
        }
        var resultObj = null;
        try {
            var detailJson = gr.getValue('detail_json') || '';
            resultObj = detailJson ? JSON.parse(detailJson) : {};
        } catch (e) {
            return {
                success: false,
                error: 'Invalid detail_json: ' + e.message
            };
        }

        // ComplÃ©ter quelques champs utiles (fallback)
        resultObj.table_name = resultObj.table_name || (gr.table_name && gr.table_name.getRefRecord ? (gr.table_name.getRefRecord().getValue('name') || '') : '');
        resultObj.table_label = resultObj.table_label || (gr.table_name && gr.table_name.getRefRecord ? (gr.table_name.getRefRecord().getValue('label') || '') : '');
        resultObj.number = resultObj.number || gr.getValue('number') || '';
        resultObj.health_score = resultObj.health_score || parseInt(gr.getValue('health_score'), 10) || 0;
        resultObj.issue_found = resultObj.issue_found || parseInt(gr.getValue('issue_found'), 10) || 0;
        resultObj.created_on = resultObj.created_on || gr.getValue('sys_created_on') || '';
        resultObj.created_by = resultObj.created_by || gr.getValue('sys_created_by') || '';

        return {
            success: true,
            result: resultObj
        };
    },

    /**
     * Run analysis for a specific configuration
     * @param {String} configSysId - Configuration sys_id
     * @param {Object} parameters - Analysis parameters
     * @returns {Object} Analysis result
     */
    runAnalysis: function(configSysId, parameters) {
        var config = this.getAnalysisConfiguration(configSysId);
        if (!config) {
            return {
                success: false,
                error: 'Invalid configuration'
            };
        }

        var engine = new FHAnalysisEngine();
        var engineResult = engine.run(config);

        // Save result to database
        var resultSysId = this._saveResult(config, engineResult, parameters);

        return {
            success: true,
            analysis_id: resultSysId,
            sys_id: resultSysId,
            details: engineResult
        };
    },


    /**
     * Save analysis result to database
     * @private
     * @param {Object} config - Analysis configuration
     * @param {Object} result - Analysis result
     * @param {Object} parameters - Analysis parameters
     * @returns {String} Result sys_id
     */
    _saveResult: function(config, result, parameters) {
        var gr = new GlideRecord(this.resultsTable);
        gr.initialize();

        // Set table_name reference (sys_db_object)
        gr.setValue('table_name', config.table_sys_id);

        // Set status
        gr.setValue('status', 'completed');

        // Calculate and set health score
        var healthScore = this._calculateHealthScore(result);
        gr.setValue('health_score', healthScore);

        // Set issue count
        var issueCount = result.issues ? result.issues.length : 0;
        gr.setValue('issue_found', issueCount);

        // Store full details as JSON in detail_json field
        var detailObj = {
            issues: result.issues || [],
            categories: result.categories || {},
            execution_metadata: result.execution_metadata || {},
            options: config
        };
        gr.setValue('detail_json', JSON.stringify(detailObj));

        var sysId = gr.insert();
        if (sysId) {
            return sysId.toString();
        }

        throw new Error('Failed to save analysis result');
    },

    /**
     * Calculate health score based on issues
     * @private
     * @param {Object} result - Analysis result
     * @returns {Number} Health score (0-100)
     */
    _calculateHealthScore: function(result) {
        if (!result || !result.issues) return 100;

        var score = 100;
        result.issues.forEach(function(issue) {
            if (issue.severity === 'high') score -= 15;
            else if (issue.severity === 'medium') score -= 5;
            else score -= 2;
        });

        return Math.max(0, Math.min(100, score));
    },

    type: 'FHAnalyzer'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-02 20:33:51</sys_created_on>
        <sys_id>f27265808316321083e1b4a6feaad33d</sys_id>
        <sys_mod_count>48</sys_mod_count>
        <sys_name>FHAnalyzer</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_f27265808316321083e1b4a6feaad33d</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-05 04:29:42</sys_updated_on>
    </sys_script_include>
</record_update>
