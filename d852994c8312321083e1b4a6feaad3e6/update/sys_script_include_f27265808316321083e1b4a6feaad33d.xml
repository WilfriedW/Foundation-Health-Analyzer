<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHAnalyzer</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Foundation Health Analyzer main class</description>
        <mobile_callable>false</mobile_callable>
        <name>FHAnalyzer</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var FHAnalyzer = Class.create();
FHAnalyzer.prototype = {
    TABLES: {
        RESULTS: 'x_1310794_founda_0_results',
        CONFIGURATIONS: 'x_1310794_founda_0_configurations',
        TEMPLATES: 'x_1310794_founda_0_analysis_templates',
        VERIFICATION_ITEMS: 'x_1310794_founda_0_verification_items',
        ISSUE_RULES: 'x_1310794_founda_0_issue_rules'
    },

    initialize: function() {},

    runAnalysis: function(configSysId) {
        var config = this.getConfiguration(configSysId);
        var engineResult = new FHAnalysisEngine().runVerification(config);
        var structuredResult = this._buildResultStructure(config, engineResult);
        var resultSysId = this._saveResult(structuredResult);
        return {
            success: true,
            analysis_id: resultSysId,
            sys_id: resultSysId,
            details: structuredResult
        };
    },

    getConfiguration: function(configSysId) {
        var gr = new GlideRecord(this.TABLES.CONFIGURATIONS);
        if (!gr.get(configSysId)) {
            gs.error('[FHAnalyzer] Configuration not found: ' + configSysId);
            return null;
        }

        var viIds = '';
        if (gr.use_template && gr.getValue('template')) {
            var template = new GlideRecord(this.TABLES.TEMPLATES);
            if (template.get(gr.getValue('template'))) {
                viIds = template.getValue('verification_items') || '';
            } else {
                gs.error('[FHAnalyzer] Template not found: ' + gr.getValue('template'));
            }
        } else {
            viIds = gr.getValue('verification_items') || '';
        }

        var configObj = this._buildConfigObj(gr);
        if (!viIds) {
            gs.warn('[FHAnalyzer] No verification items found');
            return configObj;
        }

        var utils = new FHAUtils();
        var verificationItems = new GlideRecord(this.TABLES.VERIFICATION_ITEMS);
        verificationItems.addQuery('sys_id', 'IN', viIds);
        verificationItems.addQuery('active', true);
        verificationItems.query();

        while (verificationItems.next()) {
            var viSysId = verificationItems.sys_id.toString();
            var viTableName = verificationItems.table.name + '' || '';

            var itemObj = {
                sys_id: viSysId,
                name: verificationItems.name.toString(),
                active: Boolean(verificationItems.active),
                category: verificationItems.category + '',
                tableSysid: verificationItems.table + '',
                tableName: viTableName,
                query_type: verificationItems.query_type + '',
                fields: verificationItems.fields + '' || '',
                metadata: verificationItems.metadata + '' || '',
                query_value: verificationItems.query_value + '',
                query_script: verificationItems.query_script + '',
                issue_rules: this._getIssueRulesForVI(viSysId)
            };

            // Delegate metadata to FHAUtils (single source of truth)
            itemObj.metadata = utils.buildMetadata(itemObj.metadata, itemObj.name, itemObj.tableName, itemObj.category);
            configObj.verification_items.push(itemObj);
        }

        return configObj;
    },

    _buildConfigObj: function(gr) {
        return {
            sys_id: gr.sys_id.toString(),
            name: gr.name.toString(),
            active: Boolean(gr.active),
            table_name: gr.table.name || '',
            table_label: gr.table.label || '',
            table_sys_id: gr.table.sys_id || '',
            description: gr.description || '',
            include_children_tables: gr.include_children_tables,
            deep_scan: gr.deep_scan,
            ignore_servicenow_records: gr.ignore_servicenow_records,
            include_ldap: gr.include_ldap,
            verification_items: []
        };
    },

    _getIssueRulesForVI: function(viSysId) {
        var ruleIds = [];
        var rules = new GlideRecord(this.TABLES.ISSUE_RULES);
        rules.addQuery('verification_items', 'CONTAINS', viSysId);
        rules.addQuery('active', true);
        rules.query();
        while (rules.next()) {
            ruleIds.push(rules.getUniqueValue());
        }
        return ruleIds.join(',');
    },

    _buildResultStructure: function(config, result) {
        return {
            configuration: {
                sys_id: config.sys_id,
                name: config.name,
                table_name: config.table_name,
                table_label: config.table_label,
                description: config.description,
                options: {
                    deep_scan: config.deep_scan,
                    include_children_tables: config.include_children_tables,
                    ignore_servicenow_records: config.ignore_servicenow_records,
                    include_ldap: config.include_ldap
                },
                verification_items: (config.verification_items || []).map(function(vi) {
                    return {
                        sys_id: vi.sys_id, name: vi.name, category: vi.category,
                        table_name: vi.tableName, query_type: vi.query_type,
                        query_value: vi.query_value, issue_rules: vi.issue_rules
                    };
                })
            },
            result: {
                success: result.success,
                health_score: result.health_score || 0,
                issues_high: result.issues_high || 0,
                issues_medium: result.issues_medium || 0,
                issues_low: result.issues_low || 0,
                issue_count: result.issue_count || 0,
                record_count: result.record_count || 0,
                issues: result.issues || [],
                errors: result.errors || []
            }
        };
    },

    _saveResult: function(structuredResult) {
        var gr = new GlideRecord(this.TABLES.RESULTS);
        gr.initialize();
        gr.setValue('state', 'Completed');
        gr.setValue('details', JSON.stringify(structuredResult));
        return gr.insert();
    },

    type: 'FHAnalyzer'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-02 20:33:51</sys_created_on>
        <sys_id>f27265808316321083e1b4a6feaad33d</sys_id>
        <sys_mod_count>112</sys_mod_count>
        <sys_name>FHAnalyzer</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_f27265808316321083e1b4a6feaad33d</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-12 08:23:01</sys_updated_on>
    </sys_script_include>
</record_update>
