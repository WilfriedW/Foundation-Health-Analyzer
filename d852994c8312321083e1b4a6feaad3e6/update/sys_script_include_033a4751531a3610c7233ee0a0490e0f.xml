<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHAnalysisEngine</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>FHAnalysisEngine</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var FHAnalysisEngine = Class.create();
FHAnalysisEngine.prototype = {
    initialize: function() {
        // Configuration options cache
        this.options = {};
    },

    /**
     * Executes verification for a configured item (e.g., Flow, Change Request)
     * @param {GlideRecord} configRecord - Configuration record from your "Items to Verify" table
     * @returns {Object} - Verification result { success: Boolean, data: Array, errors: Array, metadata: Object }
     */
    runVerification: function(configRecord) {
        var result = {
            success: false,
            data: [],
            errors: [],
            metadata: {},
        };

        this.options = this._loadConfigurationOptions(configRecord);

        if (!this._validateOptions()) {
            result.errors.push("Invalid configuration options");
            return result;
        }

        if (!configRecord.verification_items || !Array.isArray(configRecord.verification_items)) {
            gs.error('[FHAnalysisEngine] verification_items is not an array!');
            result.errors.push('verification_items is not an array');
            return result;
        }

        if (configRecord.verification_items.length === 0) {
            gs.warn('[FHAnalysisEngine] No verification items configured');
            result.success = true;
            return result;
        }

        var rulesMap = this._loadIssueRules(configRecord.verification_items || []);

        configRecord.verification_items.forEach(function(item) {
            try {
                var tableName = item.tableName;
                var queryType = item.query_type.toLowerCase();
                var queryValue = item.query_value || '';
                var queryScript = item.query_script || '';
                var category = item.category;
                var fields = this._determineFields(item);
                var rulesForItem = rulesMap[item.sys_id] || [];
                var ruleFields = this._extractFieldsFromRules(rulesForItem);

                ruleFields.forEach(function(rf) {
                    if (fields.indexOf(rf) === -1) {
                        fields.push(rf);
                    }
                });
                var gr = new GlideRecord(tableName);

                if (queryType === 'script') {
                    if (queryScript) {
                        var scriptResults = [];
                        var flowIds = scriptResults;
                        try {
                            eval(queryScript);
                        } catch (eScript) {
                            result.errors.push("Query script error: " + eScript.message);
                            gs.error("[FHAnalysisEngine] Query script error: " + eScript.message);
                        }
                        var ids = this._flattenIds(scriptResults);
                        if (ids.length > 0) {
                            gr.addQuery('sys_id', 'IN', ids.join(','));
                        } else {
                            gs.warn('[FHAnalysisEngine] Script query returned no IDs, skipping item: ' + item.sys_id);
                            return;
                        }
                    }
                } else {
                    var finalQuery = queryValue.replaceAll("{0}", configRecord.table_name);
                    gr.addEncodedQuery(finalQuery);
                }

                this._applyConfigurationOptions(gr, tableName);

                gr.query();

                var rowCount = gr.getRowCount();

                var recordsAdded = 0;
                while (gr.next()) {
                    var record = this._processRecord(gr, fields, item);
                    record._rules = rulesForItem;

                    if (record._rules.length === 0) {
                        gs.debug('[FHAnalysisEngine]   - No rules attached to record: ' + record.sys_id);
                    }

                    result.data.push(record);
                    recordsAdded++;
                }


            } catch (e) {
                result.errors.push("Verification error: " + e.message);
                gs.error("[FHAnalysisEngine] Verification error: " + e.message + "\nStack: " + e.stack);
            }
        }.bind(this));
        if (result.data.length > 0) {
            result = this._analyzeResults(result);
            result.success = true;
        } else {
            gs.warn('[FHAnalysisEngine] No records to analyze');
            result.success = true;
        }

        return result;
    },


    /**
     * Load configuration options
     * @param {Object} configRecord - Configuration record
     * @returns {Object} - Configuration options
     */
    _loadConfigurationOptions: function(configRecord) {
        var options = {
            ignore_servicenow_records: configRecord.ignore_servicenow_records || false,
            servicenow_users: 'system,admin,maint,guest,glide.maint',
            include_children_tables: configRecord.include_children_tables || false,
            deep_scan: configRecord.deep_scan || false,
            include_ldap: configRecord.include_ldap || true
        };

        return options;
    },

    /**
     * Validates configuration options
     * @returns {Boolean} - true if the options are valid
     */
    _validateOptions: function() {
        try {
            // Validation of servicenow_users
            if (this.options.ignore_servicenow_records && this.options.servicenow_users) {
                var users = this.options.servicenow_users.split(',');
                if (users.length === 0) {
                    this.options.servicenow_users = 'system,admin,maint,guest';
                }
            }

            this.options.ignore_servicenow_records = Boolean(this.options.ignore_servicenow_records);
            this.options.include_children_tables = Boolean(this.options.include_children_tables);
            this.options.deep_scan = Boolean(this.options.deep_scan);
            this.options.include_ldap = Boolean(this.options.include_ldap);

            return true;
        } catch (e) {
            gs.error("[FHAnalysisEngine] Options validation error: " + e.message);
            return false;
        }
    },

    /**
     * Applies configuration options to the query
     * @param {GlideRecord} gr - GlideRecord query
     * @param {String} tableName - Table name
     */
    _applyConfigurationOptions: function(gr, tableName) {

        if (this.options.ignore_servicenow_records) {
            this._applyIgnoreServiceNowRecords(gr, tableName);
        }

        if (this.options.include_children_tables) {
            this._applyIncludeChildrenTables(gr, tableName);
        }

        if (!this.options.include_ldap) {
            this._applyExcludeLDAP(gr, tableName);
        }

    },
    /**
     * Option 1: ignore_servicenow_records (Smart Logic)
     * Excludes pure OOBs, but INCLUDES modified OOBs
     */
    _applyIgnoreServiceNowRecords: function(gr, tableName) {
        try {
            // Parse the ServiceNow user list
            var snUsersStr = this.options.servicenow_users || 'system,admin,maint,guest';
            var snUsers = snUsersStr.split(',').map(function(u) {
                return u.trim();
            });

            // Check if the table has the necessary fields
            var testGr = new GlideRecord(tableName);
            testGr.setLimit(1);
            testGr.query();

            if (testGr.next()) {
                var hasCreatedBy = testGr.isValidField('sys_created_by');
                var hasUpdatedBy = testGr.isValidField('sys_updated_by');
                var hasPackage = testGr.isValidField('sys_package');

                if (hasCreatedBy && hasUpdatedBy) {
                    var notInCreated = 'sys_created_byNOT IN' + snUsers.join(',');
                    var notInUpdated = 'sys_updated_byNOT IN' + snUsers.join(',');
                    var encodedQuery = notInCreated + '^OR' + notInUpdated;

                    gr.addEncodedQuery(encodedQuery);

                } else if (hasPackage) {
                    gr.addEncodedQuery('sys_packageISNOTEMPTY^sys_package!=global');

                } else {
                    gs.warn("[FHAnalysisEngine] Cannot apply ignore_servicenow_records - required fields not found on table: " + tableName);
                }
            }
        } catch (e) {
            gs.error("[FHAnalysisEngine] Error applying ignore_servicenow_records: " + e.message);
        }
    },

    /**
     * Option 2: include_children_tables
     * Includes inherited tables in the analysis
     */
    _applyIncludeChildrenTables: function(gr, tableName) {
        try {
            // Check if the table has the sys_class_name field
            var testGr = new GlideRecord(tableName);
            testGr.setLimit(1);
            testGr.query();

            if (testGr.next() && testGr.isValidField('sys_class_name')) {
                gr.addQuery('sys_class_name', 'STARTSWITH', tableName);
            } else {
                gs.debug("[FHAnalysisEngine] Table " + tableName + " does not support inheritance (no sys_class_name)");
            }
        } catch (e) {
            gs.error("[FHAnalysisEngine] Error applying include_children_tables: " + e.message);
        }
    },

    /**
     * Option 3: include_ldap (false = exclude LDAP)
     * Excludes LDAP configurations from scanning
     */
    _applyExcludeLDAP: function(gr, tableName) {
        try {
            // List of LDAP tables to exclude
            var ldapTables = [
                'ldap_server_config',
                'ldap_ou_config',
                'ldap_group_map',
                'ldap_server'
            ];

            if (ldapTables.indexOf(tableName) !== -1) {
                gr.addQuery('sys_id', 'NULL');
            }

            // If the table has a field linked to LDAP
            var testGr = new GlideRecord(tableName);
            testGr.setLimit(1);
            testGr.query();

            if (testGr.next()) {
                if (testGr.isValidField('ldap_server')) {
                    gr.addQuery('ldap_server', 'ISEMPTY');
                    gs.debug("[FHAnalysisEngine] Excluded LDAP-related records from " + tableName);
                }
            }
        } catch (e) {
            gs.error("[FHAnalysisEngine] Error applying exclude LDAP: " + e.message);
        }
    },

    /**
     * Option 4: deep_scan
     * Determines the fields to be analysed based on the deep_scan mode
     */
    _determineFields: function(item) {
        var fields = [];

        if (this.options.deep_scan) {
            fields = (item.fields && item.fields.split(',')) || [];

            var deepScanFields = [
                'name', 'active', 'sys_created_by', 'sys_updated_by', 'sys_id',
                'sys_created_on', 'sys_updated_on', 'sys_mod_count',
                'sys_package', 'sys_scope', 'sys_class_name',
                'description', 'short_description', 'script', 'condition',
                'order', 'priority', 'when', 'filter_condition'
            ];

            deepScanFields.forEach(function(df) {
                if (fields.indexOf(df) === -1) {
                    fields.push(df);
                }
            });

            gs.debug("[FHAnalysisEngine] Deep scan enabled: " + fields.length + " fields");

        } else {
            fields = (item.fields && item.fields.split(',')) || [];
            var defaults = ['name', 'active', 'sys_created_by', 'sys_updated_by', 'sys_id'];
            defaults.forEach(function(df) {
                if (fields.indexOf(df) === -1) {
                    fields.push(df);
                }
            });
        }
        fields = fields.map(function(f) {
            return (f || '').trim();
        }).filter(function(f) {
            return !!f;
        });

        return fields;
    },

    /**
     * Processes a single record to extract relevant data
     * @param {GlideRecord} gr - Current record
     * @param {Array} fields - Fields to extract
     * @returns {Object} - Processed record with values and empty issues array
     */
    _processRecord: function(gr, fields, item) {
        var record = {
            sys_id: gr.sys_id.toString(),
            table: gr.getTableName(),
            values: {},
            issues: [],
            category: item.category
        };

        // Extract requested fields
        fields.forEach(function(field) {
            if (gr.isValidField(field)) {
                record.values[field] = gr.getValue(field);
            }
        });

        return record;
    },


    /**
     * Analyzes records to detect issues
     * Supports two execution modes:
     *   - per_record: Execute rule for each record
     *   - aggregate: Execute rule once for entire table
     * @param {Object} result - Current result object
     * @returns {Object} - Updated result with issues
     */
    _analyzeResults: function(result) {
        try {
            if (result.data.length === 0) {
                result.issues = [];
                return result;
            }

            var context = {
                totalCount: result.data.length,
                _dupsSeen: {},
                options: this.options
            };

            result.data.forEach(function(it) {
                var key = (it.values.name || '') + '|' + (it.values.code || '');
                if (!context._dupsSeen[key]) context._dupsSeen[key] = it.sys_id;
            });

            var ruleEval = new x_1310794_founda_0.FHARuleEvaluator();
            var aggregatedIssues = [];

            var dataByTable = {};
            result.data.forEach(function(item) {
                var table = item.table;
                if (!dataByTable[table]) {
                    dataByTable[table] = [];
                }
                dataByTable[table].push(item);
            });

            for (var tableName in dataByTable) {
                var tableData = dataByTable[tableName];

                // Separate aggregate and per-record rules for THIS table
                var perRecordRules = [];
                var aggregateRules = [];

                tableData.forEach(function(item) {
                    (item._rules || []).forEach(function(rule) {
                        if (rule.execution_mode === 'aggregate') {
                            var exists = aggregateRules.some(function(r) {
                                return r.sys_id === rule.sys_id;
                            });
                            if (!exists) aggregateRules.push(rule);
                        } else {
                            var exists = perRecordRules.some(function(r) {
                                return r.sys_id === rule.sys_id;
                            });
                            if (!exists) perRecordRules.push(rule);
                        }
                    });
                });

                if (aggregateRules.length > 0) {
                    gs.info('[FHAnalysisEngine] Executing ' + aggregateRules.length + ' aggregate rule(s) for table: ' + tableName);

                    var aggIssues = ruleEval.evaluateAggregate(tableName, aggregateRules, context);

                    aggIssues.forEach(function(is) {
                        var issueDetails = is.details || {};
                        aggregatedIssues.push({
                            code: is.code || '',
                            message: is.message || '',
                            severity: is.severity || 'medium',
                            record_table: is.record_table || tableName,
                            record_sys_id: is.record_sys_id || '',
                            record_name: issueDetails.record_name || '',
                            record_filter: issueDetails.record_filter || '',
                            category: tableData[0].category || '',
                            details: issueDetails
                        });
                    });
                }

                // Execute PER-RECORD rules
                if (perRecordRules.length > 0) {
                    gs.info('[FHAnalysisEngine] Executing ' + perRecordRules.length + ' per-record rule(s) for ' + tableData.length + ' records in table: ' + tableName);

                    tableData.forEach(function(item) {
                        try {
                            item.issues = ruleEval.evaluate(item, perRecordRules, context) || [];

                            (item.issues || []).forEach(function(is) {
                                var issueDetails = is.details || {};
                                aggregatedIssues.push({
                                    code: is.code || '',
                                    message: is.message || '',
                                    severity: is.severity || 'medium',
                                    record_table: issueDetails.record_table || item.table || '',
                                    record_sys_id: issueDetails.record_sys_id || item.sys_id || '',
                                    record_name: issueDetails.record_name || (item.values && item.values.name) || '',
                                    record_filter: issueDetails.record_filter || '',
                                    category: item.category || '',
                                    details: issueDetails
                                });
                            });

                        } catch (recordError) {
                            gs.error('[FHAnalysisEngine] Error analyzing record ' + item.sys_id + ': ' + recordError.message);
                        }
                    });
                }
            }

            result.issues = aggregatedIssues;
            result = this._calculateMetrics(result);

            gs.info('[FHAnalysisEngine] Analysis complete: ' + aggregatedIssues.length + ' issues found');

        } catch (error) {
            gs.error('[FHAnalysisEngine] _analyzeResults error: ' + error.message);
        }

        return result;
    },

    /**
     * Loads issue rules with execution_mode and severity
     * OPTIMIZED: Loads all required fields in one query
     * @param {Array} items - Verification items
     * @returns {Object} - Map of rules by item sys_id
     */
    _loadIssueRules: function(items) {
        var map = {};
        var ids = [];

        (items || []).forEach(function(it) {
            if (it.issue_rules) {
                ids = ids.concat(String(it.issue_rules).split(','));
            }
        });

        ids = ids.filter(function(x) {
            return x;
        });

        if (!ids.length) return map;

        var gr = new GlideRecord('x_1310794_founda_0_issue_rules');
        gr.addQuery('sys_id', 'IN', ids.join(','));
        gr.addQuery('active', true);
        gr.query();

        while (gr.next()) {

            var rule = {
                sys_id: gr.getUniqueValue(),
                name: gr.getValue('name') || '',
                code: gr.getValue('code') || '',
                type: gr.getValue('type') || '',
                execution_mode: gr.getValue('execution_mode') || 'per_record',
                severity: gr.getValue('severity') || gr.getValue('default_severity') || 'medium',
                default_severity: gr.getValue('default_severity') || 'medium',
                message_template: gr.getValue('message_template') || '',
                params: gr.getValue('params') || '{}',
                script: gr.getValue('script') || '',
                table: gr.getValue('table') || ''
            };

            // Attach rule to each item that references it
            (items || []).forEach(function(it) {
                if (String(it.issue_rules || '').indexOf(rule.sys_id) > -1) {
                    if (!map[it.sys_id]) map[it.sys_id] = [];
                    map[it.sys_id].push(rule);
                }
            });
        }

        return map;
    },

    /**
     * Calculate metrics for widget display
     * @param {Object} result - Analysis result
     * @returns {Object} - Result with calculated metrics
     */
    _calculateMetrics: function(result) {
        var issues = result.issues || [];
        var data = result.data || [];

        // Count issues by severity
        var high = 0,
            medium = 0,
            low = 0;
        issues.forEach(function(issue) {
            switch (issue.severity) {
                case 'critical':
                case 'high':
                    high++;
                    break;
                case 'medium':
                    medium++;
                    break;
                case 'low':
                    low++;
                    break;
            }
        });

        result.issues_high = high;
        result.issues_medium = medium;
        result.issues_low = low;
        result.issue_count = issues.length;
        result.record_count = data.length;

        // Calculate health score (0-100)
        var score = 100;
        score -= (high * 20); // -20 per high/critical
        score -= (medium * 5); // -5 per medium
        score -= (low * 2); // -2 per low
        result.health_score = Math.max(0, score);

        return result;
    },


    _flattenIds: function(list) {
        var ids = [];
        if (!list) return ids;
        var pushId = function(v) {
            if (!v) return;
            if (typeof v === 'string') {
                if (v.indexOf(',') > -1) {
                    v.split(',').forEach(pushId);
                } else {
                    ids.push(v);
                }
            } else if (Array.isArray(v)) {
                v.forEach(pushId);
            } else if (v.sys_id) {
                ids.push(String(v.sys_id));
            } else if (v.getUniqueValue && typeof v.getUniqueValue === 'function') {
                ids.push(String(v.getUniqueValue()));
            }
        };
        pushId(list);
        return ids;
    },

    _extractFieldsFromRules: function(rules) {
        var fields = [];

        rules.forEach(function(rule) {
            try {
                var params = rule.params;
                if (typeof params === 'string') {
                    params = JSON.parse(params);
                }

                if (params && params.fields) {
                    var ruleFields = [];

                    if (Array.isArray(params.fields)) {
                        ruleFields = params.fields;
                    } else if (typeof params.fields === 'string') {
                        ruleFields = params.fields.split(',');
                    }

                    ruleFields.forEach(function(f) {
                        var trimmed = (f || '').trim();
                        if (trimmed && fields.indexOf(trimmed) === -1) {
                            fields.push(trimmed);
                        }
                    });
                }
            } catch (e) {
                gs.warn('[FHAnalysisEngine] Failed to parse rule params: ' + e.message);
            }
        });

        return fields;
    },


    /*  _loadIssueRules: function(items) {
          var map = {};
          var ids = [];
          (items || []).forEach(function(it) {
              if (it.issue_rules) {
                  ids = ids.concat(String(it.issue_rules).split(','));
              }
          });
          ids = ids.filter(function(x) {
              return x;
          });
          if (!ids.length) return map;

          var gr = new GlideRecord('x_1310794_founda_0_issue_rules');
          gr.addQuery('sys_id', 'IN', ids.join(','));
          gr.addQuery('active', true);
          gr.query();
          while (gr.next()) {
              var rule = {
                  sys_id: gr.getUniqueValue(),
                  name: gr.getValue('name') || '',
                  code: gr.getValue('code') || '',
                  type: gr.getValue('type') || '',
                  default_severity: gr.getValue('default_severity') || 'medium',
                  params: gr.getValue('params') || '{}',
                  script: gr.getValue('script') || ''
              };
              // attach by each item that referenced it
              (items || []).forEach(function(it) {
                  if (String(it.issue_rules || '').indexOf(rule.sys_id) > -1) {
                      if (!map[it.sys_id]) map[it.sys_id] = [];
                      map[it.sys_id].push(rule);
                  }
              });
          }
          return map;
      },*/

    type: 'FHAnalysisEngine'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-07 01:18:57</sys_created_on>
        <sys_id>033a4751531a3610c7233ee0a0490e0f</sys_id>
        <sys_mod_count>109</sys_mod_count>
        <sys_name>FHAnalysisEngine</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_033a4751531a3610c7233ee0a0490e0f</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-12 09:39:27</sys_updated_on>
    </sys_script_include>
</record_update>
