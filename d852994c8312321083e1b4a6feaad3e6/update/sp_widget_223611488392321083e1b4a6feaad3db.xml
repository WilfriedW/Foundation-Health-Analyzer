<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $window, spUtil, $location) {
    var c = this;

    c.selectedConfig = null;
    c.loading = false;
    c.result = null;
    c.error = null;
    c.tables = c.data.configurations || [];
    c.recentAnalyses = c.data.recentAnalyses || [];
    c.analysisId = null;

    // Run analysis for selected configuration
    c.runAnalysis = function() {
        if (!c.selectedConfig) return;

        c.loading = true;
        c.result = null;
        c.error = null;

        c.server.get({
            action: 'run_analysis',
            configSysId: c.selectedConfig
        }).then(function(response) {
            c.loading = false;
            if (response.data.success) {
                c.result = response.data.runResult;
                c.analysisId = response.data.analysisId;
                c.refreshRecentAnalyses();
            } else {
                c.error = response.data.error || 'An error occurred';
            }
        }, function() {
            c.loading = false;
            c.error = 'Server communication error';
        });
    };

    // Load an existing result
    c.loadResult = function(analysisId) {
        c.loading = true;
        c.error = null;
        c.server.get({
            action: 'get_result',
            analysisId: analysisId
        }).then(function(response) {
            c.loading = false;
            if (response.data.success) {
                c.result = response.data.analysisResult;
                c.analysisId = analysisId;
            } else {
                c.error = response.data.error || 'Analysis not found';
            }
        });
    };

    // Refresh recent analyses list
    c.refreshRecentAnalyses = function() {
        c.server.get({
            action: 'get_recent_analyses'
        }).then(function(response) {
            if (response.data.success) {
                c.recentAnalyses = response.data.analyses;
            }
        });
    };

    // Navigate to detailed results
    c.viewDetails = function(analysisId) {
        $window.location.href = '/fha?id=fha_analysis_detail&sys_id=' + analysisId;
    };

    // Get severity class for styling
    c.getSeverityClass = function(severity) {
        var s = (severity || '').toLowerCase();
        if (s === 'critical') return 'danger';
        if (s === 'high')     return 'danger';
        if (s === 'medium')   return 'warning';
        return 'info';
    };

    // Get health score class
    c.getHealthScoreClass = function(score) {
        if (score >= 70) return 'success';
        if (score >= 40) return 'warning';
        return 'danger';
    };

    // Get health score label — was missing, caused template crash
    c.getHealthScoreLabel = function(score) {
        if (score >= 90) return 'Excellent';
        if (score >= 70) return 'Good';
        if (score >= 40) return 'Fair';
        return 'Poor';
    };

    // Calculate health score from issues
    c.calculateHealthScore = function() {
        if (!c.result || !c.result.issues) return 100;
        var score = 100;
        c.result.issues.forEach(function(issue) {
            if (issue.severity === 'high') score -= 15;
            else if (issue.severity === 'medium') score -= 5;
            else score -= 2;
        });
        return Math.max(0, score);
    };

    // Group issues by category
    c.getGroupedIssues = function() {
        if (!c.result || !c.result.issues) return {};
        
        var grouped = {};
        c.result.issues.forEach(function(issue) {
            var category = issue.category || 'general';
            if (!grouped[category]) {
                grouped[category] = [];
            }
            grouped[category].push(issue);
        });
        
        // Sort each category by severity
        Object.keys(grouped).forEach(function(key) {
            grouped[key].sort(function(a, b) {
                var severityOrder = { high: 0, medium: 1, low: 2 };
                return (severityOrder[a.severity] || 3) - (severityOrder[b.severity] || 3);
            });
        });
        
        return grouped;
    };

    // Get category display name
    c.getCategoryLabel = function(category) {
        var labels = {
            field: '${Fields}',
            business_rule: '${Business Rules}',
            client_script: '${Client Scripts}',
            integration: '${Integrations}',
            automation: '${Automation}',
            security: '${Security}',
            notification: '${Notifications}',
            ui: '${User Interface}',
            general: '${General}'
        };
        return labels[category] || category;
    };

    // Get category icon
    c.getCategoryIcon = function(category) {
        var icons = {
            field: 'fa-columns',
            business_rule: 'fa-cogs',
            client_script: 'fa-code',
            integration: 'fa-exchange-alt',
            automation: 'fa-robot',
            security: 'fa-shield-alt',
            notification: 'fa-envelope',
            ui: 'fa-desktop',
            general: 'fa-info-circle'
        };
        return icons[category] || 'fa-exclamation-circle';
    };

    // Navigate to single record
    c.goToRecord = function(issue) {
        if (issue.record_sys_id && issue.record_table) {
            // Direct link to record
            var url = '/' + issue.record_table + '.do?sys_id=' + issue.record_sys_id;
            window.open(url, '_blank');
        } else if (issue.record_filter && issue.record_table) {
            // Link to filtered list
            var url = '/' + issue.record_table + '_list.do?sysparm_query=' + encodeURIComponent(issue.record_filter);
            window.open(url, '_blank');
        }
    };

    // Navigate to list of all records (filtered)
    c.goToList = function(issue) {
        if (issue.record_table) {
            var url = '/' + issue.record_table + '_list.do';
            if (issue.record_filter) {
                url += '?sysparm_query=' + encodeURIComponent(issue.record_filter);
            }
            window.open(url, '_blank');
        }
    };

    // Check if issue has a link
    c.hasRecordLink = function(issue) {
        return (issue.record_sys_id && issue.record_table) || (issue.record_filter && issue.record_table);
    };

    // Check if issue has a list link (for "View All")
    c.hasListLink = function(issue) {
        return issue.record_table && issue.record_filter;
    };

    c.getRecordCount = function(issue) {
        if (!issue.message) return '';
        var match = issue.message.match(/(\d+)/);
        return match ? match[1] : '';
    };

    // Get issues by severity
    c.getIssuesBySeverity = function(severity) {
        if (!c.result || !c.result.issues) return [];
        return c.result.issues.filter(function(issue) {
            return issue.severity === severity;
        });
    };

    // Count issues by severity
    c.countBySeverity = function(severity) {
        return c.getIssuesBySeverity(severity).length;
    };

    // View all analyses - redirects to analysis results page
    c.viewAllAnalyses = function() {
        window.location.href = '/fha?id=fha_analysis_results';
    };

    // Toggle section visibility
    c.expandedSections = {};
    c.toggleSection = function(section) {
        c.expandedSections[section] = !c.expandedSections[section];
    };
    c.isSectionExpanded = function(section) {
        return c.expandedSections[section] === true;
    };

    c.getCategories = function() {
        return (c.result && c.result.categories) ? c.result.categories : {};
    };

    c.getCategoryItems = function(categoryId) {
        var cats = c.getCategories();
        var cat = cats[categoryId];
        if (!cat || !cat.items) return [];
        var items = [];
        cat.items.forEach(function(it) {
            var records = it.records || [];
            records.forEach(function(rec) {
                items.push(angular.extend({
                    item_type: it.type,
                    item_label: it.label || it.itemLabel,
                    item_icon: it.icon || it.itemIcon,
                    item_color: it.color || it.itemColor
                }, rec));
            });
        });
        return items;
    };

    c.getBusinessRules = function() {
        return c.getCategoryItems('automation').filter(function(r) {
            return r.item_type === 'business_rules';
        });
    };

    c.getAutomationOverview = function() {
        var allowed = {
            scheduled_job: 'Scheduled Job',
            flow: 'Flow',
            workflow: 'Workflow',
            notification: 'Notification',
            ui_action: 'UI Action',
            ui_policy: 'UI Policy',
            inbound_email: 'Inbound Email',
            client_scripts: 'Client Script',
            business_rules: 'Business Rule'
        };
        return c.getCategoryItems('automation').filter(function(r) {
            return allowed.hasOwnProperty(r.item_type);
        }).map(function(r) {
            return angular.extend({
                type: allowed[r.item_type] || r.item_type
            }, r);
        });
    };

    c.getIntegrationsOverview = function() {
        var allowed = {
            data_source: 'Data Source',
            transform_map: 'Transform Map',
            import_sets: 'Import Sets',
            rest_apis: 'REST API'
        };
        return c.getCategoryItems('integration').filter(function(r) {
            return allowed.hasOwnProperty(r.item_type);
        }).map(function(r) {
            return angular.extend({
                type: allowed[r.item_type] || r.item_type
            }, r);
        });
    };

    c.getSecurityOverview = function() {
        return c.getCategoryItems('security').filter(function(r) {
            return r.item_type === 'acl';
        }).map(function(r) {
            return angular.extend({
                type: 'ACL',
                active: true
            }, r);
        });
    };

    // Open record from overview
    c.openOverviewRecord = function(item) {
        if (item.sys_id && item.table) {
            var url = '/' + item.table + '.do?sys_id=' + item.sys_id;
            window.open(url, '_blank');
        }
    };

    c.getCategoryTotalCount = function(categoryId) {
        var cats = c.getCategories();
        var cat = cats[categoryId];
        if (!cat || !cat.items) return 0;
        return cat.items.reduce(function(acc, it) {
            return acc + (it.count || (it.records ? it.records.length : 0) || 0);
        }, 0);
    };
}
]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_dashboard</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Dashboard</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    // Load available configurations
    data.configurations = [];
    var configGr = new GlideRecord('x_1310794_founda_0_configurations');
    configGr.addQuery('active', true);
	  configGr.addQuery('sys_class_name', 'x_1310794_founda_0_configurations');
    configGr.orderBy('name');
    configGr.query();
    
    while (configGr.next()) {
        var tableRef = configGr.table.getRefRecord();
        
        // Helper to check boolean values
        var isTrue = function(val) {
            return val === 'true' || val === '1' || val === true || val === 1;
        };
        
        data.configurations.push({
            config_sys_id: configGr.getUniqueValue(),
            display_name: configGr.getValue('name'),
            table_name: tableRef ? tableRef.getValue('name') : '',
            table_label: tableRef ? tableRef.getValue('label') : '',
            description: configGr.getValue('description'),
            // Include options
            deep_scan: isTrue(configGr.getValue('deep_scan')),
            include_children_tables: isTrue(configGr.getValue('include_children_tables')),
            analyze_references: isTrue(configGr.getValue('analyze_references')),
            include_ldap: isTrue(configGr.getValue('include_ldap'))
        });
    }
    
    // Load recent analyses
    data.recentAnalyses = [];
    var resultsGr = new GlideRecord('x_1310794_founda_0_results');
    // state can be 'completed' or 'Completed' depending on instance — use OR
    var stateQ = resultsGr.addQuery('state', 'completed');
    stateQ.addOrCondition('state', 'Completed');
    resultsGr.orderByDesc('sys_created_on');
    resultsGr.setLimit(10);
    resultsGr.query();

    while (resultsGr.next()) {
        var detailObj = {};
        var issues = [];
        var tableDisplayName = '';
        var healthScore = 0;
        var resultData = {};
        var configData = {};
        try {
            detailObj = JSON.parse(resultsGr.getValue('details') || '{}');
            resultData = detailObj.result || {};
            issues = resultData.issues || [];
            healthScore = resultData.health_score || 0;
            configData = detailObj.configuration || detailObj.config || {};
            tableDisplayName = configData.table_label
                ? (configData.table_label + ' (' + configData.table_name + ')')
                : (configData.table_name || configData.name || '');
        } catch (e) {
            gs.warn('[FHA Dashboard] Failed to parse details for ' + resultsGr.getUniqueValue() + ': ' + e.message);
        }

        // Count severities from issues array (fallback when stored counts are 0/missing)
        var cntCritical = 0, cntHigh = 0, cntMedium = 0, cntLow = 0;
        issues.forEach(function(issue) {
            var sev = (issue.severity || '').toLowerCase();
            if (sev === 'critical') cntCritical++;
            else if (sev === 'high') cntHigh++;
            else if (sev === 'medium') cntMedium++;
            else if (sev === 'low') cntLow++;
        });

        // Fall back to computed score if health_score not stored
        if (!healthScore && issues.length > 0) {
            healthScore = 100;
            healthScore -= cntCritical * 20;
            healthScore -= cntHigh * 10;
            healthScore -= cntMedium * 5;
            healthScore -= cntLow * 2;
            healthScore = Math.max(0, healthScore);
        }

        data.recentAnalyses.push({
            sys_id: resultsGr.getUniqueValue(),
            number: resultsGr.getValue('number'),
            state: resultsGr.getValue('state'),
            configuration_name: configData.name || '',
            table_name: tableDisplayName,
            health_score: healthScore,
            issue_count: resultData.issue_count || issues.length,
            // Use stored counts if populated, else use counted values from issues array
            issues_critical: resultData.issues_critical || cntCritical,
            issues_high:     resultData.issues_high     || cntHigh,
            issues_medium:   resultData.issues_medium   || cntMedium,
            issues_low:      resultData.issues_low      || cntLow,
            record_count: resultData.record_count || 0,
            created_on: resultsGr.getValue('sys_created_on')
        });
    }
    
    // Handle server actions
    if (input && input.action) {
        switch(input.action) {
            case 'run_analysis':
                try {
                    var analyzer = new x_1310794_founda_0.FHAnalyzer();
                    var result = analyzer.runAnalysis(input.configSysId);

                    if (result.success) {
                        data.success = true;
                        data.analysisId = result.analysis_id || result.analysisId;

                        // Build a normalized runResult from the full details structure
                        var details = result.details || {};
                        var resultData = details.result || {};
                        var configData = details.configuration || details.config || {};

                        var runIssues = resultData.issues || [];
                        var runC=0, runH=0, runM=0, runL=0;
                        runIssues.forEach(function(i) {
                            var sv = (i.severity||'').toLowerCase();
                            if(sv==='critical') runC++;
                            else if(sv==='high') runH++;
                            else if(sv==='medium') runM++;
                            else if(sv==='low') runL++;
                        });
                        var runScore = resultData.health_score || 0;
                        if (!runScore && runIssues.length > 0) {
                            runScore = Math.max(0, 100 - runC*20 - runH*10 - runM*5 - runL*2);
                        }
                        data.runResult = {
                            health_score:    runScore,
                            issue_count:     resultData.issue_count  || runIssues.length,
                            issues_critical: resultData.issues_critical || runC,
                            issues_high:     resultData.issues_high     || runH,
                            issues_medium:   resultData.issues_medium   || runM,
                            issues_low:      resultData.issues_low      || runL,
                            record_count:    resultData.record_count || 0,
                            duration_ms:     resultData.duration_ms  || resultData.duration || null,
                            configuration_name: configData.name  || '',
                            table_name: configData.table_label
                                ? (configData.table_label + ' (' + configData.table_name + ')')
                                : (configData.table_name || '')
                        };
                    } else {
                        data.success = false;
                        data.error = result.error || 'Analysis failed';
                    }
                } catch(e) {
                    data.success = false;
                    data.error = e.message;
                }
                break;

            case 'get_result':
                try {
                    var grRes = new GlideRecord('x_1310794_founda_0_results');
                    if (grRes.get(input.analysisId)) {
                        var detRes = {};
                        try { detRes = JSON.parse(grRes.getValue('details') || '{}'); } catch(ex) {}
                        var rData = detRes.result || {};
                        var cData = detRes.configuration || detRes.config || {};
                        var hs = rData.health_score || 0;
                        var iss = rData.issues || [];
                        if (!hs && iss.length > 0) {
                            hs = 100;
                            iss.forEach(function(i) {
                                var s = (i.severity || '').toLowerCase();
                                if (s === 'critical') hs -= 20;
                                else if (s === 'high') hs -= 10;
                                else if (s === 'medium') hs -= 5;
                                else hs -= 2;
                            });
                            hs = Math.max(0, hs);
                        }
                        data.success = true;
                        data.analysisResult = {
                            health_score: hs,
                            issue_count:  rData.issue_count  || iss.length,
                            issues_critical: rData.issues_critical || 0,
                            issues_high:     rData.issues_high     || 0,
                            issues_medium:   rData.issues_medium   || 0,
                            issues_low:      rData.issues_low      || 0,
                            record_count: rData.record_count || 0,
                            duration_ms:  rData.duration_ms  || rData.duration || null,
                            configuration_name: cData.name || '',
                            table_name: cData.table_label
                                ? (cData.table_label + ' (' + cData.table_name + ')')
                                : (cData.table_name || '')
                        };
                    } else {
                        data.success = false;
                        data.error = 'Analysis not found';
                    }
                } catch(e) {
                    data.success = false;
                    data.error = e.message;
                }
                break;

            case 'get_recent_analyses':
                data.success = true;
                data.analyses = [];
                var gr = new GlideRecord('x_1310794_founda_0_results');
                var grStQ = gr.addQuery('state', 'completed');
                grStQ.addOrCondition('state', 'Completed');
                gr.orderByDesc('sys_created_on');
                gr.setLimit(10);
                gr.query();

                while (gr.next()) {
                    var det = {};
                    try { det = JSON.parse(gr.getValue('details') || '{}'); } catch(ex) {}
                    var rr = det.result || {};
                    var cc = det.configuration || det.config || {};
                    var il = rr.issues || [];
                    var rc = 0, rh = 0, rm = 0, rl = 0;
                    il.forEach(function(i) {
                        var sv = (i.severity || '').toLowerCase();
                        if (sv === 'critical') rc++;
                        else if (sv === 'high') rh++;
                        else if (sv === 'medium') rm++;
                        else if (sv === 'low') rl++;
                    });
                    var sc = rr.health_score || 0;
                    if (!sc && il.length > 0) {
                        sc = Math.max(0, 100 - rc*20 - rh*10 - rm*5 - rl*2);
                    }
                    data.analyses.push({
                        sys_id: gr.getUniqueValue(),
                        number: gr.getValue('number'),
                        state: gr.getValue('state'),
                        configuration_name: cc.name || '',
                        table_name: cc.table_label
                            ? (cc.table_label + ' (' + cc.table_name + ')')
                            : (cc.table_name || ''),
                        health_score: sc,
                        issue_count:     rr.issue_count     || il.length,
                        issues_critical: rr.issues_critical || rc,
                        issues_high:     rr.issues_high     || rh,
                        issues_medium:   rr.issues_medium   || rm,
                        issues_low:      rr.issues_low      || rl,
                        record_count:    rr.record_count    || 0,
                        created_on: gr.getValue('sys_created_on')
                    });
                }
                break;
        }
    }
})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-02 19:41:08</sys_created_on>
        <sys_id>223611488392321083e1b4a6feaad3db</sys_id>
        <sys_mod_count>31</sys_mod_count>
        <sys_name>Dashboard</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_223611488392321083e1b4a6feaad3db</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-18 09:32:07</sys_updated_on>
        <template><![CDATA[<div class="fha-dashboard">
  
  <!-- Page Header (Modern, Colorful) -->
  <div class="fha-page-header">
    <h2><i class="fa fa-heartbeat"></i> Foundation Health Analyzer</h2>
    <p>${Analyze the health of your ServiceNow tables and get improvement recommendations}</p>
  </div>

  <div class="row">
    <!-- Main Analysis Panel -->
    <div class="col-md-8">
      <div class="fha-card">
        <div class="fha-card-header">
          <h4><i class="fa fa-play-circle"></i> ${Run Analysis}</h4>
        </div>
        <div class="fha-card-body">
          
          <!-- Configuration Selection (Modern Select) -->
          <div class="form-group">
            <label>
              ${Select a configuration to analyze}
            </label>
            <select class="fha-select"
              ng-model="c.selectedConfig"
              ng-options="t.config_sys_id as (t.display_name + ' (' + t.table_name + ')') for t in c.tables">
              <option value="">-- ${Choose a table} --</option>
            </select>
          </div>

          <!-- Selected Config Description and Options (Elegant Preview) -->
          <div ng-if="c.selectedConfig" class="fha-config-preview">
            <div ng-repeat="t in c.tables" ng-if="t.config_sys_id === c.selectedConfig">
              <strong>{{t.display_name}}</strong>
              <p>{{t.description || '${No description}'}}</p>
              
              <!-- Options Display (Read Only) -->
              <div class="fha-options-divider">
                <div class="fha-options-header">
                  <i class="fa fa-cog"></i> ${Analysis Options}
                </div>
                <div class="fha-options-grid">
                  <!-- Deep Scan -->
                  <div ng-class="t.deep_scan ? 'fha-option-enabled' : 'fha-option-disabled'">
                    <i class="fa" ng-class="t.deep_scan ? 'fa-check-circle' : 'fa-times-circle'"></i>
                    ${Deep Scan}
                  </div>
                  <!-- Include Children Tables -->
                  <div ng-class="t.include_children_tables ? 'fha-option-enabled' : 'fha-option-disabled'">
                    <i class="fa" ng-class="t.include_children_tables ? 'fa-check-circle' : 'fa-times-circle'"></i>
                    ${Include Children}
                  </div>
                  <!-- Analyze References -->
                  <div ng-class="t.analyze_references ? 'fha-option-enabled' : 'fha-option-disabled'">
                    <i class="fa" ng-class="t.analyze_references ? 'fa-check-circle' : 'fa-times-circle'"></i>
                    ${Analyze References}
                  </div>
                  <!-- Include LDAP -->
                  <div ng-class="t.include_ldap ? 'fha-option-enabled' : 'fha-option-disabled'">
                    <i class="fa" ng-class="t.include_ldap ? 'fa-check-circle' : 'fa-times-circle'"></i>
                    ${Include LDAP}
                  </div>
                  <!-- Include ServiceNow records -->
                  <div ng-class="t.include_snc_records ? 'fha-option-enabled' : 'fha-option-disabled'">
                    <i class="fa" ng-class="t.include_snc_records ? 'fa-check-circle' : 'fa-times-circle'"></i>
                    ${Include ServiceNow records}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Run Button -->
          <button class="fha-btn-primary"
            ng-click="c.runAnalysis()"
            ng-disabled="!c.selectedConfig || c.loading">
            <i class="fa" ng-class="c.loading ? 'fa-spinner fa-spin' : 'fa-search'"></i>
            {{c.loading ? '${Analysis in progress...}' : '${Run Analysis}'}}
          </button>

          <!-- Error Message -->
          <div ng-if="c.error" class="alert alert-danger" style="margin-top: 20px;">
            <i class="fa fa-exclamation-triangle"></i> {{c.error}}
          </div>
        </div>
      </div>

      <!-- Results Panel -->
      <div class="fha-card" ng-if="c.result" style="border-left: 4px solid var(--fha-success);">
        <div class="fha-card-header" style="background: var(--fha-success-bg);">
          <h4 style="color: var(--fha-anthracite);"><i class="fa fa-check-circle" style="color: var(--fha-success);"></i> Analysis Complete</h4>
          <button class="fha-btn-primary" ng-if="c.analysisId" ng-click="c.viewDetails(c.analysisId)" style="padding: 8px 14px; font-size: 13px;">
            <i class="fa fa-arrow-right"></i> View Full Details
          </button>
        </div>
        <div class="fha-card-body" style="padding: 20px;">

          <!-- Config context -->
          <div ng-if="c.result.configuration_name || c.result.table_name" style="margin-bottom: 16px; padding: 10px 14px; background: var(--fha-bg-section); border-radius: 6px; font-size: 13px; color: var(--fha-text-secondary);">
            <i class="fa fa-cog"></i> <strong style="color: var(--fha-anthracite);">{{c.result.configuration_name}}</strong>
            <span ng-if="c.result.table_name"> — {{c.result.table_name}}</span>
          </div>

          <!-- KPI row -->
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 16px; align-items: start;">

            <!-- Health Score circle -->
            <div style="text-align: center;">
              <div style="width: 110px; height: 110px; border-radius: 50%; margin: 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 8px solid; font-weight: 800;"
                   ng-style="{
                     'font-size': '28px',
                     'color': c.result.health_score >= 70 ? 'var(--fha-success)' : c.result.health_score >= 40 ? 'var(--fha-warning)' : 'var(--fha-danger)',
                     'border-color': c.result.health_score >= 70 ? 'var(--fha-success)' : c.result.health_score >= 40 ? 'var(--fha-warning)' : 'var(--fha-danger)',
                     'background': c.result.health_score >= 70 ? 'var(--fha-success-bg)' : c.result.health_score >= 40 ? 'var(--fha-warning-bg)' : 'var(--fha-danger-bg)'
                   }">
                {{c.result.health_score || 0}}%
              </div>
              <div style="margin-top: 8px; font-size: 13px; font-weight: 700;"
                   ng-style="{'color': c.result.health_score >= 70 ? 'var(--fha-success)' : c.result.health_score >= 40 ? 'var(--fha-warning)' : 'var(--fha-danger)'}">
                {{c.getHealthScoreLabel(c.result.health_score || 0)}}
              </div>
            </div>

            <!-- Issue counts grid -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
              <div style="background: var(--fha-danger-bg); border: 1px solid var(--fha-danger-light); border-radius: 8px; padding: 12px; text-align: center;">
                <div style="font-size: 28px; font-weight: 800; color: var(--fha-danger);">{{c.result.issues_critical || 0}}</div>
                <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--fha-danger); letter-spacing: 0.5px;">Critical</div>
              </div>
              <div style="background: #fdf2f2; border: 1px solid #f5b7b1; border-radius: 8px; padding: 12px; text-align: center;">
                <div style="font-size: 28px; font-weight: 800; color: #E74C3C;">{{c.result.issues_high || 0}}</div>
                <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: #E74C3C; letter-spacing: 0.5px;">High</div>
              </div>
              <div style="background: var(--fha-warning-bg); border: 1px solid var(--fha-warning-light); border-radius: 8px; padding: 12px; text-align: center;">
                <div style="font-size: 28px; font-weight: 800; color: var(--fha-warning);">{{c.result.issues_medium || 0}}</div>
                <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--fha-warning); letter-spacing: 0.5px;">Medium</div>
              </div>
              <div style="background: var(--fha-info-bg); border: 1px solid var(--fha-info-light); border-radius: 8px; padding: 12px; text-align: center;">
                <div style="font-size: 28px; font-weight: 800; color: #5DADE2;">{{c.result.issues_low || 0}}</div>
                <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: #5DADE2; letter-spacing: 0.5px;">Low</div>
              </div>
            </div>
          </div>

          <!-- Summary footer -->
          <div style="margin-top: 16px; display: flex; gap: 20px; padding: 12px 16px; background: var(--fha-bg-section); border-radius: 6px; font-size: 13px; flex-wrap: wrap;">
            <span><i class="fa fa-list" style="color: var(--fha-primary);"></i> <strong>{{c.result.issue_count || 0}}</strong> total issues</span>
            <span><i class="fa fa-database" style="color: var(--fha-primary);"></i> <strong>{{c.result.record_count || 0}}</strong> records scanned</span>
            <span ng-if="c.result.duration_ms"><i class="fa fa-clock-o" style="color: var(--fha-primary);"></i> <strong>{{c.result.duration_ms}}ms</strong></span>
          </div>
        </div>
      </div>

      <!-- Recent Analyses -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h4><i class="fa fa-history"></i> ${Recent Analyses}</h4>
          <a ng-click="c.viewAllAnalyses()" class="fha-view-all-link" title="${View all analyses}">
            ${View All} <i class="fa fa-arrow-right"></i>
          </a>
        </div>
        <div class="fha-card-body" style="padding: 0;">
          <div ng-if="c.recentAnalyses.length === 0" style="padding: 30px; text-align: center; color: var(--fha-gray-500);">
            <i class="fa fa-inbox" style="font-size: 32px; margin-bottom: 10px;"></i>
            <p>${No recent analyses}</p>
          </div>
          <table class="fha-recent-table" ng-if="c.recentAnalyses.length > 0" style="width: 100%;">
            <thead>
              <tr>
                <th style="padding: 10px 16px;">Analysis</th>
                <th style="padding: 10px 16px;">Table / Config</th>
                <th style="padding: 10px 8px; text-align: center;">Issues</th>
                <th style="padding: 10px 8px; text-align: center;">Score</th>
                <th style="padding: 10px 8px;"></th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="analysis in c.recentAnalyses | limitTo:10"
                  style="cursor: pointer;"
                  ng-click="c.viewDetails(analysis.sys_id)">
                <td style="padding: 10px 16px;">
                  <strong style="font-family: monospace; font-size: 12px;">{{analysis.number}}</strong>
                  <div style="font-size: 10px; color: var(--fha-text-secondary); margin-top: 2px;">{{analysis.created_on | date:'short'}}</div>
                </td>
                <td style="padding: 10px 16px; max-width: 180px;">
                  <div style="font-size: 12px; font-weight: 600; color: var(--fha-anthracite); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{analysis.table_name}}">
                    {{analysis.configuration_name || analysis.table_name || 'N/A'}}
                  </div>
                  <div ng-if="analysis.configuration_name && analysis.table_name" style="font-size: 10px; color: var(--fha-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{analysis.table_name}}
                  </div>
                </td>
                <td style="padding: 10px 8px; text-align: center;">
                  <div style="display: flex; gap: 3px; justify-content: center; flex-wrap: wrap;">
                    <span ng-if="analysis.issues_critical > 0" style="background: var(--fha-danger); color: white; font-size: 10px; font-weight: 700; padding: 1px 5px; border-radius: 8px;" title="Critical">{{analysis.issues_critical}}C</span>
                    <span ng-if="analysis.issues_high > 0" style="background: #E74C3C; color: white; font-size: 10px; font-weight: 700; padding: 1px 5px; border-radius: 8px;" title="High">{{analysis.issues_high}}H</span>
                    <span ng-if="analysis.issues_medium > 0" style="background: var(--fha-warning); color: white; font-size: 10px; font-weight: 700; padding: 1px 5px; border-radius: 8px;" title="Medium">{{analysis.issues_medium}}M</span>
                    <span ng-if="analysis.issues_low > 0" style="background: #5DADE2; color: white; font-size: 10px; font-weight: 700; padding: 1px 5px; border-radius: 8px;" title="Low">{{analysis.issues_low}}L</span>
                    <span ng-if="!analysis.issues_critical && !analysis.issues_high && !analysis.issues_medium && !analysis.issues_low" style="font-size: 11px; color: var(--fha-text-secondary);">{{analysis.issue_count}} total</span>
                  </div>
                </td>
                <td style="padding: 10px 8px; text-align: center;">
                  <span style="font-size: 13px; font-weight: 800; padding: 4px 8px; border-radius: 12px;"
                        ng-style="{
                          'color': analysis.health_score >= 70 ? 'var(--fha-success)' : analysis.health_score >= 40 ? 'var(--fha-warning)' : 'var(--fha-danger)',
                          'background': analysis.health_score >= 70 ? 'var(--fha-success-bg)' : analysis.health_score >= 40 ? 'var(--fha-warning-bg)' : 'var(--fha-danger-bg)'
                        }">
                    {{analysis.health_score}}%
                  </span>
                </td>
                <td style="padding: 10px 8px;">
                  <button class="fha-btn-secondary fha-btn-sm" ng-click="$event.stopPropagation(); c.viewDetails(analysis.sys_id)" title="View details" style="font-size: 11px;">
                    <i class="fa fa-arrow-right"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Information Panel -->
    <div class="col-md-4">
      <div class="fha-card">
        <div class="fha-card-header">
          <h4><i class="fa fa-info-circle"></i> ${Information}</h4>
        </div>
        <div class="fha-card-body">
          <p><strong>{{c.tables.length}}</strong> ${available configurations}</p>
          
          <h5 style="margin-top: 20px; margin-bottom: 10px;">${The analyzer checks}:</h5>
          <ul style="padding-left: 20px; line-height: 1.8;">
            <li>${Unused custom fields}</li>
            <li>${Business Rules and Client Scripts}</li>
            <li>${Access Control}</li>
            <li>${Integrations and imports}</li>
            <li>${Workflows and Flows}</li>
            <li>${Notifications}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
]]></template>
    </sp_widget>
</record_update>
