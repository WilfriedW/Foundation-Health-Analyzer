<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, spUtil, $location) {
    var c = this;

    c.selectedConfig = null;
    c.loading = false;
    c.result = null;
    c.error = null;
    c.tables = c.data.configurations || [];
    c.recentAnalyses = c.data.recentAnalyses || [];
    c.analysisId = null;

    // Run analysis for selected configuration
    c.runAnalysis = function() {
        if (!c.selectedConfig) return;

        c.loading = true;
        c.result = null;
        c.error = null;

        c.server.get({
            action: 'run_analysis',
            configSysId: c.selectedConfig
        }).then(function(response) {
            c.loading = false;
            if (response.data.success) {
            c.result = response.data.runResult;
                c.analysisId = response.data.analysisId;
                // Refresh recent analyses
                c.refreshRecentAnalyses();
            } else {
                c.error = response.data.error || '${An error occurred}';
            }
        }, function(error) {
            c.loading = false;
            c.error = '${Server communication error}';
        });
    };

    // Load an existing result
    c.loadResult = function(analysisId) {
        c.loading = true;
        c.error = null;
        c.server.get({
            action: 'get_result',
            analysisId: analysisId
        }).then(function(response) {
            c.loading = false;
            if (response.data.success) {
                c.result = response.data.analysisResult;
                c.analysisId = analysisId;
            } else {
                c.error = response.data.error || '${Analysis not found}';
            }
        });
    };

    // Refresh recent analyses list
    c.refreshRecentAnalyses = function() {
        c.server.get({
            action: 'get_recent_analyses'
        }).then(function(response) {
            if (response.data.success) {
                c.recentAnalyses = response.data.analyses;
            }
        });
    };

    // Navigate to detailed results
    c.viewDetails = function(analysisId) {
        window.location.href = '/fha?id=fha_analysis_results&sys_id=' + analysisId;
    };

    // Get severity class for styling
    c.getSeverityClass = function(severity) {
        switch(severity) {
            case 'high': return 'danger';
            case 'medium': return 'warning';
            case 'low': return 'info';
            default: return 'default';
        }
    };

    // Get health score class
    c.getHealthScoreClass = function(score) {
        if (score >= 70) return 'success';
        if (score >= 40) return 'warning';
        return 'danger';
    };

    // Calculate health score from issues
    c.calculateHealthScore = function() {
        if (!c.result || !c.result.issues) return 100;
        var score = 100;
        c.result.issues.forEach(function(issue) {
            if (issue.severity === 'high') score -= 15;
            else if (issue.severity === 'medium') score -= 5;
            else score -= 2;
        });
        return Math.max(0, score);
    };

    // Group issues by category
    c.getGroupedIssues = function() {
        if (!c.result || !c.result.issues) return {};
        
        var grouped = {};
        c.result.issues.forEach(function(issue) {
            var category = issue.category || 'general';
            if (!grouped[category]) {
                grouped[category] = [];
            }
            grouped[category].push(issue);
        });
        
        // Sort each category by severity
        Object.keys(grouped).forEach(function(key) {
            grouped[key].sort(function(a, b) {
                var severityOrder = { high: 0, medium: 1, low: 2 };
                return (severityOrder[a.severity] || 3) - (severityOrder[b.severity] || 3);
            });
        });
        
        return grouped;
    };

    // Get category display name
    c.getCategoryLabel = function(category) {
        var labels = {
            field: '${Fields}',
            business_rule: '${Business Rules}',
            client_script: '${Client Scripts}',
            integration: '${Integrations}',
            automation: '${Automation}',
            security: '${Security}',
            notification: '${Notifications}',
            ui: '${User Interface}',
            general: '${General}'
        };
        return labels[category] || category;
    };

    // Get category icon
    c.getCategoryIcon = function(category) {
        var icons = {
            field: 'fa-columns',
            business_rule: 'fa-cogs',
            client_script: 'fa-code',
            integration: 'fa-exchange-alt',
            automation: 'fa-robot',
            security: 'fa-shield-alt',
            notification: 'fa-envelope',
            ui: 'fa-desktop',
            general: 'fa-info-circle'
        };
        return icons[category] || 'fa-exclamation-circle';
    };

    // Navigate to single record
    c.goToRecord = function(issue) {
        if (issue.record_sys_id && issue.record_table) {
            // Direct link to record
            var url = '/' + issue.record_table + '.do?sys_id=' + issue.record_sys_id;
            window.open(url, '_blank');
        } else if (issue.record_filter && issue.record_table) {
            // Link to filtered list
            var url = '/' + issue.record_table + '_list.do?sysparm_query=' + encodeURIComponent(issue.record_filter);
            window.open(url, '_blank');
        }
    };

    // Navigate to list of all records (filtered)
    c.goToList = function(issue) {
        if (issue.record_table) {
            var url = '/' + issue.record_table + '_list.do';
            if (issue.record_filter) {
                url += '?sysparm_query=' + encodeURIComponent(issue.record_filter);
            }
            window.open(url, '_blank');
        }
    };

    // Check if issue has a link
    c.hasRecordLink = function(issue) {
        return (issue.record_sys_id && issue.record_table) || (issue.record_filter && issue.record_table);
    };

    // Check if issue has a list link (for "View All")
    c.hasListLink = function(issue) {
        return issue.record_table && issue.record_filter;
    };

    // Get record count from message (extract number from message like "Table has 41 inactive...")
    c.getRecordCount = function(issue) {
        if (!issue.message) return '';
        var match = issue.message.match(/(\d+)/);
        return match ? match[1] : '';
    };

    // Get issues by severity
    c.getIssuesBySeverity = function(severity) {
        if (!c.result || !c.result.issues) return [];
        return c.result.issues.filter(function(issue) {
            return issue.severity === severity;
        });
    };

    // Count issues by severity
    c.countBySeverity = function(severity) {
        return c.getIssuesBySeverity(severity).length;
    };

    // View all analyses - opens native ServiceNow list
    c.viewAllAnalyses = function() {
        var url = '/x_1310794_founda_0_fha_results_list.do?sysparm_query=status=completed^ORDERBYDESCsys_created_on';
        window.open(url, '_blank');
    };

    // Toggle section visibility
    c.expandedSections = {};
    c.toggleSection = function(section) {
        c.expandedSections[section] = !c.expandedSections[section];
    };
    c.isSectionExpanded = function(section) {
        return c.expandedSections[section] === true;
    };

    // Get metrics safely
    c.getMetrics = function() {
        return (c.result && c.result.metrics) ? c.result.metrics : {};
    };

    // Get custom fields from metrics
    c.getCustomFields = function() {
        var metrics = c.getMetrics();
        return metrics.custom_fields || [];
    };

    // Get business rules from metrics
    c.getBusinessRules = function() {
        var metrics = c.getMetrics();
        return metrics.business_rules || [];
    };

    // Get all automation items
    c.getAutomationOverview = function() {
        var metrics = c.getMetrics();
        var items = [];
        
        // Scheduled Jobs
        if (metrics.scheduled_jobs) {
            metrics.scheduled_jobs.forEach(function(job) {
                items.push({
                    type: 'Scheduled Job',
                    name: job.name,
                    active: job.active,
                    sys_id: job.sys_id,
                    table: 'sysauto_script'
                });
            });
        }
        
        // Flows
        if (metrics.flows) {
            metrics.flows.forEach(function(flow) {
                items.push({
                    type: 'Flow',
                    name: flow.name,
                    active: flow.active,
                    sys_id: flow.sys_id,
                    table: 'sys_hub_flow'
                });
            });
        }
        
        // Workflows
        if (metrics.workflows) {
            metrics.workflows.forEach(function(wf) {
                items.push({
                    type: 'Workflow',
                    name: wf.name,
                    active: wf.active,
                    sys_id: wf.sys_id,
                    table: 'wf_workflow'
                });
            });
        }
        
        // Notifications
        if (metrics.notifications) {
            metrics.notifications.forEach(function(notif) {
                items.push({
                    type: 'Notification',
                    name: notif.name,
                    active: notif.active,
                    sys_id: notif.sys_id,
                    table: 'sysevent_email_action'
                });
            });
        }
        
        // UI Actions
        if (metrics.ui_actions) {
            metrics.ui_actions.forEach(function(action) {
                items.push({
                    type: 'UI Action',
                    name: action.name,
                    active: true,
                    sys_id: action.sys_id,
                    table: 'sys_ui_action'
                });
            });
        }
        
        return items;
    };

    // Get integrations overview
    c.getIntegrationsOverview = function() {
        var metrics = c.getMetrics();
        var items = [];
        
        if (metrics.data_sources) {
            metrics.data_sources.forEach(function(ds) {
                items.push({
                    type: 'Data Source',
                    name: ds.name,
                    active: ds.active,
                    sys_id: ds.sys_id,
                    table: 'sys_data_source'
                });
            });
        }
        
        if (metrics.transform_maps) {
            metrics.transform_maps.forEach(function(tm) {
                items.push({
                    type: 'Transform Map',
                    name: tm.name,
                    active: tm.active,
                    sys_id: tm.sys_id,
                    table: 'sys_transform_map'
                });
            });
        }
        
        return items;
    };

    // Open record from overview
    c.openOverviewRecord = function(item) {
        if (item.sys_id && item.table) {
            var url = '/' + item.table + '.do?sys_id=' + item.sys_id;
            window.open(url, '_blank');
        }
    };

    // Get category link for header button
    c.getCategoryListUrl = function(category) {
        var metrics = c.getMetrics();
        var tableName = c.result && c.result.table ? c.result.table : '';
        
        var urls = {
            'business_rule': '/sys_script_list.do?sysparm_query=collection=' + tableName,
            'client_script': '/sys_script_client_list.do?sysparm_query=table=' + tableName,
            'field': '/sys_dictionary_list.do?sysparm_query=name=' + tableName + '^elementSTARTSWITHu_',
            'automation': '/sysauto_script_list.do',
            'integration': '/sys_transform_map_list.do?sysparm_query=target_table=' + tableName,
            'security': '/sys_security_acl_list.do?sysparm_query=nameSTARTSWITH' + tableName
        };
        
        return urls[category] || '';
    };

    // Open category list
    c.openCategoryList = function(category) {
        var url = c.getCategoryListUrl(category);
        if (url) {
            window.open(url, '_blank');
        }
    };

    // Get category total count from metrics
    c.getCategoryTotalCount = function(category) {
        var metrics = c.getMetrics();
        
        switch(category) {
            case 'business_rule':
                return (metrics.active_br_count || 0) + (metrics.inactive_br_count || 0);
            case 'client_script':
                return metrics.client_script_count || 0;
            case 'field':
                return metrics.custom_field_count || 0;
            case 'automation':
                return (metrics.scheduled_job_count || 0) + (metrics.flow_count || 0) + 
                       (metrics.workflow_count || 0) + (metrics.notification_count || 0) +
                       (metrics.ui_action_count || 0);
            case 'integration':
                return (metrics.data_source_count || 0) + (metrics.transform_map_count || 0);
            default:
                return 0;
        }
    };
}
]]></client_script>
        <controller_as>c</controller_as>
        <css><![CDATA[/* FHA Dashboard Widget - Styles managed in FHA Theme (sp_theme) */
/* Widget-specific overrides only if needed */
]]></css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_dashboard</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>FHA Dashboard</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    // Load available configurations
    data.configurations = [];
    var configGr = new GlideRecord('x_1310794_founda_0_fha_configuration');
    configGr.addQuery('active', true);
    configGr.orderBy('name');
    configGr.query();
    
    while (configGr.next()) {
        var tableRef = configGr.table_reference.getRefRecord();
        data.configurations.push({
            config_sys_id: configGr.getUniqueValue(),
            display_name: configGr.getValue('name'),
            table_name: tableRef ? tableRef.getValue('name') : '',
            table_label: tableRef ? tableRef.getValue('label') : '',
            description: configGr.getValue('description')
        });
    }
    
    // Load recent analyses
    data.recentAnalyses = [];
    var resultsGr = new GlideRecord('x_1310794_founda_0_fha_results');
    resultsGr.addQuery('status', 'completed');
    resultsGr.orderByDesc('sys_created_on');
    resultsGr.setLimit(10);
    resultsGr.query();
    
    while (resultsGr.next()) {
        // Get table display name from reference
        var tableDisplayName = '';
        if (resultsGr.table_name && !resultsGr.table_name.nil()) {
            var tableRefGr = resultsGr.table_name.getRefRecord();
            if (tableRefGr) {
                tableDisplayName = tableRefGr.getValue('label') || tableRefGr.getValue('name') || '';
            }
        }
        
        data.recentAnalyses.push({
            sys_id: resultsGr.getUniqueValue(),
            number: resultsGr.getValue('number'),
            table_name: tableDisplayName,
            health_score: parseInt(resultsGr.getValue('health_score'), 10) || 0,
            issue_count: parseInt(resultsGr.getValue('issue_found'), 10) || 0,
            created_on: resultsGr.getValue('sys_created_on')
        });
    }
    
    // Handle server actions
    if (input && input.action) {
        switch(input.action) {
            case 'run_analysis':
                try {
                    var analyzer = new x_1310794_founda_0.FHAnalyzer();
                    var result = analyzer.runAnalysis(input.configSysId, {});
                    
                    if (result.success) {
                        data.success = true;
                        data.runResult = result.details;
                        data.analysisId = result.analysis_id;
                    } else {
                        data.success = false;
                        data.error = result.error;
                    }
                } catch(e) {
                    data.success = false;
                    data.error = e.message;
                }
                break;
                
            case 'get_result':
                try {
                    var analyzer = new x_1310794_founda_0.FHAnalyzer();
                    var result = analyzer.getAnalysisResult(input.analysisId);
                    data.success = result.success;
                    data.analysisResult = result.result;
                    data.error = result.error;
                } catch(e) {
                    data.success = false;
                    data.error = e.message;
                }
                break;
                
            case 'get_recent_analyses':
                data.success = true;
                data.analyses = [];
                var gr = new GlideRecord('x_1310794_founda_0_fha_results');
                gr.addQuery('status', 'completed');
                gr.orderByDesc('sys_created_on');
                gr.setLimit(10);
                gr.query();
                
                while (gr.next()) {
                    // Get table display name from reference
                    var tblName = '';
                    if (gr.table_name && !gr.table_name.nil()) {
                        var tblRef = gr.table_name.getRefRecord();
                        if (tblRef) {
                            tblName = tblRef.getValue('label') || tblRef.getValue('name') || '';
                        }
                    }
                    
                    data.analyses.push({
                        sys_id: gr.getUniqueValue(),
                        number: gr.getValue('number'),
                        table_name: tblName,
                        health_score: parseInt(gr.getValue('health_score'), 10) || 0,
                        issue_count: parseInt(gr.getValue('issue_found'), 10) || 0,
                        created_on: gr.getValue('sys_created_on')
                    });
                }
                break;
        }
    }
})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-02 19:41:08</sys_created_on>
        <sys_id>223611488392321083e1b4a6feaad3db</sys_id>
        <sys_mod_count>24</sys_mod_count>
        <sys_name>FHA Dashboard</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_223611488392321083e1b4a6feaad3db</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-03 07:53:42</sys_updated_on>
        <template><![CDATA[<div class="fha-dashboard">
  
  <!-- Header -->
  <div class="fha-header">
    <h2><i class="fa fa-heartbeat"></i> Foundation Health Analyzer</h2>
    <p>${Analyze the health of your ServiceNow tables and get improvement recommendations}</p>
  </div>

  <div class="row">
    <!-- Main Analysis Panel -->
    <div class="col-md-8">
      <div class="fha-card">
        <div class="fha-card-header">
          <h4><i class="fa fa-play-circle"></i> ${Run Analysis}</h4>
        </div>
        <div class="fha-card-body">
          
          <!-- Configuration Selection -->
          <div class="form-group" style="margin-bottom: 20px;">
            <label style="font-weight: 600; margin-bottom: 10px; display: block;">
              ${Select a configuration to analyze}
            </label>
            <select class="fha-select"
              ng-model="c.selectedConfig"
                    ng-options="t.config_sys_id as (t.display_name + ' (' + t.table_name + ')') for t in c.tables">
              <option value="">-- ${Choose a table} --</option>
      </select>
    </div>

          <!-- Selected Config Description -->
          <div ng-if="c.selectedConfig" style="margin-bottom: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px;">
            <div ng-repeat="t in c.tables" ng-if="t.config_sys_id === c.selectedConfig">
              <strong>{{t.display_name}}</strong>
              <p style="margin: 5px 0 0 0; color: #666;">{{t.description || '${No description}'}}</p>
            </div>
          </div>

          <!-- Run Button -->
          <button class="fha-btn-primary"
            ng-click="c.runAnalysis()"
            ng-disabled="!c.selectedConfig || c.loading">
            <i class="fa" ng-class="c.loading ? 'fa-spinner fa-spin' : 'fa-search'"></i>
            {{c.loading ? '${Analysis in progress...}' : '${Run Analysis}'}}
    </button>

          <!-- Error Message -->
          <div ng-if="c.error" class="alert alert-danger" style="margin-top: 20px;">
            <i class="fa fa-exclamation-triangle"></i> {{c.error}}
          </div>
        </div>
      </div>

      <!-- Results Panel -->
      <div class="fha-card" ng-if="c.result">
        <div class="fha-card-header">
          <h4><i class="fa fa-chart-bar"></i> ${Analysis Results}</h4>
        </div>
        <div class="fha-card-body">
          
          <!-- Stats Row -->
          <div class="fha-stats-row">
            <div class="fha-stat-box">
              <div class="fha-stat-value">
                <span class="fha-score-badge" 
                      ng-class="'fha-score-' + c.getHealthScoreClass(c.calculateHealthScore())">
                  {{c.calculateHealthScore()}}/100
    </span>
              </div>
              <div class="fha-stat-label">${Health Score}</div>
            </div>
            <div class="fha-stat-box">
              <div class="fha-stat-value">{{c.result.issues.length}}</div>
              <div class="fha-stat-label">${Issues Found}</div>
            </div>
            <div class="fha-stat-box">
              <div class="fha-stat-value">{{c.result.metrics.duration_ms || 0}}ms</div>
              <div class="fha-stat-label">${Analysis Duration}</div>
            </div>
    </div>

          <!-- Severity Summary -->
          <div class="fha-severity-summary" ng-if="c.result.issues && c.result.issues.length > 0">
            <div class="fha-severity-badge high" ng-if="c.countBySeverity('high') > 0">
              <i class="fa fa-exclamation-triangle"></i>
              {{c.countBySeverity('high')}} ${High}
            </div>
            <div class="fha-severity-badge medium" ng-if="c.countBySeverity('medium') > 0">
              <i class="fa fa-exclamation-circle"></i>
              {{c.countBySeverity('medium')}} ${Medium}
            </div>
            <div class="fha-severity-badge low" ng-if="c.countBySeverity('low') > 0">
              <i class="fa fa-info-circle"></i>
              {{c.countBySeverity('low')}} ${Low}
            </div>
    </div>

          <!-- No Issues Message -->
          <div ng-if="c.result.issues && c.result.issues.length === 0" class="fha-no-issues">
            <i class="fa fa-check-circle"></i>
            <h4>${Excellent!}</h4>
            <p>${No issues detected on this table.}</p>
          </div>

          <!-- ==================== FIELDS SECTION ==================== -->
          <div class="fha-section" ng-if="c.getCustomFields().length > 0">
            <div class="fha-section-header" ng-click="c.toggleSection('fields')">
              <div class="fha-section-title">
                <i class="fa fa-columns"></i>
                <h5>${Custom Fields}</h5>
                <span class="fha-section-count">{{c.getCustomFields().length}} ${fields}</span>
              </div>
              <div class="fha-section-actions">
                <a class="fha-header-link" ng-click="$event.stopPropagation(); c.openCategoryList('field')">
                  <i class="fa fa-external-link-alt"></i> ${View All}
                </a>
                <i class="fa" ng-class="c.isSectionExpanded('fields') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </div>
            </div>
            
            <!-- Issues for Fields -->
            <div class="fha-section-issues" ng-if="c.getGroupedIssues()['field']">
              <div class="fha-issue-item" ng-repeat="issue in c.getGroupedIssues()['field']"
                   ng-class="{'clickable': c.hasRecordLink(issue)}"
                   ng-click="c.hasRecordLink(issue) && c.goToRecord(issue)">
                <span class="fha-issue-severity" ng-class="'fha-severity-' + issue.severity">{{issue.severity}}</span>
                <div class="fha-issue-content">
                  <div class="fha-issue-code">{{issue.code}}</div>
                  <div class="fha-issue-message">{{issue.message}}</div>
                </div>
                <a class="fha-issue-link" ng-if="c.hasRecordLink(issue)" 
                   ng-click="$event.stopPropagation(); c.goToRecord(issue)">
                  <i class="fa fa-external-link-alt"></i> ${View}
                </a>
              </div>
      </div>

            <!-- Overview of all custom fields -->
            <div class="fha-section-overview" ng-show="c.isSectionExpanded('fields')">
              <div class="fha-overview-header">${All Custom Fields}</div>
              <table class="fha-overview-table">
                <thead>
                  <tr>
                    <th>${Field Name}</th>
                    <th>${Label}</th>
                    <th>${Type}</th>
                    <th>${Fill Rate}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="field in c.getCustomFields()" 
                      ng-class="{'fha-row-warning': field.fill_rate < 10, 'fha-row-danger': field.fill_rate === 0}">
                    <td><code>{{field.name}}</code></td>
                    <td>{{field.label}}</td>
                    <td><span class="fha-type-badge">{{field.type}}</span></td>
                    <td>
                      <div class="fha-fill-rate">
                        <div class="fha-fill-bar" ng-style="{'width': field.fill_rate + '%'}" 
                             ng-class="{'danger': field.fill_rate === 0, 'warning': field.fill_rate > 0 && field.fill_rate < 10, 'success': field.fill_rate >= 10}"></div>
                        <span>{{field.fill_rate}}%</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ==================== BUSINESS RULES SECTION ==================== -->
          <div class="fha-section" ng-if="c.getCategoryTotalCount('business_rule') > 0">
            <div class="fha-section-header" ng-click="c.toggleSection('business_rules')">
              <div class="fha-section-title">
                <i class="fa fa-cogs"></i>
                <h5>${Business Rules}</h5>
                <span class="fha-section-count">{{c.getCategoryTotalCount('business_rule')}} ${total}</span>
                <span class="fha-section-detail">({{c.getMetrics().active_br_count || 0}} ${active}, {{c.getMetrics().inactive_br_count || 0}} ${inactive})</span>
              </div>
              <div class="fha-section-actions">
                <a class="fha-header-link fha-header-link-green" ng-click="$event.stopPropagation(); c.openCategoryList('business_rule')">
                  <i class="fa fa-list"></i> {{c.getCategoryTotalCount('business_rule')}} ${records}
                </a>
                <i class="fa" ng-class="c.isSectionExpanded('business_rules') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </div>
            </div>
            
            <!-- Issues for Business Rules -->
            <div class="fha-section-issues" ng-if="c.getGroupedIssues()['business_rule']">
              <div class="fha-issue-item" ng-repeat="issue in c.getGroupedIssues()['business_rule']">
                <span class="fha-issue-severity" ng-class="'fha-severity-' + issue.severity">{{issue.severity}}</span>
                <div class="fha-issue-content">
                  <div class="fha-issue-code">{{issue.code}}</div>
                  <div class="fha-issue-message">{{issue.message}}</div>
                </div>
              </div>
            </div>

            <!-- Overview of all business rules -->
            <div class="fha-section-overview" ng-show="c.isSectionExpanded('business_rules')">
              <div class="fha-overview-header">${All Business Rules}</div>
              <table class="fha-overview-table">
                <thead>
                  <tr>
                    <th>${Name}</th>
                    <th>${When}</th>
                    <th>${Order}</th>
                    <th>${Status}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="br in c.getBusinessRules()" ng-class="{'fha-row-inactive': !br.active}">
                    <td>
                      <a ng-click="c.openOverviewRecord({sys_id: br.sys_id, table: 'sys_script'})">{{br.name}}</a>
                    </td>
                    <td>{{br.when}}</td>
                    <td>{{br.order}}</td>
                    <td>
                      <span class="fha-status-badge" ng-class="br.active ? 'active' : 'inactive'">
                        {{br.active ? '${Active}' : '${Inactive}'}}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ==================== AUTOMATION SECTION ==================== -->
          <div class="fha-section" ng-if="c.getCategoryTotalCount('automation') > 0">
            <div class="fha-section-header" ng-click="c.toggleSection('automation')">
              <div class="fha-section-title">
                <i class="fa fa-robot"></i>
                <h5>${Automation}</h5>
                <span class="fha-section-count">{{c.getCategoryTotalCount('automation')}} ${items}</span>
              </div>
              <div class="fha-section-actions">
                <i class="fa" ng-class="c.isSectionExpanded('automation') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </div>
            </div>
            
            <!-- Issues for Automation -->
            <div class="fha-section-issues" ng-if="c.getGroupedIssues()['automation']">
              <div class="fha-issue-item" ng-repeat="issue in c.getGroupedIssues()['automation']"
                   ng-class="{'clickable': c.hasRecordLink(issue)}"
                   ng-click="c.hasRecordLink(issue) && c.goToRecord(issue)">
                <span class="fha-issue-severity" ng-class="'fha-severity-' + issue.severity">{{issue.severity}}</span>
                <div class="fha-issue-content">
                  <div class="fha-issue-code">{{issue.code}}</div>
                  <div class="fha-issue-message">{{issue.message}}</div>
                </div>
                <a class="fha-issue-link" ng-if="c.hasRecordLink(issue)" 
                   ng-click="$event.stopPropagation(); c.goToRecord(issue)">
                  <i class="fa fa-external-link-alt"></i> ${View}
                </a>
              </div>
            </div>

            <!-- Overview of all automation -->
            <div class="fha-section-overview" ng-show="c.isSectionExpanded('automation')">
              <div class="fha-overview-header">${All Automation Items}</div>
              <table class="fha-overview-table">
                <thead>
                  <tr>
                    <th>${Type}</th>
                    <th>${Name}</th>
                    <th>${Status}</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="item in c.getAutomationOverview()" ng-class="{'fha-row-inactive': !item.active}">
                    <td><span class="fha-type-badge">{{item.type}}</span></td>
                    <td>{{item.name}}</td>
                    <td>
                      <span class="fha-status-badge" ng-class="item.active ? 'active' : 'inactive'">
                        {{item.active ? '${Active}' : '${Inactive}'}}
                      </span>
                    </td>
                    <td>
                      <a class="fha-mini-link" ng-click="c.openOverviewRecord(item)" ng-if="item.sys_id">
                        <i class="fa fa-external-link-alt"></i>
                      </a>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ==================== INTEGRATIONS SECTION ==================== -->
          <div class="fha-section" ng-if="c.getCategoryTotalCount('integration') > 0 || c.getGroupedIssues()['integration']">
            <div class="fha-section-header" ng-click="c.toggleSection('integration')">
              <div class="fha-section-title">
                <i class="fa fa-exchange-alt"></i>
                <h5>${Integrations}</h5>
                <span class="fha-section-count">{{c.getCategoryTotalCount('integration')}} ${items}</span>
              </div>
              <div class="fha-section-actions">
                <a class="fha-header-link" ng-click="$event.stopPropagation(); c.openCategoryList('integration')">
                  <i class="fa fa-external-link-alt"></i> ${View All}
                </a>
                <i class="fa" ng-class="c.isSectionExpanded('integration') ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </div>
            </div>
            
            <!-- Issues for Integrations -->
            <div class="fha-section-issues" ng-if="c.getGroupedIssues()['integration']">
              <div class="fha-issue-item" ng-repeat="issue in c.getGroupedIssues()['integration']"
                   ng-class="{'clickable': c.hasRecordLink(issue)}"
                   ng-click="c.hasRecordLink(issue) && c.goToRecord(issue)">
                <span class="fha-issue-severity" ng-class="'fha-severity-' + issue.severity">{{issue.severity}}</span>
                <div class="fha-issue-content">
                  <div class="fha-issue-code">{{issue.code}}</div>
                  <div class="fha-issue-message">{{issue.message}}</div>
                </div>
                <a class="fha-issue-link" ng-if="c.hasRecordLink(issue)" 
                   ng-click="$event.stopPropagation(); c.goToRecord(issue)">
                  <i class="fa fa-external-link-alt"></i> ${View}
                </a>
              </div>
            </div>

            <!-- Overview of all integrations -->
            <div class="fha-section-overview" ng-show="c.isSectionExpanded('integration')">
              <div class="fha-overview-header">${All Integration Items}</div>
              <table class="fha-overview-table">
                <thead>
                  <tr>
                    <th>${Type}</th>
                    <th>${Name}</th>
                    <th>${Status}</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="item in c.getIntegrationsOverview()" ng-class="{'fha-row-inactive': !item.active}">
                    <td><span class="fha-type-badge">{{item.type}}</span></td>
                    <td>{{item.name}}</td>
                    <td>
                      <span class="fha-status-badge" ng-class="item.active ? 'active' : 'inactive'">
                        {{item.active ? '${Active}' : '${Inactive}'}}
                      </span>
                    </td>
                    <td>
                      <a class="fha-mini-link" ng-click="c.openOverviewRecord(item)" ng-if="item.sys_id">
                        <i class="fa fa-external-link-alt"></i>
                      </a>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ==================== SECURITY SECTION ==================== -->
          <div class="fha-section" ng-if="c.getGroupedIssues()['security']">
            <div class="fha-section-header">
              <div class="fha-section-title">
                <i class="fa fa-shield-alt"></i>
                <h5>${Security}</h5>
                <span class="fha-section-count">{{c.getGroupedIssues()['security'].length}} ${issues}</span>
              </div>
              <div class="fha-section-actions">
                <a class="fha-header-link" ng-click="c.openCategoryList('security')">
                  <i class="fa fa-external-link-alt"></i> ${View ACLs}
                </a>
              </div>
            </div>
            <div class="fha-section-issues">
              <div class="fha-issue-item" ng-repeat="issue in c.getGroupedIssues()['security']">
                <span class="fha-issue-severity" ng-class="'fha-severity-' + issue.severity">{{issue.severity}}</span>
                <div class="fha-issue-content">
                  <div class="fha-issue-code">{{issue.code}}</div>
                  <div class="fha-issue-message">{{issue.message}}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ==================== OTHER ISSUES (General, UI, etc.) ==================== -->
          <div class="fha-section" ng-repeat="(category, issues) in c.getGroupedIssues()" 
               ng-if="category !== 'field' && category !== 'business_rule' && category !== 'automation' && category !== 'integration' && category !== 'security'">
            <div class="fha-section-header">
              <div class="fha-section-title">
                <i class="fa" ng-class="c.getCategoryIcon(category)"></i>
                <h5>{{c.getCategoryLabel(category)}}</h5>
                <span class="fha-section-count">{{issues.length}} ${issues}</span>
              </div>
            </div>
            <div class="fha-section-issues">
              <div class="fha-issue-item" ng-repeat="issue in issues"
                   ng-class="{'clickable': c.hasRecordLink(issue)}"
                   ng-click="c.hasRecordLink(issue) && c.goToRecord(issue)">
                <span class="fha-issue-severity" ng-class="'fha-severity-' + issue.severity">{{issue.severity}}</span>
                <div class="fha-issue-content">
                  <div class="fha-issue-code">{{issue.code}}</div>
                  <div class="fha-issue-message">{{issue.message}}</div>
                </div>
                <a class="fha-issue-link" ng-if="c.hasRecordLink(issue)" 
                   ng-click="$event.stopPropagation(); c.goToRecord(issue)">
                  <i class="fa fa-external-link-alt"></i> ${View}
                </a>
              </div>
            </div>
          </div>

          <!-- View Details Button -->
          <div style="margin-top: 20px; text-align: right;" ng-if="c.analysisId">
            <button class="fha-btn-primary" ng-click="c.viewDetails(c.analysisId)">
              <i class="fa fa-arrow-right"></i> ${View Full Details}
            </button>
          </div>
        </div>
      </div>
      </div>

    <!-- Sidebar -->
    <div class="col-md-4">
      <!-- Quick Stats (moved to top) -->
      <div class="fha-card">
        <div class="fha-card-header">
          <h4><i class="fa fa-info-circle"></i> ${Information}</h4>
        </div>
        <div class="fha-card-body">
          <p><strong>{{c.tables.length}}</strong> ${available configurations}</p>
          <p style="font-size: 13px; color: #666; margin-top: 15px;">
            ${The analyzer checks:}
          </p>
          <ul style="font-size: 13px; color: #666; padding-left: 20px;">
            <li>${Unused custom fields}</li>
            <li>${Business Rules and Client Scripts}</li>
            <li>${ACLs and security}</li>
            <li>${Integrations and imports}</li>
            <li>${Workflows and Flows}</li>
            <li>${Notifications}</li>
          </ul>
        </div>
      </div>

      <!-- Recent Analyses (moved to bottom, limited to 10) -->
      <div class="fha-card">
        <div class="fha-card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h4 style="margin: 0;"><i class="fa fa-history"></i> ${Recent Analyses}</h4>
          <a ng-click="c.viewAllAnalyses()" class="fha-view-all-link" title="${View all analyses}">
            ${View All} <i class="fa fa-arrow-right"></i>
        </a>
      </div>
        <div class="fha-card-body" style="padding: 0;">
          <div ng-if="c.recentAnalyses.length === 0" style="padding: 30px; text-align: center; color: #999;">
            <i class="fa fa-inbox" style="font-size: 32px; margin-bottom: 10px;"></i>
            <p>${No recent analyses}</p>
          </div>
          <table class="fha-recent-table" ng-if="c.recentAnalyses.length > 0">
            <thead>
              <tr>
                <th>${Table}</th>
                <th>${Score}</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="analysis in c.recentAnalyses | limitTo:10">
                <td>
                  <strong>{{analysis.table_name || 'N/A'}}</strong>
                  <div style="font-size: 11px; color: #999;">{{analysis.number}}</div>
                </td>
                <td>
                  <span class="fha-score-badge" 
                        ng-class="'fha-score-' + c.getHealthScoreClass(analysis.health_score)"
                        style="font-size: 14px; padding: 4px 10px;">
                    {{analysis.health_score}}/100
                  </span>
                </td>
                <td>
                  <button class="btn btn-xs btn-default" ng-click="c.loadResult(analysis.sys_id)" title="${Load this analysis}">
                    <i class="fa fa-eye"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
]]></template>
    </sp_widget>
</record_update>
