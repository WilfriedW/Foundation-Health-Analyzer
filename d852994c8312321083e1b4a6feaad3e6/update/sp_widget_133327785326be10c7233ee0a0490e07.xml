<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function($scope, $timeout) {
  var c = this;

  c.loading = false;
  c.error = null;
  c.trendingDays = 30;
  c.trending = c.data.trending || [];
  c.summary = c.data.summary || {};

  // Chart instance reference
  var trendChart = null;

  c.$onInit = function() {
    $timeout(function() {
      c.renderChart();
    }, 200);
  };

  c.changePeriod = function(days) {
    if (c.trendingDays === days) return;
    c.trendingDays = days;
    c.refresh();
  };

  c.refresh = function() {
    c.loading = true;
    c.error = null;
    c.server.get({ action: 'get_trending', days: c.trendingDays }).then(function(response) {
      if (response.data.success) {
        c.trending = response.data.trending;
        c.summary = response.data.summary;
        $timeout(function() { c.renderChart(); }, 100);
      } else {
        c.error = response.data.error || 'Error loading trending data';
      }
    }).finally(function() {
      c.loading = false;
    });
  };

  c.renderChart = function() {
    var canvas = document.getElementById('fha-trending-chart');
    if (!canvas) return;

    if (trendChart) trendChart.destroy();

    var labels = c.trending.map(function(d) { return d.date; });
    var healthScores = c.trending.map(function(d) { return d.avg_health_score; });
    var totalIssues = c.trending.map(function(d) { return d.total_issues; });
    var criticalIssues = c.trending.map(function(d) { return d.critical_issues; });
    var highIssues = c.trending.map(function(d) { return d.high_issues; });

    trendChart = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Health Score',
            data: healthScores,
            borderColor: '#16a34a',
            backgroundColor: 'rgba(22,163,74,0.08)',
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            yAxisID: 'y-health'
          },
          {
            label: 'Total Issues',
            data: totalIssues,
            borderColor: '#0c63d4',
            backgroundColor: 'rgba(12,99,212,0.08)',
            borderWidth: 2,
            tension: 0.4,
            fill: false,
            yAxisID: 'y-issues'
          },
          {
            label: 'Critical',
            data: criticalIssues,
            borderColor: '#dc2626',
            borderWidth: 1.5,
            borderDash: [4, 4],
            tension: 0.4,
            fill: false,
            yAxisID: 'y-issues'
          },
          {
            label: 'High',
            data: highIssues,
            borderColor: '#f97316',
            borderWidth: 1.5,
            borderDash: [4, 4],
            tension: 0.4,
            fill: false,
            yAxisID: 'y-issues'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'top', labels: { usePointStyle: true, pointStyle: 'circle', padding: 12, font: { size: 11 } } },
          tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', padding: 10 }
        },
        scales: {
          x: { grid: { display: false }, ticks: { maxRotation: 45, font: { size: 10 } } },
          'y-health': {
            type: 'linear', position: 'left', min: 0, max: 100,
            ticks: { callback: function(v) { return v + '%'; }, font: { size: 10 } },
            title: { display: true, text: 'Health Score', font: { size: 11 } },
            grid: { color: 'rgba(0,0,0,0.04)' }
          },
          'y-issues': {
            type: 'linear', position: 'right', min: 0,
            ticks: { font: { size: 10 } },
            title: { display: true, text: 'Issues', font: { size: 11 } },
            grid: { display: false }
          }
        }
      }
    });
  };

  c.$onDestroy = function() {
    if (trendChart) trendChart.destroy();
  };
};]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_trending_analysis</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Trending Analysis</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  data.trending = [];
  data.summary = {};
  data.success = false;
  data.error = null;

  var days = (input && input.days) ? parseInt(input.days) : 30;

  try {
    var engine = new x_1310794_founda_0.FHMetricsEngine();
    var trending = engine.getTrendingData(days);

    data.trending = trending;
    data.success = true;

    // Build summary from trending data
    var totalAnalyses = 0;
    var totalIssues = 0;
    var totalCritical = 0;
    var scores = [];

    trending.forEach(function(day) {
      totalAnalyses += day.analyses_count || 0;
      totalIssues += day.total_issues || 0;
      totalCritical += day.critical_issues || 0;
      if (day.avg_health_score > 0) scores.push(day.avg_health_score);
    });

    var avgScore = 0;
    if (scores.length > 0) {
      avgScore = Math.round(scores.reduce(function(a, b) { return a + b; }, 0) / scores.length);
    }

    // Trend direction: compare first half vs second half
    var trend = 'stable';
    if (scores.length >= 4) {
      var mid = Math.floor(scores.length / 2);
      var firstHalf = scores.slice(0, mid).reduce(function(a, b) { return a + b; }, 0) / mid;
      var secondHalf = scores.slice(mid).reduce(function(a, b) { return a + b; }, 0) / (scores.length - mid);
      if (secondHalf - firstHalf > 3) trend = 'improving';
      else if (firstHalf - secondHalf > 3) trend = 'declining';
    }

    data.summary = {
      total_analyses: totalAnalyses,
      total_issues: totalIssues,
      total_critical: totalCritical,
      avg_health_score: avgScore,
      days_with_data: scores.length,
      trend: trend
    };

  } catch (e) {
    gs.error('[FHA Trending Widget] Error: ' + e.message);
    data.error = e.message;
    data.success = false;
  }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-18 00:06:38</sys_created_on>
        <sys_id>133327785326be10c7233ee0a0490e07</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>Trending Analysis</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_133327785326be10c7233ee0a0490e07</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-18 09:31:51</sys_updated_on>
        <template><![CDATA[<div class="fha-trending-widget">

  <!-- Loading -->
  <div ng-if="c.loading" style="text-align:center; padding:40px;">
    <i class="fa fa-spinner fa-spin fa-2x"></i>
    <p style="margin-top:8px; color:#6b7280;">Loading trends...</p>
  </div>

  <!-- Error -->
  <div ng-if="c.error" class="alert alert-danger" style="margin:16px;">
    <i class="fa fa-exclamation-triangle"></i> {{c.error}}
  </div>

  <!-- Content -->
  <div ng-if="!c.loading">

    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:12px;">
      <h3 style="margin:0; font-size:18px; font-weight:700; color:#1e293b;">
        <i class="fa fa-area-chart" style="color:#0c63d4;"></i> Trending Analysis
      </h3>
      <div style="display:flex; gap:4px;">
        <button class="btn btn-xs" ng-class="{'btn-primary': c.trendingDays==7, 'btn-default': c.trendingDays!=7}" ng-click="c.changePeriod(7)">7d</button>
        <button class="btn btn-xs" ng-class="{'btn-primary': c.trendingDays==30, 'btn-default': c.trendingDays!=30}" ng-click="c.changePeriod(30)">30d</button>
        <button class="btn btn-xs" ng-class="{'btn-primary': c.trendingDays==60, 'btn-default': c.trendingDays!=60}" ng-click="c.changePeriod(60)">60d</button>
        <button class="btn btn-xs" ng-class="{'btn-primary': c.trendingDays==90, 'btn-default': c.trendingDays!=90}" ng-click="c.changePeriod(90)">90d</button>
      </div>
    </div>

    <!-- Summary Cards -->
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px,1fr)); gap:12px; margin-bottom:20px;">
      <div style="background:#f0fdf4; border-radius:8px; padding:14px; border-left:3px solid #16a34a;">
        <div style="font-size:10px; color:#6b7280; font-weight:600; text-transform:uppercase;">Avg Score</div>
        <div style="font-size:22px; font-weight:700; color:#16a34a;">{{c.summary.avg_health_score || 0}}%</div>
      </div>
      <div style="background:#eff6ff; border-radius:8px; padding:14px; border-left:3px solid #0c63d4;">
        <div style="font-size:10px; color:#6b7280; font-weight:600; text-transform:uppercase;">Total Issues</div>
        <div style="font-size:22px; font-weight:700; color:#0c63d4;">{{c.summary.total_issues || 0}}</div>
      </div>
      <div style="background:#fef2f2; border-radius:8px; padding:14px; border-left:3px solid #dc2626;">
        <div style="font-size:10px; color:#6b7280; font-weight:600; text-transform:uppercase;">Critical</div>
        <div style="font-size:22px; font-weight:700; color:#dc2626;">{{c.summary.total_critical || 0}}</div>
      </div>
      <div style="padding:14px; border-radius:8px; border-left:3px solid;"
           ng-style="{
             'background': c.summary.trend=='improving' ? '#f0fdf4' : c.summary.trend=='declining' ? '#fef2f2' : '#f8fafc',
             'border-left-color': c.summary.trend=='improving' ? '#16a34a' : c.summary.trend=='declining' ? '#dc2626' : '#94a3b8'
           }">
        <div style="font-size:10px; color:#6b7280; font-weight:600; text-transform:uppercase;">Trend</div>
        <div style="font-size:16px; font-weight:700;"
             ng-style="{'color': c.summary.trend=='improving' ? '#16a34a' : c.summary.trend=='declining' ? '#dc2626' : '#64748b'}">
          <i class="fa" ng-class="{'fa-arrow-up': c.summary.trend=='improving', 'fa-arrow-down': c.summary.trend=='declining', 'fa-minus': c.summary.trend=='stable'}"></i>
          {{c.summary.trend | uppercase}}
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
      <div style="height:300px;">
        <canvas id="fha-trending-chart"></canvas>
      </div>
      <div ng-if="c.trending.length==0" style="text-align:center; padding:40px; color:#9ca3af;">
        <i class="fa fa-line-chart fa-3x" style="margin-bottom:12px;"></i>
        <p>No trending data available for this period</p>
      </div>
    </div>

  </div>
</div>]]></template>
    </sp_widget>
</record_update>
