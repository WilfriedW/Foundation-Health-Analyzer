<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ws_operation">
    <sys_ws_operation action="INSERT_OR_UPDATE">
        <active>true</active>
        <consumes>application/json,application/xml,text/xml</consumes>
        <consumes_customized>false</consumes_customized>
        <default_operation_uri/>
        <enforce_acl/>
        <http_method>GET</http_method>
        <name>Analyze by config</name>
        <operation_script><![CDATA[(function process(/*RESTAPIRequest*/ request, /*RESTAPIResponse*/ response) {
    
    try {
        var config_sys_id = request.pathParams.config_sys_id;
        var user = gs.getUserName();
        
        if (!config_sys_id) {
            return sendError(response, 400, 'Missing config_sys_id parameter');
        }
        
        // Verify configuration exists
        var grConfig = new GlideRecord('x_1310794_founda_0_fha_configuration');
        if (!grConfig.get(config_sys_id)) {
            return sendError(response, 404, 'Configuration not found: ' + config_sys_id);
        }
        
        // Check if active
        if (grConfig.getValue('active') !== '1') {
            return sendError(response, 400, 'Configuration is not active');
        }
        
        // Create analysis instance
        var analyzer = new FHAnalyzer();
        
        // Prepare parameters
        var params = {
            deep_scan: true,
            user_sys_id: gs.getUserID(),
            config_sys_id: config_sys_id
        };
        
        // Start analysis
        var startTime = new Date().getTime();
        var result = analyzer.analyzeTable(config_sys_id, params);
        var duration = Math.round((new Date().getTime() - startTime) / 1000);
        
        // Update configuration with last analysis date
        grConfig.setValue('last_analysis_date', new GlideDateTime());
        grConfig.setValue('analysis_duration', duration);
        grConfig.update();
        
        // Return result
        var responseBody = {
            success: result.success || false,
            status: result.success ? 'COMPLETED' : 'FAILED',
            analysis_id: result.analysis_id || null,
            result_sys_id: result.result_sys_id || null,
            config_sys_id: config_sys_id,
            table_name: result.table_name || '',
            issues_found: result.issues_found || 0,
            total_fields_analyzed: result.total_fields || 0,
            duration: result.duration || duration,
            message: result.message || 'Analysis processed',
            error: result.error || null,
            timestamp: new GlideDateTime().getDisplayValue()
        };
        
        return sendSuccess(response, responseBody);
        
    } catch (e) {
        gs.error('FHA API Error in analyze_by_config: ' + e);
        gs.error('Stack: ' + e.stack);
        return sendError(response, 500, 'Server error: ' + e.toString());
    }
    
})(request, response);

// Helper function for success response
function sendSuccess(response, data) {
    response.setStatus(200);
    response.setHeader('Content-Type', 'application/json');
    response.setBody(data);
}

// Helper function for error response
function sendError(response, statusCode, message) {
    response.setStatus(statusCode);
    response.setHeader('Content-Type', 'application/json');
    response.setBody({
        success: false,
        error: message,
        statusCode: statusCode,
        timestamp: new GlideDateTime().getDisplayValue()
    });
}
]]></operation_script>
        <operation_uri>/api/x_1310794_founda_0/fha/analyze_by_config/{config_sys_id}</operation_uri>
        <produces>application/json,application/xml,text/xml</produces>
        <produces_customized>false</produces_customized>
        <relative_path>/analyze_by_config/{config_sys_id}</relative_path>
        <request_example/>
        <requires_acl_authorization>true</requires_acl_authorization>
        <requires_authentication>true</requires_authentication>
        <requires_snc_internal_role>true</requires_snc_internal_role>
        <short_description/>
        <sys_class_name>sys_ws_operation</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-02 22:28:58</sys_created_on>
        <sys_id>dfecb14883d6321083e1b4a6feaad35b</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Analyze by config</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_ws_operation_dfecb14883d6321083e1b4a6feaad35b</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-02 22:28:58</sys_updated_on>
        <web_service_definition display_value="Foundation Health Analyzer API">8add5d0883d2321083e1b4a6feaad355</web_service_definition>
        <web_service_version/>
    </sys_ws_operation>
</record_update>
