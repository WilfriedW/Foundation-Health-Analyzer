<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHARuleEvaluator</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Apply issue rules to analyzed records</description>
        <mobile_callable>false</mobile_callable>
        <name>FHARuleEvaluator</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var FHARuleEvaluator = Class.create();
FHARuleEvaluator.prototype = {
    initialize: function() {
        // Initialization
    },

    /**
     * Evaluates rules for a given item
     * @param {Object} item - The record to evaluate
     * @param {Array} rules - The rules to apply
     * @param {Object} context - Shared context (for aggregation, etc.)
     * @returns {Array} - List of detected issues
     */
    evaluate: function(item, rules, context) {

        // âœ… VÃ‰RIFICATION CRITIQUE
        if (!item) {
            gs.error('[FHARuleEvaluator] âŒ item is NULL or undefined');
            return [];
        }

        if (typeof item.getTableName !== 'function') {
            gs.error('[FHARuleEvaluator] âŒ item is not a GlideRecord');
            gs.error('[FHARuleEvaluator] item type: ' + typeof item);
            gs.error('[FHARuleEvaluator] item keys: ' + Object.keys(item).join(', '));
            return [];
        }

        gs.info('[FHARuleEvaluator] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        gs.info('[FHARuleEvaluator] ]]>ğŸ”<![CDATA[ Starting evaluation');
        gs.info('[FHARuleEvaluator] Item: ' + item.getTableName() + ' / ' + item.sys_id.toString());
        gs.info('[FHARuleEvaluator] Rules to evaluate: ' + (rules ? rules.length : 0));
        gs.info('[FHARuleEvaluator] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        var allIssues = [];

        if (!rules || !Array.isArray(rules)) {
            gs.warn('[FHARuleEvaluator] No rules provided or invalid rules array');
            return allIssues;
        }

        var self = this;

        rules.forEach(function(rule, ruleIndex) {
            try {
                gs.info('[FHARuleEvaluator] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                gs.info('[FHARuleEvaluator] ]]>ğŸ“‹<![CDATA[ Rule #' + (ruleIndex + 1) + ': ' + rule.code);

                var issues = [];

                // Parse JSON params
                var params = {};
                try {
                    if (rule.params) {
                        params = JSON.parse(rule.params);
                        gs.info('[FHARuleEvaluator] Params parsed: ' + JSON.stringify(params));
                    }
                } catch (parseError) {
                    gs.error('[FHARuleEvaluator] Error parsing params for rule ' + rule.code + ': ' + parseError.message);
                }

                // Execute the rule script
                if (rule.script) {
                    gs.info('[FHARuleEvaluator] Executing script for rule: ' + rule.code);
                    issues = self._runScriptSafe(rule, item, context);

                    gs.info('[FHARuleEvaluator] âœ… Rule ' + rule.code + ' returned ' + issues.length + ' issue(s)');

                    if (issues.length > 0) {
                        issues.forEach(function(issue, issueIndex) {
                            gs.info('[FHARuleEvaluator] Issue #' + (issueIndex + 1) + ': ' + issue.code + ' - ' + issue.message);
                        });
                    }
                } else {
                    gs.warn('[FHARuleEvaluator] Rule ' + rule.code + ' has no script');
                }

                // Add found issues
                if (issues && Array.isArray(issues) && issues.length > 0) {
                    gs.info('[FHARuleEvaluator] Adding ' + issues.length + ' issue(s) to allIssues');
                    allIssues = allIssues.concat(issues);
                }

            } catch (error) {
                gs.error('[FHARuleEvaluator] Error evaluating rule ' + rule.code + ': ' + error.message);
                gs.error('[FHARuleEvaluator] Stack: ' + error.stack);
            }
        });

        gs.info('[FHARuleEvaluator] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        gs.info('[FHARuleEvaluator] ]]>ğŸ“Š<![CDATA[ Total issues found: ' + allIssues.length);
        gs.info('[FHARuleEvaluator] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        return allIssues;
    },


    /**
     * Executes a rule script safely (Scoped App compatible)
     * @param {Object} rule - The rule (must contain rule.sys_id)
     * @param {Object} item - The item to evaluate
     * @param {Object} context - The context
     * @returns {Array} - Detected issues
     */
    _runScriptSafe: function(rule, item, context) {
        var issues = [];

        try {
            // âœ… CORRECTION #1 : Charger la rÃ¨gle depuis la DB
            var grX_1310794F_0IR = new GlideRecord('x_1310794_founda_0_issue_rules');

            if (!grX_1310794F_0IR.get(rule.sys_id)) {
                gs.warn('[FHARuleEvaluator] âš ï¸ Rule not found in database: ' + rule.sys_id);
                return issues;
            }

            gs.info('[FHARuleEvaluator]    â–¶ï¸ Executing rule: ' + grX_1310794F_0IR.getValue('name') + ' (' + grX_1310794F_0IR.getValue('code') + ')');
            gs.info('[FHARuleEvaluator]    Table: ' + grX_1310794F_0IR.getValue('table'));
            gs.info('[FHARuleEvaluator]    Active: ' + grX_1310794F_0IR.getValue('active'));

            // Create evaluator
            var evaluator = new GlideScopedEvaluator();

            // Inject variables
            evaluator.putVariable('params', {});
            evaluator.putVariable('item', item);
            evaluator.putVariable('context', context || {});
            evaluator.putVariable('issues', issues);

            // Execute script
            gs.info('[FHARuleEvaluator]    Evaluating script...');
            var scriptResult = evaluator.evaluateScript(grX_1310794F_0IR, 'script');
            gs.info('[FHARuleEvaluator]    Script execution result: ' + scriptResult);

            // Retrieve issues
            var retrievedIssues = evaluator.getVariable('issues');

            gs.info('[FHARuleEvaluator]    Retrieved issues: ' + (retrievedIssues ? 'EXISTS' : 'NULL'));
            gs.info('[FHARuleEvaluator]    Is Array: ' + Array.isArray(retrievedIssues));

            if (retrievedIssues && Array.isArray(retrievedIssues)) {
                gs.info('[FHARuleEvaluator]    Issues count: ' + retrievedIssues.length);

                if (retrievedIssues.length > 0) {
                    gs.info('[FHARuleEvaluator]    âœ… Found ' + retrievedIssues.length + ' issue(s)');

                    // Log each issue
                    retrievedIssues.forEach(function(issue, index) {
                        gs.info('[FHARuleEvaluator]       â”Œâ”€ Issue #' + (index + 1));
                        gs.info('[FHARuleEvaluator]       â”‚  Code: ' + issue.code);
                        gs.info('[FHARuleEvaluator]       â”‚  Message: ' + issue.message);
                        gs.info('[FHARuleEvaluator]       â”‚  Severity: ' + issue.severity);
                        gs.info('[FHARuleEvaluator]       â”‚  Record: ' + issue.record);

                        if (issue.details) {
                            gs.info('[FHARuleEvaluator]       â”‚  Details:');
                            for (var key in issue.details) {
                                gs.info('[FHARuleEvaluator]       â”‚     â€¢ ' + key + ': ' + issue.details[key]);
                            }
                        }
                        gs.info('[FHARuleEvaluator]       â””â”€');
                    });

                    issues = retrievedIssues;
                } else {
                    gs.info('[FHARuleEvaluator]    â„¹ï¸ No issues found for this item');
                }
            } else {
                gs.warn('[FHARuleEvaluator]    âš ï¸ retrievedIssues is NULL or not an array');
            }

        } catch (error) {
            gs.error('[FHARuleEvaluator] âŒ Error running script for rule ' + rule.code + ': ' + error.message);
            gs.error('[FHARuleEvaluator] Stack: ' + error.stack);
        }

        return issues;
    },

    /**
     * Checks if a script is already wrapped in a function
     * @param {String} script - The script to check
     * @returns {Boolean} - True if already wrapped
     */
    _isScriptWrapped: function(script) {
        if (!script) return false;

        var trimmed = script.trim();

        // Check if starts with (function and ends with })(); or }).call() or }).apply()
        var startsWithFunction = trimmed.indexOf('(function') === 0;
        var endsWithExecution =
            trimmed.lastIndexOf('})();') === trimmed.length - 5 ||
            trimmed.lastIndexOf('}).call') !== -1 ||
            trimmed.lastIndexOf('}).apply') !== -1;

        return startsWithFunction && endsWithExecution;
    },

    /**
     * Wraps a script in a function to allow return statements
     * @param {String} script - The script to wrap
     * @param {String} ruleCode - The rule code (for error messages)
     * @returns {String} - The wrapped script
     */
    _wrapScript: function(script, ruleCode) {
        return '(function() {\n' +
            '    try {\n' +
            '        ' + script.split('\n').join('\n        ') + '\n' +
            '        return issues;\n' +
            '    } catch (e) {\n' +
            '        gs.error("[Rule Script] Error in ' + ruleCode + ': " + e.message);\n' +
            '        return issues;\n' +
            '    }\n' +
            '})();';
    },

    type: 'FHARuleEvaluator'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-13 21:15:00</sys_created_on>
        <sys_id>cccafeed53163610c7233ee0a0490abc</sys_id>
        <sys_mod_count>40</sys_mod_count>
        <sys_name>FHARuleEvaluator</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_cccafeed53163610c7233ee0a0490abc</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-29 08:26:49</sys_updated_on>
    </sys_script_include>
</record_update>
