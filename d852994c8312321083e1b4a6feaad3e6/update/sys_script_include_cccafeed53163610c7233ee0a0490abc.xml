<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHARuleEvaluator</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Apply issue rules to analyzed records</description>
        <mobile_callable>false</mobile_callable>
        <name>FHARuleEvaluator</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var FHARuleEvaluator = Class.create();
FHARuleEvaluator.prototype = {
    initialize: function() {
        // Initialization
    },

    /**
     * Evaluates rules for a given item
     * @param {Object} item - The record to evaluate
     * @param {Array} rules - The rules to apply
     * @param {Object} context - Shared context (for aggregation, etc.)
     * @returns {Array} - List of detected issues
     */
    evaluate: function(item, rules, context) {

        if (typeof item.getTableName !== 'function') {
            return [];
        }
        var allIssues = [];

        if (!rules || !Array.isArray(rules)) {
            return allIssues;
        }

        var self = this;

        rules.forEach(function(rule, ruleIndex) {
            try {
                var issues = [];

                // Execute the rule script
                if (rule.script) {
                    issues = self._runScriptSafe(rule, item, context);

                    if (issues.length > 0) {
                        issues.forEach(function(issue, issueIndex) {
                        });
                    }
                } 

                // Add found issues
                if (issues && Array.isArray(issues) && issues.length > 0) {
                    allIssues = allIssues.concat(issues);
                }

            } catch (error) {
                gs.error('[FHARuleEvaluator] Error evaluating rule ' + rule.code + ': ' + error.message);
                gs.error('[FHARuleEvaluator] Stack: ' + error.stack);
            }
        });

        return allIssues;
    },


    /**
     * Executes a rule script safely (Scoped App compatible)
     * @param {Object} rule - The rule (must contain rule.sys_id)
     * @param {Object} item - The item to evaluate
     * @param {Object} context - The context
     * @returns {Array} - Detected issues
     */
    _runScriptSafe: function(rule, item, context) {
        var issues = [];

        try {
            // ✅ CORRECTION #1 : Charger la règle depuis la DB
            var grX_1310794F_0IR = new GlideRecord('x_1310794_founda_0_issue_rules');

            if (!grX_1310794F_0IR.get(rule.sys_id)) {
                gs.warn('[FHARuleEvaluator] ⚠️ Rule not found in database: ' + rule.sys_id);
                return issues;
            }

            gs.info('[FHARuleEvaluator]    ▶️ Executing rule: ' + grX_1310794F_0IR.getValue('name') + ' (' + grX_1310794F_0IR.getValue('code') + ')');
            gs.info('[FHARuleEvaluator]    Table: ' + grX_1310794F_0IR.getValue('table'));
            gs.info('[FHARuleEvaluator]    Active: ' + grX_1310794F_0IR.getValue('active'));

            // Create evaluator
            var evaluator = new GlideScopedEvaluator();

            // Parse rule params
            var params = {};
            try {
                if (grX_1310794F_0IR.getValue('params')) {
                    params = JSON.parse(grX_1310794F_0IR.getValue('params'));
                }
            } catch (e) {
                gs.warn('[FHARuleEvaluator] Failed to parse params: ' + e.message);
            }

            // Build rule object for script context
            var ruleObj = {
                sys_id: grX_1310794F_0IR.getUniqueValue(),
                code: grX_1310794F_0IR.getValue('code'),
                name: grX_1310794F_0IR.getValue('name'),
                severity: grX_1310794F_0IR.getValue('severity'),
                message_template: grX_1310794F_0IR.getValue('message_template'),
                table: grX_1310794F_0IR.getValue('table')
            };

            // Build item object with values
            var itemObj = {
                sys_id: item.getUniqueValue(),
                table: item.getTableName(),
                values: {}
            };

            // Extract field values from GlideRecord (scoped app compatible)
            var tableName = item.getTableName();
            var dict = new GlideRecord('sys_dictionary');
            dict.addQuery('name', tableName);
            dict.addQuery('internal_type', '!=', 'collection');
            dict.query();

            while (dict.next()) {
                var fieldName = dict.getValue('element');
                if (fieldName && item.isValidField(fieldName)) {
                    try {
                        itemObj.values[fieldName] = item.getValue(fieldName);
                    } catch (e) {
                        // Skip fields that can't be accessed
                    }
                }
            }

            // Inject variables
            evaluator.putVariable('params', params);
            evaluator.putVariable('rule', ruleObj);
            evaluator.putVariable('item', itemObj);
            evaluator.putVariable('context', context || {});
            evaluator.putVariable('issues', issues);

            var fieldCount = Object.keys(itemObj.values).length;
            gs.info('[FHARuleEvaluator]    Variables injected:');
            gs.info('[FHARuleEvaluator]      - params: ' + JSON.stringify(params));
            gs.info('[FHARuleEvaluator]      - rule.code: ' + ruleObj.code);
            gs.info('[FHARuleEvaluator]      - rule.severity: ' + ruleObj.severity);
            gs.info('[FHARuleEvaluator]      - item.table: ' + itemObj.table);
            gs.info('[FHARuleEvaluator]      - item.sys_id: ' + itemObj.sys_id);
            gs.info('[FHARuleEvaluator]      - item.values: ' + fieldCount + ' fields extracted');

            // Execute script
            gs.info('[FHARuleEvaluator]    Evaluating script...');
            var scriptResult = evaluator.evaluateScript(grX_1310794F_0IR, 'script');
            gs.info('[FHARuleEvaluator]    Script execution result: ' + scriptResult);

            // Retrieve issues
            var retrievedIssues = evaluator.getVariable('issues');

            gs.info('[FHARuleEvaluator]    Retrieved issues: ' + (retrievedIssues ? 'EXISTS' : 'NULL'));
            gs.info('[FHARuleEvaluator]    Is Array: ' + Array.isArray(retrievedIssues));

            if (retrievedIssues && Array.isArray(retrievedIssues)) {
                gs.info('[FHARuleEvaluator]    Issues count: ' + retrievedIssues.length);

                if (retrievedIssues.length > 0) {
                    gs.info('[FHARuleEvaluator]    ✅ Found ' + retrievedIssues.length + ' issue(s)');

                    // Log each issue
                    retrievedIssues.forEach(function(issue, index) {
                        gs.info('[FHARuleEvaluator]       ┌─ Issue #' + (index + 1));
                        gs.info('[FHARuleEvaluator]       │  Code: ' + issue.code);
                        gs.info('[FHARuleEvaluator]       │  Message: ' + issue.message);
                        gs.info('[FHARuleEvaluator]       │  Severity: ' + issue.severity);
                        gs.info('[FHARuleEvaluator]       │  Record: ' + issue.record);

                        if (issue.details) {
                            gs.info('[FHARuleEvaluator]       │  Details:');
                            for (var key in issue.details) {
                                gs.info('[FHARuleEvaluator]       │     • ' + key + ': ' + issue.details[key]);
                            }
                        }
                        gs.info('[FHARuleEvaluator]       └─');
                    });

                    issues = retrievedIssues;
                } else {
                    gs.info('[FHARuleEvaluator]    ℹ️ No issues found for this item');
                }
            } else {
                gs.warn('[FHARuleEvaluator]    ⚠️ retrievedIssues is NULL or not an array');
            }

        } catch (error) {
            gs.error('[FHARuleEvaluator] ❌ Error running script for rule ' + rule.code + ': ' + error.message);
            gs.error('[FHARuleEvaluator] Stack: ' + error.stack);
        }

        return issues;
    },

    /**
     * Checks if a script is already wrapped in a function
     * @param {String} script - The script to check
     * @returns {Boolean} - True if already wrapped
     */
    _isScriptWrapped: function(script) {
        if (!script) return false;

        var trimmed = script.trim();

        // Check if starts with (function and ends with })(); or }).call() or }).apply()
        var startsWithFunction = trimmed.indexOf('(function') === 0;
        var endsWithExecution =
            trimmed.lastIndexOf('})();') === trimmed.length - 5 ||
            trimmed.lastIndexOf('}).call') !== -1 ||
            trimmed.lastIndexOf('}).apply') !== -1;

        return startsWithFunction && endsWithExecution;
    },

    /**
     * Wraps a script in a function to allow return statements
     * @param {String} script - The script to wrap
     * @param {String} ruleCode - The rule code (for error messages)
     * @returns {String} - The wrapped script
     */
    _wrapScript: function(script, ruleCode) {
        return '(function() {\n' +
            '    try {\n' +
            '        ' + script.split('\n').join('\n        ') + '\n' +
            '        return issues;\n' +
            '    } catch (e) {\n' +
            '        gs.error("[Rule Script] Error in ' + ruleCode + ': " + e.message);\n' +
            '        return issues;\n' +
            '    }\n' +
            '})();';
    },

    type: 'FHARuleEvaluator'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-13 21:15:00</sys_created_on>
        <sys_id>cccafeed53163610c7233ee0a0490abc</sys_id>
        <sys_mod_count>42</sys_mod_count>
        <sys_name>FHARuleEvaluator</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_cccafeed53163610c7233ee0a0490abc</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-10 08:55:45</sys_updated_on>
    </sys_script_include>
</record_update>
