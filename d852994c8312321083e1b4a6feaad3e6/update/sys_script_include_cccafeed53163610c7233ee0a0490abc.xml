<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHARuleEvaluator</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Apply issue rules to analyzed records</description>
        <mobile_callable>false</mobile_callable>
        <name>FHARuleEvaluator</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var FHARuleEvaluator = Class.create();
FHARuleEvaluator.prototype = {
    initialize: function() {
        // Initialization
    },

    /**
     * Evaluates rules for a given item
     * @param {Object} item - The record to evaluate
     * @param {Array} rules - The rules to apply
     * @param {Object} context - Shared context (for aggregation, etc.)
     * @returns {Array} - List of detected issues
     */
    evaluate: function(item, rules, context) {

        var allIssues = [];

        if (!rules || !Array.isArray(rules)) {
            return allIssues;
        }

        var self = this;

        rules.forEach(function(rule) {
            try {
                var issues = [];

                // Parse JSON params
                var params = {};
                try {
                    if (rule.params) {
                        params = JSON.parse(rule.params);
                    }
                } catch (parseError) {
                    gs.error("[FHARuleEvaluator] Error parsing params for rule " + rule.code + ": " + parseError.message);
                }

                // Execute the rule script
                if (rule.script) {
                    issues = self._runScriptSafe(rule, item,context);
                }

                // Add found issues
                if (issues && Array.isArray(issues)) {
                    allIssues = allIssues.concat(issues);
                }

            } catch (error) {
                gs.error("[FHARuleEvaluator] Error evaluating rule " + rule.code + ": " + error.message);
            }
        });
        return allIssues;
    },

  /**
 * Executes a rule script safely (Scoped App compatible)
 * @param {Object} rule - The rule (doit contenir rule.params déjà parsé)
 * @param {Object} item - The item to evaluate
 * @param {Object} context - The context
 * @returns {Array} - Detected issues
 */
_runScriptSafe: function(rule, item, context, ) {
    var issues = [];
    try {
        var grX_1310794F_0IR = new GlideRecord('x_1310794_founda_0_issue_rules');
        if (grX_1310794F_0IR.get(rule.sys_id)) {

            var evaluator = new GlideScopedEvaluator();
            evaluator.putVariable('params', {});
			gs.info('Item ' +JSON.stringify(item))
            evaluator.putVariable('item', item || {});
            evaluator.putVariable('context', context || {});
						gs.info('context ' +JSON.stringify(context))


            var result = evaluator.evaluateScript(grX_1310794F_0IR, 'script');

            if (result && Array.isArray(result)) {
                issues = result;
            } else if (result) {
                var retrievedIssues = evaluator.getVariable('issues');
                if (retrievedIssues && Array.isArray(retrievedIssues)) {
                    issues = retrievedIssues;
                }
            }
        }
    } catch (error) {
        gs.error('[FHARuleEvaluator] Error running script for rule ' + rule.code + ': ' + error.message);
    }

    return issues;
},



    /**
     * Checks if a script is already wrapped in a function
     * @param {String} script - The script to check
     * @returns {Boolean} - True if already wrapped
     */
    _isScriptWrapped: function(script) {

        if (!script) return false;

        var trimmed = script.trim();

        // Check if starts with (function and ends with })(); or }).call() or }).apply()
        var startsWithFunction = trimmed.indexOf('(function') === 0;
        var endsWithExecution =
            trimmed.lastIndexOf('})();') === trimmed.length - 5 ||
            trimmed.lastIndexOf('}).call') !== -1 ||
            trimmed.lastIndexOf('}).apply') !== -1;

        return startsWithFunction && endsWithExecution;
    },

    /**
     * Wraps a script in a function to allow return statements
     * @param {String} script - The script to wrap
     * @param {String} ruleCode - The rule code (for error messages)
     * @returns {String} - The wrapped script
     */
    _wrapScript: function(script, ruleCode) {
        return '(function() {\n' +
            '    try {\n' +
            '        ' + script.split('\n').join('\n        ') + '\n' +
            '        return issues;\n' +
            '    } catch (e) {\n' +
            '        gs.error("[Rule Script] Error in ' + ruleCode + ': " + e.message);\n' +
            '        return issues;\n' +
            '    }\n' +
            '})();';
    },

    type: 'FHARuleEvaluator'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-13 21:15:00</sys_created_on>
        <sys_id>cccafeed53163610c7233ee0a0490abc</sys_id>
        <sys_mod_count>32</sys_mod_count>
        <sys_name>FHARuleEvaluator</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_cccafeed53163610c7233ee0a0490abc</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-21 08:24:08</sys_updated_on>
    </sys_script_include>
</record_update>
