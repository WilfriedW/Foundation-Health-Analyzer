<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHARuleEvaluator</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Apply issue rules to analyzed records</description>
        <mobile_callable>false</mobile_callable>
        <name>FHARuleEvaluator</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var FHARuleEvaluator = Class.create();
FHARuleEvaluator.prototype = {
    initialize: function() {
        // Handlers are now loaded from x_1310794_founda_0_issue_rules table
        this._handlersCache = null;
    },

    /**
     * Evaluate rules against an item
     * @param {Object} item - The item to evaluate
     * @param {Array} rules - Array of rule objects from issue_rules table
     * @param {Object} context - Evaluation context (totalCount, etc.)
     * @returns {Array} Array of issues found
     */
    evaluate: function(item, rules, context) {
        var issues = [];
        var self = this;

        (rules || []).forEach(function(rule) {
            var params = self._safeParse(rule.params, {});
            if (!self._isApplicable(item, params)) return;

            // Execute the rule script (all handlers are now in scripts)
            var scriptIssues = self._runScript(rule.script, item, rule, params, context);
            if (scriptIssues && scriptIssues.length) {
                issues = issues.concat(scriptIssues);
            }
        });

        return issues;
    },

    /**
     * Load handler scripts from the issue_rules table
     * This method is for reference/debugging only - handlers are executed via rule.script
     */
    _loadHandlers: function() {
        if (this._handlersCache) return this._handlersCache;

        var handlers = {};
        var gr = new GlideRecord('x_1310794_founda_0_issue_rules');
        gr.addQuery('active', true);
        gr.query();

        while (gr.next()) {
            var code = gr.getValue('code');
            if (code) {
                handlers[code] = {
                    name: gr.getValue('name'),
                    code: code,
                    type: gr.getValue('type'),
                    severity: gr.getValue('severity'),
                    script: gr.getValue('script'),
                    params: gr.getValue('params'),
                    description: gr.getValue('description')
                };
            }
        }

        this._handlersCache = handlers;
        return handlers;
    },

    _issue: function(rule, message, details) {
        return {
            code: rule.code || rule.type || 'ISSUE',
            message: message,
            severity: rule.severity || rule.default_severity || 'medium',
            details: details || {}
        };
    },

    _safeParse: function(str, fb) {
        if (fb === undefined) fb = {};
        try {
            if (!str) return fb;
            return JSON.parse(str);
        } catch (e) {
            return fb;
        }
    },

    _runScript: function(script, item, rule, params, context) {
        if (!script || typeof script !== 'string' || !script.trim()) return [];
        try {
            var fn = new Function('item', 'rule', 'params', 'context', 'issue', 'issues', script + '\n; return issues;');
            var res = fn(item, rule, params, context, this._issue.bind(this), []);
            if (!res) return [];
            if (Array.isArray(res)) return res;
            return [res];
        } catch (e) {
            gs.error("[FHARuleEvaluator] script error for rule " + (rule && rule.code) + ": " + e.message);
            return [];
        }
    },

    _isApplicable: function(item, params) {
        // optional filters in params:
        // allowed_tables: comma list
        // allowed_categories: comma list
        var tblOk = true,
            catOk = true;
        if (params.allowed_tables) {
            tblOk = this._matchList(item.table, params.allowed_tables);
        }
        if (params.allowed_categories) {
            catOk = this._matchList(item.category, params.allowed_categories);
        }
        return tblOk && catOk;
    },

    _matchList: function(value, listStr) {
        if (!listStr) return true;
        var parts = listStr.split(',').map(function(p) {
            return (p || '').trim();
        }).filter(function(p) {
            return !!p;
        });
        if (!parts.length) return true;
        return parts.indexOf(value) !== -1;
    },

    type: 'FHARuleEvaluator'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-13 21:15:00</sys_created_on>
        <sys_id>cccafeed53163610c7233ee0a0490abc</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>FHARuleEvaluator</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_cccafeed53163610c7233ee0a0490abc</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-17 23:07:55</sys_updated_on>
    </sys_script_include>
</record_update>
