<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHCheckTable</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>FHCheckTable</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var FHCheckTable = Class.create();
FHCheckTable.prototype = {
    initialize: function() {
        this.utils = new FHScanUtils();
        this.optionsHandler = new FHOptionsHandler();
    },

    /**
     * execute(ctx)
     * Public entrypoint retained for compatibility.
     * ctx is the FHAnalysisContext instance used across the analyzer.
     */
    execute: function(ctx) {
        // Register table category first
        ctx.registerCategory('table', 'Table', 'fa-table');

        // _checkTableSummary doit être appelé en tout premier car il crée la catégorie table
        this._checkTableSummary(ctx);

        // Ensuite les autres checks peuvent s'appuyer sur ctx.isTableExists()
        if (ctx.isTableExists && ctx.isTableExists()) {
            this._checkFieldUsage(ctx);
            this._checkReferenceFields(ctx);
            this._checkBusinessRules(ctx);
            this._checkClientScripts(ctx);
        }

        if (ctx.isDeepScanEnabled && ctx.isDeepScanEnabled()) {
            this.optionsHandler.deepScanScripts(ctx);
        }

        if (ctx.isAnalyzeReferencesEnabled && ctx.isAnalyzeReferencesEnabled()) {
            this.optionsHandler.analyzeIntegrationDependencies(ctx);
        }

        if (ctx.isLdapEnabled && ctx.isLdapEnabled()) {
            this.optionsHandler.analyzeLdapConfiguration(ctx);
        }
    },

    /**
     * Check table existence + record count, raise issues,
     * and add a "Table Summary" item in the 'table' category for UI.
     * Uses categories structure only, no metrics.
     */
    _checkTableSummary: function(ctx) {
        var tableName = (ctx.getTableName && ctx.getTableName()) || (ctx.config && ctx.config.table_name);
        var tableLabel = null;
        var recordCount = 0;
        var exists = false;

        if (!tableName) {
            ctx.addIssue('INVALID_CONFIG', 'Table name is not defined in configuration', 'high');
            var missingSummary = {
                table: null,
                label: null,
                exists: false,
                record_count: 0
            };
            this.utils.addCategoryAndMetrics(ctx, 'table', 'table_summary', 'Table Summary', [missingSummary], {
                table: 'sys_db_object',
                icon: 'fa-table',
                color: '#d9534f'
            });
            return;
        }

        // Query sys_db_object to verify existence and get label (if any)
        try {
            var gr = new GlideRecord('sys_db_object');
            if (gr.get('name', tableName)) {
                exists = true;
                tableLabel = ctx.safeGetValue(gr, 'label') || ctx.safeGetValue(gr, 'name') || tableName;
            } else {
                exists = false;
                ctx.addIssue('TABLE_NOT_FOUND', 'Table "' + tableName + '" does not exist in the system', 'high');
            }
        } catch (e) {
            gs.error('FHCheckTable._checkTableSummary error checking sys_db_object: ' + e);
            exists = false;
        }

        // If table exists, attempt a lightweight record count (use GlideAggregate for performance)
        if (exists) {
            try {
                var ga = new GlideAggregate(tableName);
                ga.addAggregate('COUNT');
                ga.query();
                if (ga.next()) {
                    recordCount = parseInt(ga.getAggregate('COUNT'), 10) || 0;
                } else {
                    recordCount = 0;
                }
            } catch (e) {
                gs.error('FHCheckTable._checkTableSummary record count error for ' + tableName + ': ' + e);
                recordCount = 0;
            }

            // Raise issues based on record count
            if (recordCount === 0) {
                ctx.addIssue('EMPTY_TABLE', 'Table "' + tableName + '" contains no records.', 'low', {
                    record_table: tableName
                });
            } else if (recordCount > 100000) {
                ctx.addIssue('LARGE_TABLE', 'Table "' + tableName + '" has ' + recordCount + ' records — consider archiving.', 'medium', {
                    record_table: tableName
                });
            }
        }

        // Build summary object and add to category
        var tableSummary = {
            table: tableName,
            label: tableLabel || tableName,
            exists: !!exists,
            record_count: recordCount
        };

        this.utils.addCategoryAndMetrics(ctx, 'table', 'table_summary', 'Table Summary', [tableSummary], {
            table: 'sys_db_object',
            icon: 'fa-table',
            color: exists ? '#17a2b8' : '#d9534f'
        });
    },

    /**
     * Check field usage (starts only if table exists)
     */
    _checkFieldUsage: function(ctx) {
        if (!ctx.isTableExists || !ctx.isTableExists()) return;

        var tableName = ctx.getTableName();
        // TODO: Implement field usage checks if needed
    },

    _checkReferenceFields: function(ctx) {
        if (!ctx.isTableExists || !ctx.isTableExists()) return;
        // TODO: Implement reference field checks if needed
    },

    _checkBusinessRules: function(ctx) {
        if (!ctx.isTableExists || !ctx.isTableExists()) return;

        var tableName = ctx.getTableName();
        var tablesToCheck = ctx.getTablesToCheck();
        var businessRules = [];

        try {
            var gr = new GlideRecord('sys_script');
            this.utils.addInQuery(gr, 'collection', tablesToCheck);
            gr.query();
            while (gr.next()) {
                var brName = ctx.safeGetValue(gr, 'name') || 'Unnamed';
                var brTable = ctx.safeGetValue(gr, 'collection');
                var isActive = this.utils.toBool(gr.getValue('active'));
                businessRules.push({
                    sys_id: gr.getUniqueValue(),
                    name: brName,
                    table: 'sys_script',
                    collection: brTable,
                    active: isActive,
                    inherited: (brTable !== tableName),
                    when: ctx.safeGetValue(gr, 'when'),
                    order: ctx.safeGetValue(gr, 'order')
                });

                if (!isActive) {
                    ctx.addIssue('INACTIVE_BUSINESS_RULE', 'Inactive business rule: "' + brName + '"', 'low', {
                        record_table: 'sys_script',
                        record_sys_id: gr.getUniqueValue(),
                        category: 'automation'
                    });
                }
            }

            // Consigne: regrouper dans la catégorie automation
            this.utils.addCategoryAndMetrics(ctx, 'automation', 'business_rules', 'Business Rules', businessRules, {
                table: 'sys_script',
                icon: 'fa-cogs',
                color: '#6c757d'
            });

            var activeCount = businessRules.filter(function(br) { return br.active; }).length;
            if (activeCount > 50) {
                ctx.addIssue('MANY_BUSINESS_RULES', 'Table has ' + businessRules.length + ' business rules, ' + activeCount + ' active. This may impact performance.', 'medium', {
                    record_table: 'sys_script',
                    record_filter: 'collection=' + tableName + '^active=true',
                    category: 'automation'
                });
            }
        } catch (e) {
            gs.error('FHCheckTable._checkBusinessRules error: ' + e);
        }
    },

    _checkClientScripts: function(ctx) {
        if (!ctx.isTableExists || !ctx.isTableExists()) return;

        var tableName = ctx.getTableName();
        var tablesToCheck = ctx.getTablesToCheck();
        var clientScripts = [];

        try {
            var gr = new GlideRecord('sys_script_client');
            this.utils.addInQuery(gr, 'table', tablesToCheck);
            gr.addQuery('active', true);
            gr.query();
            while (gr.next()) {
                clientScripts.push({
                    sys_id: gr.getUniqueValue(),
                    name: ctx.safeGetValue(gr, 'name') || 'Unnamed',
                    table: 'sys_script_client',
                    target_table: ctx.safeGetValue(gr, 'table'),
                    type: ctx.safeGetValue(gr, 'type'),
                    ui_type: ctx.safeGetValue(gr, 'ui_type'),
                    active: true,
                    inherited: (ctx.safeGetValue(gr, 'table') !== tableName)
                });
            }

                this.utils.addCategoryAndMetrics(ctx, 'automation', 'client_scripts', 'Client Scripts', clientScripts, {
                    table: 'sys_script_client',
                    icon: 'fa-desktop',
                    color: '#6c757d'
                });

            if (clientScripts.length > 15) {
                ctx.addIssue('MANY_CLIENT_SCRIPTS', 'Table has ' + clientScripts.length + ' active client scripts. This may impact user experience.', 'medium', {
                    record_table: 'sys_script_client',
                    record_filter: 'table=' + tableName + '^active=true',
                    category: 'automation'
                });
            }
        } catch (e) {
            gs.error('FHCheckTable._checkClientScripts query error: ' + e);
        }
    },

    type: 'FHCheckTable'

};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-02 23:20:59</sys_created_on>
        <sys_id>99f80240835a321083e1b4a6feaad361</sys_id>
        <sys_mod_count>19</sys_mod_count>
        <sys_name>FHCheckTable</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_99f80240835a321083e1b4a6feaad361</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-04 21:27:07</sys_updated_on>
    </sys_script_include>
</record_update>
