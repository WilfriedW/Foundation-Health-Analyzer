<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function($scope) {
  var c = this;

  c.reports = c.data.reports || [];
  c.loading = false;
  c.error = c.data.error || null;
  c.sortField = 'sys_created_on';
  c.sortDir = 'desc';
  c.searchQuery = '';
  c.selectedReport = null;

  c.getFilteredReports = function() {
    var list = c.reports;
    if (c.searchQuery) {
      var q = c.searchQuery.toLowerCase();
      list = list.filter(function(r) {
        return (r.number + ' ' + r.config_name + ' ' + r.table_name).toLowerCase().indexOf(q) !== -1;
      });
    }
    list.sort(function(a, b) {
      var va = a[c.sortField] || '';
      var vb = b[c.sortField] || '';
      if (c.sortDir === 'asc') return va > vb ? 1 : -1;
      return va < vb ? 1 : -1;
    });
    return list;
  };

  c.sortBy = function(field) {
    if (c.sortField === field) {
      c.sortDir = c.sortDir === 'asc' ? 'desc' : 'asc';
    } else {
      c.sortField = field;
      c.sortDir = 'desc';
    }
  };

  c.getSortIcon = function(field) {
    if (c.sortField !== field) return 'fa-sort';
    return c.sortDir === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
  };

  c.getScoreClass = function(score) {
    if (score >= 90) return '#16a34a';
    if (score >= 70) return '#4ade80';
    if (score >= 50) return '#fbbf24';
    if (score >= 30) return '#f97316';
    return '#dc2626';
  };

  c.viewDetail = function(report) {
    window.location.href = '?id=fha_analysis_detail&sys_id=' + report.sys_id;
  };

  c.exportJSON = function(report) {
    c.server.get({ action: 'export_json', sys_id: report.sys_id }).then(function(response) {
      if (response.data.json_content) {
        var blob = new Blob([response.data.json_content], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'fha_report_' + report.number + '.json';
        a.click();
        URL.revokeObjectURL(url);
      }
    });
  };

  c.exportAllCSV = function() {
    var rows = [['Number', 'Config', 'Table', 'Health Score', 'Issues', 'Critical', 'High', 'Medium', 'Low', 'Date']];
    c.getFilteredReports().forEach(function(r) {
      rows.push([r.number, r.config_name, r.table_name, r.health_score, r.issue_count, r.critical, r.high, r.medium, r.low, r.sys_created_on]);
    });
    var csv = rows.map(function(row) { return row.join(','); }).join('\n');
    var blob = new Blob([csv], { type: 'text/csv' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'fha_reports_export.csv';
    a.click();
    URL.revokeObjectURL(url);
  };
};]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_report_manager</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Report Manager</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  data.reports = [];
  data.error = null;

  // Handle client-side actions
  if (input && input.action === 'export_json') {
    var exportGr = new GlideRecord('x_1310794_founda_0_results');
    if (exportGr.get(input.sys_id)) {
      data.json_content = exportGr.getValue('details') || '{}';
    }
    return;
  }

  try {
    var gr = new GlideRecord('x_1310794_founda_0_results');
    gr.addQuery('state', 'Completed');
    gr.orderByDesc('sys_created_on');
    gr.setLimit(200);
    gr.query();

    while (gr.next()) {
      var report = {
        sys_id: gr.getUniqueValue(),
        number: gr.getValue('number') || '',
        state: gr.getValue('state') || '',
        sys_created_on: gr.getValue('sys_created_on') || '',
        sys_created_by: gr.getValue('sys_created_by') || '',
        config_name: '',
        table_name: '',
        health_score: 0,
        issue_count: 0,
        critical: 0,
        high: 0,
        medium: 0,
        low: 0
      };

      var details = gr.getValue('details');
      if (details) {
        try {
          var parsed = JSON.parse(details);
          if (parsed.configuration) {
            report.config_name = parsed.configuration.name || '';
            report.table_name = parsed.configuration.table_name || '';
          }
          if (parsed.result) {
            report.health_score = parsed.result.health_score || 0;
            report.issue_count = parsed.result.issue_count || 0;
            report.critical = parsed.result.issues_critical || 0;
            report.high = parsed.result.issues_high || 0;
            report.medium = parsed.result.issues_medium || 0;
            report.low = parsed.result.issues_low || 0;
          }
        } catch (pe) {
          // Skip unparseable details
        }
      }

      data.reports.push(report);
    }
  } catch (e) {
    gs.error('[FHA Report Manager] Error: ' + e.message);
    data.error = e.message;
  }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-17 23:59:24</sys_created_on>
        <sys_id>9a912b745326be10c7233ee0a0490ee4</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>Report Manager</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_9a912b745326be10c7233ee0a0490ee4</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-18 09:31:58</sys_updated_on>
        <template><![CDATA[<div class="fha-report-manager">

  <!-- Error -->
  <div ng-if="c.error" class="alert alert-danger" style="margin:16px;">
    <i class="fa fa-exclamation-triangle"></i> {{c.error}}
  </div>

  <!-- Header -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:12px;">
    <h3 style="margin:0; font-size:18px; font-weight:700; color:#1e293b;">
      <i class="fa fa-file-text-o" style="color:#0c63d4;"></i> Report Manager
      <span style="font-size:13px; font-weight:400; color:#6b7280; margin-left:8px;">({{c.getFilteredReports().length}} reports)</span>
    </h3>
    <div style="display:flex; gap:8px; align-items:center;">
      <div style="position:relative;">
        <i class="fa fa-search" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#9ca3af;"></i>
        <input type="text" ng-model="c.searchQuery" placeholder="Search reports..."
               style="padding:8px 12px 8px 32px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; width:220px;">
      </div>
      <button class="btn btn-sm btn-default" ng-click="c.exportAllCSV()" title="Export all to CSV">
        <i class="fa fa-download"></i> CSV
      </button>
    </div>
  </div>

  <!-- Empty state -->
  <div ng-if="c.getFilteredReports().length === 0" style="text-align:center; padding:60px 20px; color:#9ca3af;">
    <i class="fa fa-file-text-o fa-3x" style="margin-bottom:16px; opacity:0.4;"></i>
    <h4 style="margin:0 0 8px; color:#374151;">No reports found</h4>
    <p style="margin:0; font-size:13px;">Run an analysis to generate your first report</p>
  </div>

  <!-- Reports Table -->
  <div ng-if="c.getFilteredReports().length > 0" style="background:white; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;">
    <table style="width:100%; border-collapse:collapse; font-size:13px;">
      <thead>
        <tr style="background:#f8fafc; border-bottom:2px solid #e5e7eb;">
          <th style="padding:12px 16px; text-align:left; cursor:pointer; user-select:none;" ng-click="c.sortBy('number')">
            # <i class="fa" ng-class="c.getSortIcon('number')"></i>
          </th>
          <th style="padding:12px 16px; text-align:left; cursor:pointer; user-select:none;" ng-click="c.sortBy('config_name')">
            Configuration <i class="fa" ng-class="c.getSortIcon('config_name')"></i>
          </th>
          <th style="padding:12px 16px; text-align:left; cursor:pointer; user-select:none;" ng-click="c.sortBy('table_name')">
            Table <i class="fa" ng-class="c.getSortIcon('table_name')"></i>
          </th>
          <th style="padding:12px 16px; text-align:center; cursor:pointer; user-select:none;" ng-click="c.sortBy('health_score')">
            Score <i class="fa" ng-class="c.getSortIcon('health_score')"></i>
          </th>
          <th style="padding:12px 16px; text-align:center;">Issues</th>
          <th style="padding:12px 16px; text-align:left; cursor:pointer; user-select:none;" ng-click="c.sortBy('sys_created_on')">
            Date <i class="fa" ng-class="c.getSortIcon('sys_created_on')"></i>
          </th>
          <th style="padding:12px 16px; text-align:center;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="report in c.getFilteredReports() track by report.sys_id"
            style="border-bottom:1px solid #f1f5f9; transition:background 0.15s;"
            ng-mouseenter="$event.currentTarget.style.background='#f8fafc'"
            ng-mouseleave="$event.currentTarget.style.background='transparent'">
          <td style="padding:12px 16px; font-weight:600; color:#0c63d4;">{{report.number}}</td>
          <td style="padding:12px 16px;">{{report.config_name || 'N/A'}}</td>
          <td style="padding:12px 16px;">
            <code style="background:#f1f5f9; padding:2px 6px; border-radius:3px; font-size:11px;">{{report.table_name || 'N/A'}}</code>
          </td>
          <td style="padding:12px 16px; text-align:center;">
            <span style="display:inline-block; min-width:48px; padding:4px 10px; border-radius:12px; font-weight:700; font-size:12px; color:white;"
                  ng-style="{'background': c.getScoreClass(report.health_score)}">
              {{report.health_score}}%
            </span>
          </td>
          <td style="padding:12px 16px; text-align:center;">
            <span style="font-weight:600;">{{report.issue_count}}</span>
            <span ng-if="report.critical > 0" style="margin-left:6px; color:#dc2626; font-size:11px; font-weight:600;">
              <i class="fa fa-times-circle"></i>{{report.critical}}
            </span>
            <span ng-if="report.high > 0" style="margin-left:4px; color:#f97316; font-size:11px; font-weight:600;">
              <i class="fa fa-exclamation-triangle"></i>{{report.high}}
            </span>
          </td>
          <td style="padding:12px 16px; font-size:12px; color:#6b7280;">{{report.sys_created_on}}</td>
          <td style="padding:12px 16px; text-align:center;">
            <button class="btn btn-xs btn-primary" ng-click="c.viewDetail(report)" title="View details">
              <i class="fa fa-eye"></i>
            </button>
            <button class="btn btn-xs btn-default" ng-click="c.exportJSON(report)" title="Export JSON" style="margin-left:4px;">
              <i class="fa fa-download"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>]]></template>
    </sp_widget>
</record_update>
