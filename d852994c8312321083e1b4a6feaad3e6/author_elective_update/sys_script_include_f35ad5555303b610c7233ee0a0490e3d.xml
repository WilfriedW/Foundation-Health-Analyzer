<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="DELETE">
        <access>package_private</access>
        <active>false</active>
        <api_name>x_1310794_founda_0.FHARuleEvaluator</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Apply issue rules to analyzed records</description>
        <mobile_callable>false</mobile_callable>
        <name>FHARuleEvaluator</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var FHARuleEvaluator = Class.create();
FHARuleEvaluator.prototype = {
    initialize: function() {
        this._ruleCache = {}; // Cache for rule GlideRecords
    },

    /**
     * Evaluates per-record rules
     * @param {Object} item - Item object with {sys_id, table, values}
     * @param {Array} rules - Rules to apply
     * @param {Object} context - Shared context
     * @returns {Array} - Issues found
     */
    evaluate: function(item, rules, context) {
        var allIssues = [];

        if (!rules || !Array.isArray(rules)) return allIssues;

        var self = this;

        rules.forEach(function(rule) {
            try {
                if (rule.execution_mode === "aggregate") return;

                var params = self._parseParams(rule.params);
                var issues = self._runScriptSafe(rule, item, params, context);

                if (issues && Array.isArray(issues)) {
                    allIssues = allIssues.concat(issues);
                }
            } catch (error) {
                gs.error(
                    "[FHARuleEvaluator] Error in rule " +
                    rule.code +
                    ": " +
                    error.message,
                );
            }
        });

        return allIssues;
    },

    /**
     * Evaluates aggregate rules (executed ONCE per table)
     * @param {String} tableName - Table to analyze
     * @param {Array} rules - Aggregate rules
     * @param {Object} context - Shared context
     * @returns {Array} - Issues found
     */
    evaluateAggregate: function(tableName, rules, context) {
        var allIssues = [];

        if (!rules || !Array.isArray(rules)) return allIssues;

        var self = this;

        rules.forEach(function(rule) {
            try {
                if (rule.execution_mode !== "aggregate") return;

                var params = self._parseParams(rule.params);
                var issues = self._runAggregateScript(rule, tableName, params, context);

                if (issues && Array.isArray(issues)) {
                    allIssues = allIssues.concat(issues);
                }
            } catch (error) {
                gs.error(
                    "[FHARuleEvaluator] Error in aggregate rule " +
                    rule.code +
                    ": " +
                    error.message,
                );
            }
        });

        return allIssues;
    },

    /**
     * Executes per-record rule script
     */
    _runScriptSafe: function(rule, item, params, context) {
        var issues = [];

        try {
            var ruleGr = this._getRuleGlideRecord(rule.sys_id);
            if (!ruleGr) {
                gs.error("[FHARuleEvaluator] Rule not found: " + rule.sys_id);
                return issues;
            }

            var evaluator = new GlideScopedEvaluator();

            var ruleObj = {
                sys_id: rule.sys_id,
                code: rule.code,
                name: rule.name,
                severity: rule.severity || rule.default_severity || "medium",
                message_template: rule.message_template,
                table: rule.table,
            };

            // Inject variables
            evaluator.putVariable("params", params);
            evaluator.putVariable("rule", ruleObj);
            evaluator.putVariable("item", item);
            evaluator.putVariable("context", context || {});
            evaluator.putVariable("issues", issues);

            evaluator.evaluateScript(ruleGr, "script");

            // Retrieve issues
            var retrievedIssues = evaluator.getVariable("issues");

            if (retrievedIssues && Array.isArray(retrievedIssues)) {
                issues = retrievedIssues;
            }
        } catch (error) {
            gs.error(
                "[FHARuleEvaluator] Script error in " +
                rule.code +
                ": " +
                error.message,
            );
        }

        return issues;
    },

    /**
     * Executes aggregate rule script
     * FIXED: Uses GlideRecord for evaluateScript()
     */
    _runAggregateScript: function(rule, tableName, params, context) {
        var issues = [];

        try {
            var ruleGr = this._getRuleGlideRecord(rule.sys_id);
            var evaluator = new GlideScopedEvaluator();

            var ruleObj = {
                sys_id: rule.sys_id,
                code: rule.code,
                name: rule.name,
                severity: rule.severity || rule.default_severity || "medium",
                message_template: rule.message_template,
                table: rule.table,
            };

            // Inject variables for aggregate mode
            evaluator.putVariable("tableName", tableName);
            evaluator.putVariable("params", params);
            evaluator.putVariable("rule", ruleObj);
            evaluator.putVariable("context", context || {});
            evaluator.putVariable("issues", issues);

            evaluator.evaluateScript(ruleGr, "script");

            var retrievedIssues = evaluator.getVariable("issues");

            if (retrievedIssues && Array.isArray(retrievedIssues)) {
                issues = retrievedIssues;
            }
        } catch (error) {
            gs.error(
                "[FHARuleEvaluator] Aggregate script error in " +
                rule.code +
                ": " +
                error.message,
            );
        }

        return issues;
    },

    /**
     * Gets rule GlideRecord from cache or DB
     * Optimization: Cache to avoid multiple queries for same rule
     */
    _getRuleGlideRecord: function(ruleSysId) {
        // Check cache first
        if (this._ruleCache[ruleSysId]) {
            return this._ruleCache[ruleSysId];
        }

        // Load from DB
        var gr = new GlideRecord("x_1310794_founda_0_issue_rules");
        if (gr.get(ruleSysId)) {
            // Cache for reuse
            this._ruleCache[ruleSysId] = gr;
            return gr;
        }

        return null;
    },

    _parseParams: function(paramsStr) {
        try {
            var parsed = JSON.parse(paramsStr);
            return parsed;
        } catch (e) {
            gs.error("[FHARuleEvaluator]   - Error: " + e.message);
            return {};
        }
    },

    type: "FHARuleEvaluator",
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-02-12 23:56:45</sys_created_on>
        <sys_id>f35ad5555303b610c7233ee0a0490e3d</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>FHARuleEvaluator</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_f35ad5555303b610c7233ee0a0490e3d</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-13 08:29:10</sys_updated_on>
    </sys_script_include>
    <sys_update_version action="INSERT_OR_UPDATE">
        <action>DELETE</action>
        <application display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</application>
        <file_path/>
        <instance_id>6f7583ffeb78a61456eafddacad0cd0a</instance_id>
        <instance_name>dev329251</instance_name>
        <name>sys_script_include_f35ad5555303b610c7233ee0a0490e3d</name>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;&lt;sys_script_include action="INSERT_OR_UPDATE"&gt;&lt;access&gt;package_private&lt;/access&gt;&lt;active&gt;false&lt;/active&gt;&lt;api_name&gt;x_1310794_founda_0.FHARuleEvaluator&lt;/api_name&gt;&lt;caller_access/&gt;&lt;client_callable&gt;false&lt;/client_callable&gt;&lt;description&gt;Apply issue rules to analyzed records&lt;/description&gt;&lt;mobile_callable&gt;false&lt;/mobile_callable&gt;&lt;name&gt;FHARuleEvaluator&lt;/name&gt;&lt;sandbox_callable&gt;false&lt;/sandbox_callable&gt;&lt;script&gt;&lt;![CDATA[var FHARuleEvaluator = Class.create();
FHARuleEvaluator.prototype = {
    initialize: function() {
        this._ruleCache = {}; // Cache for rule GlideRecords
    },

    /**
     * Evaluates per-record rules
     * @param {Object} item - Item object with {sys_id, table, values}
     * @param {Array} rules - Rules to apply
     * @param {Object} context - Shared context
     * @returns {Array} - Issues found
     */
    evaluate: function(item, rules, context) {
        var allIssues = [];

        if (!rules || !Array.isArray(rules)) return allIssues;

        var self = this;

        rules.forEach(function(rule) {
            try {
                if (rule.execution_mode === "aggregate") return;

                var params = self._parseParams(rule.params);
                var issues = self._runScriptSafe(rule, item, params, context);

                if (issues &amp;&amp; Array.isArray(issues)) {
                    allIssues = allIssues.concat(issues);
                }
            } catch (error) {
                gs.error(
                    "[FHARuleEvaluator] Error in rule " +
                    rule.code +
                    ": " +
                    error.message,
                );
            }
        });

        return allIssues;
    },

    /**
     * Evaluates aggregate rules (executed ONCE per table)
     * @param {String} tableName - Table to analyze
     * @param {Array} rules - Aggregate rules
     * @param {Object} context - Shared context
     * @returns {Array} - Issues found
     */
    evaluateAggregate: function(tableName, rules, context) {
        var allIssues = [];

        if (!rules || !Array.isArray(rules)) return allIssues;

        var self = this;

        rules.forEach(function(rule) {
            try {
                if (rule.execution_mode !== "aggregate") return;

                var params = self._parseParams(rule.params);
                var issues = self._runAggregateScript(rule, tableName, params, context);

                if (issues &amp;&amp; Array.isArray(issues)) {
                    allIssues = allIssues.concat(issues);
                }
            } catch (error) {
                gs.error(
                    "[FHARuleEvaluator] Error in aggregate rule " +
                    rule.code +
                    ": " +
                    error.message,
                );
            }
        });

        return allIssues;
    },

    /**
     * Executes per-record rule script
     */
    _runScriptSafe: function(rule, item, params, context) {
        var issues = [];

        try {
            var ruleGr = this._getRuleGlideRecord(rule.sys_id);
            if (!ruleGr) {
                gs.error("[FHARuleEvaluator] Rule not found: " + rule.sys_id);
                return issues;
            }

            var evaluator = new GlideScopedEvaluator();

            var ruleObj = {
                sys_id: rule.sys_id,
                code: rule.code,
                name: rule.name,
                severity: rule.severity || rule.default_severity || "medium",
                message_template: rule.message_template,
                table: rule.table,
            };

            // Inject variables
            evaluator.putVariable("params", params);
            evaluator.putVariable("rule", ruleObj);
            evaluator.putVariable("item", item);
            evaluator.putVariable("context", context || {});
            evaluator.putVariable("issues", issues);

            evaluator.evaluateScript(ruleGr, "script");

            // Retrieve issues
            var retrievedIssues = evaluator.getVariable("issues");

            if (retrievedIssues &amp;&amp; Array.isArray(retrievedIssues)) {
                issues = retrievedIssues;
            }
        } catch (error) {
            gs.error(
                "[FHARuleEvaluator] Script error in " +
                rule.code +
                ": " +
                error.message,
            );
        }

        return issues;
    },

    /**
     * Executes aggregate rule script
     * FIXED: Uses GlideRecord for evaluateScript()
     */
    _runAggregateScript: function(rule, tableName, params, context) {
        var issues = [];

        try {
            var ruleGr = this._getRuleGlideRecord(rule.sys_id);
            var evaluator = new GlideScopedEvaluator();

            var ruleObj = {
                sys_id: rule.sys_id,
                code: rule.code,
                name: rule.name,
                severity: rule.severity || rule.default_severity || "medium",
                message_template: rule.message_template,
                table: rule.table,
            };

            // Inject variables for aggregate mode
            evaluator.putVariable("tableName", tableName);
            evaluator.putVariable("params", params);
            evaluator.putVariable("rule", ruleObj);
            evaluator.putVariable("context", context || {});
            evaluator.putVariable("issues", issues);

            evaluator.evaluateScript(ruleGr, "script");

            var retrievedIssues = evaluator.getVariable("issues");

            if (retrievedIssues &amp;&amp; Array.isArray(retrievedIssues)) {
                issues = retrievedIssues;
            }
        } catch (error) {
            gs.error(
                "[FHARuleEvaluator] Aggregate script error in " +
                rule.code +
                ": " +
                error.message,
            );
        }

        return issues;
    },

    /**
     * Gets rule GlideRecord from cache or DB
     * Optimization: Cache to avoid multiple queries for same rule
     */
    _getRuleGlideRecord: function(ruleSysId) {
        // Check cache first
        if (this._ruleCache[ruleSysId]) {
            return this._ruleCache[ruleSysId];
        }

        // Load from DB
        var gr = new GlideRecord("x_1310794_founda_0_issue_rules");
        if (gr.get(ruleSysId)) {
            // Cache for reuse
            this._ruleCache[ruleSysId] = gr;
            return gr;
        }

        return null;
    },

    _parseParams: function(paramsStr) {
        try {
            var parsed = JSON.parse(paramsStr);
            return parsed;
        } catch (e) {
            gs.error("[FHARuleEvaluator]   - Error: " + e.message);
            return {};
        }
    },

    type: "FHARuleEvaluator",
};]]&gt;&lt;/script&gt;&lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;&lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2026-02-12 23:56:45&lt;/sys_created_on&gt;&lt;sys_id&gt;f35ad5555303b610c7233ee0a0490e3d&lt;/sys_id&gt;&lt;sys_mod_count&gt;1&lt;/sys_mod_count&gt;&lt;sys_name&gt;FHARuleEvaluator&lt;/sys_name&gt;&lt;sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0"&gt;d852994c8312321083e1b4a6feaad3e6&lt;/sys_package&gt;&lt;sys_policy&gt;read&lt;/sys_policy&gt;&lt;sys_scope display_value="Foundation Health Analyzer"&gt;d852994c8312321083e1b4a6feaad3e6&lt;/sys_scope&gt;&lt;sys_update_name&gt;sys_script_include_f35ad5555303b610c7233ee0a0490e3d&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2026-02-13 08:29:10&lt;/sys_updated_on&gt;&lt;/sys_script_include&gt;&lt;/record_update&gt;</payload>
        <payload_hash>-295261093</payload_hash>
        <record_name>FHARuleEvaluator</record_name>
        <reverted_from/>
        <source>daee8fd9538fb610c7233ee0a0490e53</source>
        <source_table>sys_update_set</source_table>
        <state>previous</state>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-02-13 08:29:10</sys_created_on>
        <sys_id>bdaf03d953cfb610c7233ee0a0490e49</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_recorded_at>19c561e44f50000001</sys_recorded_at>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-13 08:29:10</sys_updated_on>
        <type>Script Include</type>
        <update_guid>bdaf03d93bcfb610939536386d0ef448</update_guid>
        <update_guid_history>bdaf03d93bcfb610939536386d0ef448:-295261093,5aee4b19dccfb610f542abec263adbf9:0,d5bec3d55bcfb610539574328e14c7c6:-1210773586,12ed871505cfb610517d3aa8efaccb59:0,3ad883d5328fb6103c6929327aca387c:-552302413,2d58cb55c18fb610e66a6940073a641e:0,423887553b8fb610f7e10b92a34d6c85:1985103073,cc188f15928fb61055d85e1f57db5d0d:0,69778b91348fb610ffef80f602c4f0c8:-415942464,f75ad555f603b610251590a90d3b9743:-2003534070</update_guid_history>
    </sys_update_version>
    <sys_metadata_delete action="INSERT_OR_UPDATE">
        <sys_audit_delete/>
        <sys_class_name>sys_metadata_delete</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-02-13 08:29:14</sys_created_on>
        <sys_db_object display_value="" name="sys_script_include">sys_script_include</sys_db_object>
        <sys_id>1c514239042b4fc58a4b025f92bb12e9</sys_id>
        <sys_metadata>f35ad5555303b610c7233ee0a0490e3d</sys_metadata>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>FHARuleEvaluator</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_parent/>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_scope_delete display_value="">459c20c5891043079673a2edc4dc74b1</sys_scope_delete>
        <sys_update_name>sys_script_include_f35ad5555303b610c7233ee0a0490e3d</sys_update_name>
        <sys_update_version display_value="sys_script_include_f35ad5555303b610c7233ee0a0490e3d">bdaf03d953cfb610c7233ee0a0490e49</sys_update_version>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-13 08:29:14</sys_updated_on>
    </sys_metadata_delete>
</record_update>
