<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHARuleEvaluator</api_name>
        <client_callable>false</client_callable>
        <description>Apply issue rules to analyzed records - Simplified version that only executes scripts from issue_rules table</description>
        <name>FHARuleEvaluator</name>
        <script><![CDATA[var FHARuleEvaluator = Class.create();
FHARuleEvaluator.prototype = {
    initialize: function() {},

    /**
     * Evaluate rules against an item
     * @param {Object} item - Record being analyzed with values, sys_id, table, etc.
     * @param {Array} rules - Array of rule objects from x_1310794_founda_0_issue_rules
     * @param {Object} context - Shared context for aggregate operations (totalCount, _dupsSeen, _aggregateIssuesFired)
     * @return {Array} Array of issues found
     */
    evaluate: function(item, rules, context) {
        var issues = [];
        var self = this;
        
        (rules || []).forEach(function(rule) {
            // Skip inactive rules
            if (!rule.active) return;
            
            // Parse rule parameters
            var params = self._safeParse(rule.params, {});
            
            // Check if rule is applicable to this item
            if (!self._isApplicable(item, params)) return;
            
            // Execute the script from the rule
            if (rule.script && typeof rule.script === 'string' && rule.script.trim()) {
                var scriptIssues = self._runScript(rule.script, item, rule, params, context);
                if (scriptIssues && scriptIssues.length) {
                    issues = issues.concat(scriptIssues);
                }
            } else {
                // No script defined - log warning
                gs.warn('[FHARuleEvaluator] Rule "' + (rule.code || rule.name) + '" has no script defined');
            }
        });
        
        return issues;
    },

    /**
     * Helper to create an issue object
     * @param {Object} rule - Rule configuration
     * @param {String} message - Issue message
     * @param {Object} details - Additional details
     * @return {Object} Issue object
     */
    _issue: function(rule, message, details) {
        return {
            code: rule.code || rule.type || 'ISSUE',
            message: message,
            severity: rule.severity || rule.default_severity || 'medium',
            details: details || {}
        };
    },

    /**
     * Safely parse JSON string
     * @param {String} str - JSON string
     * @param {Object} fb - Fallback value
     * @return {Object} Parsed object or fallback
     */
    _safeParse: function(str, fb) {
        if (fb === undefined) fb = {};
        try {
            if (!str) return fb;
            return JSON.parse(str);
        } catch(e) {
            gs.warn('[FHARuleEvaluator] JSON parse error: ' + e.message);
            return fb;
        }
    },

    /**
     * Execute a custom script
     * @param {String} script - JavaScript code to execute
     * @param {Object} item - Item being analyzed
     * @param {Object} rule - Rule configuration
     * @param {Object} params - Parsed parameters
     * @param {Object} context - Shared context
     * @return {Array} Issues found by script
     */
    _runScript: function(script, item, rule, params, context) {
        if (!script || typeof script !== 'string' || !script.trim()) return [];
        
        try {
            // Create a new Function with all necessary context
            // The script can access: item, rule, params, context, issue (helper function), issues (array)
            var fn = new Function(
                'item',      // Record being analyzed
                'rule',      // Rule configuration
                'params',    // Parsed parameters
                'context',   // Shared context for aggregates
                'issue',     // Helper function to create issues
                'issues',    // Array to populate with issues
                script + '\n; return issues;'
            );
            
            // Execute the script with context
            var res = fn(
                item,
                rule,
                params,
                context,
                this._issue.bind(this),  // Bound helper function
                []                        // Empty issues array
            );
            
            // Validate result
            if (!res) return [];
            if (Array.isArray(res)) return res;
            
            // Single issue returned
            return [res];
            
        } catch (e) {
            gs.error('[FHARuleEvaluator] Script execution error for rule "' + (rule && rule.code) + '": ' + e.message + '\nStack: ' + e.stack);
            return [];
        }
    },

    /**
     * Check if a rule is applicable to an item based on filters
     * @param {Object} item - Item being analyzed
     * @param {Object} params - Rule parameters (may contain allowed_tables, allowed_categories)
     * @return {Boolean} True if rule should be evaluated
     */
    _isApplicable: function(item, params) {
        // Filter by table
        if (params.allowed_tables) {
            if (!this._matchList(item.table, params.allowed_tables)) {
                return false;
            }
        }
        
        // Filter by category
        if (params.allowed_categories) {
            if (!this._matchList(item.category, params.allowed_categories)) {
                return false;
            }
        }
        
        return true;
    },

    /**
     * Check if a value matches any item in a comma-separated list
     * @param {String} value - Value to check
     * @param {String} listStr - Comma-separated list
     * @return {Boolean} True if value is in list
     */
    _matchList: function(value, listStr) {
        if (!listStr) return true;
        
        var parts = listStr.split(',')
            .map(function(p){ return (p || '').trim(); })
            .filter(function(p){ return !!p; });
        
        if (!parts.length) return true;
        
        return parts.indexOf(value) !== -1;
    },

    type: 'FHARuleEvaluator'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-17 12:00:00</sys_created_on>
        <sys_id>cccafeed53163610c7233ee0a0490abc</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>FHARuleEvaluator</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_cccafeed53163610c7233ee0a0490abc</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-17 12:00:00</sys_updated_on>
    </sys_script_include>
</record_update>
