<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="DELETE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHARuleEvaluator</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Apply issue rules to analyzed records</description>
        <mobile_callable>false</mobile_callable>
        <name>FHARuleEvaluator</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var FHARuleEvaluator = Class.create();
FHARuleEvaluator.prototype = {
    initialize: function() {
        this._ruleCache = {}; // Cache for rule GlideRecords
    },

    /**
     * Evaluates per-record rules
     * @param {Object} item - Item object with {sys_id, table, values}
     * @param {Array} rules - Rules to apply
     * @param {Object} context - Shared context
     * @returns {Array} - Issues found
     */
    evaluate: function(item, rules, context) {
        var allIssues = [];

        if (!rules || !Array.isArray(rules)) return allIssues;

        var self = this;

        rules.forEach(function(rule) {
            try {
                if (rule.execution_mode === "aggregate") return;

                var params = self._parseParams(rule.params);
                var issues = self._runScriptSafe(rule, item, params, context);

                if (issues && Array.isArray(issues)) {
                    allIssues = allIssues.concat(issues);
                }
            } catch (error) {
                gs.error(
                    "[FHARuleEvaluator] Error in rule " +
                    rule.code +
                    ": " +
                    error.message,
                );
            }
        });

        return allIssues;
    },

    /**
     * Evaluates aggregate rules (executed ONCE per table)
     * @param {String} tableName - Table to analyze
     * @param {Array} rules - Aggregate rules
     * @param {Object} context - Shared context
     * @returns {Array} - Issues found
     */
    evaluateAggregate: function(tableName, rules, context) {
        var allIssues = [];

        if (!rules || !Array.isArray(rules)) return allIssues;

        var self = this;

        rules.forEach(function(rule) {
            try {
                if (rule.execution_mode !== "aggregate") return;

                var params = self._parseParams(rule.params);
                var issues = self._runAggregateScript(rule, tableName, params, context);

                if (issues && Array.isArray(issues)) {
                    allIssues = allIssues.concat(issues);
                }
            } catch (error) {
                gs.error(
                    "[FHARuleEvaluator] Error in aggregate rule " +
                    rule.code +
                    ": " +
                    error.message,
                );
            }
        });

        return allIssues;
    },

    /**
     * Executes per-record rule script
     */
    _runScriptSafe: function(rule, item, params, context) {
        var issues = [];

        try {
            var ruleGr = this._getRuleGlideRecord(rule.sys_id);
            if (!ruleGr) {
                gs.error("[FHARuleEvaluator] Rule not found: " + rule.sys_id);
                return issues;
            }

            var evaluator = new GlideScopedEvaluator();

            var ruleObj = {
                sys_id: rule.sys_id,
                code: rule.code,
                name: rule.name,
                severity: rule.severity || rule.default_severity || "medium",
                message_template: rule.message_template,
                table: rule.table,
            };

            // Inject variables
            evaluator.putVariable("params", params);
            evaluator.putVariable("rule", ruleObj);
            evaluator.putVariable("item", item);
            evaluator.putVariable("context", context || {});
            evaluator.putVariable("issues", issues);

            evaluator.evaluateScript(ruleGr, "script");

            // Retrieve issues
            var retrievedIssues = evaluator.getVariable("issues");

            if (retrievedIssues && Array.isArray(retrievedIssues)) {
                issues = retrievedIssues;
            }
        } catch (error) {
            gs.error(
                "[FHARuleEvaluator] Script error in " +
                rule.code +
                ": " +
                error.message,
            );
        }

        return issues;
    },

    /**
     * Executes aggregate rule script
     * FIXED: Uses GlideRecord for evaluateScript()
     */
    _runAggregateScript: function(rule, tableName, params, context) {
        var issues = [];

        try {
            var ruleGr = this._getRuleGlideRecord(rule.sys_id);
            var evaluator = new GlideScopedEvaluator();

            var ruleObj = {
                sys_id: rule.sys_id,
                code: rule.code,
                name: rule.name,
                severity: rule.severity || rule.default_severity || "medium",
                message_template: rule.message_template,
                table: rule.table,
            };

            // Inject variables for aggregate mode
            evaluator.putVariable("tableName", tableName);
            evaluator.putVariable("params", params);
            evaluator.putVariable("rule", ruleObj);
            evaluator.putVariable("context", context || {});
            evaluator.putVariable("issues", issues);

            evaluator.evaluateScript(ruleGr, "script");

            var retrievedIssues = evaluator.getVariable("issues");

            if (retrievedIssues && Array.isArray(retrievedIssues)) {
                issues = retrievedIssues;
            }
        } catch (error) {
            gs.error(
                "[FHARuleEvaluator] Aggregate script error in " +
                rule.code +
                ": " +
                error.message,
            );
        }

        return issues;
    },

    /**
     * Gets rule GlideRecord from cache or DB
     * Optimization: Cache to avoid multiple queries for same rule
     */
    _getRuleGlideRecord: function(ruleSysId) {
        // Check cache first
        if (this._ruleCache[ruleSysId]) {
            return this._ruleCache[ruleSysId];
        }

        // Load from DB
        var gr = new GlideRecord("x_1310794_founda_0_issue_rules");
        if (gr.get(ruleSysId)) {
            // Cache for reuse
            this._ruleCache[ruleSysId] = gr;
            return gr;
        }

        return null;
    },

    _parseParams: function(paramsStr) {
        try {
            var parsed = JSON.parse(paramsStr);
            return parsed;
        } catch (e) {
            gs.error("[FHARuleEvaluator]   - Error: " + e.message);
            return {};
        }
    },

    type: "FHARuleEvaluator",
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-13 21:15:00</sys_created_on>
        <sys_id>cccafeed53163610c7233ee0a0490abc</sys_id>
        <sys_mod_count>72</sys_mod_count>
        <sys_name>FHARuleEvaluator</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_cccafeed53163610c7233ee0a0490abc</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-12 08:58:40</sys_updated_on>
    </sys_script_include>
    <sys_update_version action="INSERT_OR_UPDATE">
        <action>DELETE</action>
        <application display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</application>
        <file_path/>
        <instance_id>6f7583ffeb78a61456eafddacad0cd0a</instance_id>
        <instance_name>dev329251</instance_name>
        <name>sys_script_include_cccafeed53163610c7233ee0a0490abc</name>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;&lt;sys_script_include action="INSERT_OR_UPDATE"&gt;&lt;access&gt;package_private&lt;/access&gt;&lt;active&gt;true&lt;/active&gt;&lt;api_name&gt;x_1310794_founda_0.FHARuleEvaluator&lt;/api_name&gt;&lt;caller_access/&gt;&lt;client_callable&gt;false&lt;/client_callable&gt;&lt;description&gt;Apply issue rules to analyzed records&lt;/description&gt;&lt;mobile_callable&gt;false&lt;/mobile_callable&gt;&lt;name&gt;FHARuleEvaluator&lt;/name&gt;&lt;sandbox_callable&gt;false&lt;/sandbox_callable&gt;&lt;script&gt;&lt;![CDATA[var FHARuleEvaluator = Class.create();
FHARuleEvaluator.prototype = {
    initialize: function() {
        this._ruleCache = {}; // Cache for rule GlideRecords
    },

    /**
     * Evaluates per-record rules
     * @param {Object} item - Item object with {sys_id, table, values}
     * @param {Array} rules - Rules to apply
     * @param {Object} context - Shared context
     * @returns {Array} - Issues found
     */
    evaluate: function(item, rules, context) {
        var allIssues = [];

        if (!rules || !Array.isArray(rules)) return allIssues;

        var self = this;

        rules.forEach(function(rule) {
            try {
                if (rule.execution_mode === "aggregate") return;

                var params = self._parseParams(rule.params);
                var issues = self._runScriptSafe(rule, item, params, context);

                if (issues &amp;&amp; Array.isArray(issues)) {
                    allIssues = allIssues.concat(issues);
                }
            } catch (error) {
                gs.error(
                    "[FHARuleEvaluator] Error in rule " +
                    rule.code +
                    ": " +
                    error.message,
                );
            }
        });

        return allIssues;
    },

    /**
     * Evaluates aggregate rules (executed ONCE per table)
     * @param {String} tableName - Table to analyze
     * @param {Array} rules - Aggregate rules
     * @param {Object} context - Shared context
     * @returns {Array} - Issues found
     */
    evaluateAggregate: function(tableName, rules, context) {
        var allIssues = [];

        if (!rules || !Array.isArray(rules)) return allIssues;

        var self = this;

        rules.forEach(function(rule) {
            try {
                if (rule.execution_mode !== "aggregate") return;

                var params = self._parseParams(rule.params);
                var issues = self._runAggregateScript(rule, tableName, params, context);

                if (issues &amp;&amp; Array.isArray(issues)) {
                    allIssues = allIssues.concat(issues);
                }
            } catch (error) {
                gs.error(
                    "[FHARuleEvaluator] Error in aggregate rule " +
                    rule.code +
                    ": " +
                    error.message,
                );
            }
        });

        return allIssues;
    },

    /**
     * Executes per-record rule script
     */
    _runScriptSafe: function(rule, item, params, context) {
        var issues = [];

        try {
            var ruleGr = this._getRuleGlideRecord(rule.sys_id);
            if (!ruleGr) {
                gs.error("[FHARuleEvaluator] Rule not found: " + rule.sys_id);
                return issues;
            }

            var evaluator = new GlideScopedEvaluator();

            var ruleObj = {
                sys_id: rule.sys_id,
                code: rule.code,
                name: rule.name,
                severity: rule.severity || rule.default_severity || "medium",
                message_template: rule.message_template,
                table: rule.table,
            };

            // Inject variables
            evaluator.putVariable("params", params);
            evaluator.putVariable("rule", ruleObj);
            evaluator.putVariable("item", item);
            evaluator.putVariable("context", context || {});
            evaluator.putVariable("issues", issues);

            evaluator.evaluateScript(ruleGr, "script");

            // Retrieve issues
            var retrievedIssues = evaluator.getVariable("issues");

            if (retrievedIssues &amp;&amp; Array.isArray(retrievedIssues)) {
                issues = retrievedIssues;
            }
        } catch (error) {
            gs.error(
                "[FHARuleEvaluator] Script error in " +
                rule.code +
                ": " +
                error.message,
            );
        }

        return issues;
    },

    /**
     * Executes aggregate rule script
     * FIXED: Uses GlideRecord for evaluateScript()
     */
    _runAggregateScript: function(rule, tableName, params, context) {
        var issues = [];

        try {
            var ruleGr = this._getRuleGlideRecord(rule.sys_id);
            var evaluator = new GlideScopedEvaluator();

            var ruleObj = {
                sys_id: rule.sys_id,
                code: rule.code,
                name: rule.name,
                severity: rule.severity || rule.default_severity || "medium",
                message_template: rule.message_template,
                table: rule.table,
            };

            // Inject variables for aggregate mode
            evaluator.putVariable("tableName", tableName);
            evaluator.putVariable("params", params);
            evaluator.putVariable("rule", ruleObj);
            evaluator.putVariable("context", context || {});
            evaluator.putVariable("issues", issues);

            evaluator.evaluateScript(ruleGr, "script");

            var retrievedIssues = evaluator.getVariable("issues");

            if (retrievedIssues &amp;&amp; Array.isArray(retrievedIssues)) {
                issues = retrievedIssues;
            }
        } catch (error) {
            gs.error(
                "[FHARuleEvaluator] Aggregate script error in " +
                rule.code +
                ": " +
                error.message,
            );
        }

        return issues;
    },

    /**
     * Gets rule GlideRecord from cache or DB
     * Optimization: Cache to avoid multiple queries for same rule
     */
    _getRuleGlideRecord: function(ruleSysId) {
        // Check cache first
        if (this._ruleCache[ruleSysId]) {
            return this._ruleCache[ruleSysId];
        }

        // Load from DB
        var gr = new GlideRecord("x_1310794_founda_0_issue_rules");
        if (gr.get(ruleSysId)) {
            // Cache for reuse
            this._ruleCache[ruleSysId] = gr;
            return gr;
        }

        return null;
    },

    _parseParams: function(paramsStr) {
        try {
            var parsed = JSON.parse(paramsStr);
            return parsed;
        } catch (e) {
            gs.error("[FHARuleEvaluator]   - Error: " + e.message);
            return {};
        }
    },

    type: "FHARuleEvaluator",
};]]&gt;&lt;/script&gt;&lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;&lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2026-01-13 21:15:00&lt;/sys_created_on&gt;&lt;sys_id&gt;cccafeed53163610c7233ee0a0490abc&lt;/sys_id&gt;&lt;sys_mod_count&gt;72&lt;/sys_mod_count&gt;&lt;sys_name&gt;FHARuleEvaluator&lt;/sys_name&gt;&lt;sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0"&gt;d852994c8312321083e1b4a6feaad3e6&lt;/sys_package&gt;&lt;sys_policy&gt;read&lt;/sys_policy&gt;&lt;sys_scope display_value="Foundation Health Analyzer"&gt;d852994c8312321083e1b4a6feaad3e6&lt;/sys_scope&gt;&lt;sys_update_name&gt;sys_script_include_cccafeed53163610c7233ee0a0490abc&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2026-02-12 08:58:40&lt;/sys_updated_on&gt;&lt;/sys_script_include&gt;&lt;/record_update&gt;</payload>
        <payload_hash>-2003534070</payload_hash>
        <record_name>FHARuleEvaluator</record_name>
        <reverted_from/>
        <source>d2c4bfc553c37610c7233ee0a0490ef0</source>
        <source_table>sys_update_set</source_table>
        <state>previous</state>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-02-12 16:32:56</sys_created_on>
        <sys_id>76c4ffc553c37610c7233ee0a0490ea6</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_recorded_at>19c52b2d27e0000001</sys_recorded_at>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-12 16:32:56</sys_updated_on>
        <type>Script Include</type>
        <update_guid>50dc4a892687361011874246c4d734ce</update_guid>
        <update_guid_history>50dc4a892687361011874246c4d734ce:-2003534070,97a43bc577c37610ec1693741e77c443:0,50dc4a892687361011874246c4d734ce:-2003534070,d50d3909cd0736109e35a7fa47722876:378352630,dfcc7585e3073610e7645b6bac9db714:-255294173,f429b5cdefc33610088db6fa74505793:-1573964082,41b8798dd6c33610d48325f42ea98c40:-1526661087,5438b14d35c3361071b27c44d2e702ca:-2051917702,fad7f90dfcc336106aceef296f3a127e:832092855,221731c900c33610128a1581abf654e9:-560217694,f5757dc53fc3361090aed0f6bbb4be17:2067876322,fc643945b8c33610dbf999589b079232:714384186,868271cdc4833610f05615c25eedb238:-1805817536,0001398dad833610f44646c35d56726b:254873470,b1dea189368336105cd5bbc3dda64ca9:-400397680,85be6189328336106cada4eabb4be2bf:1178793464,8a9ead49f68336100bcec0682ed36902:1958695467,076e29498a833610bbeb692aac48c692:-1274779005,f31ee90947833610a7df8e9f31a3aec4:1768768777,e09d6dc5868336105373c717e69e5d77:-927905277,722c2145e583361083f96fdbd422cbac:-1820959699,0f9b2901da83361024c637b375de544c:-304044980,16eaa5814b833610d194a33aa65325b9:71364944,93ca65817783361035f9d04788b59861:-458202863,308a2d4181833610ef15fa3c97af0065:499779154,644ae14130833610a5e187b59789a5e0:2132418458,80e9a101088336105d790b92f10eb323:990239259,3088654d2e4336103236a5611f5de087:-1717753777,7d97a1c958433610cd6c65e59943c459:-105367415,603591c5fbcff21023c370b404113294:1882003005,3505dd85a1cff210b82181df24954a5e:-903966277,eb6cc145668ff2107cbee22e63524438:427255461,0f133cf462cb72101ac673c59efba94b:0,b37517d43c0772107a480a09910406a2:0,514f71a89df23210870a82545578f566:-1519280143,b61d752425f23210c0aefb2d22ab4edc:777789547,985c3524fbf23210a7392a13968ebe57:136261022,31cbf1e0f3f232102ebaee6431864e3d:-501885288,7fe979ecf0b23210fb045d46d741b422:-1672739065,9259fd6c2db232109f536a927a6c9521:-536065423,4637392868b23210853e1754e83207b8:-1958163424,def6752854b2321027fadca3db35cba2:-1529902302,48a675a423b23210321df0b74c430b4f:-2104342265,64963d64d5b232105df1cdd7710150a0:-1412282130,6953b9ecf37232106616b2f2a3f5dc67:-1529902302,8cf134ca23e23210549145f567b78c4c:-1087450280,d6313c4ac9e2321093a5180e80486bcf:1260683035,346078c608e232104d628f0b2d817885:243257717,586b43e986aef25079b7ef31e6db1b67:540020487,a0498fa561aef250ed5e551c4979a102:-1308395577,1158cf25d6aef2508e4c8ae97af266ca:-258988690,66a0e4e185aab250a49627ea20c35d2d:-426670671,471f142191aab250c2a5f156af929edd:-174815938,44fe1021afaab250b505ede09de4cfd5:-612232873,cf9ed4ed2c6ab25036eb3fddbf2d3a62:1419261598,5d3e58ad986ab250eec3f54777e944cb:-2036138721,071b9025706ab250bcde9e8b674ce601:298559479,6f72d8217f2ab2509811da55b8ca78a4:-843545584,756e4ced00e6b250f06e2992e21b5402:1253085185,71fd0425bee6b250f6595a915c3a36a8:57080902,ed6d0c6df5e6b250719cc953907d6aca:-1113082028,072d446de8e6b25038da8283077a879a:833538325,550d882dbee6b250c30748f8e077fc03:1836120360,90ac04e945e6b250dd1f2e2466b71a27:-1905308730,42fbcc69f9e6b2507ca7f50ce4db9550:-693212493,871bcc297ce6b2507881d10783c069f0:-1719243774,86bac0290ae6b250fc8afb5f1613319a:1537356433,6e8a4ce5cee6b250b351aa8d663adfa9:-2092127266,b7e988a598e6b250db72b104f6829391:-657039683,19894c657de6b250f175d59f43844dd6:-1739398608,9249842561e6b2506249c343db184498:-183086513,b4b8c02576e6b2509cfc140f16bbdee0:537089368,6c1b2addccea7250d55ecaa116c3f252:-474454328,e16966d96dea7250a3f2b16562283943:1374990964,7787e61984ea72502a4727680915dfd3:79597541,e617e2d562ea72502e3bd672159bbbdc:755723162,09956ed1ebea72505195c2388cfc2b1a:79597541,f7842291e1ea7250facb851b5073d61c:-1127172357,3ad593bc99a2be102119ffb2922d6b7e:697634713,3565df3c5fa2be105470322b9e5c62d9:0,f9678730e862be10c3f1d4bef40814e2:0,225447784322be1087e8b320048a6ae2:-539573229,6ffc6638766e7e1078798e5896ba4933:0,ae8322348a2e7e102682b3d1ff9e8a8e:1393324103,bd9d92b4a0ea7e10fe609746116d432a:0,89421230bbaa7e109362acb5cdd4c1f5:-517711091,c4b04e38dce67e10d51e0352c9926af6:0,123c13f314d6b610b79ff16a48b32482:0,56b10aa7005ef21000062bc6f8f3b532:0,6b7da71b9bdab210cff8c72c52d1f658:0,81fa6f933ddab2106bc5a3c28e619672:0,cb862f5b789ab21000e0cc35885907d9:0,d0ef9f5b045ab21000870f159906dcf0:2047263898</update_guid_history>
    </sys_update_version>
    <sys_metadata_delete action="INSERT_OR_UPDATE">
        <sys_audit_delete/>
        <sys_class_name>sys_metadata_delete</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-02-12 23:56:59</sys_created_on>
        <sys_db_object display_value="" name="sys_script_include">sys_script_include</sys_db_object>
        <sys_id>7c1bd25c04484f5ca02d1ee9af1154b9</sys_id>
        <sys_metadata>cccafeed53163610c7233ee0a0490abc</sys_metadata>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>FHARuleEvaluator</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_parent/>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_scope_delete display_value="">459c20c5891043079673a2edc4dc74b1</sys_scope_delete>
        <sys_update_name>sys_script_include_cccafeed53163610c7233ee0a0490abc</sys_update_name>
        <sys_update_version display_value="sys_script_include_cccafeed53163610c7233ee0a0490abc">76c4ffc553c37610c7233ee0a0490ea6</sys_update_version>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-12 23:56:59</sys_updated_on>
    </sys_metadata_delete>
</record_update>
