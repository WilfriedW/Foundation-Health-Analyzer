<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ws_operation">
    <sys_ws_operation action="INSERT_OR_UPDATE">
        <active>true</active>
        <consumes>application/json,application/xml,text/xml</consumes>
        <consumes_customized>false</consumes_customized>
        <default_operation_uri/>
        <enforce_acl/>
        <http_method>GET</http_method>
        <name>Analyze by config</name>
        <operation_script><![CDATA[(function process(/*RESTAPIRequest*/ request, /*RESTAPIResponse*/ response) {
    
    try {
        var config_sys_id = request.pathParams.config_sys_id;
        
        if (!config_sys_id) {
            return sendError(response, 400, 'Missing config_sys_id parameter');
        }
        
        // Verify configuration exists
        var grConfig = new GlideRecord('x_1310794_founda_0_fha_configuration');
        if (!grConfig.get(config_sys_id)) {
            return sendError(response, 404, 'Configuration not found: ' + config_sys_id);
        }
        
        // Check if active
        var activeVal = grConfig.getValue('active');
        var isActive = (activeVal === 'true' || activeVal === '1' || activeVal === true);
        if (!isActive) {
            return sendError(response, 400, 'Configuration is not active');
        }
        
        // Create analysis instance with scoped name
        var analyzer = new x_1310794_founda_0.FHAnalyzer();
        
        // Prepare parameters
        var params = {
            deep_scan: true,
            user_sys_id: gs.getUserID()
        };
        
        // Start analysis
        var startTime = new Date().getTime();
        var result = analyzer.runAnalysis(config_sys_id, params);
        var duration = Math.round((new Date().getTime() - startTime) / 1000);
        
        // Update configuration with last analysis date if fields exist
        try {
            grConfig.setValue('last_analysis_date', new GlideDateTime());
            grConfig.setValue('analysis_duration', duration);
            grConfig.update();
        } catch (updateErr) {
            // Fields may not exist, continue
        }
        
        if (result.success) {
            // Return success result
            var responseBody = {
                success: true,
                status: 'COMPLETED',
                analysis_id: result.sys_id || null,
                result_sys_id: result.sys_id || null,
                config_sys_id: config_sys_id,
                table_name: result.details ? result.details.table_name : '',
                health_score: result.details ? result.details.health_score : 0,
                issues_found: result.details && result.details.issues ? result.details.issues.length : 0,
                duration: duration,
                message: 'Analysis completed successfully',
                timestamp: new GlideDateTime().getDisplayValue()
            };
            
            return sendSuccess(response, responseBody);
        } else {
            return sendError(response, 500, result.error || 'Analysis failed');
        }
        
    } catch (e) {
        gs.error('FHA API Error in analyze_by_config: ' + e);
        return sendError(response, 500, 'Server error: ' + e.toString());
    }
    
})(request, response);

// Helper function for success response
function sendSuccess(response, data) {
    response.setStatus(200);
    response.setHeader('Content-Type', 'application/json');
    response.setBody(data);
}

// Helper function for error response
function sendError(response, statusCode, message) {
    response.setStatus(statusCode);
    response.setHeader('Content-Type', 'application/json');
    response.setBody({
        success: false,
        error: message,
        statusCode: statusCode,
        timestamp: new GlideDateTime().getDisplayValue()
    });
}
]]></operation_script>
        <operation_uri>/api/x_1310794_founda_0/fha/analyze_by_config/{config_sys_id}</operation_uri>
        <produces>application/json,application/xml,text/xml</produces>
        <produces_customized>false</produces_customized>
        <relative_path>/analyze_by_config/{config_sys_id}</relative_path>
        <request_example>// Path Parameter: config_sys_id (required)
// Example: /api/x_1310794_founda_0/fha/analyze_by_config/abc123def456

// Success Response (200):
{
  "success": true,
  "status": "COMPLETED",
  "analysis_id": "xyz789...",
  "result_sys_id": "xyz789...",
  "config_sys_id": "abc123def456",
  "table_name": "incident",
  "issues_found": 8,
  "total_fields_analyzed": 45,
  "duration": 3,
  "message": "Analysis processed",
  "timestamp": "2026-01-03 10:30:00"
}

// Error Response (404):
{
  "success": false,
  "error": "Configuration not found: abc123def456",
  "statusCode": 404,
  "timestamp": "2026-01-03 10:30:00"
}</request_example>
        <requires_acl_authorization>true</requires_acl_authorization>
        <requires_authentication>true</requires_authentication>
        <requires_snc_internal_role>true</requires_snc_internal_role>
        <short_description>Run health analysis using a specific configuration sys_id</short_description>
        <sys_class_name>sys_ws_operation</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-02 22:28:58</sys_created_on>
        <sys_id>dfecb14883d6321083e1b4a6feaad35b</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Analyze by config</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_ws_operation_dfecb14883d6321083e1b4a6feaad35b</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-02 22:28:58</sys_updated_on>
        <web_service_definition display_value="Foundation Health Analyzer API">8add5d0883d2321083e1b4a6feaad355</web_service_definition>
        <web_service_version/>
    </sys_ws_operation>
</record_update>
