<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1310794_founda_0.FHAnalysisEngine</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>FHAnalysisEngine</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[// =====================================================================
// SCRIPT: FHAnalysisEngine - Standardized Version
// =====================================================================
// Description: Updated version with standardized issue structure support
// Date: 2026-02-12
// =====================================================================
// CHANGES:
// - Added _normalizeIssue() to ensure consistent issue structure
// - Updated _analyzeResults() to use normalization
// - Ensures record_table is at level 1 of issue object
// - Auto-fills missing contextual fields
// - Backward compatible with old rule formats
// =====================================================================

var FHAnalysisEngine = Class.create();
FHAnalysisEngine.prototype = {
    TABLES: {
        RESULTS: 'x_1310794_founda_0_results',
        CONFIGURATIONS: 'x_1310794_founda_0_configurations',
        TEMPLATES: 'x_1310794_founda_0_analysis_templates',
        VERIFICATION_ITEMS: 'x_1310794_founda_0_verification_items',
        ISSUE_RULES: 'x_1310794_founda_0_issue_rules'
    },

    initialize: function() {
        this.options = {};
    },

    /**
     * Executes verification for a configured item (e.g., Flow, Change Request)
     * @param {GlideRecord} configRecord - Configuration record from your "Items to Verify" table
     * @returns {Object} - Verification result { success: Boolean, data: Array, errors: Array, metadata: Object }
     */
    runVerification: function(configRecord) {
        var result = {
            success: false,
            data: [],
            errors: [],
            metadata: {},
        };

        // Load configuration options
        this.options = this._loadConfigurationOptions(configRecord);

        if (!this._validateOptions()) {
            result.errors.push("Invalid configuration options");
            return result;
        }

        var rulesMap = this._loadIssueRules(configRecord.verification_items || []);
        var self = this;
        result.issues = [];

        configRecord.verification_items.forEach(function(item) {
            try {
                // Extract configuration parameters
                var tableName = item.tableName;
                var queryType = item.query_type.toLowerCase();
                var queryValue = item.query_value || '';
                var queryScript = item.query_script || '';

                // Apply deep_scan option to fields
                var fields = self._determineFields(item);

                // Build the query based on type
                var gr = new GlideRecord(tableName);

                if (queryType === 'script') {
                    if (queryScript) {
                        var scriptResults = [];
                        try {
                            eval(queryScript);
                        } catch (eScript) {
                            result.errors.push("Query script error: " + eScript.message);
                            gs.error("[FHAnalysisEngine] Query script error: " + eScript.message);
                        }
                        var ids = self._flattenIds(scriptResults);
                        if (ids.length > 0) {
                            gr.addQuery('sys_id', 'IN', ids.join(','));
                        } else {
                            result.success = true;
                            return;
                        }
                    }
                } else {
                    gr.addEncodedQuery(queryValue.replaceAll("{0}", configRecord.table_name));
                }

                // Apply configuration options
                self._applyConfigurationOptions(gr, tableName);

                // Execute query and collect records for THIS VI only
                var itemRecords = [];
                gr.query();

                while (gr.next()) {
                    var record = self._processRecord(gr, fields, item);
                    record._rules = rulesMap[item.sys_id] || [];
                    itemRecords.push(record);
                }

                // Add to global result
                result.data = result.data.concat(itemRecords);

                // Analyze ONLY records from this VI (avoids cumulative re-analysis)
                self._analyzeItemResults(result, itemRecords, item);
                result.success = true;

            } catch (e) {
                result.errors.push("Verification error: " + e.message);
                gs.error("[FHAnalysisEngine] Verification error: " + e.message + "\nStack: " + e.stack);
            }
        });

        return result;
    },

    // ============================================================
    // CONFIGURATION OPTIONS MANAGEMENT
    // ============================================================

    _loadConfigurationOptions: function(configRecord) {
        var options = {
            ignore_servicenow_records: configRecord.ignore_servicenow_records || false,
            servicenow_users: configRecord.servicenow_users || 'system,admin,maint,guest',
            include_children_tables: configRecord.include_children_tables || false,
            deep_scan: configRecord.deep_scan || false,
            include_ldap: configRecord.include_ldap || true
        };

        gs.debug("[FHAnalysisEngine] Configuration options loaded: " + JSON.stringify(options));
        return options;
    },

    _validateOptions: function() {
        try {
            // Validation
            if (this.options.ignore_servicenow_records && this.options.servicenow_users) {
                var users = this.options.servicenow_users.split(',');
                if (users.length === 0) {
                    gs.warn("[FHAnalysisEngine] servicenow_users is empty, using default");
                    this.options.servicenow_users = 'system,admin,maint,guest';
                }
            }

            // Validate boolean types
            this.options.ignore_servicenow_records = Boolean(this.options.ignore_servicenow_records);
            this.options.include_children_tables = Boolean(this.options.include_children_tables);
            this.options.deep_scan = Boolean(this.options.deep_scan);
            this.options.include_ldap = Boolean(this.options.include_ldap);

            return true;
        } catch (e) {
            gs.error("[FHAnalysisEngine] Options validation error: " + e.message);
            return false;
        }
    },

    _applyConfigurationOptions: function(gr, tableName) {
        gs.debug("[FHAnalysisEngine] Applying configuration options for table: " + tableName);

        if (this.options.ignore_servicenow_records) {
            this._applyIgnoreServiceNowRecords(gr, tableName);
        }

        if (this.options.include_children_tables) {
            this._applyIncludeChildrenTables(gr, tableName);
        }

        if (!this.options.include_ldap) {
            this._applyExcludeLDAP(gr, tableName);
        }
    },

    _applyIgnoreServiceNowRecords: function(gr, tableName) {
        try {
            var snUsersStr = this.options.servicenow_users || 'system,admin,maint,guest';
            var snUsers = snUsersStr.split(',').map(function(u) { return u.trim(); });

            gs.debug("[FHAnalysisEngine] Applying intelligent ServiceNow filter");

            var testGr = new GlideRecord(tableName);
            testGr.setLimit(1);
            testGr.query();

            if (testGr.next()) {
                var hasCreatedBy = testGr.isValidField('sys_created_by');
                var hasUpdatedBy = testGr.isValidField('sys_updated_by');

                if (hasCreatedBy && hasUpdatedBy) {
                    var notInCreated = 'sys_created_byNOT IN' + snUsers.join(',');
                    var notInUpdated = 'sys_updated_byNOT IN' + snUsers.join(',');
                    var encodedQuery = notInCreated + '^OR' + notInUpdated;

                    gr.addEncodedQuery(encodedQuery);

                }
            }
        } catch (e) {
            gs.error("[FHAnalysisEngine] Error applying ignore_servicenow_records: " + e.message);
        }
    },

    _applyIncludeChildrenTables: function(gr, tableName) {
        try {
            var testGr = new GlideRecord(tableName);
            testGr.setLimit(1);
            testGr.query();

            if (testGr.next() && testGr.isValidField('sys_class_name')) {
                gr.addQuery('sys_class_name', 'STARTSWITH', tableName);
            }
        } catch (e) {
            gs.error("[FHAnalysisEngine] Error applying include_children_tables: " + e.message);
        }
    },

    _applyExcludeLDAP: function(gr, tableName) {
        try {
            var ldapTables = [
                'ldap_server_config',
                'ldap_ou_config',
                'ldap_group_map',
                'ldap_server'
            ];

            if (ldapTables.indexOf(tableName) !== -1) {
                gr.addQuery('sys_id', 'NULL');
            }
        } catch (e) {
            gs.error("[FHAnalysisEngine] Error applying exclude LDAP: " + e.message);
        }
    },

    _determineFields: function(item) {
        var fields = [];

        if (this.options.deep_scan) {
            fields = (item.fields && item.fields.split(',')) || [];

            var deepScanFields = [
                'name', 'active', 'sys_created_by', 'sys_updated_by', 'sys_id',
                'sys_created_on', 'sys_updated_on', 'sys_mod_count',
                'sys_package', 'sys_scope', 'sys_class_name',
                'description', 'short_description', 'script', 'condition',
                'order', 'priority', 'when', 'filter_condition'
            ];

            deepScanFields.forEach(function(df) {
                if (fields.indexOf(df) === -1) {
                    fields.push(df);
                }
            });

        } else {
            fields = (item.fields && item.fields.split(',')) || [];

            var defaults = ['name', 'active', 'sys_created_by', 'sys_updated_by', 'sys_id', 'sys_created_on', 'sys_updated_on'];
            defaults.forEach(function(df) {
                if (fields.indexOf(df) === -1) {
                    fields.push(df);
                }
            });
        }

        fields = fields.map(function(f) {
            return (f || '').trim();
        }).filter(function(f) {
            return !!f;
        });

        return fields;
    },

    // ============================================================
    // RECORD PROCESSING
    // ============================================================

    _processRecord: function(gr, fields, item) {
        var record = {
            sys_id: gr.sys_id.toString(),
            table: gr.getTableName(),
            values: {},
            issues: [],
            category: item.category
        };

        fields.forEach(function(field) {
            if (gr.isValidField(field)) {
                record.values[field] = gr.getValue(field);
            }
        });

        return record;
    },

    // ============================================================
    // ISSUE ANALYSIS - STANDARDIZED VERSION
    // ============================================================

    /**
     * Analyzes records for a single verification item
     * Handles both per-record and aggregate rules
     * @param {Object} result - Global result object (issues array is appended to)
     * @param {Array} itemRecords - Records from this VI only
     * @param {Object} item - The verification item config
     */
    _analyzeItemResults: function(result, itemRecords, item) {
        try {
            var self = this;

            // Context scoped to this VI's records
            var context = {
                totalCount: itemRecords.length,
                _dupsSeen: {},
                options: this.options
            };

            itemRecords.forEach(function(it) {
                var key = (it.values.name || '') + '|' + (it.values.code || '');
                if (!context._dupsSeen[key]) context._dupsSeen[key] = it.sys_id;
            });

            var ruleEval = new x_1310794_founda_0.FHARuleEvaluator();
            var allRules = (itemRecords.length > 0 && itemRecords[0]._rules) || [];

            // 1. Per-record rules: execute per record
            itemRecords.forEach(function(record) {
                var rules = record._rules || [];
                var rawIssues = ruleEval.evaluate(record, rules, context) || [];

                record.issues = [];
                rawIssues.forEach(function(issue) {
                    var normalized = self._normalizeIssue(issue, record);
                    if (normalized) {
                        record.issues.push(normalized);

                        result.issues.push({
                            code: normalized.code,
                            message: normalized.message,
                            severity: normalized.severity,
                            record: normalized.record,
                            record_table: normalized.record_table,
                            record_sys_id: normalized.details.record_sys_id || '',
                            record_name: normalized.details.record_name || '',
                            record_filter: normalized.details.record_filter || '',
                            category: record.category || '',
                            details: normalized.details
                        });
                    }
                });
            });

            // 2. Aggregate rules: execute once per table/VI
            if (allRules.length > 0) {
                var tableName = item.tableName || '';
                var aggregateIssues = ruleEval.evaluateAggregate(tableName, allRules, context) || [];

                aggregateIssues.forEach(function(issue) {
                    var placeholder = {
                        table: tableName,
                        sys_id: '',
                        values: {},
                        category: item.category
                    };
                    var normalized = self._normalizeIssue(issue, placeholder);
                    if (normalized) {
                        result.issues.push({
                            code: normalized.code,
                            message: normalized.message,
                            severity: normalized.severity,
                            record: normalized.record,
                            record_table: normalized.record_table,
                            record_sys_id: normalized.details.record_sys_id || '',
                            record_name: normalized.details.record_name || '',
                            record_filter: normalized.details.record_filter || '',
                            category: item.category || '',
                            details: normalized.details
                        });
                    }
                });
            }

        } catch (error) {
            gs.error("[FHAnalysisEngine] _analyzeItemResults: " + error.message);
        }
    },

    /**
     * Normalizes and validates issue structure
     * Ensures consistent format for portal/widget consumption
     * @param {Object} issue - The issue object from rule script
     * @param {Object} item - The item being analyzed
     * @returns {Object} - Normalized issue or null if invalid
     */
    _normalizeIssue: function(issue, item) {
        // Validate required fields
        if (!issue || typeof issue !== 'object') {
            gs.error('[FHAnalysisEngine] Invalid issue object');
            return null;
        }

        // Create normalized structure
        var normalized = {
            code: issue.code || 'UNKNOWN',
            message: issue.message || 'No message provided',
            severity: issue.severity || 'medium',
            record: issue.record || null,
            // LEVEL 1: record_table for widget filtering
            record_table: issue.record_table || (issue.details && issue.details.record_table) || item.table || '',
            details: issue.details || {}
        };

        // Ensure details has required standard fields
        if (!normalized.details.record_table) {
            normalized.details.record_table = normalized.record_table;
        }
        if (!normalized.details.record_sys_id) {
            normalized.details.record_sys_id = issue.record || item.sys_id || '';
        }
        if (!normalized.details.record_name) {
            normalized.details.record_name = (item.values && item.values.name) || (item.values && item.values.number) || item.sys_id || 'N/A';
        }

        // Add contextual fields if missing (backward compatibility)
        if (!normalized.details.created_on && item.values && item.values.sys_created_on) {
            normalized.details.created_on = item.values.sys_created_on;
        }
        if (!normalized.details.created_by && item.values && item.values.sys_created_by) {
            normalized.details.created_by = item.values.sys_created_by;
        }
        if (!normalized.details.updated_on && item.values && item.values.sys_updated_on) {
            normalized.details.updated_on = item.values.sys_updated_on;
        }
        if (!normalized.details.updated_by && item.values && item.values.sys_updated_by) {
            normalized.details.updated_by = item.values.sys_updated_by;
        }
        if (normalized.details.active === undefined && item.values && item.values.active !== undefined) {
            normalized.details.active = item.values.active;
        }

        // Warn if recommendation is missing (best practice)
        if (!normalized.details.recommendation) {
            gs.debug('[FHAnalysisEngine] Issue ' + normalized.code + ' is missing recommendation field');
        }

        return normalized;
    },

    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================

    _flattenIds: function(list) {
        var ids = [];
        if (!list) return ids;
        var pushId = function(v) {
            if (!v) return;
            if (typeof v === 'string') {
                if (v.indexOf(',') > -1) {
                    v.split(',').forEach(pushId);
                } else {
                    ids.push(v);
                }
            } else if (Array.isArray(v)) {
                v.forEach(pushId);
            } else if (v.sys_id) {
                ids.push(String(v.sys_id));
            } else if (v.getUniqueValue && typeof v.getUniqueValue === 'function') {
                ids.push(String(v.getUniqueValue()));
            }
        };
        pushId(list);
        return ids;
    },

    _loadIssueRules: function(items) {
        var map = {};
        var ids = [];
        (items || []).forEach(function(it) {
            if (it.issue_rules) {
                ids = ids.concat(String(it.issue_rules).split(','));
            }
        });
        ids = ids.filter(function(x) {
            return x;
        });
        if (!ids.length) return map;

        var gr = new GlideRecord(this.TABLES.ISSUE_RULES);
        gr.addQuery('sys_id', 'IN', ids.join(','));
        gr.addQuery('active', true);
        gr.query();
        while (gr.next()) {
            var rule = {
                sys_id: gr.getUniqueValue(),
                name: gr.getValue('name') || '',
                code: gr.getValue('code') || '',
                type: gr.getValue('type') || '',
                execution_mode: gr.getValue('execution_mode') || 'per_record',
                default_severity: gr.getValue('default_severity') || 'medium',
                params: gr.getValue('params') || '{}',
                script: gr.getValue('script') || ''
            };
            (items || []).forEach(function(it) {
                if (String(it.issue_rules || '').indexOf(rule.sys_id) > -1) {
                    if (!map[it.sys_id]) map[it.sys_id] = [];
                    map[it.sys_id].push(rule);
                }
            });
        }
        return map;
    },

    type: 'FHAnalysisEngine'
};
]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-07 01:18:57</sys_created_on>
        <sys_id>033a4751531a3610c7233ee0a0490e0f</sys_id>
        <sys_mod_count>112</sys_mod_count>
        <sys_name>FHAnalysisEngine</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sys_script_include_033a4751531a3610c7233ee0a0490e0f</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-12 18:15:06</sys_updated_on>
    </sys_script_include>
</record_update>
