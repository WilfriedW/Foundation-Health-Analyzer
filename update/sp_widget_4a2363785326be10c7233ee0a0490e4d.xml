<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function() {
 var c = this;
  
  // Initialize
  c.data.loading = true;
  c.data.refreshing = false;
  c.data.chartType = 'bar'; // 'bar' or 'pie'
  c.data.selectedCategory = null;
  
  // Chart instance
  var categoryChart = null;
  
  /**
   * Initialize widget
   */
  c.$onInit = function() {
    // Convert categories object to array
    c.data.categoriesArray = c.convertCategoriesToArray(c.data.categories);
    
    // Calculate total issues for percentage
    c.data.totalIssues = c.data.categoriesArray.reduce(function(sum, cat) {
      return sum + cat.total_issues;
    }, 0);
    
    // Sort by total issues (descending)
    c.data.categoriesArray.sort(function(a, b) {
      return b.total_issues - a.total_issues;
    });
    
    // Render chart
    $timeout(function() {
      c.renderChart();
    }, 100);
    
    c.data.loading = false;
  };
  
  /**
   * Convert categories object to array
   */
  c.convertCategoriesToArray = function(categoriesObj) {
    var array = [];
    for (var key in categoriesObj) {
      if (categoriesObj.hasOwnProperty(key)) {
        array.push(categoriesObj[key]);
      }
    }
    return array;
  };
  
  /**
   * Refresh data
   */
  c.refreshData = function() {
    c.data.refreshing = true;
    c.server.get().then(function(response) {
      if (response.data.success) {
        c.data.categories = response.data.categories;
        c.data.categoriesArray = c.convertCategoriesToArray(c.data.categories);
        
        // Recalculate total
        c.data.totalIssues = c.data.categoriesArray.reduce(function(sum, cat) {
          return sum + cat.total_issues;
        }, 0);
        
        // Sort
        c.data.categoriesArray.sort(function(a, b) {
          return b.total_issues - a.total_issues;
        });
        
        // Re-render chart
        $timeout(function() {
          c.renderChart();
        }, 100);
      } else {
        c.data.error = response.data.error || 'Error refreshing data';
      }
    }).catch(function(error) {
      c.data.error = 'Error refreshing data: ' + (error.message || 'Unknown error');
    }).finally(function() {
      c.data.refreshing = false;
    });
  };
  
  /**
   * Select a category
   */
  c.selectCategory = function(category) {
    if (c.data.selectedCategory === category.name) {
      c.data.selectedCategory = null;
    } else {
      c.data.selectedCategory = category.name;
    }
  };
  
  /**
   * Calculate percentage of total issues
   */
  c.calculatePercentage = function(issues) {
    if (c.data.totalIssues === 0) return 0;
    return Math.round((issues / c.data.totalIssues) * 100);
  };
  
  /**
   * Get category color
   */
  c.getCategoryColor = function(categoryName) {
    var colors = {
      automation: '#0c63d4',
      security: '#dc2626',
      integration: '#7c3aed',
      performance: '#f59e0b',
      data_quality: '#10b981',
      configuration: '#6366f1',
      compliance: '#ec4899',
      general: '#6b7280'
    };
    return colors[categoryName] || '#6b7280';
  };
  
  /**
   * Get category icon
   */
  c.getCategoryIcon = function(categoryName) {
    var icons = {
      automation: 'fa-cogs',
      security: 'fa-shield',
      integration: 'fa-plug',
      performance: 'fa-tachometer',
      data_quality: 'fa-database',
      configuration: 'fa-sliders',
      compliance: 'fa-gavel',
      general: 'fa-cubes'
    };
    return icons[categoryName] || 'fa-cubes';
  };
  
  /**
   * Get category label
   */
  c.getCategoryLabel = function(categoryName) {
    var labels = {
      automation: c.data.i18n.automation || 'Automation',
      security: c.data.i18n.security || 'Security',
      integration: c.data.i18n.integration || 'Integration',
      performance: c.data.i18n.performance || 'Performance',
      data_quality: c.data.i18n.dataQuality || 'Data Quality',
      configuration: c.data.i18n.configuration || 'Configuration',
      compliance: c.data.i18n.compliance || 'Compliance',
      general: c.data.i18n.general || 'General'
    };
    return labels[categoryName] || categoryName;
  };
  
  /**
   * Change chart type
   */
  c.changeChartType = function(type) {
    if (c.data.chartType === type) return;
    c.data.chartType = type;
    $timeout(function() {
      c.renderChart();
    }, 50);
  };
  
  /**
   * Render chart
   */
  c.renderChart = function() {
    var canvasId = 'category-chart-' + c.widget.options.id;
    var canvas = document.getElementById(canvasId);
    
    if (!canvas) {
      console.error('Canvas not found: ' + canvasId);
      return;
    }
    
    var ctx = canvas.getContext('2d');
    
    // Destroy existing chart
    if (categoryChart) {
      categoryChart.destroy();
    }
    
    var labels = c.data.categoriesArray.map(function(cat) {
      return c.getCategoryLabel(cat.name);
    });
    
    var dataValues = c.data.categoriesArray.map(function(cat) {
      return cat.total_issues;
    });
    
    var backgroundColors = c.data.categoriesArray.map(function(cat) {
      return c.getCategoryColor(cat.name);
    });
    
    if (c.data.chartType === 'bar') {
      categoryChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: c.data.i18n.totalIssues,
            data: dataValues,
            backgroundColor: backgroundColors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: {
                size: 13
              },
              bodyFont: {
                size: 12
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                font: {
                  size: 11
                }
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    } else { // pie chart
      categoryChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: dataValues,
            backgroundColor: backgroundColors,
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 15,
                font: {
                  size: 12
                },
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: {
                size: 13
              },
              bodyFont: {
                size: 12
              },
              callbacks: {
                label: function(context) {
                  var label = context.label || '';
                  var value = context.parsed || 0;
                  var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                  var percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return label + ': ' + value + ' (' + percentage + '%)';
                }
              }
            }
          }
        }
      });
    }
  };
  
  /**
   * Cleanup on destroy
   */
  c.$onDestroy = function() {
    if (categoryChart) {
      categoryChart.destroy();
    }
  };

}]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>fha_category_metrics</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Category Metrics</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[// ===================================================
// FHA Category Metrics Widget - Server Script
// ===================================================

(function() {
  
  // Initialize data
  data.categories = {};
  data.success = false;
  data.error = null;
  
  // Internationalization (i18n)
  data.i18n = {
    title: gs.getMessage('Issues by Category'),
    loading: gs.getMessage('Loading...'),
    noData: gs.getMessage('No category data available'),
    totalIssues: gs.getMessage('Total Issues'),
    critical: gs.getMessage('Critical'),
    high: gs.getMessage('High'),
    medium: gs.getMessage('Medium'),
    low: gs.getMessage('Low'),
    affectedTables: gs.getMessage('Affected Tables'),
    ofTotal: gs.getMessage('of total'),
    issuesByCategory: gs.getMessage('Issues by Category'),
    // Category names
    automation: gs.getMessage('Automation'),
    security: gs.getMessage('Security'),
    integration: gs.getMessage('Integration'),
    performance: gs.getMessage('Performance'),
    dataQuality: gs.getMessage('Data Quality'),
    configuration: gs.getMessage('Configuration'),
    compliance: gs.getMessage('Compliance'),
    general: gs.getMessage('General')
  };
  
  /**
   * Load category metrics
   */
  function loadCategoryMetrics() {
    try {
      var metricsEngine = new x_1310794_founda_0.FHMetricsEngine();
      
      // Get category metrics
      data.categories = metricsEngine.getCategoryMetrics();
      
      data.success = true;
      
    } catch (error) {
      gs.error('[FHA Category Metrics Widget] Error loading data: ' + error.message);
      data.error = error.message;
      data.success = false;
    }
  }
  
  // Load data on server init
  loadCategoryMetrics();
  
})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-18 00:06:18</sys_created_on>
        <sys_id>4a2363785326be10c7233ee0a0490e4d</sys_id>
        <sys_mod_count>4</sys_mod_count>
        <sys_name>Category Metrics</sys_name>
        <sys_package display_value="Foundation Health Analyzer" source="x_1310794_founda_0">d852994c8312321083e1b4a6feaad3e6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Foundation Health Analyzer">d852994c8312321083e1b4a6feaad3e6</sys_scope>
        <sys_update_name>sp_widget_4a2363785326be10c7233ee0a0490e4d</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-18 09:31:46</sys_updated_on>
        <template><![CDATA[<div class="fha-category-metrics">
  
  <!-- Loading State -->
  <div ng-if="c.data.loading" class="loading-container">
    <i class="fa fa-spinner fa-spin fa-3x"></i>
    <p>{{::c.data.i18n.loading}}</p>
  </div>

  <!-- Error State -->
  <div ng-if="c.data.error" class="alert alert-danger">
    <i class="fa fa-exclamation-triangle"></i>
    {{c.data.error}}
  </div>

  <!-- Content -->
  <div ng-if="!c.data.loading && !c.data.error">
    
    <!-- Header -->
    <div class="widget-header">
      <h3>
        <i class="fa fa-pie-chart"></i>
        {{::c.data.i18n.title}}
      </h3>
      <button class="btn btn-sm btn-default" ng-click="c.refreshData()">
        <i class="fa fa-refresh" ng-class="{'fa-spin': c.data.refreshing}"></i>
      </button>
    </div>

    <!-- No Data State -->
    <div ng-if="c.data.categoriesArray.length === 0" class="empty-state">
      <i class="fa fa-inbox fa-3x"></i>
      <p>{{::c.data.i18n.noData}}</p>
    </div>

    <!-- Categories Grid -->
    <div ng-if="c.data.categoriesArray.length > 0" class="categories-container">
      
      <!-- Category Card -->
      <div class="category-card" 
           ng-repeat="category in c.data.categoriesArray track by category.name"
           ng-click="c.selectCategory(category)"
           ng-class="{'selected': c.data.selectedCategory === category.name}">
        
        <div class="category-header">
          <div class="category-icon" ng-style="{'background-color': c.getCategoryColor(category.name)}">
            <i class="fa" ng-class="c.getCategoryIcon(category.name)"></i>
          </div>
          <div class="category-info">
            <h4>{{c.getCategoryLabel(category.name)}}</h4>
            <small class="text-muted">{{category.name}}</small>
          </div>
        </div>

        <div class="category-body">
          
          <!-- Total Issues -->
          <div class="stat-row main-stat">
            <span class="stat-label">{{::c.data.i18n.totalIssues}}</span>
            <span class="stat-value">{{category.total_issues | number:0}}</span>
          </div>

          <!-- Issues Breakdown -->
          <div class="severity-breakdown">
            <div class="severity-item" ng-if="category.critical > 0">
              <span class="severity-badge critical">
                <i class="fa fa-times-circle"></i>
                {{category.critical}}
              </span>
              <span class="severity-label">{{::c.data.i18n.critical}}</span>
            </div>
            <div class="severity-item" ng-if="category.high > 0">
              <span class="severity-badge high">
                <i class="fa fa-exclamation-triangle"></i>
                {{category.high}}
              </span>
              <span class="severity-label">{{::c.data.i18n.high}}</span>
            </div>
            <div class="severity-item" ng-if="category.medium > 0">
              <span class="severity-badge medium">
                <i class="fa fa-exclamation"></i>
                {{category.medium}}
              </span>
              <span class="severity-label">{{::c.data.i18n.medium}}</span>
            </div>
            <div class="severity-item" ng-if="category.low > 0">
              <span class="severity-badge low">
                <i class="fa fa-info-circle"></i>
                {{category.low}}
              </span>
              <span class="severity-label">{{::c.data.i18n.low}}</span>
            </div>
          </div>

          <!-- Affected Tables -->
          <div class="stat-row">
            <span class="stat-label">
              <i class="fa fa-database"></i>
              {{::c.data.i18n.affectedTables}}
            </span>
            <span class="stat-value">{{category.affected_tables_count}}</span>
          </div>

          <!-- Percentage -->
          <div class="percentage-bar">
            <div class="percentage-fill" 
                 ng-style="{'width': c.calculatePercentage(category.total_issues) + '%', 'background-color': c.getCategoryColor(category.name)}">
            </div>
          </div>
          <div class="percentage-text">
            {{c.calculatePercentage(category.total_issues)}}% {{::c.data.i18n.ofTotal}}
          </div>

        </div>

      </div>

    </div>

    <!-- Chart Section -->
    <div class="chart-section" ng-if="c.data.categoriesArray.length > 0">
      <div class="chart-header">
        <h4>{{::c.data.i18n.issuesByCategory}}</h4>
        <div class="chart-type-selector">
          <button class="btn btn-xs" 
                  ng-class="{'btn-primary': c.data.chartType === 'bar', 'btn-default': c.data.chartType !== 'bar'}"
                  ng-click="c.changeChartType('bar')">
            <i class="fa fa-bar-chart"></i>
          </button>
          <button class="btn btn-xs" 
                  ng-class="{'btn-primary': c.data.chartType === 'pie', 'btn-default': c.data.chartType !== 'pie'}"
                  ng-click="c.changeChartType('pie')">
            <i class="fa fa-pie-chart"></i>
          </button>
        </div>
      </div>
      <div class="chart-body">
        <canvas id="category-chart-{{c.widget.options.id}}" height="300"></canvas>
      </div>
    </div>

  </div>

</div>]]></template>
    </sp_widget>
</record_update>
